# DDD æ¶æ„è¯¦ç»†è§£é‡Šä¸ç™»å½•ä¸šåŠ¡æµç¨‹ç¤ºä¾‹

## ğŸ“‹ ç›®å½•

- [1. Interfaces å±‚è¯¦è§£](#1-interfaceså±‚è¯¦è§£)
- [2. Application å±‚è¯¦è§£](#2-applicationå±‚è¯¦è§£)
- [3. Command/Query ä¸ DTO å…³ç³»](#3-commandqueryä¸dtoå…³ç³»)
- [4. Domain å±‚æ ¸å¿ƒæ¦‚å¿µ](#4-domainå±‚æ ¸å¿ƒæ¦‚å¿µ)
- [5. Domain å±‚å…±äº«ç»„ä»¶](#5-domainå±‚å…±äº«ç»„ä»¶)
- [6. Domain å®ä½“è¯¦è§£](#6-domainå®ä½“è¯¦è§£)
- [7. ç™»å½•ä¸šåŠ¡æµç¨‹å®Œæ•´ç¤ºä¾‹](#7-ç™»å½•ä¸šåŠ¡æµç¨‹å®Œæ•´ç¤ºä¾‹)

---

## 1. Interfaces å±‚è¯¦è§£

### 1.1 Assembler è½¬æ¢å™¨ï¼ˆDTO <-> VOï¼‰

**ä½œç”¨**ï¼šåœ¨æ¥å£å±‚å’Œåº”ç”¨å±‚ä¹‹é—´è¿›è¡Œæ•°æ®è½¬æ¢ï¼Œå°†å¤–éƒ¨ DTO è½¬æ¢ä¸ºå†…éƒ¨é¢†åŸŸå¯¹è±¡ï¼Œæˆ–å°†é¢†åŸŸå¯¹è±¡è½¬æ¢ä¸ºå¤–éƒ¨ VOã€‚

**è½¬æ¢æ–¹å¼**ï¼š

```java
// ç¤ºä¾‹ï¼šUserAssembler.java
@Component
public class UserAssembler {

    /**
     * DTO -> Domain Object
     * å°†å¤–éƒ¨è¯·æ±‚è½¬æ¢ä¸ºé¢†åŸŸå¯¹è±¡
     */
    public User toDomain(UserRegisterRequest request) {
        return User.builder()
            .username(request.getUsername())
            .email(new Email(request.getEmail()))
            .password(new Password(request.getPassword()))
            .build();
    }

    /**
     * Domain Object -> VO
     * å°†é¢†åŸŸå¯¹è±¡è½¬æ¢ä¸ºå¤–éƒ¨å“åº”
     */
    public UserInfoResponse toResponse(User user) {
        return UserInfoResponse.builder()
            .id(user.getId())
            .username(user.getUsername())
            .email(user.getEmail().getValue())
            .status(user.getStatus().name())
            .build();
    }
}
```

### 1.2 Facade é—¨é¢æ¥å£

**ä½œç”¨**ï¼šå¯¹å¤–æš´éœ²ç»Ÿä¸€çš„ä¸šåŠ¡æ¥å£ï¼Œéšè—å†…éƒ¨å¤æ‚æ€§ï¼Œæä¾›ç²—ç²’åº¦çš„ä¸šåŠ¡æ“ä½œã€‚

**ä¸ Controller çš„åŒºåˆ«**ï¼š

- **Controller**ï¼šå¤„ç† HTTP è¯·æ±‚ï¼Œå‚æ•°æ ¡éªŒï¼Œæƒé™éªŒè¯
- **Facade**ï¼šæä¾›ä¸šåŠ¡é—¨é¢ï¼Œåè°ƒå¤šä¸ªåº”ç”¨æœåŠ¡

```java
// ç¤ºä¾‹ï¼šUserFacade.java
@Service
public class UserFacade {

    @Autowired
    private UserApplicationService userApplicationService;
    @Autowired
    private AuthApplicationService authApplicationService;

    /**
     * ç”¨æˆ·æ³¨å†Œé—¨é¢
     * åè°ƒå¤šä¸ªåº”ç”¨æœåŠ¡å®Œæˆå¤æ‚ä¸šåŠ¡
     */
    public UserInfoResponse registerUser(UserRegisterRequest request) {
        // 1. åˆ›å»ºç”¨æˆ·
        User user = userApplicationService.createUser(request);

        // 2. å‘é€æ¬¢è¿é‚®ä»¶
        authApplicationService.sendWelcomeEmail(user);

        // 3. è®°å½•æ³¨å†Œæ—¥å¿—
        authApplicationService.logUserRegistration(user);

        return UserAssembler.toResponse(user);
    }
}
```

### 1.3 Controller æ§åˆ¶å™¨

**ä½œç”¨**ï¼šå¤„ç† HTTP è¯·æ±‚ï¼Œå‚æ•°æ ¡éªŒï¼Œæƒé™éªŒè¯ï¼Œè°ƒç”¨ Facade æˆ– ApplicationServiceã€‚

```java
// ç¤ºä¾‹ï¼šUserController.java
@RestController
@RequestMapping("/api/users")
public class UserController {

    @Autowired
    private UserFacade userFacade;

    @PostMapping("/register")
    public Result<UserInfoResponse> register(@Valid @RequestBody UserRegisterRequest request) {
        // å‚æ•°æ ¡éªŒç”±@Validè‡ªåŠ¨å®Œæˆ
        UserInfoResponse response = userFacade.registerUser(request);
        return Result.success(response);
    }
}
```

---

## 2. Application å±‚è¯¦è§£

### 2.1 Event äº‹ä»¶å¤„ç†æœºåˆ¶

**Handlerï¼ˆäº‹ä»¶å¤„ç†å™¨ï¼‰**ï¼šå¤„ç†é¢†åŸŸäº‹ä»¶ï¼Œæ‰§è¡Œå‰¯ä½œç”¨æ“ä½œã€‚

```java
// ç¤ºä¾‹ï¼šUserEventHandler.java
@Component
public class UserEventHandler {

    @Autowired
    private EmailService emailService;
    @Autowired
    private LogService logService;

    /**
     * å¤„ç†ç”¨æˆ·æ³¨å†Œäº‹ä»¶
     */
    @EventHandler
    public void handleUserRegistered(UserRegisteredEvent event) {
        // å‘é€æ¬¢è¿é‚®ä»¶
        emailService.sendWelcomeEmail(event.getUser());

        // è®°å½•æ³¨å†Œæ—¥å¿—
        logService.logUserRegistration(event.getUser());
    }

    /**
     * å¤„ç†ç”¨æˆ·ç™»å½•äº‹ä»¶
     */
    @EventHandler
    public void handleUserLogin(UserLoginEvent event) {
        // æ›´æ–°æœ€åç™»å½•æ—¶é—´
        logService.updateLastLoginTime(event.getUser());

        // å‘é€ç™»å½•é€šçŸ¥
        emailService.sendLoginNotification(event.getUser());
    }
}
```

**Publisherï¼ˆäº‹ä»¶å‘å¸ƒå™¨ï¼‰**ï¼šå‘å¸ƒé¢†åŸŸäº‹ä»¶ï¼Œè§£è€¦ä¸šåŠ¡é€»è¾‘ã€‚

```java
// ç¤ºä¾‹ï¼šDomainEventPublisher.java
@Component
public class DomainEventPublisher {

    @Autowired
    private ApplicationEventPublisher eventPublisher;

    /**
     * å‘å¸ƒé¢†åŸŸäº‹ä»¶
     */
    public void publish(DomainEvent event) {
        eventPublisher.publishEvent(event);
    }

    /**
     * å‘å¸ƒç”¨æˆ·æ³¨å†Œäº‹ä»¶
     */
    public void publishUserRegistered(User user) {
        UserRegisteredEvent event = new UserRegisteredEvent(user);
        publish(event);
    }
}
```

---

## 3. Command/Query ä¸ DTO å…³ç³»

### 3.1 Commandï¼ˆå‘½ä»¤å¯¹è±¡ï¼‰

**ä½œç”¨**ï¼šå°è£…å†™æ“ä½œï¼ŒåŒ…å«ä¸šåŠ¡æ„å›¾å’Œå¿…è¦æ•°æ®ã€‚

```java
// ç¤ºä¾‹ï¼šCreateUserCommand.java
public class CreateUserCommand {
    private String username;
    private String email;
    private String password;
    private String departmentId;

    // æ„é€ å‡½æ•°ã€getterã€setter
}

// ä¸DTOçš„å…³ç³»
public class UserRegisterRequest {  // DTO
    private String username;
    private String email;
    private String password;
    private String departmentId;

    // è½¬æ¢ä¸ºCommand
    public CreateUserCommand toCommand() {
        return new CreateUserCommand(username, email, password, departmentId);
    }
}
```

### 3.2 Queryï¼ˆæŸ¥è¯¢å¯¹è±¡ï¼‰

**ä½œç”¨**ï¼šå°è£…è¯»æ“ä½œï¼ŒåŒ…å«æŸ¥è¯¢æ¡ä»¶å’Œåˆ†é¡µä¿¡æ¯ã€‚

```java
// ç¤ºä¾‹ï¼šUserQuery.java
public class UserQuery {
    private String keyword;
    private String departmentId;
    private UserStatus status;
    private PageRequest pageRequest;

    // æ„é€ å‡½æ•°ã€getterã€setter
}

// ä¸DTOçš„å…³ç³»
public class UserSearchRequest {  // DTO
    private String keyword;
    private String departmentId;
    private String status;
    private int page;
    private int size;

    // è½¬æ¢ä¸ºQuery
    public UserQuery toQuery() {
        return new UserQuery(keyword, departmentId,
                           UserStatus.valueOf(status),
                           PageRequest.of(page, size));
    }
}
```

---

## 4. Domain å±‚æ ¸å¿ƒæ¦‚å¿µ

### 4.1 Aggregateï¼ˆèšåˆæ ¹ï¼‰

**å®šä¹‰**ï¼šä¿è¯ä¸šåŠ¡ä¸€è‡´æ€§çš„è¾¹ç•Œï¼ŒåŒ…å«å®ä½“å’Œå€¼å¯¹è±¡ï¼Œé€šè¿‡å”¯ä¸€æ ‡è¯†è¿›è¡Œç®¡ç†ã€‚

```java
// ç¤ºä¾‹ï¼šUser.javaï¼ˆç”¨æˆ·èšåˆæ ¹ï¼‰
@Entity
@Table(name = "sys_user")
public class User {

    @Id
    private UserId id;

    private Username username;
    private Email email;
    private Password password;
    private UserStatus status;

    // èšåˆå†…çš„å®ä½“
    private List<Role> roles;
    private UserProfile profile;

    /**
     * ä¸šåŠ¡æ–¹æ³•ï¼šç”¨æˆ·æ³¨å†Œ
     */
    public void register(Username username, Email email, Password password) {
        this.username = username;
        this.email = email;
        this.password = password;
        this.status = UserStatus.ACTIVE;

        // å‘å¸ƒé¢†åŸŸäº‹ä»¶
        DomainEventPublisher.publish(new UserRegisteredEvent(this));
    }

    /**
     * ä¸šåŠ¡æ–¹æ³•ï¼šç”¨æˆ·ç™»å½•
     */
    public void login(String inputPassword) {
        if (!this.password.matches(inputPassword)) {
            throw new InvalidPasswordException("å¯†ç é”™è¯¯");
        }

        // å‘å¸ƒç™»å½•äº‹ä»¶
        DomainEventPublisher.publish(new UserLoginEvent(this));
    }
}
```

### 4.2 ValueObjectï¼ˆå€¼å¯¹è±¡ï¼‰

**å®šä¹‰**ï¼šæ— æ ‡è¯†çš„ä¸å¯å˜å¯¹è±¡ï¼Œé€šè¿‡å€¼ç›¸ç­‰æ€§åˆ¤æ–­ã€‚

```java
// ç¤ºä¾‹ï¼šEmail.javaï¼ˆé‚®ç®±å€¼å¯¹è±¡ï¼‰
@Embeddable
public class Email {

    private String value;

    private Email() {} // JPAéœ€è¦

    public Email(String value) {
        if (!isValidEmail(value)) {
            throw new InvalidEmailException("é‚®ç®±æ ¼å¼ä¸æ­£ç¡®");
        }
        this.value = value;
    }

    public String getValue() {
        return value;
    }

    private boolean isValidEmail(String email) {
        return email.matches("^[\\w-\\.]+@([\\w-]+\\.)+[\\w-]{2,4}$");
    }

    @Override
    public boolean equals(Object obj) {
        if (this == obj) return true;
        if (obj == null || getClass() != obj.getClass()) return false;
        Email email = (Email) obj;
        return Objects.equals(value, email.value);
    }

    @Override
    public int hashCode() {
        return Objects.hash(value);
    }
}
```

---

## 5. Domain å±‚å…±äº«ç»„ä»¶

### 5.1 Shared/Eventï¼ˆå…±äº«äº‹ä»¶ï¼‰

**å®šä¹‰**ï¼šè·¨èšåˆçš„é¢†åŸŸäº‹ä»¶ï¼Œç”¨äºè§£è€¦ä¸šåŠ¡é€»è¾‘ã€‚

```java
// ç¤ºä¾‹ï¼šUserRegisteredEvent.java
public class UserRegisteredEvent extends DomainEvent {

    private final UserId userId;
    private final String username;
    private final String email;

    public UserRegisteredEvent(User user) {
        super();
        this.userId = user.getId();
        this.username = user.getUsername().getValue();
        this.email = user.getEmail().getValue();
    }

    // getteræ–¹æ³•
}
```

### 5.2 Shared/Exceptionï¼ˆå…±äº«å¼‚å¸¸ï¼‰

**å®šä¹‰**ï¼šé¢†åŸŸå¼‚å¸¸ï¼Œè¡¨ç¤ºä¸šåŠ¡è§„åˆ™è¿åã€‚

```java
// ç¤ºä¾‹ï¼šInvalidPasswordException.java
public class InvalidPasswordException extends DomainException {

    public InvalidPasswordException(String message) {
        super(message);
    }

    public InvalidPasswordException(String message, Throwable cause) {
        super(message, cause);
    }
}

// ç¤ºä¾‹ï¼šUserNotFoundException.java
public class UserNotFoundException extends DomainException {

    public UserNotFoundException(UserId userId) {
        super("ç”¨æˆ·ä¸å­˜åœ¨: " + userId.getValue());
    }
}
```

---

## 6. Domain å®ä½“è¯¦è§£

### 6.1 Entityï¼ˆå®ä½“ï¼‰

**å®šä¹‰**ï¼šå…·æœ‰å”¯ä¸€æ ‡è¯†çš„é¢†åŸŸå¯¹è±¡ï¼Œé€šè¿‡ ID åŒºåˆ†ä¸åŒå®ä¾‹ã€‚

```java
// ç¤ºä¾‹ï¼šRole.javaï¼ˆè§’è‰²å®ä½“ï¼‰
@Entity
@Table(name = "sys_role")
public class Role {

    @Id
    private RoleId id;

    private String name;
    private String description;
    private RoleStatus status;

    // å…³è”çš„æƒé™
    private List<Permission> permissions;

    /**
     * ä¸šåŠ¡æ–¹æ³•ï¼šåˆ†é…æƒé™
     */
    public void assignPermission(Permission permission) {
        if (permissions == null) {
            permissions = new ArrayList<>();
        }
        permissions.add(permission);
    }

    /**
     * ä¸šåŠ¡æ–¹æ³•ï¼šç§»é™¤æƒé™
     */
    public void removePermission(Permission permission) {
        if (permissions != null) {
            permissions.remove(permission);
        }
    }
}
```

---

## 7. ç™»å½•ä¸šåŠ¡æµç¨‹å®Œæ•´ç¤ºä¾‹

### 7.1 å®Œæ•´ç›®å½•ç»“æ„å±•ç¤º

```
src/main/java/com/sciz/server/
â”œâ”€â”€ interfaces/                           # æ¥å£å±‚
â”‚   â”œâ”€â”€ controller/
â”‚   â”‚   â””â”€â”€ user/
â”‚   â”‚       â””â”€â”€ AuthController.java      # è®¤è¯æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”œâ”€â”€ request/
â”‚   â”‚   â”‚   â””â”€â”€ UserLoginRequest.java    # ç™»å½•è¯·æ±‚DTO
â”‚   â”‚   â””â”€â”€ response/
â”‚   â”‚       â””â”€â”€ LoginResponse.java       # ç™»å½•å“åº”DTO
â”‚   â”œâ”€â”€ assembler/
â”‚   â”‚   â””â”€â”€ AuthAssembler.java          # è®¤è¯è½¬æ¢å™¨
â”‚   â””â”€â”€ facade/
â”‚       â””â”€â”€ AuthFacade.java              # è®¤è¯é—¨é¢
â”œâ”€â”€ application/                         # åº”ç”¨å±‚
â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â””â”€â”€ user/
â”‚   â”‚       â””â”€â”€ AuthApplicationService.java # è®¤è¯åº”ç”¨æœåŠ¡
â”‚   â”œâ”€â”€ command/
â”‚   â”‚   â””â”€â”€ user/
â”‚   â”‚       â””â”€â”€ LoginCommand.java         # ç™»å½•å‘½ä»¤
â”‚   â”œâ”€â”€ query/
â”‚   â”‚   â””â”€â”€ user/
â”‚   â”‚       â””â”€â”€ UserQuery.java           # ç”¨æˆ·æŸ¥è¯¢
â”‚   â””â”€â”€ event/
â”‚       â”œâ”€â”€ handler/
â”‚       â”‚   â””â”€â”€ UserEventHandler.java    # ç”¨æˆ·äº‹ä»¶å¤„ç†å™¨
â”‚       â””â”€â”€ publisher/
â”‚           â””â”€â”€ DomainEventPublisher.java # é¢†åŸŸäº‹ä»¶å‘å¸ƒå™¨
â”œâ”€â”€ domain/                              # é¢†åŸŸå±‚
â”‚   â”œâ”€â”€ iam/                             # IAMé¢†åŸŸ
â”‚   â”‚   â”œâ”€â”€ aggregate/
â”‚   â”‚   â”‚   â””â”€â”€ User.java                # ç”¨æˆ·èšåˆæ ¹
â”‚   â”‚   â”œâ”€â”€ entity/
â”‚   â”‚   â”‚   â”œâ”€â”€ Role.java                # è§’è‰²å®ä½“
â”‚   â”‚   â”‚   â””â”€â”€ Permission.java          # æƒé™å®ä½“
â”‚   â”‚   â”œâ”€â”€ valueobject/
â”‚   â”‚   â”‚   â”œâ”€â”€ Username.java            # ç”¨æˆ·åå€¼å¯¹è±¡
â”‚   â”‚   â”‚   â”œâ”€â”€ Email.java               # é‚®ç®±å€¼å¯¹è±¡
â”‚   â”‚   â”‚   â”œâ”€â”€ Password.java            # å¯†ç å€¼å¯¹è±¡
â”‚   â”‚   â”‚   â””â”€â”€ UserStatus.java          # ç”¨æˆ·çŠ¶æ€å€¼å¯¹è±¡
â”‚   â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â”‚   â””â”€â”€ AuthenticationService.java # è®¤è¯é¢†åŸŸæœåŠ¡
â”‚   â”‚   â”œâ”€â”€ repository/
â”‚   â”‚   â”‚   â””â”€â”€ UserRepository.java      # ç”¨æˆ·ä»“å‚¨æ¥å£
â”‚   â”‚   â””â”€â”€ event/
â”‚   â”‚       â”œâ”€â”€ UserLoginEvent.java      # ç”¨æˆ·ç™»å½•äº‹ä»¶
â”‚   â”‚       â””â”€â”€ UserRegisteredEvent.java # ç”¨æˆ·æ³¨å†Œäº‹ä»¶
â”‚   â””â”€â”€ shared/                          # å…±äº«ç»„ä»¶
â”‚       â”œâ”€â”€ event/
â”‚       â”‚   â””â”€â”€ DomainEvent.java         # é¢†åŸŸäº‹ä»¶åŸºç±»
â”‚       â””â”€â”€ exception/
â”‚           â”œâ”€â”€ InvalidPasswordException.java # å¯†ç é”™è¯¯å¼‚å¸¸
â”‚           â””â”€â”€ UserNotFoundException.java  # ç”¨æˆ·ä¸å­˜åœ¨å¼‚å¸¸
â””â”€â”€ infrastructure/                      # åŸºç¡€è®¾æ–½å±‚
    â”œâ”€â”€ persistence/
    â”‚   â”œâ”€â”€ repository/
    â”‚   â”‚   â””â”€â”€ user/
    â”‚   â”‚       â””â”€â”€ UserRepositoryImpl.java # ç”¨æˆ·ä»“å‚¨å®ç°
    â”‚   â”œâ”€â”€ mapper/
    â”‚   â”‚   â””â”€â”€ user/
    â”‚   â”‚       â””â”€â”€ UserMapper.java       # ç”¨æˆ·Mapper
    â”‚   â””â”€â”€ entity/
    â”‚       â””â”€â”€ user/
    â”‚           â””â”€â”€ UserPO.java           # ç”¨æˆ·æ•°æ®åº“å®ä½“
    â”œâ”€â”€ cache/
    â”‚   â””â”€â”€ redis/
    â”‚       â””â”€â”€ UserCacheService.java     # ç”¨æˆ·ç¼“å­˜æœåŠ¡
    â””â”€â”€ external/
        â””â”€â”€ dify/
            â””â”€â”€ DifyService.java          # DifyæœåŠ¡é›†æˆ
```

### 7.2 ç™»å½•ä¸šåŠ¡æµç¨‹ä»£ç ç¤ºä¾‹

#### 7.2.1 æ¥å£å±‚ - Controller

```java
// AuthController.java
@RestController
@RequestMapping("/api/auth")
public class AuthController {

    @Autowired
    private AuthFacade authFacade;

    @PostMapping("/login")
    public Result<LoginResponse> login(@Valid @RequestBody UserLoginRequest request) {
        LoginResponse response = authFacade.login(request);
        return Result.success(response);
    }
}
```

#### 7.2.2 æ¥å£å±‚ - DTO

```java
// UserLoginRequest.java
public class UserLoginRequest {
    @NotBlank(message = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
    private String username;

    @NotBlank(message = "å¯†ç ä¸èƒ½ä¸ºç©º")
    private String password;

    private Boolean rememberMe = false;

    // getterã€setter
}

// LoginResponse.java
public class LoginResponse {
    private String token;
    private String refreshToken;
    private UserInfo userInfo;
    private Long expiresIn;

    // getterã€setter
}
```

#### 7.2.3 æ¥å£å±‚ - Assembler

```java
// AuthAssembler.java
@Component
public class AuthAssembler {

    public LoginCommand toCommand(UserLoginRequest request) {
        return new LoginCommand(
            new Username(request.getUsername()),
            new Password(request.getPassword()),
            request.getRememberMe()
        );
    }

    public LoginResponse toResponse(String token, String refreshToken,
                                  User user, Long expiresIn) {
        return LoginResponse.builder()
            .token(token)
            .refreshToken(refreshToken)
            .userInfo(UserInfo.builder()
                .id(user.getId().getValue())
                .username(user.getUsername().getValue())
                .email(user.getEmail().getValue())
                .build())
            .expiresIn(expiresIn)
            .build();
    }
}
```

#### 7.2.4 æ¥å£å±‚ - Facade

```java
// AuthFacade.java
@Service
public class AuthFacade {

    @Autowired
    private AuthApplicationService authApplicationService;

    @Autowired
    private AuthAssembler authAssembler;

    public LoginResponse login(UserLoginRequest request) {
        // 1. è½¬æ¢ä¸ºå‘½ä»¤å¯¹è±¡
        LoginCommand command = authAssembler.toCommand(request);

        // 2. æ‰§è¡Œç™»å½•ä¸šåŠ¡
        LoginResult result = authApplicationService.login(command);

        // 3. è½¬æ¢ä¸ºå“åº”å¯¹è±¡
        return authAssembler.toResponse(
            result.getToken(),
            result.getRefreshToken(),
            result.getUser(),
            result.getExpiresIn()
        );
    }
}
```

#### 7.2.5 åº”ç”¨å±‚ - ApplicationService

```java
// AuthApplicationService.java
@Service
@Transactional
public class AuthApplicationService {

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private AuthenticationService authenticationService;

    @Autowired
    private TokenService tokenService;

    @Autowired
    private DomainEventPublisher eventPublisher;

    public LoginResult login(LoginCommand command) {
        // 1. æŸ¥æ‰¾ç”¨æˆ·
        User user = userRepository.findByUsername(command.getUsername())
            .orElseThrow(() -> new UserNotFoundException(command.getUsername()));

        // 2. éªŒè¯å¯†ç 
        authenticationService.authenticate(user, command.getPassword());

        // 3. ç”ŸæˆToken
        String token = tokenService.generateToken(user);
        String refreshToken = tokenService.generateRefreshToken(user);
        Long expiresIn = command.getRememberMe() ? 7 * 24 * 3600L : 3600L;

        // 4. å‘å¸ƒç™»å½•äº‹ä»¶
        eventPublisher.publish(new UserLoginEvent(user));

        return new LoginResult(token, refreshToken, user, expiresIn);
    }
}
```

#### 7.2.6 åº”ç”¨å±‚ - Command

```java
// LoginCommand.java
public class LoginCommand {
    private final Username username;
    private final Password password;
    private final Boolean rememberMe;

    public LoginCommand(Username username, Password password, Boolean rememberMe) {
        this.username = username;
        this.password = password;
        this.rememberMe = rememberMe;
    }

    // getteræ–¹æ³•
}
```

#### 7.2.7 åº”ç”¨å±‚ - Event Handler

```java
// UserEventHandler.java
@Component
public class UserEventHandler {

    @Autowired
    private LogService logService;

    @Autowired
    private EmailService emailService;

    @EventHandler
    public void handleUserLogin(UserLoginEvent event) {
        // 1. è®°å½•ç™»å½•æ—¥å¿—
        logService.logUserLogin(event.getUser());

        // 2. æ›´æ–°æœ€åç™»å½•æ—¶é—´
        logService.updateLastLoginTime(event.getUser());

        // 3. å‘é€ç™»å½•é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
        if (event.getUser().isNotificationEnabled()) {
            emailService.sendLoginNotification(event.getUser());
        }
    }
}
```

#### 7.2.8 é¢†åŸŸå±‚ - Aggregate

```java
// User.javaï¼ˆç”¨æˆ·èšåˆæ ¹ï¼‰
@Entity
@Table(name = "sys_user")
public class User {

    @Id
    private UserId id;

    private Username username;
    private Email email;
    private Password password;
    private UserStatus status;

    private LocalDateTime lastLoginTime;
    private Boolean notificationEnabled = true;

    // æ„é€ å‡½æ•°
    private User() {} // JPAéœ€è¦

    public User(Username username, Email email, Password password) {
        this.id = new UserId();
        this.username = username;
        this.email = email;
        this.password = password;
        this.status = UserStatus.ACTIVE;
    }

    /**
     * ä¸šåŠ¡æ–¹æ³•ï¼šç”¨æˆ·ç™»å½•
     */
    public void login() {
        if (this.status != UserStatus.ACTIVE) {
            throw new UserStatusException("ç”¨æˆ·çŠ¶æ€å¼‚å¸¸ï¼Œæ— æ³•ç™»å½•");
        }

        this.lastLoginTime = LocalDateTime.now();

        // å‘å¸ƒç™»å½•äº‹ä»¶
        DomainEventPublisher.publish(new UserLoginEvent(this));
    }

    // getteræ–¹æ³•
}
```

#### 7.2.9 é¢†åŸŸå±‚ - ValueObject

```java
// Username.java
@Embeddable
public class Username {

    private String value;

    private Username() {} // JPAéœ€è¦

    public Username(String value) {
        if (value == null || value.trim().isEmpty()) {
            throw new InvalidUsernameException("ç”¨æˆ·åä¸èƒ½ä¸ºç©º");
        }
        if (value.length() < 3 || value.length() > 20) {
            throw new InvalidUsernameException("ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-20ä¸ªå­—ç¬¦ä¹‹é—´");
        }
        this.value = value;
    }

    public String getValue() {
        return value;
    }

    @Override
    public boolean equals(Object obj) {
        if (this == obj) return true;
        if (obj == null || getClass() != obj.getClass()) return false;
        Username username = (Username) obj;
        return Objects.equals(value, username.value);
    }

    @Override
    public int hashCode() {
        return Objects.hash(value);
    }
}
```

#### 7.2.10 é¢†åŸŸå±‚ - DomainService

```java
// AuthenticationService.java
@Service
public class AuthenticationService {

    @Autowired
    private PasswordEncoder passwordEncoder;

    public void authenticate(User user, Password password) {
        if (!passwordEncoder.matches(password.getValue(), user.getPassword().getValue())) {
            throw new InvalidPasswordException("å¯†ç é”™è¯¯");
        }

        if (user.getStatus() != UserStatus.ACTIVE) {
            throw new UserStatusException("ç”¨æˆ·çŠ¶æ€å¼‚å¸¸ï¼Œæ— æ³•ç™»å½•");
        }
    }
}
```

#### 7.2.11 é¢†åŸŸå±‚ - Repository æ¥å£

```java
// UserRepository.java
public interface UserRepository {

    Optional<User> findByUsername(Username username);

    Optional<User> findByEmail(Email email);

    User save(User user);

    void delete(User user);
}
```

#### 7.2.12 åŸºç¡€è®¾æ–½å±‚ - Repository å®ç°

```java
// UserRepositoryImpl.java
@Repository
public class UserRepositoryImpl implements UserRepository {

    @Autowired
    private UserMapper userMapper;

    @Autowired
    private UserAssembler userAssembler;

    @Override
    public Optional<User> findByUsername(Username username) {
        UserPO userPO = userMapper.findByUsername(username.getValue());
        if (userPO == null) {
            return Optional.empty();
        }
        return Optional.of(userAssembler.toDomain(userPO));
    }

    @Override
    public User save(User user) {
        UserPO userPO = userAssembler.toPO(user);
        if (userPO.getId() == null) {
            userMapper.insert(userPO);
        } else {
            userMapper.update(userPO);
        }
        return user;
    }
}
```

### 7.3 ç™»å½•ä¸šåŠ¡æµç¨‹æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant Controller as AuthController
    participant Facade as AuthFacade
    participant AppService as AuthApplicationService
    participant Domain as Userèšåˆæ ¹
    participant Repo as UserRepository
    participant EventHandler as UserEventHandler
    participant LogService as LogService

    Client->>Controller: POST /api/auth/login
    Controller->>Facade: login(request)
    Facade->>AppService: login(command)
    AppService->>Repo: findByUsername(username)
    Repo-->>AppService: User
    AppService->>Domain: authenticate(user, password)
    Domain->>Domain: login()
    Domain->>EventHandler: publish(UserLoginEvent)
    EventHandler->>LogService: logUserLogin(user)
    EventHandler->>LogService: updateLastLoginTime(user)
    AppService-->>Facade: LoginResult
    Facade-->>Controller: LoginResponse
    Controller-->>Client: Result<LoginResponse>
```

### 7.4 æ€»ç»“

è¿™ä¸ªå®Œæ•´çš„ç™»å½•ä¸šåŠ¡æµç¨‹ç¤ºä¾‹å±•ç¤ºäº† DDD æ¶æ„ä¸­å„ä¸ªå±‚æ¬¡çš„ä½œç”¨ï¼š

1. **Interfaces å±‚**ï¼šå¤„ç† HTTP è¯·æ±‚ï¼Œå‚æ•°æ ¡éªŒï¼Œæ•°æ®è½¬æ¢
2. **Application å±‚**ï¼šç¼–æ’ä¸šåŠ¡ç”¨ä¾‹ï¼Œäº‹åŠ¡ç®¡ç†ï¼Œäº‹ä»¶å‘å¸ƒ
3. **Domain å±‚**ï¼šæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œé¢†åŸŸæ¨¡å‹ï¼Œä¸šåŠ¡è§„åˆ™
4. **Infrastructure å±‚**ï¼šæŠ€æœ¯å®ç°ï¼Œæ•°æ®æŒä¹…åŒ–ï¼Œå¤–éƒ¨æœåŠ¡é›†æˆ

é€šè¿‡è¿™ä¸ªç¤ºä¾‹ï¼Œæ‚¨å¯ä»¥çœ‹åˆ° DDD æ¶æ„å¦‚ä½•å°†å¤æ‚çš„ä¸šåŠ¡é€»è¾‘åˆ†è§£åˆ°ä¸åŒçš„å±‚æ¬¡ä¸­ï¼Œæ¯ä¸ªå±‚æ¬¡éƒ½æœ‰æ˜ç¡®çš„èŒè´£ï¼Œæ—¢ä¿è¯äº†ä¸šåŠ¡é€»è¾‘çš„æ¸…æ™°æ€§ï¼Œåˆæä¾›äº†è‰¯å¥½çš„å¯æµ‹è¯•æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚
