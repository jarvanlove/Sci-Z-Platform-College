# 操作日志索引优化建议

## 当前索引分析

根据数据库表 `sys_operation_log` 的索引情况，当前已有以下索引：

1. **主键索引**：`sys_operation_log_pkey` (id) - 唯一索引
2. **用户 ID 索引**：`idx_sys_operation_log_user_id` (user_id)
3. **状态索引**：`idx_sys_operation_log_status` (status)
4. **创建时间索引**：`idx_sys_operation_log_created_time` (created_time)
5. **复合索引**：`idx_operation_log_level_time` (log_level, created_time)

## 索引优化建议

### 1. 优化现有索引

#### 1.1 复合索引优化

**当前索引**：`idx_operation_log_level_time` (log_level, created_time)

**优化建议**：

- ✅ **保持现有索引**：该索引已经覆盖了按日志级别和时间范围查询的场景
- 📝 **建议**：如果查询经常按 `(log_level, created_time DESC)` 排序，可以考虑添加降序索引

**SQL 示例**：

```sql
-- 如果需要降序查询优化，可以创建降序索引
CREATE INDEX IF NOT EXISTS idx_operation_log_level_time_desc
ON sys_operation_log(log_level, created_time DESC);
```

#### 1.2 用户名索引优化

**当前情况**：用户名查询使用 `LIKE` 模糊查询，没有专门索引

**优化建议**：

- ✅ **添加用户名索引**：如果用户名查询频繁，可以添加索引
- ⚠️ **注意**：`LIKE '%keyword%'` 无法使用索引，只有 `LIKE 'keyword%'` 可以使用索引

**SQL 示例**：

```sql
-- 如果用户名查询频繁，可以添加索引（但LIKE '%keyword%'无法使用）
CREATE INDEX IF NOT EXISTS idx_sys_operation_log_username
ON sys_operation_log(username);
```

### 2. 新增索引建议

#### 2.1 操作名称索引

**场景**：按操作名称查询（虽然当前查询参数已移除，但未来可能需要）

**SQL 示例**：

```sql
CREATE INDEX IF NOT EXISTS idx_sys_operation_log_operation
ON sys_operation_log(operation);
```

#### 2.2 请求方法索引

**场景**：按请求方法（GET/POST 等）查询

**SQL 示例**：

```sql
CREATE INDEX IF NOT EXISTS idx_sys_operation_log_method
ON sys_operation_log(method);
```

#### 2.3 复合查询索引（推荐）

**场景**：最常见的查询组合

- 按用户名 + 时间范围查询
- 按日志级别 + 时间范围查询
- 按状态 + 时间范围查询

**SQL 示例**：

```sql
-- 用户名 + 时间范围查询（最常用）
CREATE INDEX IF NOT EXISTS idx_sys_operation_log_username_time
ON sys_operation_log(username, created_time DESC);

-- 日志级别 + 时间范围查询（已存在：idx_operation_log_level_time）
-- 状态 + 时间范围查询
CREATE INDEX IF NOT EXISTS idx_sys_operation_log_status_time
ON sys_operation_log(status, created_time DESC);
```

### 3. 索引使用原则

1. **避免过度索引**：索引会占用存储空间，并影响写入性能
2. **优先覆盖常用查询**：根据实际查询场景添加索引
3. **复合索引顺序**：将选择性高的字段放在前面
4. **定期监控**：使用 `EXPLAIN` 分析查询计划，确认索引是否生效

### 4. 查询性能优化

#### 4.1 时间范围查询优化

**当前索引**：`idx_sys_operation_log_created_time`

**优化建议**：

- ✅ 时间范围查询已经可以使用该索引
- 📝 如果查询经常按时间倒序，可以考虑添加降序索引

#### 4.2 分页查询优化

**场景**：分页查询时，如果页码较大，性能会下降

**优化建议**：

- 使用 `LIMIT` + `OFFSET` 时，确保有合适的索引
- 考虑使用游标分页（基于 ID 或时间戳）

### 5. 批量写入优化

**当前实现**：已实现批量写入（每批 500 条）

**优化建议**：

1. **批量大小调整**：根据实际情况调整批量大小（500-1000 条）
2. **异步写入**：使用 Kafka 异步写入（已提供代码，注释状态）
3. **索引维护**：批量写入时，索引维护会有开销，可以考虑：
   - 在低峰期批量写入
   - 使用延迟索引（如果数据库支持）

### 6. 索引维护建议

1. **定期重建索引**：如果数据量很大，定期重建索引可以提升性能
2. **监控索引使用率**：使用数据库监控工具查看索引使用情况
3. **删除未使用的索引**：如果某个索引从未被使用，考虑删除

### 7. 推荐索引配置（最终方案）

基于当前查询场景，推荐以下索引配置：

```sql
-- 主键索引（已存在）
-- sys_operation_log_pkey (id)

-- 单列索引
CREATE INDEX IF NOT EXISTS idx_sys_operation_log_user_id ON sys_operation_log(user_id);
CREATE INDEX IF NOT EXISTS idx_sys_operation_log_status ON sys_operation_log(status);
CREATE INDEX IF NOT EXISTS idx_sys_operation_log_created_time ON sys_operation_log(created_time DESC);

-- 复合索引（覆盖常用查询场景）
CREATE INDEX IF NOT EXISTS idx_operation_log_level_time ON sys_operation_log(log_level, created_time DESC);
CREATE INDEX IF NOT EXISTS idx_sys_operation_log_username_time ON sys_operation_log(username, created_time DESC);
CREATE INDEX IF NOT EXISTS idx_sys_operation_log_status_time ON sys_operation_log(status, created_time DESC);
```

### 8. 索引创建 SQL（完整版）

```sql
-- ==================== 操作日志表索引优化 ====================

-- 1. 用户ID索引（已存在，保持）
-- CREATE INDEX IF NOT EXISTS idx_sys_operation_log_user_id ON sys_operation_log(user_id);

-- 2. 状态索引（已存在，保持）
-- CREATE INDEX IF NOT EXISTS idx_sys_operation_log_status ON sys_operation_log(status);

-- 3. 创建时间索引（已存在，优化为降序）
-- CREATE INDEX IF NOT EXISTS idx_sys_operation_log_created_time ON sys_operation_log(created_time DESC);

-- 4. 复合索引：日志级别 + 时间（已存在，保持）
-- CREATE INDEX IF NOT EXISTS idx_operation_log_level_time ON sys_operation_log(log_level, created_time DESC);

-- 5. 新增：用户名 + 时间范围查询（推荐）
CREATE INDEX IF NOT EXISTS idx_sys_operation_log_username_time
ON sys_operation_log(username, created_time DESC);

-- 6. 新增：状态 + 时间范围查询（推荐）
CREATE INDEX IF NOT EXISTS idx_sys_operation_log_status_time
ON sys_operation_log(status, created_time DESC);

-- 7. 可选：操作名称索引（如果未来需要按操作名称查询）
-- CREATE INDEX IF NOT EXISTS idx_sys_operation_log_operation ON sys_operation_log(operation);

-- 8. 可选：请求方法索引（如果未来需要按请求方法查询）
-- CREATE INDEX IF NOT EXISTS idx_sys_operation_log_method ON sys_operation_log(method);
```

## 总结

1. **保持现有索引**：当前索引配置基本合理
2. **新增推荐索引**：
   - `idx_sys_operation_log_username_time` - 用户名 + 时间范围查询
   - `idx_sys_operation_log_status_time` - 状态 + 时间范围查询
3. **批量写入优化**：已实现，每批 500 条
4. **Kafka 异步写入**：已提供代码（注释状态），需要时启用
