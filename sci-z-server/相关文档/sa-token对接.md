## Sa-Token 对接现状与后续计划（项目专用）

### 1. 登录与注册后的能力说明

- **注册**：`POST /api/auth/register` 仅写入 `sys_user` 基础信息（用户名、邮箱、手机号、院系等），默认状态为启用。不会自动绑定角色或权限。
- **默认角色**：注册完成后会自动尝试为用户绑定代码为 `ROLE_USER`、行业类型与注册院系一致的角色，并刷新权限缓存。若库中不存在该角色，会记录 warn 日志，需要运维提前在 `sys_role` 中配置好默认角色及其权限。
- **登录**：`POST /api/auth/login` 成功后返回完整用户聚合信息：
  - Token 及有效期；
  - `userInfo`（由 `AuthConverter` 转换）：id、用户名、真实姓名、邮箱、手机号、院系、头像等；
  - `roles` / `permissions` / `menus` 列表（通过 `PermissionService` 查询）。
- **默认权限**：注册后的新用户在未被赋权前，上述集合均为空。前端可以拿到完整结构，但无任何菜单和功能可访问。
- **赋权流程**：
  1. 使用后台管理接口或脚本在 `sys_user_role`、`sys_role_permission` 等表中为该用户绑定角色/权限。
  2. 操作后调用 `PermissionService.refreshUserAuthCache(userId, industryType)` 或提供对应的管理端刷新接口。
  3. 用户重新登录即可在响应中看到角色、权限码和对应菜单，前端即可渲染具体功能。

### 2. 已落地功能概览

| 模块           | 状态 | 说明                                                      |
| -------------- | ---- | --------------------------------------------------------- |
| 登录/注册      | ✅   | 接口可用，注册写入用户表，登录返回全量聚合信息            |
| 验证码校验     | ✅   | 登录/注册均支持图形验证码校验                             |
| 全局鉴权过滤器 | ✅   | `SecurityConfig.saServletFilter` 放行公开接口，其余需登录 |
| 登录日志与统计 | ✅   | 成功登录会写入 `sys_login_log` 并更新用户登录统计         |

### 3. 待对接清单

| 优先级 | 项目                           | 当前状态                                                    | 对接方案                                                              |
| ------ | ------------------------------ | ----------------------------------------------------------- | --------------------------------------------------------------------- |
| **高** | 角色/权限赋权链路              | 注册后无默认角色                                            | 落地用户/角色/权限绑定接口或后台管理界面，操作后刷新缓存              |
| **高** | `POST /api/auth/profile`       | 返回占位数据                                                | 调 `PermissionService` 返回真实资料（角色、权限码、菜单树、基础信息） |
| **高** | `POST /api/auth/refresh-token` | 仅回显当前 Token                                            | 使用 Sa-Token `renewTimeout` 或重新签发 Token，完善返回结构           |
| **中** | 便捷校验接口                   | 未实现 (`check/login`、`check/role`、`check/perm`)          | 补齐简单接口，前端可快速判断登录态/权限态                             |
| **中** | 会话治理接口                   | 未实现 (`session/current`、`kickout`、`disable`、`devices`) | 封装 `StpUtil` 能力，支持后台运维                                     |
| **中** | 重置密码 `reset-password`      | 占位                                                        | 完成验证码/旧密码校验、强密码策略及事件推送                           |
| **低** | 风控与限流                     | 部分缺失                                                    | 按业务需要补充分布式限流、黑名单、登录失败锁定等                      |
| **低** | 测试与验收                     | 未覆盖                                                      | 编写登录/鉴权相关单测、集成测试，覆盖成功/失败/越权场景               |

### 4. 登录响应示例

```json
{
  "token": "xxx",
  "tokenType": "Bearer",
  "expiresIn": 2592000,
  "rememberMe": false,
  "userInfo": {
    "id": 1,
    "username": "admin001",
    "realName": "张三",
    "email": "zhangsan@example.com",
    "phone": "13800138000",
    "department": "计算机科学与技术学院",
    "role": "ROLE_ADMIN",
    "status": "启用",
    "industry": "education",
    "avatar": null
  },
  "roles": ["ROLE_ADMIN"],
  "permissions": ["menu:dashboard:view"],
  "menus": [
    /* 菜单树 */
  ]
}
```

> 上述 `roles`、`permissions`、`menus` 取决于用户所绑定的角色与权限。无角色时返回空数组。

### 5. 默认权限与运维流程

1. 运维需在 `sys_role` 中为各行业配置好默认角色（角色编码固定为 `ROLE_USER`，状态启用、未删除），并在 `sys_role_permission` 中绑定默认菜单、按钮、接口等权限。
2. 新用户注册成功后，系统自动绑定默认角色，无需人工介入；若数据库缺少默认角色，需及时补齐。
3. 当用户需要调整权限时，由管理员（具备最高权限的账号）在系统管理模块中调整角色或直接绑定权限，操作完毕后调用 “刷新权限缓存” 接口或按钮（内部调用 `PermissionService.refreshUserAuthCache`），用户重新登录即可生效。

### 5. 后续实施建议

1. **完善权限管理链路**：实现角色/权限绑定、解除、查询接口，并支持行业维度的差异化配置。
2. **打通用户资料接口**：`profile` 返回真实聚合信息，供前端在登录后一次性缓存。
3. **补齐会话治理**：实现续期、踢人、封禁、查询在线设备等能力，满足运维管理需求。
4. **安全与审计**：继续完善密码策略、登录失败锁定、限流等安全基线措施。
5. **测试覆盖**：围绕登录、鉴权、会话管理补充单元测试和集成测试。

完成以上事项后，即可满足 Sa-Token 在本项目中的完整落地要求。
