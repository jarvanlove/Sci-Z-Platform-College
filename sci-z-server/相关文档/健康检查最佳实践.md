# å¥åº·æ£€æŸ¥æœ€ä½³å®è·µï¼ˆé K8s ç”Ÿäº§ç¯å¢ƒï¼‰

## ğŸ“‹ æ–¹æ¡ˆæ¦‚è¿°

é’ˆå¯¹é Kubernetes ç”Ÿäº§ç¯å¢ƒï¼Œé‡‡ç”¨ **Spring Boot Actuator + HealthIndicator** çš„æ ‡å‡†å¥åº·æ£€æŸ¥æ–¹æ¡ˆã€‚

## âœ… å·²å®æ–½çš„æ–¹æ¡ˆ

### 1. ä¿ç•™ `HealthCheckConfig.java`ï¼ˆå¿…éœ€ï¼‰

**ä½œç”¨**ï¼š

- åŸºäº Spring Boot Actuator æ ‡å‡†å®ç°
- æä¾› `/actuator/health` å¥åº·æ£€æŸ¥ç«¯ç‚¹
- æ”¯æŒå„ä¸­é—´ä»¶ï¼ˆæ•°æ®åº“ã€Redisã€Kafkaã€MinIOï¼‰çš„å¥åº·çŠ¶æ€æ£€æŸ¥

**è®¿é—®ç«¯ç‚¹**ï¼š

- `GET /actuator/health` - æ€»ä½“å¥åº·çŠ¶æ€
- `GET /actuator/health/{component}` - å•ä¸ªç»„ä»¶å¥åº·çŠ¶æ€
  - `/actuator/health/database` - æ•°æ®åº“å¥åº·çŠ¶æ€
  - `/actuator/health/redis` - Redis å¥åº·çŠ¶æ€
  - `/actuator/health/kafka` - Kafka å¥åº·çŠ¶æ€
  - `/actuator/health/minio` - MinIO å¥åº·çŠ¶æ€

### 2. ç§»é™¤ `StartupHealthCheckListener.java`ï¼ˆå·²åˆ é™¤ï¼‰

**åŸå› **ï¼š

- å¯åŠ¨æ—¶æ£€æŸ¥å¤±è´¥ä¹Ÿä¸é˜»æ­¢å¯åŠ¨ï¼Œæ„ä¹‰ä¸å¤§
- Actuator å·²æä¾›è¿è¡Œæ—¶å¥åº·æ£€æŸ¥ï¼ŒåŠŸèƒ½é‡å¤
- å‡å°‘å¯åŠ¨æ—¶é—´ï¼Œç®€åŒ–ä»£ç 

## ğŸ”§ ç”Ÿäº§ç¯å¢ƒé…ç½®

### application-prod.yml é…ç½®

```yaml
management:
  endpoints:
    web:
      exposure:
        include: health,info # ä»…æš´éœ²å¥åº·æ£€æŸ¥å’ŒåŸºæœ¬ä¿¡æ¯
      base-path: /actuator # ç»Ÿä¸€çš„åŸºç¡€è·¯å¾„
  endpoint:
    health:
      show-details: never # ç”Ÿäº§ç¯å¢ƒä¸æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ï¼ˆé¿å…æ³„éœ²æ•æ„Ÿä¿¡æ¯ï¼‰
      show-components: always # æ˜¾ç¤ºå„ç»„ä»¶çŠ¶æ€
  health:
    db:
      enabled: true
    redis:
      enabled: true
```

## ğŸš€ ä½¿ç”¨åœºæ™¯

### 1. è´Ÿè½½å‡è¡¡å™¨å¥åº·æ£€æŸ¥

#### Nginx é…ç½®ç¤ºä¾‹

```nginx
upstream backend {
    server 192.168.1.10:8080;
    server 192.168.1.11:8080;
}

server {
    listen 80;
    server_name api.example.com;

    location / {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;

        # å¥åº·æ£€æŸ¥
        health_check uri=/actuator/health interval=10s fails=3 passes=2;
    }
}
```

#### HAProxy é…ç½®ç¤ºä¾‹

```haproxy
backend api_backend
    balance roundrobin
    option httpchk GET /actuator/health
    http-check expect status 200
    server api1 192.168.1.10:8080 check
    server api2 192.168.1.11:8080 check
```

### 2. ç›‘æ§ç³»ç»Ÿé›†æˆ

#### Prometheus é…ç½®ç¤ºä¾‹

```yaml
# prometheus.yml
scrape_configs:
  - job_name: "sci-z-server"
    metrics_path: "/actuator/prometheus" # éœ€è¦æ·»åŠ  Prometheus ä¾èµ–
    static_configs:
      - targets: ["192.168.1.10:8080", "192.168.1.11:8080"]

  # å¥åº·æ£€æŸ¥ç›‘æ§
  - job_name: "sci-z-server-health"
    metrics_path: "/actuator/health"
    static_configs:
      - targets: ["192.168.1.10:8080", "192.168.1.11:8080"]
```

#### Zabbix é…ç½®ç¤ºä¾‹

```bash
# Zabbix ç›‘æ§é¡¹é…ç½®
# é”®å€¼ï¼šweb.page.get[api.example.com/actuator/health,8080]
# æœŸæœ›è¿”å›ï¼š{"status":"UP"}
```

### 3. è¿ç»´æ‰‹åŠ¨æ£€æŸ¥

```bash
# æ£€æŸ¥æ€»ä½“å¥åº·çŠ¶æ€
curl http://api.example.com/actuator/health

# æ£€æŸ¥æ•°æ®åº“å¥åº·çŠ¶æ€
curl http://api.example.com/actuator/health/database

# æ£€æŸ¥ Redis å¥åº·çŠ¶æ€
curl http://api.example.com/actuator/health/redis
```

## ğŸ“Š å¥åº·æ£€æŸ¥å“åº”æ ¼å¼

### æ€»ä½“å¥åº·çŠ¶æ€ï¼ˆshow-details: neverï¼‰

```json
{
  "status": "UP",
  "components": {
    "database": {
      "status": "UP"
    },
    "redis": {
      "status": "UP"
    },
    "kafka": {
      "status": "UP"
    },
    "minio": {
      "status": "UP"
    }
  }
}
```

### å•ä¸ªç»„ä»¶å¥åº·çŠ¶æ€

```json
{
  "status": "UP",
  "details": {
    "database": "PostgreSQL",
    "version": "15.2",
    "status": "Connected"
  }
}
```

## ğŸ”’ å®‰å…¨å»ºè®®

1. **ç«¯ç‚¹è®¿é—®æ§åˆ¶**ï¼š

   - ç”Ÿäº§ç¯å¢ƒä»…æš´éœ² `health` å’Œ `info` ç«¯ç‚¹
   - ä¸æš´éœ²æ•æ„Ÿç«¯ç‚¹ï¼ˆå¦‚ `/actuator/env`ã€`/actuator/configprops`ï¼‰

2. **è¯¦ç»†ä¿¡æ¯éšè—**ï¼š

   - `show-details: never` - ä¸æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ï¼Œé¿å…æ³„éœ²æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚æ•°æ®åº“ URLï¼‰

3. **ç½‘ç»œéš”ç¦»**ï¼š

   - å¥åº·æ£€æŸ¥ç«¯ç‚¹ä»…åœ¨å†…ç½‘æˆ–é€šè¿‡é˜²ç«å¢™è®¿é—®
   - è´Ÿè½½å‡è¡¡å™¨å’Œç›‘æ§ç³»ç»Ÿåº”é…ç½®ç™½åå•

4. **è®¤è¯ä¿æŠ¤**ï¼ˆå¯é€‰ï¼‰ï¼š
   - å¦‚éœ€æ›´ä¸¥æ ¼çš„å®‰å…¨æ§åˆ¶ï¼Œå¯é€šè¿‡ Spring Security å¯¹ `/actuator/**` è·¯å¾„è¿›è¡Œè®¤è¯

## ğŸ“ å¥åº·æ£€æŸ¥ç»„ä»¶è¯´æ˜

| ç»„ä»¶         | æ£€æŸ¥æ–¹å¼                    | è¶…æ—¶æ—¶é—´ | è¯´æ˜                          |
| ------------ | --------------------------- | -------- | ----------------------------- |
| **database** | `connection.isValid(5)`     | 5 ç§’     | æ£€æŸ¥æ•°æ®åº“è¿æ¥æœ‰æ•ˆæ€§          |
| **redis**    | `connection.ping()`         | é»˜è®¤     | æ£€æŸ¥ Redis è¿æ¥               |
| **kafka**    | `producer.partitionsFor()`  | 3 ç§’     | æ£€æŸ¥ Kafka è¿æ¥ï¼ˆä¸å‘é€æ¶ˆæ¯ï¼‰ |
| **minio**    | `minioClient.listBuckets()` | é»˜è®¤     | æ£€æŸ¥ MinIO è¿æ¥               |

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **Kafka å¥åº·æ£€æŸ¥ä¼˜åŒ–**ï¼š

   - å·²ä¼˜åŒ–ä¸ºä»…æ£€æŸ¥è¿æ¥ï¼Œä¸å®é™…å‘é€æ¶ˆæ¯
   - é¿å…åˆ›å»ºä¸´æ—¶ä¸»é¢˜å’Œäº§ç”Ÿä¸å¿…è¦çš„æ¶ˆæ¯

2. **Redis è¿æ¥ç®¡ç†**ï¼š

   - å¥åº·æ£€æŸ¥åæ­£ç¡®å…³é—­è¿æ¥ï¼Œé¿å…è¿æ¥æ³„æ¼

3. **è¶…æ—¶é…ç½®**ï¼š

   - å„ç»„ä»¶å¥åº·æ£€æŸ¥åº”è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
   - é¿å…å› å¥åº·æ£€æŸ¥è¶…æ—¶å½±å“æ•´ä½“å“åº”

4. **ç›‘æ§å‘Šè­¦**ï¼š
   - å»ºè®®é…ç½®ç›‘æ§å‘Šè­¦ï¼Œå½“å¥åº·æ£€æŸ¥å¤±è´¥æ—¶åŠæ—¶é€šçŸ¥è¿ç»´äººå‘˜

## ğŸ¯ æ€»ç»“

**æœ€ä½³æ–¹æ¡ˆ**ï¼š

- âœ… ä¿ç•™ `HealthCheckConfig`ï¼ˆåŸºäº Actuator æ ‡å‡†å®ç°ï¼‰
- âœ… ç§»é™¤ `StartupHealthCheckListener`ï¼ˆåŠŸèƒ½é‡å¤ï¼Œå·²åˆ é™¤ï¼‰
- âœ… é…ç½®ç”Ÿäº§ç¯å¢ƒ Actuator å®‰å…¨ç­–ç•¥
- âœ… é›†æˆè´Ÿè½½å‡è¡¡å™¨å’Œç›‘æ§ç³»ç»Ÿ

**ä¼˜åŠ¿**ï¼š

- æ ‡å‡†åŒ–ï¼šç¬¦åˆ Spring Boot æœ€ä½³å®è·µ
- çµæ´»æ€§ï¼šå¯è¢«å¤šç§ç³»ç»Ÿï¼ˆè´Ÿè½½å‡è¡¡å™¨ã€ç›‘æ§ç³»ç»Ÿï¼‰ä½¿ç”¨
- å®‰å…¨æ€§ï¼šç”Ÿäº§ç¯å¢ƒé…ç½®åˆç†ï¼Œä¸æ³„éœ²æ•æ„Ÿä¿¡æ¯
- å¯ç»´æŠ¤æ€§ï¼šä»£ç ç®€æ´ï¼Œæ˜“äºç»´æŠ¤
