# Repository æ‰¹é‡æ“ä½œæœ€ä½³å®è·µ

> **æ–‡æ¡£è¯´æ˜**ï¼šæœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ Repository å±‚æ‰¹é‡æ“ä½œçš„æœ€ä½³å®è·µã€æ€§èƒ½ä¼˜åŒ–å’Œå®é™…ä½¿ç”¨ç¤ºä¾‹ã€‚

---

## ç›®å½•

- [ä¸€ã€æ‰¹é‡æ“ä½œæ¦‚è§ˆ](#ä¸€æ‰¹é‡æ“ä½œæ¦‚è§ˆ)
- [äºŒã€æ‰¹é‡æ–°å¢ï¼ˆBatch Insertï¼‰](#äºŒæ‰¹é‡æ–°å¢batch-insert)
- [ä¸‰ã€æ‰¹é‡æ›´æ–°ï¼ˆBatch Updateï¼‰](#ä¸‰æ‰¹é‡æ›´æ–°batch-update)
- [å››ã€æ‰¹é‡åˆ é™¤ï¼ˆBatch Deleteï¼‰](#å››æ‰¹é‡åˆ é™¤batch-delete)
- [äº”ã€æ€§èƒ½ä¼˜åŒ–](#äº”æ€§èƒ½ä¼˜åŒ–)
- [å…­ã€å®Œæ•´ç¤ºä¾‹](#å…­å®Œæ•´ç¤ºä¾‹)
- [ä¸ƒã€å¸¸è§é—®é¢˜](#ä¸ƒå¸¸è§é—®é¢˜)

---

## ä¸€ã€æ‰¹é‡æ“ä½œæ¦‚è§ˆ

### 1.1 æ‰¹é‡æ“ä½œç±»å‹

| æ“ä½œç±»å‹                 | æ–¹æ³•å                           | SQL æ‰§è¡Œæ¬¡æ•° | æ€§èƒ½ | æ¨èåº¦      |
| ------------------------ | -------------------------------- | ------------ | ---- | ----------- |
| **æ‰¹é‡æ–°å¢**             | `saveBatch(List<T>)`             | å°‘           | é«˜   | â­â­â­â­â­  |
| **æ‰¹é‡æ›´æ–°ï¼ˆæŒ‡å®šå­—æ®µï¼‰** | `updateStatusByIds(ids, status)` | 1 æ¬¡         | æœ€é«˜ | â­â­â­â­â­  |
| **æ‰¹é‡æ›´æ–°ï¼ˆæ•´ä¸ªå®ä½“ï¼‰** | `updateBatchById(List<T>)`       | N æ¬¡         | ä½   | â­â­        |
| **æ‰¹é‡åˆ é™¤ï¼ˆè½¯åˆ é™¤ï¼‰**   | `deleteBatchByIds(List<Long>)`   | 1 æ¬¡         | é«˜   | â­â­â­â­â­  |
| **æ‰¹é‡åˆ é™¤ï¼ˆç‰©ç†åˆ é™¤ï¼‰** | `mapper.deleteBatchIds(ids)`     | 1 æ¬¡         | é«˜   | âš ï¸ è°¨æ…ä½¿ç”¨ |

---

### 1.2 ä½•æ—¶ä½¿ç”¨æ‰¹é‡æ“ä½œï¼Ÿ

**æ¨èä½¿ç”¨åœºæ™¯**ï¼š

- âœ… å¯¼å…¥æ•°æ®ï¼ˆExcelã€CSVï¼‰
- âœ… æ‰¹é‡å®¡æ‰¹/é©³å›
- âœ… æ‰¹é‡å¯ç”¨/ç¦ç”¨
- âœ… æ‰¹é‡åˆ é™¤
- âœ… æ•°æ®è¿ç§»
- âœ… æ‰¹é‡è®¾ç½®çŠ¶æ€

**ä¸æ¨èä½¿ç”¨åœºæ™¯**ï¼š

- âŒ æ•°æ®é‡ < 10 æ¡ï¼ˆå•ä¸ªæ“ä½œå³å¯ï¼‰
- âŒ éœ€è¦å¤æ‚çš„ä¸šåŠ¡é€»è¾‘åˆ¤æ–­
- âŒ éœ€è¦å®æ—¶åé¦ˆæ¯æ¡æ•°æ®çš„å¤„ç†ç»“æœ

---

## äºŒã€æ‰¹é‡æ–°å¢ï¼ˆBatch Insertï¼‰

### 2.1 ç®€å•æ‰¹é‡æ’å…¥

**Repository å®ç°**ï¼š

```java
/**
 * æ‰¹é‡ä¿å­˜å®ä½“
 *
 * @param entities List<Xxx> å®ä½“åˆ—è¡¨
 * @return boolean æ˜¯å¦å…¨éƒ¨ä¿å­˜æˆåŠŸ
 */
public boolean saveBatch(List<Xxx> entities) {
    if (CollectionUtils.isEmpty(entities)) {
        return true;
    }

    try {
        // ä½¿ç”¨ forEach + æ–¹æ³•å¼•ç”¨
        entities.forEach(mapper::insert);
        log.info(String.format("æ‰¹é‡ä¿å­˜æˆåŠŸ: size=%d", entities.size()));
        return true;
    } catch (Exception e) {
        log.error(String.format("æ‰¹é‡ä¿å­˜å¤±è´¥: size=%d, err=%s", entities.size(), e.getMessage()), e);
        return false;
    }
}
```

**Service å±‚è°ƒç”¨**ï¼š

```java
@Override
@Transactional(rollbackFor = Exception.class)
public boolean importUsers(List<UserCreateReq> requests) {
    // 1. è½¬æ¢ä¸ºå®ä½“
    var users = requests.stream()
            .map(userConverter::toEntity)
            .toList();

    // 2. æ‰¹é‡ä¿å­˜
    boolean success = userRepo.saveBatch(users);

    if (!success) {
        throw new BusinessException(ResultCode.DATABASE_OPERATION_FAILED);
    }

    log.info(String.format("å¯¼å…¥ç”¨æˆ·æˆåŠŸ: size=%d", users.size()));
    return true;
}
```

---

### 2.2 å¤§æ‰¹é‡æ’å…¥ï¼ˆåˆ†æ‰¹ï¼‰

**Repository å®ç°**ï¼š

```java
/**
 * æ‰¹é‡ä¿å­˜å®ä½“ï¼ˆåˆ†æ‰¹æ’å…¥ï¼‰
 * é€‚ç”¨äºå¤§æ‰¹é‡æ•°æ®ï¼ˆ> 1000æ¡ï¼‰
 *
 * @param entities List<Xxx> å®ä½“åˆ—è¡¨
 * @param batchSize int æ¯æ‰¹æ•°é‡ï¼ˆæ¨è 500ï¼‰
 * @return boolean æ˜¯å¦å…¨éƒ¨ä¿å­˜æˆåŠŸ
 */
public boolean saveBatch(List<Xxx> entities, int batchSize) {
    if (CollectionUtils.isEmpty(entities)) {
        return true;
    }

    var totalSize = entities.size();
    var savedCount = 0;

    for (int i = 0; i < totalSize; i += batchSize) {
        var endIndex = Math.min(i + batchSize, totalSize);
        var batch = entities.subList(i, endIndex);

        // æ‰¹é‡æ’å…¥å½“å‰æ‰¹æ¬¡
        batch.forEach(entity -> {
            int rows = mapper.insert(entity);
            if (rows > 0) {
                savedCount++;
            }
        });

        log.debug(String.format("æ‰¹é‡æ’å…¥è¿›åº¦: %d/%d", savedCount, totalSize));
    }

    log.info(String.format("æ‰¹é‡ä¿å­˜å®Œæˆ: total=%d, success=%d", totalSize, savedCount));
    return savedCount == totalSize;
}
```

**Service å±‚è°ƒç”¨**ï¼š

```java
@Override
@Transactional(rollbackFor = Exception.class)
public boolean importLargeDataset(List<DataCreateReq> requests) {
    var entities = requests.stream()
            .map(dataConverter::toEntity)
            .toList();

    // åˆ†æ‰¹æ’å…¥ï¼ˆæ¯æ‰¹ 500 æ¡ï¼‰
    return dataRepo.saveBatch(entities, 500);
}
```

---

## ä¸‰ã€æ‰¹é‡æ›´æ–°ï¼ˆBatch Updateï¼‰

### 3.1 æ‰¹é‡æ›´æ–°æŒ‡å®šå­—æ®µï¼ˆæ¨èï¼‰â­â­â­â­â­

**Repository å®ç°**ï¼š

```java
/**
 * æ‰¹é‡æ›´æ–°çŠ¶æ€
 * ä½¿ç”¨ LambdaUpdateChainWrapperï¼Œåªç”Ÿæˆ 1 æ¡ SQL
 *
 * @param ids List<Long> IDåˆ—è¡¨
 * @param status Integer æ–°çŠ¶æ€
 * @return boolean æ˜¯å¦æ›´æ–°æˆåŠŸ
 */
public boolean updateStatusByIds(List<Long> ids, Integer status) {
    if (CollectionUtils.isEmpty(ids)) {
        return true;
    }

    return new LambdaUpdateChainWrapper<>(mapper)
            .in(Xxx::getId, ids)
            .set(Xxx::getStatus, status)
            .update();
}

/**
 * æ‰¹é‡å®¡æ‰¹ï¼ˆæ›´æ–°çŠ¶æ€å’Œå®¡æ‰¹äººï¼‰
 *
 * @param ids List<Long> IDåˆ—è¡¨
 * @param status Integer å®¡æ‰¹çŠ¶æ€
 * @param approverUserId Long å®¡æ‰¹äººID
 * @return boolean æ˜¯å¦æ›´æ–°æˆåŠŸ
 */
public boolean approveByIds(List<Long> ids, Integer status, Long approverUserId) {
    if (CollectionUtils.isEmpty(ids)) {
        return true;
    }

    return new LambdaUpdateChainWrapper<>(mapper)
            .in(Xxx::getId, ids)
            .set(Xxx::getStatus, status)
            .set(Xxx::getApproverUserId, approverUserId)
            .set(Xxx::getApproveTime, LocalDateTime.now())
            .update();
}
```

**Service å±‚è°ƒç”¨**ï¼š

```java
@Override
@Transactional(rollbackFor = Exception.class)
public boolean batchApprove(List<Long> projectIds) {
    var currentUserId = StpUtil.getLoginIdAsLong();
    var approvedStatus = ProjectStatus.APPROVED.getCode();

    // æ‰¹é‡å®¡æ‰¹ï¼ˆä¸€æ¡ SQLï¼‰
    boolean success = projectRepo.approveByIds(projectIds, approvedStatus, currentUserId);

    if (!success) {
        throw new BusinessException(ResultCode.DATABASE_OPERATION_FAILED);
    }

    log.info(String.format("æ‰¹é‡å®¡æ‰¹æˆåŠŸ: size=%d, approver=%d", projectIds.size(), currentUserId));
    return true;
}
```

**ç”Ÿæˆçš„ SQL**ï¼š

```sql
UPDATE sys_project
SET status = 2,
    approver_user_id = 1,
    approve_time = '2025-11-07 10:30:00'
WHERE id IN (1, 2, 3, 4, 5, ..., 100)
```

**ä¼˜ç‚¹**ï¼š

- âœ… åªæ‰§è¡Œ 1 æ¡ SQL
- âœ… æ€§èƒ½æœ€é«˜
- âœ… äº‹åŠ¡å®‰å…¨

---

### 3.2 æ‰¹é‡æ›´æ–°æ•´ä¸ªå®ä½“ï¼ˆä¸æ¨èï¼‰

**Repository å®ç°**ï¼š

```java
/**
 * æ‰¹é‡æ›´æ–°å®ä½“ï¼ˆæ ¹æ®IDï¼‰
 * æ³¨æ„ï¼šä¼šç”Ÿæˆ N æ¡ SQLï¼Œæ€§èƒ½è¾ƒä½
 *
 * @param entities List<Xxx> å®ä½“åˆ—è¡¨
 * @return boolean æ˜¯å¦å…¨éƒ¨æ›´æ–°æˆåŠŸ
 */
public boolean updateBatchById(List<Xxx> entities) {
    if (CollectionUtils.isEmpty(entities)) {
        return true;
    }

    var successCount = entities.stream()
            .filter(entity -> mapper.updateById(entity) > 0)
            .count();

    return successCount == entities.size();
}
```

**ç”Ÿæˆçš„ SQL**ï¼ˆæ€§èƒ½ä½ï¼‰ï¼š

```sql
UPDATE sys_xxx SET name=?, status=?, ... WHERE id=1;
UPDATE sys_xxx SET name=?, status=?, ... WHERE id=2;
UPDATE sys_xxx SET name=?, status=?, ... WHERE id=3;
...
UPDATE sys_xxx SET name=?, status=?, ... WHERE id=100;
```

**ç¼ºç‚¹**ï¼š

- âŒ æ‰§è¡Œ N æ¡ SQL
- âŒ æ€§èƒ½ä½
- âŒ ç½‘ç»œå¼€é”€å¤§

**å»ºè®®**ï¼š

- âš ï¸ å¦‚æœåªéœ€è¦æ›´æ–°éƒ¨åˆ†å­—æ®µï¼Œä½¿ç”¨ `LambdaUpdateChainWrapper`
- âš ï¸ å¦‚æœçœŸçš„éœ€è¦æ›´æ–°æ•´ä¸ªå®ä½“ï¼Œè€ƒè™‘æ˜¯å¦å¯ä»¥åˆ†æ‰¹å¤„ç†

---

## å››ã€æ‰¹é‡åˆ é™¤ï¼ˆBatch Deleteï¼‰

### 4.1 æ‰¹é‡è½¯åˆ é™¤ï¼ˆæ¨èï¼‰

**Repository å®ç°**ï¼š

```java
/**
 * æ‰¹é‡è½¯åˆ é™¤
 * ä½¿ç”¨ LambdaUpdateChainWrapperï¼Œåªç”Ÿæˆ 1 æ¡ SQL
 *
 * @param ids List<Long> IDåˆ—è¡¨
 * @return boolean æ˜¯å¦åˆ é™¤æˆåŠŸ
 */
public boolean deleteBatchByIds(List<Long> ids) {
    if (CollectionUtils.isEmpty(ids)) {
        return true;
    }

    return new LambdaUpdateChainWrapper<>(mapper)
            .in(Xxx::getId, ids)
            .set(Xxx::getIsDeleted, DeleteStatus.DELETED.getCode())
            .set(Xxx::getDeleteTime, LocalDateTime.now())
            .update();
}
```

**Service å±‚è°ƒç”¨**ï¼š

```java
@Override
@Transactional(rollbackFor = Exception.class)
public boolean batchDelete(List<Long> userIds) {
    // æ‰¹é‡è½¯åˆ é™¤
    boolean success = userRepo.deleteBatchByIds(userIds);

    if (!success) {
        throw new BusinessException(ResultCode.DATABASE_OPERATION_FAILED);
    }

    log.info(String.format("æ‰¹é‡åˆ é™¤ç”¨æˆ·æˆåŠŸ: size=%d", userIds.size()));
    return true;
}
```

**ç”Ÿæˆçš„ SQL**ï¼š

```sql
UPDATE sys_user
SET is_deleted = 1,
    delete_time = '2025-11-07 10:30:00'
WHERE id IN (1, 2, 3, 4, 5, ..., 100)
```

---

### 4.2 æ‰¹é‡ç‰©ç†åˆ é™¤ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰

**Repository å®ç°**ï¼š

```java
/**
 * æ‰¹é‡ç‰©ç†åˆ é™¤
 * è°¨æ…ä½¿ç”¨ï¼Œæ•°æ®æ— æ³•æ¢å¤
 *
 * @param ids List<Long> IDåˆ—è¡¨
 * @return boolean æ˜¯å¦åˆ é™¤æˆåŠŸ
 */
public boolean hardDeleteBatchByIds(List<Long> ids) {
    if (CollectionUtils.isEmpty(ids)) {
        return true;
    }

    // ç‰©ç†åˆ é™¤ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
    int rows = mapper.deleteBatchIds(ids);
    log.warn(String.format("æ‰¹é‡ç‰©ç†åˆ é™¤: size=%d, deleted=%d", ids.size(), rows));
    return rows > 0;
}
```

**ç”Ÿæˆçš„ SQL**ï¼š

```sql
DELETE FROM sys_xxx WHERE id IN (1, 2, 3, 4, 5, ..., 100)
```

**æ³¨æ„**ï¼š

- âš ï¸ æ•°æ®æ— æ³•æ¢å¤
- âš ï¸ åªç”¨äºä¸´æ—¶æ•°æ®ã€æµ‹è¯•æ•°æ®
- âš ï¸ ç”Ÿäº§ç¯å¢ƒä¼˜å…ˆä½¿ç”¨è½¯åˆ é™¤

---

## äº”ã€æ€§èƒ½ä¼˜åŒ–

### 5.1 æ‰¹é‡æ“ä½œæ€§èƒ½å¯¹æ¯”

**æµ‹è¯•åœºæ™¯**ï¼šæ‰¹é‡æ’å…¥ 1000 æ¡ç”¨æˆ·æ•°æ®

| æ–¹å¼                           | SQL æ‰§è¡Œæ¬¡æ•° | è€—æ—¶    | æ€§èƒ½    |
| ------------------------------ | ------------ | ------- | ------- |
| å¾ªç¯å•ä¸ªæ’å…¥                   | 1000 æ¬¡      | ~5000ms | âŒ ä½   |
| `forEach(mapper::insert)`      | 1000 æ¬¡      | ~3000ms | âš ï¸ ä¸­   |
| `saveBatch(entities)` åˆ†æ‰¹ 500 | 2 æ¬¡         | ~800ms  | âœ… é«˜   |
| åŸç”Ÿæ‰¹é‡ SQL                   | 1 æ¬¡         | ~500ms  | âœ… æœ€é«˜ |

---

### 5.2 æ‰¹é‡æ›´æ–°æ€§èƒ½å¯¹æ¯”

**æµ‹è¯•åœºæ™¯**ï¼šæ‰¹é‡æ›´æ–° 100 ä¸ªé¡¹ç›®çš„çŠ¶æ€

| æ–¹å¼                                  | SQL æ‰§è¡Œæ¬¡æ•° | è€—æ—¶    | æ€§èƒ½    |
| ------------------------------------- | ------------ | ------- | ------- |
| `forEach(mapper::updateById)`         | 100 æ¬¡       | ~1000ms | âŒ ä½   |
| `LambdaUpdateChainWrapper.in().set()` | 1 æ¬¡         | ~50ms   | âœ… æœ€é«˜ |

**æ€§èƒ½æå‡**ï¼š**20 å€ï¼** ğŸš€

---

### 5.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®

**å»ºè®® 1ï¼šä¼˜å…ˆä½¿ç”¨ LambdaUpdateChainWrapper**

```java
// âœ… æ¨èï¼šä¸€æ¡ SQLï¼ˆæ€§èƒ½æœ€é«˜ï¼‰
return new LambdaUpdateChainWrapper<>(mapper)
        .in(Xxx::getId, ids)
        .set(Xxx::getStatus, status)
        .update();

// âŒ ä¸æ¨èï¼šN æ¡ SQLï¼ˆæ€§èƒ½ä½ï¼‰
entities.forEach(entity -> mapper.updateById(entity));
```

**å»ºè®® 2ï¼šåˆ†æ‰¹å¤„ç†å¤§æ•°æ®é‡**

```java
// âœ… æ¨èï¼šåˆ†æ‰¹å¤„ç†
var batchSize = 500;
for (int i = 0; i < totalSize; i += batchSize) {
    var batch = entities.subList(i, Math.min(i + batchSize, totalSize));
    batch.forEach(mapper::insert);
}

// âŒ ä¸æ¨èï¼šä¸€æ¬¡æ€§æ’å…¥ 10000 æ¡
entities.forEach(mapper::insert);  // å¯èƒ½å¯¼è‡´å†…å­˜æº¢å‡º
```

**å»ºè®® 3ï¼šä½¿ç”¨äº‹åŠ¡æ§åˆ¶**

```java
// âœ… æ¨èï¼šåœ¨ Service å±‚åŠ äº‹åŠ¡
@Transactional(rollbackFor = Exception.class)
public boolean batchCreate(List<XxxCreateReq> requests) {
    // æ‰¹é‡æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»š
    return xxxRepo.saveBatch(entities);
}
```

---

## å…­ã€å®Œæ•´ç¤ºä¾‹

### 6.1 æ‰¹é‡å¯¼å…¥ç”¨æˆ·

**åœºæ™¯**ï¼šä» Excel å¯¼å…¥ 5000 ä¸ªç”¨æˆ·

**Repository å±‚**ï¼š

```java
/**
 * æ‰¹é‡ä¿å­˜ç”¨æˆ·ï¼ˆåˆ†æ‰¹æ’å…¥ï¼‰
 *
 * @param users List<SysUser> ç”¨æˆ·åˆ—è¡¨
 * @return boolean æ˜¯å¦å…¨éƒ¨ä¿å­˜æˆåŠŸ
 */
public boolean saveBatch(List<SysUser> users) {
    if (CollectionUtils.isEmpty(users)) {
        return true;
    }

    var batchSize = 500;
    var totalSize = users.size();
    var savedCount = 0;

    for (int i = 0; i < totalSize; i += batchSize) {
        var endIndex = Math.min(i + batchSize, totalSize);
        var batch = users.subList(i, endIndex);

        // æ‰¹é‡æ’å…¥å½“å‰æ‰¹æ¬¡
        batch.forEach(user -> {
            int rows = mapper.insert(user);
            if (rows > 0) {
                savedCount++;
            }
        });

        log.debug(String.format("æ‰¹é‡æ’å…¥è¿›åº¦: %d/%d", savedCount, totalSize));
    }

    log.info(String.format("æ‰¹é‡ä¿å­˜ç”¨æˆ·å®Œæˆ: total=%d, success=%d", totalSize, savedCount));
    return savedCount == totalSize;
}
```

**Service å±‚**ï¼š

```java
@Override
@Transactional(rollbackFor = Exception.class)
public boolean importUsers(MultipartFile file) {
    // 1. è§£æ Excel
    var requests = ExcelUtil.parseExcel(file, UserCreateReq.class);

    // 2. æ•°æ®æ ¡éªŒ
    validateUsers(requests);

    // 3. è½¬æ¢ä¸ºå®ä½“
    var users = requests.stream()
            .map(req -> {
                var user = userConverter.toEntity(req);
                user.setStatus(EnableStatus.ENABLED.getCode());
                user.setIsDeleted(DeleteStatus.NOT_DELETED.getCode());
                return user;
            })
            .toList();

    // 4. æ‰¹é‡ä¿å­˜ï¼ˆåˆ†æ‰¹ 500 æ¡ï¼‰
    boolean success = userRepo.saveBatch(users);

    if (!success) {
        throw new BusinessException(ResultCode.DATABASE_OPERATION_FAILED, "å¯¼å…¥ç”¨æˆ·å¤±è´¥");
    }

    log.info(String.format("å¯¼å…¥ç”¨æˆ·æˆåŠŸ: size=%d", users.size()));
    return true;
}
```

---

### 6.2 æ‰¹é‡å®¡æ‰¹é¡¹ç›®

**åœºæ™¯**ï¼šç®¡ç†å‘˜æ‰¹é‡å®¡æ‰¹ 100 ä¸ªé¡¹ç›®

**Repository å±‚**ï¼š

```java
/**
 * æ‰¹é‡å®¡æ‰¹é¡¹ç›®
 *
 * @param ids List<Long> é¡¹ç›®IDåˆ—è¡¨
 * @param approverUserId Long å®¡æ‰¹äººID
 * @return boolean æ˜¯å¦å®¡æ‰¹æˆåŠŸ
 */
public boolean batchApprove(List<Long> ids, Long approverUserId) {
    if (CollectionUtils.isEmpty(ids)) {
        return true;
    }

    return new LambdaUpdateChainWrapper<>(mapper)
            .in(Project::getId, ids)
            .set(Project::getStatus, ProjectStatus.APPROVED.getCode())
            .set(Project::getApproverUserId, approverUserId)
            .set(Project::getApproveTime, LocalDateTime.now())
            .update();
}
```

**Service å±‚**ï¼š

```java
@Override
@Transactional(rollbackFor = Exception.class)
public boolean batchApprove(List<Long> projectIds) {
    // 1. æ£€æŸ¥é¡¹ç›®æ˜¯å¦éƒ½å­˜åœ¨ä¸”å¯å®¡æ‰¹
    validateProjects(projectIds);

    // 2. è·å–å½“å‰ç”¨æˆ·ID
    var currentUserId = StpUtil.getLoginIdAsLong();

    // 3. æ‰¹é‡å®¡æ‰¹ï¼ˆä¸€æ¡ SQLï¼‰
    boolean success = projectRepo.batchApprove(projectIds, currentUserId);

    if (!success) {
        throw new BusinessException(ResultCode.DATABASE_OPERATION_FAILED);
    }

    // 4. å‘å¸ƒå®¡æ‰¹äº‹ä»¶ï¼ˆå¯é€‰ï¼‰
    projectIds.forEach(id -> {
        var event = new ProjectApprovedEvent(id, currentUserId);
        eventPublisher.publish(event);
    });

    log.info(String.format("æ‰¹é‡å®¡æ‰¹é¡¹ç›®æˆåŠŸ: size=%d, approver=%d", projectIds.size(), currentUserId));
    return true;
}
```

---

### 6.3 æ‰¹é‡ç¦ç”¨ç”¨æˆ·

**åœºæ™¯**ï¼šç®¡ç†å‘˜æ‰¹é‡ç¦ç”¨ 50 ä¸ªç”¨æˆ·

**Repository å±‚**ï¼š

```java
/**
 * æ‰¹é‡ç¦ç”¨ç”¨æˆ·
 *
 * @param userIds List<Long> ç”¨æˆ·IDåˆ—è¡¨
 * @return boolean æ˜¯å¦ç¦ç”¨æˆåŠŸ
 */
public boolean batchDisable(List<Long> userIds) {
    if (CollectionUtils.isEmpty(userIds)) {
        return true;
    }

    return new LambdaUpdateChainWrapper<>(mapper)
            .in(SysUser::getId, userIds)
            .set(SysUser::getStatus, EnableStatus.DISABLED.getCode())
            .update();
}

/**
 * æ‰¹é‡å¯ç”¨ç”¨æˆ·
 *
 * @param userIds List<Long> ç”¨æˆ·IDåˆ—è¡¨
 * @return boolean æ˜¯å¦å¯ç”¨æˆåŠŸ
 */
public boolean batchEnable(List<Long> userIds) {
    if (CollectionUtils.isEmpty(userIds)) {
        return true;
    }

    return new LambdaUpdateChainWrapper<>(mapper)
            .in(SysUser::getId, userIds)
            .set(SysUser::getStatus, EnableStatus.ENABLED.getCode())
            .update();
}
```

**Service å±‚**ï¼š

```java
@Override
@Transactional(rollbackFor = Exception.class)
public boolean batchDisable(List<Long> userIds) {
    // 1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    validateUsers(userIds);

    // 2. æ‰¹é‡ç¦ç”¨
    boolean success = userRepo.batchDisable(userIds);

    if (!success) {
        throw new BusinessException(ResultCode.DATABASE_OPERATION_FAILED);
    }

    // 3. æ¸…ç†è¢«ç¦ç”¨ç”¨æˆ·çš„ç¼“å­˜å’Œ token
    userIds.forEach(this::clearUserCache);

    log.info(String.format("æ‰¹é‡ç¦ç”¨ç”¨æˆ·æˆåŠŸ: size=%d", userIds.size()));
    return true;
}
```

---

## ä¸ƒã€å¸¸è§é—®é¢˜

### Q1ï¼šæ‰¹é‡æ“ä½œå¤±è´¥å¦‚ä½•å›æ»šï¼Ÿ

**A1ï¼šåœ¨ Service å±‚ä½¿ç”¨ @Transactional**

```java
@Transactional(rollbackFor = Exception.class)
public boolean batchCreate(List<XxxCreateReq> requests) {
    // æ‰¹é‡ä¿å­˜
    boolean success = xxxRepo.saveBatch(entities);

    if (!success) {
        throw new BusinessException(ResultCode.DATABASE_OPERATION_FAILED);
        // æŠ›å‡ºå¼‚å¸¸åï¼Œäº‹åŠ¡ä¼šè‡ªåŠ¨å›æ»š
    }

    return true;
}
```

---

### Q2ï¼šå¦‚ä½•å¤„ç†æ‰¹é‡æ“ä½œä¸­çš„éƒ¨åˆ†å¤±è´¥ï¼Ÿ

**A2ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©ç­–ç•¥**

**ç­–ç•¥ 1ï¼šå…¨éƒ¨æˆåŠŸæˆ–å…¨éƒ¨å¤±è´¥ï¼ˆæ¨èï¼‰**

```java
@Transactional(rollbackFor = Exception.class)
public boolean batchCreate(List<XxxCreateReq> requests) {
    // ä»»æ„ä¸€ä¸ªå¤±è´¥ï¼Œå…¨éƒ¨å›æ»š
    entities.forEach(entity -> {
        Long id = xxxRepo.save(entity);
        if (id == null) {
            throw new BusinessException(ResultCode.DATABASE_OPERATION_FAILED);
        }
    });
    return true;
}
```

**ç­–ç•¥ 2ï¼šè®°å½•å¤±è´¥é¡¹ï¼Œç»§ç»­å¤„ç†**

```java
public BatchResult batchCreate(List<XxxCreateReq> requests) {
    var successIds = new ArrayList<Long>();
    var failedReqs = new ArrayList<XxxCreateReq>();

    // ä¸ä½¿ç”¨äº‹åŠ¡ï¼Œå…è®¸éƒ¨åˆ†æˆåŠŸ
    for (var req : requests) {
        try {
            var entity = xxxConverter.toEntity(req);
            Long id = xxxRepo.save(entity);
            if (id != null) {
                successIds.add(id);
            } else {
                failedReqs.add(req);
            }
        } catch (Exception e) {
            log.error(String.format("ä¿å­˜å¤±è´¥: name=%s", req.getName()), e);
            failedReqs.add(req);
        }
    }

    return new BatchResult(successIds, failedReqs);
}
```

---

### Q3ï¼šæ‰¹é‡æ“ä½œå¦‚ä½•æç¤ºè¿›åº¦ï¼Ÿ

**A3ï¼šä½¿ç”¨æ—¥å¿—æˆ–è¿”å›è¿›åº¦ä¿¡æ¯**

**æ–¹å¼ 1ï¼šä½¿ç”¨æ—¥å¿—**

```java
public boolean saveBatch(List<Xxx> entities) {
    var totalSize = entities.size();
    var savedCount = 0;

    for (int i = 0; i < totalSize; i += 500) {
        var batch = entities.subList(i, Math.min(i + 500, totalSize));
        batch.forEach(mapper::insert);
        savedCount += batch.size();

        // è¾“å‡ºè¿›åº¦
        log.info(String.format("æ‰¹é‡æ’å…¥è¿›åº¦: %d/%d (%.2f%%)",
                savedCount, totalSize, (savedCount * 100.0 / totalSize)));
    }

    return true;
}
```

**æ–¹å¼ 2ï¼šè¿”å›è¿›åº¦ä¿¡æ¯**

```java
public record BatchProgress(int total, int success, int failed, double percentage) {}

public BatchProgress saveBatchWithProgress(List<Xxx> entities) {
    var totalSize = entities.size();
    var successCount = 0;
    var failedCount = 0;

    for (var entity : entities) {
        try {
            int rows = mapper.insert(entity);
            if (rows > 0) {
                successCount++;
            } else {
                failedCount++;
            }
        } catch (Exception e) {
            failedCount++;
        }
    }

    var percentage = (successCount * 100.0) / totalSize;
    return new BatchProgress(totalSize, successCount, failedCount, percentage);
}
```

---

### Q4ï¼šæ‰¹é‡æ“ä½œå¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ

**A4ï¼šä½¿ç”¨äº‹åŠ¡ + æ ¡éªŒ**

```java
@Transactional(rollbackFor = Exception.class)
public boolean batchApprove(List<Long> projectIds) {
    // 1. æ ¡éªŒæ‰€æœ‰é¡¹ç›®æ˜¯å¦å­˜åœ¨ä¸”å¯å®¡æ‰¹
    for (var projectId : projectIds) {
        var project = projectRepo.findById(projectId);
        if (project == null) {
            throw new BusinessException(ResultCode.PROJECT_NOT_FOUND);
        }
        if (!ProjectStatus.PENDING.getCode().equals(project.getStatus())) {
            throw new BusinessException(ResultCode.PROJECT_STATUS_INVALID,
                    "é¡¹ç›®çŠ¶æ€ä¸æ˜¯å¾…å®¡æ‰¹: " + projectId);
        }
    }

    // 2. æ‰¹é‡å®¡æ‰¹ï¼ˆæ ¡éªŒé€šè¿‡åæ‰æ‰§è¡Œï¼‰
    return projectRepo.batchApprove(projectIds, currentUserId);
}
```

---

## å…«ã€æ€»ç»“

### æ‰¹é‡æ“ä½œé€‰æ‹©æŒ‡å—

**æ‰¹é‡æ–°å¢**ï¼š

- âœ… å°æ‰¹é‡ï¼ˆ< 1000ï¼‰ï¼š`forEach(mapper::insert)`
- âœ… å¤§æ‰¹é‡ï¼ˆ> 1000ï¼‰ï¼šåˆ†æ‰¹æ’å…¥ï¼Œæ¯æ‰¹ 500 æ¡

**æ‰¹é‡æ›´æ–°**ï¼š

- âœ… æ›´æ–°æŒ‡å®šå­—æ®µï¼š`LambdaUpdateChainWrapper.in().set()` â­â­â­â­â­
- âš ï¸ æ›´æ–°æ•´ä¸ªå®ä½“ï¼š`forEach(mapper::updateById)`ï¼ˆæ…ç”¨ï¼‰

**æ‰¹é‡åˆ é™¤**ï¼š

- âœ… è½¯åˆ é™¤ï¼š`LambdaUpdateChainWrapper.in().set(isDeleted, 1)` â­â­â­â­â­
- âš ï¸ ç‰©ç†åˆ é™¤ï¼š`mapper.deleteBatchIds(ids)`ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰

### æ ¸å¿ƒåŸåˆ™

1. âœ… **ä¼˜å…ˆä½¿ç”¨ LambdaUpdateChainWrapper**ï¼ˆæ€§èƒ½æœ€é«˜ï¼‰
2. âœ… **æ‰¹é‡æ“ä½œåŠ äº‹åŠ¡**ï¼ˆä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼‰
3. âœ… **å¤§æ•°æ®é‡åˆ†æ‰¹å¤„ç†**ï¼ˆé¿å…å†…å­˜æº¢å‡ºï¼‰
4. âœ… **å®Œå–„çš„æ—¥å¿—å’Œå¼‚å¸¸å¤„ç†**ï¼ˆæ–¹ä¾¿æ’æŸ¥é—®é¢˜ï¼‰
5. âœ… **ä½¿ç”¨ Java 21 ç‰¹æ€§**ï¼ˆvarã€Stream APIï¼‰

---

**ç°åœ¨æ‚¨å¯ä»¥é«˜æ•ˆåœ°å®ç°æ‰¹é‡æ“ä½œäº†ï¼** ğŸš€
