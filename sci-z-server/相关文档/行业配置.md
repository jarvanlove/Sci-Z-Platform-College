## 行业配置一体化方案（前后端协同）

本方案目标：不改动通用权限/用户/系统管理代码的前提下，实现“跨行业可切换”，并让前端表单/标签随行业动态变化。

### 一、核心理念

- **单一真相源**：行业元数据落在 `sys_industry_config` 与 `sys_config` 中；其中 `sys_industry_config` 保存各行业的标签与启用状态，`sys_config` 提供前端快速渲染所需的当前行业与标签键值。
- **低耦合**：通用域（用户、角色、权限）只感知 `industry_type`，不关心具体行业含义；前端通过接口读取行业标签渲染即可。
- **可切换**：后台切换“当前行业”（或通过页面保存为 `sys_config.current_industry_type`），前端在刷新配置后即可按新行业标签展示。

### 二、后端配置读取（推荐）

后端提供一个轻量配置查询接口，聚合当前行业与标签，供前端一次性获取。

```java
// 核心 DTO（示例）
public record IndustryUiConfig(
    String currentIndustryType,
    String currentIndustryName,
    String departmentLabel,
    String roleLabel,
    String employeeIdLabel
) {}

// Service 伪代码（从 sys_config 与 sys_industry_config 聚合）
@Service
public class IndustryConfigService {
    public IndustryUiConfig fetch() {
        String type = configRepo.getString("current_industry_type", "education");
        String name = configRepo.getString("current_industry_name", "教育行业");

        // 优先从 sys_industry_config 取标签，兜底用 sys_config 提供的 label.*
        var meta = industryRepo.findByType(type);
        String deptLabel = meta != null ? meta.getDepartmentLabel() : configRepo.getString("label.department", "院系");
        String roleLabel = meta != null ? meta.getRoleLabel() : configRepo.getString("label.role", "角色");
        String empLabel  = meta != null ? meta.getEmployeeIdLabel() : configRepo.getString("label.employee_id", "学工号");

        return new IndustryUiConfig(type, name, deptLabel, roleLabel, empLabel);
    }
}
```

> 说明：真实项目请替换为你现有的 Repository/Mapper 调用。该接口可放置在 `SystemController` 或独立 `ConfigController` 下，路由如 `/api/system/industry/config`。

### 三、前端核心用法（伪代码）

```ts
// 获取并缓存行业 UI 配置
async function loadIndustryUiConfig() {
  const cfg = await http.get<IndustryUiConfig>('/api/system/industry/config');
  uiStore.set(cfg); // {currentIndustryType, departmentLabel, ...}
}

// 表单渲染
<FormItem label={uiStore.departmentLabel}>
  <Select /* 院系/科室/部门 */ />
</FormItem>
<FormItem label={uiStore.roleLabel}>
  <Select /* 角色/职务/岗位 */ />
</FormItem>
<FormItem label={uiStore.employeeIdLabel}>
  <Input />
</FormItem>
```

### 四、行业切换流程

1. 前端“系统配置-行业配置”页提交 `current_industry_type` 和展示名称；
2. 后端更新 `sys_config` 中 `current_industry_type/current_industry_name`；
3. 前端重新拉取 `/api/system/industry/config`，整个权限/用户/系统管理页面标签随之改变。

### 五、与种子数据的配合

- `db/seed/init_data.sql` 已为 education/medical/power 三行业写入基础元数据与示例部门；
- `sys_config` 里提供 `label.department/label.role/label.employee_id` 三个标签键，作为兜底文案；
- 默认启用 `education` 行业，如需切换，改 `sys_industry_config.is_active` 或通过页面保存到 `sys_config.current_industry_type`。

#### 5.1 与最新种子脚本的对齐说明

- 我们不再在种子里使用过程块或复杂 SQL 做“自动同步”。行业切换通过后端接口保存 `current_industry_type/current_industry_name` 并同时写入三条 `label.*` 键即可，直观可审计。
- 前端渲染只依赖上述 5 个键（`current_industry_type/current_industry_name/label.*`），或调用聚合接口一次性获取。
- 三行业已补充更贴近真实的“顶级部门清单”，全部为幂等 `INSERT ... WHERE NOT EXISTS`，便于开箱即用，也便于后续按单位实际扩充。

#### 5.2 顶级部门示例清单（与 init_data.sql 一致）

- 教育（`industry_type=education`）示例部门/机构：

  - 计算机科学学院(`CS`)、人工智能学院(`AI`)、软件工程学院(`SE`)、信息工程学院(`IE`)
  - 数学学院(`MATH`)、物理学院(`PHYS`)、人文社科学院(`HSS`)
  - 教务处(`ACADEMIC`)、科研处(`RESEARCH`)、财务处(`FINANCE`)

- 医疗（`industry_type=medical`）示例科室/部门：

  - 内科(`INTERNAL`)、外科(`SURGERY`)、儿科(`PEDIATRICS`)、妇产科(`OBSTETRICS`)
  - 急诊医学科(`EMERGENCY`)、放射科(`RADIOLOGY`)、检验科(`LAB`)、麻醉科(`ANESTHESIA`)
  - 药学部(`PHARMACY`)、护理部(`NURSING`)

- 电力（`industry_type=power`）示例部门：
  - 发电部(`GENERATION`)、输电部(`TRANSMISSION`)、配电部(`DISTRIBUTION`)、调度控制中心(`DISPATCH`)
  - 运维中心(`OMC`)、安全监督部(`SAFETY`)、设备管理部(`EQUIPMENT`)、生产计划部(`PLANNING`)
  - 采购供应部(`PROCUREMENT`)、综合管理部(`ADMIN`)

### 六、扩展建议

- 若需行业特有的字段或校验，放到“行业扩展”域（如 `sys_user_profile` 承载动态字段），以避免污染通用模型；
- 权限侧若需行业差异，使用 `sys_permission.industry_type` 进行隔离，通用权限保持一致时即可复用；
- 为前端提供“行业列表”接口，便于下拉选择与切换。

---

### 七、设计理念总结与页面行为

- **核心理念**：用一个“当前行业开关”驱动全局标签与数据筛选。`sys_config` 决定“当前行业”，`sys_industry_config` 存各行业的默认标签与字典；业务表用 `industry_type` 做隔离，不做数据迁移。
- **页面切换行业会改什么**：在“系统配置 → 行业配置”保存时，仅更新配置层的数据：
  - 覆盖 `sys_config.current_industry_type/current_industry_name`；
  - 同时写入（或覆盖）三条兜底标签 `label.department/label.role/label.employee_id`（可从 `sys_industry_config` 同步）；
  - 不会改动历史业务数据，也不会迁移任何行。
- **是否需要初始化数据**：建议保留“最小可用种子”，用于开箱即用与演示：
  - `sys_industry_config` 三行业元数据与默认标签；
  - `sys_department` 各行业若干顶级部门/科室/机构（已在种子补充，幂等）；
  - 可选：`init_permission_data.sql` 提供一套通用角色/权限骨架，便于权限树渲染。
- **数据如何随行业生效**：
  - 前端渲染直接使用 5 个键（`current_industry_type/current_industry_name/label.*`），或调用聚合接口一次获取；
  - 后端查询/写入按 `industry_type` 做条件与赋值，实现同库多行业隔离；
  - 切换行业仅改变“视角与标签”，不影响既有数据。

---

### 八、关于 `sys_user_profile` 的使用时机与示例

`sys_user_profile` 是“用户扩展属性表”，用于在不改动用户主表结构的情况下，为不同单位/行业按需增加可配置字段（键值对）。典型场景：

- **教育行业**：
  - 新增字段：`student_id`(学号)、`advisor`(导师姓名)、`grade`(年级)、`major`(专业)
  - 适用：研究生院/教务系统对接时，学校之间字段差异较大，不宜改主表。
- **医疗行业**：
  - 新增字段：`practitioner_license`(执业证号)、`title`(职称)、`department_grade`(医师等级)
  - 适用：医院等级不同，资质字段差异大。
- **电力行业**：
  - 新增字段：`post_series`(岗位序列)、`work_area`(工区)、`safety_cert_level`(安规证等级)
  - 适用：央国企/地方公司口径不一。

#### 8.1 后端写入（幂等）示例

```sql
-- 为用户 123 设置（或更新）“执业证号”
INSERT INTO sys_user_profile (user_id, attribute_name, attribute_value, attribute_type, is_required, sort_order)
VALUES (123, 'practitioner_license', 'A1234567', 'text', 1, 10)
ON CONFLICT (user_id, attribute_name) DO UPDATE
SET attribute_value = EXCLUDED.attribute_value, updated_time = CURRENT_TIMESTAMP;
```

#### 8.2 前端渲染思路（伪代码）

```ts
// 读取配置：决定哪些扩展字段需要显示（可来源于后端配置或元数据表）
const fields = [
  {
    name: "practitioner_license",
    label: "执业证号",
    type: "text",
    required: true,
  },
  {
    name: "title",
    label: "职称",
    type: "select",
    options: ["住院医师", "主治医师", "副主任医师", "主任医师"],
  },
];

// 读取用户扩展属性并回填表单
const profiles = await api.get(`/api/user/${userId}/profiles`); // [{attributeName, attributeValue}, ...]
fillForm(fields, profiles);
```

#### 8.3 何时优先使用 `sys_user_profile`？

- 当字段只在部分行业/单位使用，且会随时间演进（增/改），就应放在 `sys_user_profile`；
- 当字段是所有行业都通用且稳定（例如手机号、邮箱），应放在 `sys_user` 主表；
- 这样可以避免频繁改表，保持通用模型稳定，同时满足行业差异化需求。
