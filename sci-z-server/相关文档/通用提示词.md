# 通用提示词（Sci-Z Server：DDD 生产级开发模板）

本模板用于指导本项目后续所有模块的快速、规范落地。约束：严格 DDD 分层；仅使用 req/resp 命名（无 VO 概念）；统一异常、统一返回、统一日志；事件驱动；可复用组件优先。

一、基本原则

1. 语言与版本：Java 21
2. 分层依赖：Interfaces → Application → Domain ← Infrastructure；Shared 可被各层使用
3. 命名统一：入参 req，出参 resp；Converter 只做对象转换
4. 日志统一：String.format("%s") 样式；引入 MDC traceId
5. 异常统一：BusinessException + GlobalExceptionHandler + Result/ResultCode
6. 配置分环境：application.yml（通用） + application-dev.yml / application-prod.yml（环境）

回复规范（必须遵守）

- 回复语言：始终使用中文，并在开头展示当前回复使用的模型信息
- 执行前置：先复述你对需求的理解，待确认后再编码
- 执行计划：先列出精简执行计划，再按计划依次完成
- 解决方案：明确变更点范围（涉及代码/配置/脚本需同步），避免只改单点导致不可启动
- 自检与总结：每次回复末尾给出简要总结与关键检查项（是否遗漏文件/是否影响启动）

注释模板（必须遵守）

- 类名注释模板（置于类声明上方）：

```java
/**
 * @author JiaWen.Wu
 * @className 当前类名
 * @date 中国北京当前时间(yyyy-MM-dd HH:mm)
 */
```

- 方法名注释模板（置于方法声明上方）：

```java
/**
 * 方法是做什么的
 *
 * @param 参数类型 参数描述
 * @return 返回结果
 */
```

- 实体类字段注释模板（置于字段上方）：

```java
/**
 * 字段注释
 */
```

二、分层与目录（约束）

- interfaces（对外接口）
  - controller：只做入参校验、鉴权注解（如有）、调用应用服务、返回 Result<resp>
  - converter：MapStruct 转换（componentModel = "spring"），不得写业务逻辑
- application（应用层）
  - service：用例编排（接口与 impl），事务边界、聚合跨越、发布事件，不包含持久化或 Web 细节
- domain（领域层）
  - pojo/entity：与表一致，继承 BaseEntity（is_deleted、created_by、updated_by、created_time、updated_time）
  - pojo/dto/request|response：统一放置 req/resp 模型
  - pojo/mapper：仅 BaseMapper<T>；不包含业务逻辑
  - pojo/repository：仓储接口与 impl（impl 组合 mapper 实现查询/持久化），不做业务编排
- infrastructure（基础设施层）
  - config：数据库、缓存、MQ、存储、Web、Swagger/OpenAPI 等配置
  - shared：统一返回、异常、事件、工具、常量、枚举等通用能力
  - external：外部系统对接（Dify、MinIO、Kafka、Redis 等）

三、文件清单矩阵（任何模块均适用）

- interfaces/controller/XxxController.java
- interfaces/converter/XxxConverter.java
- application/service/XxxService.java
- application/service/impl/XxxServiceImpl.java
- domain/pojo/dto/request/XxxCreateReq.java、XxxUpdateReq.java、XxxQueryReq.java（可含分页）
- domain/pojo/dto/response/XxxResp.java、XxxDetailResp.java、XxxPageResp.java
- domain/pojo/entity/Xxx.java（继承 BaseEntity）
- domain/pojo/mapper/XxxMapper.java（BaseMapper<Xxx>）
- domain/pojo/repository/XxxRepo.java
- domain/pojo/repository/impl/XxxRepoImpl.java
- infrastructure/shared/event/（按需）XxxCreatedEvent.java / XxxUpdatedEvent.java / XxxDeletedEvent.java
- infrastructure/shared/handler/（按需）XxxEventHandler.java

四、命名与方法（统一）

- Controller：createXxx / updateXxx / deleteXxx / getXxxDetail / listXxx / pageXxx
- Service：create / update / deleteById / findDetail / list / page
- Repo：save / update / deleteById / findById / findByCondition / pageByCondition
- Converter：toEntity(req) / toResp(entity) / toRespList(list) / updateEntity(@MappingTarget, req)
- DTO：全部使用 req/resp；字段加校验注解；分页含 pageNo/pageSize/sortBy/sortOrder

五、开发流程（可复制）

1. 定义实体（与表一致，继承 BaseEntity）
2. 创建 Mapper（BaseMapper）与 Repository（接口 + impl，组合 mapper）
3. 定义 req/resp 模型（请求/响应）
4. 创建 MapStruct Converter（只做转换）
5. 声明并实现 Application Service（事务、编排、发布事件）
6. 编写 Controller（入参校验 → 调用 Service → 返回 Result<resp>）
7. 按需发布与处理事件（见第七部分）
8. 完善 Swagger 注释（类 @Tag，方法 @Operation）
9. 校验统一日志/异常/返回；lints 清零

六、统一规范（必须遵守）

- 返回值：Result<T>（成功/失败），错误使用 Result.fail(code, message)
- 异常：仅抛 BusinessException(ResultCode.X)
- 日志：统一使用 String.format("%s") 占位；关键路径 + 异常打点；使用 MDC traceId
- 事务：应用层写操作 @Transactional(rollbackFor = Exception.class)
- 映射：对象转换统一使用 MapStruct，不在 Controller/Service 手写映射
- 查询：分页/条件查询由 Repository 实现；Controller 不拼接 SQL 条件

七、事件与异步（通用）

- 事件基类：DomainEvent（含 getAggregateId()/getAggregateType() 等）
- 发布：EventPublisher.publish()/publishAsync()
- 线程池：事件专用（AsyncEventConfig）+ 全局异步（AsyncGlobalConfig）
- 常用事件：
  - 操作日志：OperationLoggedEvent → handler 调用应用服务入库至 sys_operation_log
  - 登录日志：LoginLoggedEvent → handler 调用应用服务入库至 sys_login_log
  - 业务事件：XxxCreated/Updated/DeletedEvent（按需）
- Handler 职责（必须）：事件发布后必须创建对应 Handler 完成“落地动作”
  - 位置：`infrastructure/shared/handler/{模块}/XxxEventHandler.java`
  - 注解：类上 `@Component`；方法上 `@EventListener` + `@Async`
  - 规范：仅做入库/联动（调用 Application Service），不做业务编排
  - 日志：统一 `String.format("%s")`；入口/完成/异常均需打点，包含事件关键字段
  - 异常：方法内 try-catch 兜底并记录错误，避免影响主线程
  - 参考：`infrastructure/shared/handler/user/UserEventHandler.java`

八、Repository/Mapper 规范

- Mapper：仅 CRUD 映射；复杂查询避免放 Mapper XML 的业务拼接，建议在 RepoImpl 组合多表
- Repo 接口：对外语义，屏蔽持久化细节，返回实体/集合/分页结果
- Repo 实现：只做数据访问，不发布事件，不记录与业务相关日志

九、Swagger/OpenAPI（通用）

- 统一在 SwaggerConfig 中配置分组（按模块）、扫描包、排序；
- Controller：类上 @Tag(name="模块 - Xxx")；方法上 @Operation(summary="动作 - 说明")；

十、配置与脚本（通用）

- application.yml：通用配置（端口、日志模式、springdoc、jackson、management、mybatis-plus、logging 等）
- application-dev.yml / application-prod.yml：按环境覆盖（数据源、redis、kafka、minio、dify、llm 等）
- 生产敏感项：使用环境变量占位 `${VAR:default}`
- SQL：`init_all_tables.sql`（建表、含 BaseEntity 字段、注释与索引、幂等）；`init_data.sql`（初始数据，幂等）

十一、通用组件清单（已封装，优先复用）

- 返回与异常：Result、ResultCode、BusinessException、GlobalExceptionHandler
- 事件：DomainEvent、EventPublisher、AsyncEventConfig、AsyncGlobalConfig
- 日志与追踪：TraceIdUtil（MDC）、统一 logging.pattern（含 traceId）
- 数据与存储：DatabaseConfig（HikariCP）、MyBatisPlusConfig（分页拦截器）
- 缓存与消息：RedisConfig、RedisUtil；KafkaConfig、KafkaUtil
- 对象存储：MinioConfig、MinioUtil
- AI/LangChain4j 与 Dify：LangChain4jConfig、DifyConfig（如使用）
- 其他工具：Date/Json/File 等工具类（如在 shared/utils 下）

十二、通用落地模板（按模块复用）

说明：以下为“任何模块”可直接套用的文件清单与命名规则模板。将“Xxx”替换为模块名（如 User/Role/Permission/Department/Industry/Project/Report/Knowledge/File/AI/Declaration）。

12.1 目录矩阵（应创建的文件）

- interfaces/controller
  - `XxxController.java`：对外接口，仅入参校验 + 鉴权注解（如有） + 调用应用服务 + 返回 Result<resp>
- interfaces/converter
  - `XxxConverter.java`：MapStruct 转换器（componentModel=spring）
- application/service
  - `XxxService.java`：应用服务接口（用例方法，入参/出参加 req/resp）
  - `impl/XxxServiceImpl.java`：应用服务实现（事务、编排、发布事件）
- domain/pojo/dto/request
  - `XxxCreateReq.java`、`XxxUpdateReq.java`、`XxxQueryReq.java`（含分页/筛选）
- domain/pojo/dto/response
  - `XxxResp.java`、`XxxDetailResp.java`、`XxxPageResp.java`
- domain/pojo/entity
  - `Xxx.java`：与表字段一一对应，继承 `BaseEntity`
- domain/pojo/mapper
  - `XxxMapper.java`：`BaseMapper<Xxx>`
- domain/pojo/repository
  - `XxxRepo.java`：仓储接口（按领域语义命名方法）
  - `impl/XxxRepoImpl.java`：组合 Mapper 实现查询/持久化，不包含业务编排
- infrastructure/shared/event/[模块可选]
  - `XxxCreatedEvent.java`、`XxxUpdatedEvent.java`、`XxxDeletedEvent.java`（必要时）
- infrastructure/shared/handler/[模块可选]

  - `XxxEventHandler.java`（监听事件，调用应用服务入库或联动，必须与发布的事件一一对应）

（事件落地步骤 - 必须执行）

1. 在应用/切面发布事件后，新增 `infrastructure/shared/handler/{模块}/XxxEventHandler.java`
2. 在 Handler 中为每类事件新增方法：`@EventListener @Async public void handleXxx(XxxEvent e)`
3. 方法内：参数校验 → 组装实体/DTO → 调用 Application Service 入库/联动 → 记录完成日志
4. 所有日志使用 `String.format("%s")`，异常采用 try-catch 兜底并记录错误

   12.2 命名与方法模板

- Controller 方法：`createXxx`、`updateXxx`、`deleteXxx`、`getXxxDetail`、`listXxx`、`pageXxx`
- Service 方法：`create`、`update`、`deleteById`、`findDetail`、`list`、`page`
- Repo 方法：`save`、`update`、`deleteById`、`findById`、`findByCondition`、`pageByCondition`
- Converter 方法：`toEntity(req)`、`toResp(entity)`、`toRespList(list)`、`updateEntity(@MappingTarget entity, req)`

  12.3 鉴权与权限码模板

- Controller 注解（如需）：
  - `@SaCheckLogin`：通用登录态校验
  - `@SaCheckPermission("api:module:xxx:action")`：按《权限码.md》规范命名
- 权限码命名：

  - 列表：`api:module:xxx:list`
  - 新增：`api:module:xxx:create`
  - 修改：`api:module:xxx:update`
  - 删除：`api:module:xxx:delete`
  - 详情：`api:module:xxx:detail`

    12.4 事件与日志模板

- 常用事件：`XxxCreatedEvent/XxxUpdatedEvent/XxxDeletedEvent`；重要操作发布 `OperationLoggedEvent`
- 登录/安全相关：`LoginLoggedEvent`
- 日志规范：统一 `String.format("%s")`，Handler 内仅做入库与必要转换

  12.5 事务与幂等模板

- 应用服务方法：`@Transactional(rollbackFor = Exception.class)`
- 写操作幂等：`@Idempotent(prefix = "module:xxx", strategy = REJECT|RETURN_CACHED)`（如已接入）
- 重试：`@Retry(maxAttempts=3, delay=200)`（必要外部依赖调用）

  12.6 req/resp 字段与校验模板

- Request：使用 `@NotBlank/@NotNull/@Size/@Pattern` 等；分页查询含 `pageNo/pageSize/sortBy/sortOrder`
- Response：最小暴露原则；时间统一为 ISO 字符串或 long，根据前端约定

  12.7 Repository 实现要点

- 仅组合 Mapper；必要时引入自定义 SQL（XML/注解）
- 统一返回实体/集合/分页结果对象；禁止在 Repo 内写业务编排或发布事件

  12.8 Swagger 注释模板

- 类：`@Tag(name = "模块 - Xxx", description = "Xxx 管理")`
- 方法：`@Operation(summary = "动作 - 说明", description = "更多业务背景")`

  12.9 常见校验清单（每个模块都适用）

- req/resp 与 Converter 是否齐全；
- Controller 是否只做入参校验与调用应用服务；
- Service 是否承载事务/编排/事件发布；
- Repo 是否只做持久化与查询；
- 权限码与注解是否覆盖所有接口（如启用权限体系）；
- 日志是否符合格式；异常是否统一；
- 必要事件是否发布并能被 Handler 正确入库；

十三、一次性新模块落地指令（可复制）

1. 创建目录与文件骨架（将 Xxx 替换为模块名）：

- interfaces/controller/`XxxController.java`
- interfaces/converter/`XxxConverter.java`
- application/service/`XxxService.java`
- application/service/impl/`XxxServiceImpl.java`
- domain/pojo/dto/request/`XxxCreateReq.java`、`XxxUpdateReq.java`、`XxxQueryReq.java`
- domain/pojo/dto/response/`XxxResp.java`、`XxxDetailResp.java`、`XxxPageResp.java`
- domain/pojo/entity/`Xxx.java`
- domain/pojo/mapper/`XxxMapper.java`
- domain/pojo/repository/`XxxRepo.java`
- domain/pojo/repository/impl/`XxxRepoImpl.java`

2. 实现顺序：实体 → 仓储 → req/resp → Converter → Service 接口 → Service 实现 → Controller → 事件与 Handler → Swagger 注释。

3. 统一核对：权限注解/事件发布/日志异常/分页与查询/配置项与分组。
