<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>æ–°å»ºé¡¹ç›® - é«˜æ ¡ç§‘ç ”é¡¹ç›®ç®¡ç†å¹³å°</title>
    <link rel="icon" href="../images/favicon.ico" type="image/x-icon" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/element-plus@2.3.14/dist/index.css"
    />
    <script src="https://unpkg.com/vue@3.2.47/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/element-plus@2.3.14"></script>
    <!-- Element Plus ä¸­æ–‡æœ¬åœ°åŒ–ï¼ˆä¿®å¤ locale undefined æŠ¥é”™ï¼‰ -->
    <script src="https://unpkg.com/element-plus@2.3.14/dist/locale/zh-cn.js"></script>
    <script>
      // ç¡®ä¿ Element Plus ä¸­æ–‡æœ¬åœ°åŒ–æ­£ç¡®åŠ è½½
      window.ElementPlusLocaleZhCn = window.ElementPlusLocaleZhCn || {
        name: "zh-cn",
        el: {
          datepicker: {
            now: "æ­¤åˆ»",
            today: "ä»Šå¤©",
            cancel: "å–æ¶ˆ",
            clear: "æ¸…ç©º",
            confirm: "ç¡®è®¤",
            selectDate: "é€‰æ‹©æ—¥æœŸ",
            selectTime: "é€‰æ‹©æ—¶é—´",
            startDate: "å¼€å§‹æ—¥æœŸ",
            startTime: "å¼€å§‹æ—¶é—´",
            endDate: "ç»“æŸæ—¥æœŸ",
            endTime: "ç»“æŸæ—¶é—´",
            prevYear: "å‰ä¸€å¹´",
            nextYear: "åä¸€å¹´",
            prevMonth: "ä¸Šä¸ªæœˆ",
            nextMonth: "ä¸‹ä¸ªæœˆ",
            year: "å¹´",
            month1: "1æœˆ",
            month2: "2æœˆ",
            month3: "3æœˆ",
            month4: "4æœˆ",
            month5: "5æœˆ",
            month6: "6æœˆ",
            month7: "7æœˆ",
            month8: "8æœˆ",
            month9: "9æœˆ",
            month10: "10æœˆ",
            month11: "11æœˆ",
            month12: "12æœˆ",
            weeks: {
              sun: "æ—¥",
              mon: "ä¸€",
              tue: "äºŒ",
              wed: "ä¸‰",
              thu: "å››",
              fri: "äº”",
              sat: "å…­",
            },
            months: {
              jan: "ä¸€æœˆ",
              feb: "äºŒæœˆ",
              mar: "ä¸‰æœˆ",
              apr: "å››æœˆ",
              may: "äº”æœˆ",
              jun: "å…­æœˆ",
              jul: "ä¸ƒæœˆ",
              aug: "å…«æœˆ",
              sep: "ä¹æœˆ",
              oct: "åæœˆ",
              nov: "åä¸€æœˆ",
              dec: "åäºŒæœˆ",
            },
          },
        },
      };
    </script>
    <script src="https://unpkg.com/dayjs@1.11.10/locale/zh-cn.js"></script>
    <link rel="stylesheet" href="../é€šç”¨è§„èŒƒ/æ ·å¼.css" />
    <style>
      .new-project-container {
        padding: 20px;
        background: #f7f9fc;
        min-height: calc(100vh - 56px);
      }

      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .page-title {
        font-size: 24px;
        font-weight: 600;
        color: #1e3a8a;
        margin: 0;
      }

      .form-card {
        background: #ffffff;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        border: 1px solid #e5e7eb;
      }

      .form-section-title {
        font-size: 18px;
        font-weight: 600;
        color: #1e3a8a;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 2px solid #e5e7eb;
      }

      .form-row {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
      }

      .form-row .el-form-item {
        flex: 1;
        margin-bottom: 0;
      }

      .member-item {
        display: flex;
        align-items: center;
        padding: 12px;
        background: #f8fafc;
        border-radius: 6px;
        margin-bottom: 8px;
      }

      .member-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        margin-right: 12px;
      }

      .member-info {
        flex: 1;
      }

      .member-name {
        font-weight: 500;
        color: #374151;
        margin-bottom: 4px;
      }

      .member-id {
        font-size: 12px;
        color: #6b7280;
      }

      .member-role {
        margin-right: 12px;
      }

      .milestone-item {
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 16px;
        margin-bottom: 12px;
        background: #fafafa;
      }

      .milestone-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }

      .milestone-title {
        font-weight: 500;
        color: #374151;
      }

      .milestone-content {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr;
        gap: 12px;
      }

      .button-group {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 24px;
        padding-top: 20px;
        border-top: 1px solid #e5e7eb;
      }

      .search-results {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        background: #ffffff;
        margin-top: 8px;
      }

      .search-result-item {
        padding: 12px;
        cursor: pointer;
        border-bottom: 1px solid #f3f4f6;
      }

      .search-result-item:hover {
        background: #f8fafc;
      }

      .search-result-item:last-child {
        border-bottom: none;
      }

      .empty-state {
        text-align: center;
        padding: 20px;
        color: #6b7280;
      }

      .empty-state-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
      }

      .empty-state-text {
        font-size: 16px;
        margin-bottom: 8px;
      }

      .empty-state-hint {
        font-size: 14px;
        color: #9ca3af;
      }
      /* æ–‡æ¡£ç®¡ç†æ ·å¼ï¼ˆä¸é¡¹ç›®è¯¦æƒ…ä¸€è‡´ï¼‰ */
      .document-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .document-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: #f8fafc;
        border-radius: 6px;
      }
      .document-icon {
        width: 32px;
        height: 32px;
        border-radius: 4px;
        background: #dbeafe;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #1e40af;
      }
      .document-info {
        flex: 1;
      }
      .document-name {
        font-size: 14px;
        font-weight: 500;
        color: #374151;
        margin-bottom: 2px;
      }
      .document-meta {
        font-size: 12px;
        color: #6b7280;
      }
      .document-actions {
        display: flex;
        gap: 8px;
      }
      .upload-section {
        margin-top: 12px;
      }
      .upload-area {
        border: 2px dashed #d1d5db;
        border-radius: 6px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
      }
      .upload-area.dragover {
        background: #f0f9ff;
        border-color: #1e3a8a;
      }
      .upload-icon {
        font-size: 24px;
        color: #9ca3af;
        margin-bottom: 8px;
      }
      .upload-text {
        font-size: 14px;
        color: #6b7280;
        margin-bottom: 4px;
      }
      .upload-hint {
        font-size: 12px;
        color: #9ca3af;
      }

      /* å¼¹çª—å†…è¡¨å•å¯è¯»æ€§ï¼ˆä¿®å¤æ–‡å­—çœ‹ä¸æ¸…çš„é—®é¢˜ï¼‰ + ä¸é¡µé¢ç»Ÿä¸€é£æ ¼ */
      .el-dialog {
        font-family: inherit;
        color: #1f2937;
        border-radius: 12px !important;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12) !important;
      }
      .el-dialog .el-dialog__title {
        font-weight: 600;
        color: #1e3a8a;
        font-size: 18px;
      }
      .el-dialog .el-form-item__label {
        color: #374151;
        font-weight: 500;
        font-size: 14px;
      }
      .el-dialog .el-input__inner,
      .el-dialog input,
      .el-dialog .el-textarea__inner,
      .el-dialog .el-select .el-input__inner {
        color: #1f2937;
        font-size: 14px;
      }
      .el-dialog .el-input__inner::placeholder,
      .el-dialog input::placeholder,
      .el-dialog .el-textarea__inner::placeholder,
      .el-dialog .el-select .el-input__inner::placeholder {
        color: #9ca3af;
        font-size: 14px;
      }
      .el-dialog .el-option {
        color: #1f2937;
        font-size: 14px;
      }
      .el-dialog .el-option:hover {
        background-color: #f8fafc;
        color: #1f2937;
      }

      /* è‡ªå®šä¹‰å¼¹çª—æ ·å¼ */
      .el-message-box {
        border-radius: 12px !important;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12) !important;
      }

      .el-message-box__header {
        padding: 20px 24px 16px 24px !important;
        border-bottom: 1px solid #f0f0f0 !important;
        background: #ffffff !important;
      }

      .el-message-box__title {
        font-size: 16px !important;
        font-weight: 600 !important;
        color: #1f2937 !important;
        line-height: 1.5 !important;
      }

      .el-message-box__headerbtn {
        top: 16px !important;
        right: 20px !important;
        width: 24px !important;
        height: 24px !important;
      }

      .el-message-box__close {
        color: #9ca3af !important;
        font-size: 16px !important;
      }

      .el-message-box__close:hover {
        color: #6b7280 !important;
      }

      .el-message-box__content {
        padding: 20px 24px !important;
        background: #ffffff !important;
      }

      .el-message-box__message {
        font-size: 14px !important;
        line-height: 1.6 !important;
        color: #374151 !important;
        margin: 0 !important;
        padding: 0 !important;
      }

      .el-message-box__btns {
        padding: 16px 24px 20px 24px !important;
        background: #ffffff !important;
        display: flex !important;
        justify-content: flex-end !important;
        gap: 12px !important;
      }

      .el-message-box__btns .el-button {
        padding: 8px 20px !important;
        border-radius: 8px !important;
        font-size: 14px !important;
        font-weight: 500 !important;
        border: 1px solid !important;
        transition: all 0.2s ease !important;
      }

      .el-message-box__btns .el-button--default {
        background: #ffffff !important;
        border-color: #d1d5db !important;
        color: #6b7280 !important;
      }

      .el-message-box__btns .el-button--default:hover {
        background: #f9fafb !important;
        border-color: #9ca3af !important;
        color: #374151 !important;
      }

      .el-message-box__btns .el-button--primary {
        background: #1e3a8a !important;
        border-color: #1e3a8a !important;
        color: #ffffff !important;
      }

      .el-message-box__btns .el-button--primary:hover {
        background: #1e40af !important;
        border-color: #1e40af !important;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
      }

      .el-message-box__btns .el-button--primary:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(30, 58, 138, 0.3);
      }

      /* è­¦å‘Šç±»å‹å¼¹çª—çš„ç‰¹æ®Šæ ·å¼ */
      .el-message-box--warning .el-message-box__content {
        position: relative;
      }

      .el-message-box--warning .el-message-box__message::before {
        content: "âš ï¸";
        font-size: 18px !important;
        margin-right: 8px !important;
        vertical-align: -0.15em !important;
        display: inline-block !important;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="new-project-container">
        <!-- é¡µé¢æ ‡é¢˜å’Œè¿”å› -->
        <div class="page-header">
          <div style="display: flex; align-items: center; gap: 16px">
            <el-button @click="handleCancel">
              <el-icon><ArrowLeft /></el-icon>
              è¿”å›é¡¹ç›®åˆ—è¡¨
            </el-button>
            <h1 class="page-title">æ–°å»ºé¡¹ç›®</h1>
          </div>
        </div>

        <!-- æ–°å¢é‡Œç¨‹ç¢‘å¯¹è¯æ¡† -->
        <el-dialog
          v-model="showMilestoneDialog"
          title="æ–°å¢é‡Œç¨‹ç¢‘"
          width="700px"
          :close-on-click-modal="false"
        >
          <div class="form-row">
            <el-form-item label="é‡Œç¨‹ç¢‘åç§°" style="flex: 1 1 100%">
              <el-select
                v-model="milestoneDraft.name"
                placeholder="è¯·é€‰æ‹©é‡Œç¨‹ç¢‘åç§°"
                style="width: 100%"
              >
                <el-option
                  v-for="opt in milestoneOptions"
                  :key="opt"
                  :label="opt"
                  :value="opt"
                  :disabled="addedMilestoneNames && addedMilestoneNames.includes(opt)"
                />
              </el-select>
            </el-form-item>
          </div>
          <div class="form-row">
            <el-form-item label="å¼€å§‹æ—¶é—´" style="flex: 1">
              <el-date-picker
                v-model="milestoneDraft.startTime"
                type="date"
                placeholder="é€‰æ‹©å¼€å§‹æ—¶é—´"
                style="width: 100%"
                format="YYYY-MM-DD"
                value-format="YYYY-MM-DD"
              />
            </el-form-item>
            <el-form-item label="ç»“æŸæ—¶é—´" style="flex: 1">
              <el-date-picker
                v-model="milestoneDraft.endTime"
                type="date"
                placeholder="é€‰æ‹©ç»“æŸæ—¶é—´"
                style="width: 100%"
                format="YYYY-MM-DD"
                value-format="YYYY-MM-DD"
              />
            </el-form-item>
          </div>
          <el-form-item label="æè¿°">
            <el-input
              v-model="milestoneDraft.description"
              type="textarea"
              :rows="2"
              placeholder="è¯·è¾“å…¥é‡Œç¨‹ç¢‘æè¿°"
            />
          </el-form-item>
          <template #footer>
            <el-button @click="closeMilestoneDialog">å–æ¶ˆ</el-button>
            <el-button type="primary" @click="confirmAddMilestone"
              >ç¡®å®šæ·»åŠ </el-button
            >
          </template>
        </el-dialog>

        <!-- åŸºæœ¬ä¿¡æ¯è¡¨å• -->
        <div class="form-card">
          <div class="form-section-title">åŸºæœ¬ä¿¡æ¯</div>
          <el-form
            ref="projectFormRef"
            :model="projectForm"
            :rules="formRules"
            label-width="120px"
          >
            <div class="form-row">
              <el-form-item label="é¡¹ç›®åç§°" prop="name">
                <el-input
                  v-model="projectForm.name"
                  placeholder="è¯·è¾“å…¥é¡¹ç›®åç§°"
                  clearable
                />
              </el-form-item>
              <!-- é¡¹ç›®ç±»å‹: æ–°å»ºåœºæ™¯ä¸éœ€è¦ï¼Œç§»é™¤ -->
            </div>

            <el-form-item label="é¡¹ç›®æè¿°" prop="description">
              <el-input
                v-model="projectForm.description"
                type="textarea"
                :rows="4"
                placeholder="è¯·è¾“å…¥é¡¹ç›®è¯¦ç»†æè¿°"
              />
            </el-form-item>

            <div class="form-row">
              <el-form-item label="é¡¹ç›®è´Ÿè´£äºº" prop="manager">
                <el-select
                  v-model="projectForm.manager"
                  placeholder="è¯·é€‰æ‹©é¡¹ç›®è´Ÿè´£äºº"
                  style="width: 100%"
                >
                  <el-option
                    v-for="user in userList"
                    :key="user.id"
                    :label="user.name"
                    :value="user.id"
                  />
                </el-select>
              </el-form-item>
              <!-- é¡¹ç›®çº§åˆ«: æ–°å»ºåœºæ™¯ä¸éœ€è¦ï¼Œç§»é™¤ -->
            </div>

            <div class="form-row">
              <el-form-item label="åˆ›å»ºæ—¶é—´" prop="startTime">
                <el-date-picker
                  v-model="projectForm.startTime"
                  type="date"
                  placeholder="é€‰æ‹©å¼€å§‹æ—¶é—´"
                  style="width: 100%"
                  format="YYYY-MM-DD"
                  value-format="YYYY-MM-DD"
                />
              </el-form-item>
              <el-form-item label="é¢„è®¡å®Œæˆæ—¶é—´" prop="endTime">
                <el-date-picker
                  v-model="projectForm.endTime"
                  type="date"
                  placeholder="é€‰æ‹©å®Œæˆæ—¶é—´"
                  style="width: 100%"
                  format="YYYY-MM-DD"
                  value-format="YYYY-MM-DD"
                />
              </el-form-item>
            </div>

            <div class="form-row">
              <el-form-item label="é¡¹ç›®é¢„ç®—" prop="budget">
                <el-input-number
                  v-model="projectForm.budget"
                  :min="0"
                  :precision="2"
                  placeholder="è¯·è¾“å…¥é¡¹ç›®é¢„ç®—"
                  style="width: 100%"
                />
                <span style="margin-left: 8px; color: #6b7280">å…ƒ</span>
              </el-form-item>
            </div>
          </el-form>
        </div>

        <!-- æˆå‘˜é€‰æ‹© -->
        <div class="form-card">
          <div
            class="form-section-title"
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <span>é¡¹ç›®æˆå‘˜</span>
            <el-button type="primary" size="small" @click="openMemberDialog">
              <el-icon><Plus /></el-icon>
              æ·»åŠ æˆå‘˜
            </el-button>
          </div>

          <!-- å·²é€‰æˆå‘˜åˆ—è¡¨ -->
          <div v-if="selectedMembers.length > 0">
            <div
              v-for="member in selectedMembers"
              :key="member.id"
              class="member-item"
              style="
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 16px;
                background: #f8fafc;
                border-radius: 8px;
                margin-bottom: 12px;
                border: 1px solid #e5e7eb;
              "
            >
              <div
                style="
                  width: 48px;
                  height: 48px;
                  border-radius: 50%;
                  background: #e5e7eb;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  color: #374151;
                  font-weight: 500;
                  font-size: 18px;
                "
              >
                {{ member.name.charAt(0) }}
              </div>
              <div style="flex: 1">
                <div
                  style="
                    font-weight: 500;
                    color: #374151;
                    font-size: 16px;
                    margin-bottom: 4px;
                  "
                >
                  {{ member.name }}
                </div>
                <div style="font-size: 12px; color: #6b7280">
                  {{ getRoleText(member.role) }} Â· åŠ å…¥æ—¶é—´: {{ getCurrentDate()
                  }}
                </div>
              </div>
              <el-button
                type="danger"
                size="small"
                @click="handleRemoveMember(member.id)"
              >
                ç§»é™¤
              </el-button>
            </div>
          </div>

          <div v-else class="empty-state">
            <div class="empty-state-icon">ğŸ‘¥</div>
            <div class="empty-state-text">æš‚æ— é¡¹ç›®æˆå‘˜</div>
            <div class="empty-state-hint">è¯·æœç´¢å¹¶æ·»åŠ é¡¹ç›®æˆå‘˜</div>
          </div>
        </div>

        <!-- é‡Œç¨‹ç¢‘è®¾ç½® -->
        <div class="form-card">
          <div
            class="form-section-title"
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <span>é¡¹ç›®é‡Œç¨‹ç¢‘</span>
            <el-button type="primary" size="small" @click="openMilestoneDialog">
              <el-icon><Plus /></el-icon>
              æ·»åŠ é‡Œç¨‹ç¢‘
            </el-button>
          </div>

          <!-- ç©ºæ€æç¤ºï¼šä»…å½“æ²¡æœ‰é‡Œç¨‹ç¢‘æ—¶æ˜¾ç¤º -->
          <div
            v-if="milestones.length === 0"
            class="empty-state"
            style="padding: 20px 0"
          >
            <div class="empty-state-icon">ğŸ¯</div>
            <div class="empty-state-text">æš‚æ— é‡Œç¨‹ç¢‘</div>
            <div class="empty-state-hint">è¯·æ·»åŠ é¡¹ç›®é‡Œç¨‹ç¢‘</div>
          </div>

          <!-- é‡Œç¨‹ç¢‘åˆ—è¡¨ -->
          <div v-if="milestones.length > 0">
            <div
              v-for="(milestone, index) in milestones"
              :key="index"
              class="milestone-item"
            >
              <div class="milestone-header">
                <span class="milestone-title">é‡Œç¨‹ç¢‘ {{ index + 1 }}</span>
                <el-button
                  type="danger"
                  size="small"
                  @click="handleRemoveMilestone(index)"
                >
                  åˆ é™¤
                </el-button>
              </div>
              <div class="milestone-content">
                <el-form-item label="é‡Œç¨‹ç¢‘åç§°">
                  <el-input
                    v-model="milestone.name"
                    placeholder="è¯·è¾“å…¥é‡Œç¨‹ç¢‘åç§°"
                  />
                </el-form-item>
                <el-form-item label="å¼€å§‹æ—¶é—´">
                  <el-date-picker
                    v-model="milestone.startTime"
                    type="date"
                    placeholder="é€‰æ‹©å¼€å§‹æ—¶é—´"
                    style="width: 100%"
                    format="YYYY-MM-DD"
                    value-format="YYYY-MM-DD"
                  />
                </el-form-item>
                <el-form-item label="ç»“æŸæ—¶é—´">
                  <el-date-picker
                    v-model="milestone.endTime"
                    type="date"
                    placeholder="é€‰æ‹©ç»“æŸæ—¶é—´"
                    style="width: 100%"
                    format="YYYY-MM-DD"
                    value-format="YYYY-MM-DD"
                  />
                </el-form-item>
              </div>
              <el-form-item label="æè¿°">
                <el-input
                  v-model="milestone.description"
                  type="textarea"
                  :rows="2"
                  placeholder="è¯·è¾“å…¥é‡Œç¨‹ç¢‘æè¿°"
                />
              </el-form-item>
            </div>
          </div>

          <!-- æ³¨æ„ï¼šé¿å…é‡å¤æ˜¾ç¤ºç©ºæ€ï¼Œæ­¤å¤„ä¸å†é‡å¤æ¸²æŸ“ -->
        </div>

        <!-- æ·»åŠ æˆå‘˜å¯¹è¯æ¡† -->
        <el-dialog
          v-model="showMemberDialog"
          title="æ·»åŠ æˆå‘˜"
          width="600px"
          :close-on-click-modal="false"
        >
          <el-input
            v-model="memberSearchKeyword"
            placeholder="æœç´¢æˆå‘˜ï¼ˆå§“åæˆ–å­¦å·¥å·ï¼‰"
            clearable
            @keyup.enter="handleMemberSearch"
            @input="handleMemberSearch"
          >
            <template #prefix>
              <el-icon><Search /></el-icon>
            </template>
          </el-input>
          <div
            v-if="memberSearchResults.length > 0"
            class="search-results"
            style="margin-top: 12px"
          >
            <div
              v-for="user in memberSearchResults"
              :key="user.id"
              class="search-result-item"
              style="
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 12px;
                border: 1px solid #e5e7eb;
                border-radius: 6px;
                margin-bottom: 8px;
                background: #ffffff;
              "
            >
              <div style="display: flex; align-items: center; gap: 12px">
                <div
                  style="
                    width: 40px;
                    height: 40px;
                    border-radius: 50%;
                    background: #f3f4f6;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: #374151;
                    font-weight: 500;
                    font-size: 16px;
                  "
                >
                  {{ user.name.charAt(0) }}
                </div>
                <div>
                  <div
                    style="
                      font-weight: 500;
                      color: #374151;
                      font-size: 14px;
                      margin-bottom: 4px;
                    "
                  >
                    {{ user.name }}
                  </div>
                  <!-- <div style="font-size:12px;color:#6b7280;">å·¥å·: {{ user.id }}</div> -->
                </div>
              </div>
              <el-button
                type="primary"
                size="small"
                :disabled="selectedMembers.some(m=>m.id===user.id)"
                @click="handleAddMember(user)"
                style="min-width: 60px"
              >
                {{ selectedMembers.some(m=>m.id===user.id) ? 'å·²æ·»åŠ ' : 'æ·»åŠ '
                }}
              </el-button>
            </div>
          </div>
          <div v-else class="empty-state" style="padding: 20px 0">
            <div class="empty-state-text">è¯·è¾“å…¥å…³é”®è¯è¿›è¡Œæœç´¢</div>
          </div>
          <template #footer>
            <el-button @click="closeMemberDialog">å…³é—­</el-button>
          </template>
        </el-dialog>

        <!-- æ–‡æ¡£ç®¡ç†ï¼ˆæ–°å¢æ—¶ä¸ºç©ºï¼Œä¸Šä¼ åæ˜¾ç¤ºåˆ—è¡¨ï¼‰ -->
        <div class="form-card">
          <div class="form-section-title">æ–‡æ¡£ç®¡ç†</div>

          <div v-if="documents.length > 0" class="document-list">
            <div
              v-for="doc in documents"
              :key="doc.id"
              class="document-item"
              style="
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 12px;
                background: #f8fafc;
                border-radius: 6px;
                margin-bottom: 12px;
              "
            >
              <div
                style="
                  width: 32px;
                  height: 32px;
                  border-radius: 4px;
                  background: #dbeafe;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  color: #1e40af;
                "
              >
                ğŸ“„
              </div>
              <div style="flex: 1">
                <div style="font-weight: 500; color: #374151">
                  {{ doc.name }}
                </div>
                <div style="font-size: 12px; color: #6b7280">
                  {{ doc.type }} Â· {{ doc.uploader }} Â· {{ doc.uploadTime }} Â·
                  {{ doc.size }}
                </div>
              </div>
              <div>
                <el-button size="small" @click="handlePreview(doc.id)"
                  >é¢„è§ˆ</el-button
                >
                <el-button size="small" @click="handleDownload(doc.id)"
                  >ä¸‹è½½</el-button
                >
                <el-button
                  size="small"
                  type="danger"
                  @click="handleDeleteDoc(doc.id)"
                  >åˆ é™¤</el-button
                >
              </div>
            </div>
          </div>

          <div v-else class="empty-state">
            <div class="empty-state-icon">ğŸ“„</div>
            <div class="empty-state-text">æš‚æ— æ–‡æ¡£</div>
            <div class="empty-state-hint">ä¸Šä¼ é¡¹ç›®ç›¸å…³æ–‡æ¡£</div>
          </div>

          <!-- ä¸Šä¼ åŒºåŸŸ -->
          <div class="upload-section">
            <div
              class="upload-area"
              @click="triggerUpload"
              @dragover.prevent="handleDragOver"
              @dragleave.prevent="handleDragLeave"
              @drop.prevent="handleDrop"
              :class="{ dragover: isDragOver }"
            >
              <div class="upload-icon">
                <el-icon><Upload /></el-icon>
              </div>
              <div class="upload-text">ç‚¹å‡»ä¸Šä¼ æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</div>
              <div class="upload-hint">
                æ”¯æŒ PDFã€DOCã€DOCXã€XLSã€XLSX ç­‰æ ¼å¼
              </div>
            </div>
            <input
              ref="fileInput"
              type="file"
              multiple
              style="display: none"
              @change="handleFileSelect"
              accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx"
            />
          </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div
          class="button-group"
          style="
            background: #fff;
            position: sticky;
            bottom: 0;
            border-top: 1px solid #e5e7eb;
            padding: 16px;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
          "
        >
          <el-button @click="handleCancel">å–æ¶ˆ</el-button>
          <el-button
            type="primary"
            :loading="loading"
            @click="handleSaveProject"
          >
            <el-icon><Check /></el-icon>
            ä¿å­˜é¡¹ç›®
          </el-button>
        </div>
      </div>
    </div>

    <script>
      const { createApp, ref, reactive, computed, nextTick } = Vue;
      const { ElMessage, ElMessageBox } = ElementPlus;

      createApp({
        setup() {
          // æ•°æ®çŠ¶æ€
          const loading = ref(false);
          const projectFormRef = ref(null);
          const memberSearchKeyword = ref("");
          const memberSearchResults = ref([]);
          const showMemberDialog = ref(false);
          const showMemberEditor = ref(false);

          // é¡¹ç›®è¡¨å•æ•°æ®
          const projectForm = reactive({
            name: "",
            description: "",
            manager: "",
            startTime: "",
            endTime: "",
            budget: 0,
          });

          // è¡¨å•éªŒè¯è§„åˆ™
          const formRules = {
            name: [
              { required: true, message: "è¯·è¾“å…¥é¡¹ç›®åç§°", trigger: "blur" },
              {
                min: 2,
                max: 100,
                message: "é¡¹ç›®åç§°é•¿åº¦åœ¨2åˆ°100ä¸ªå­—ç¬¦",
                trigger: "blur",
              },
            ],
            description: [
              { required: true, message: "è¯·è¾“å…¥é¡¹ç›®æè¿°", trigger: "blur" },
              {
                min: 10,
                max: 1000,
                message: "é¡¹ç›®æè¿°é•¿åº¦åœ¨10åˆ°1000ä¸ªå­—ç¬¦",
                trigger: "blur",
              },
            ],
            manager: [
              {
                required: true,
                message: "è¯·é€‰æ‹©é¡¹ç›®è´Ÿè´£äºº",
                trigger: "change",
              },
            ],
            startTime: [
              { required: true, message: "è¯·é€‰æ‹©åˆ›å»ºæ—¶é—´", trigger: "change" },
            ],
            endTime: [
              {
                required: true,
                message: "è¯·é€‰æ‹©é¢„è®¡å®Œæˆæ—¶é—´",
                trigger: "change",
              },
            ],
            budget: [
              { required: true, message: "è¯·è¾“å…¥é¡¹ç›®é¢„ç®—", trigger: "blur" },
              {
                type: "number",
                min: 0,
                message: "é¡¹ç›®é¢„ç®—å¿…é¡»å¤§äºç­‰äº0",
                trigger: "blur",
              },
            ],
          };

          // ç”¨æˆ·åˆ—è¡¨æ•°æ®
          const userList = ref([
            { id: "1", name: "å¼ æ•™æˆ", avatar: "../images/favicon.ico" },
            { id: "2", name: "æåšå£«", avatar: "../images/favicon.ico" },
            { id: "3", name: "ç‹æ•™æˆ", avatar: "../images/favicon.ico" },
            { id: "4", name: "èµµåšå£«", avatar: "../images/favicon.ico" },
            { id: "5", name: "é™ˆæ•™æˆ", avatar: "../images/favicon.ico" },
          ]);

          // å·²é€‰æˆå‘˜åˆ—è¡¨
          const selectedMembers = ref([]);

          // é‡Œç¨‹ç¢‘åˆ—è¡¨
          const milestones = ref([]);
          // é‡Œç¨‹ç¢‘ä¸‹æ‹‰é€‰é¡¹ï¼ˆç¡®ä¿ä¸ºå“åº”å¼ï¼Œé¿å…æ¸²æŸ“ä¸ºç©ºï¼‰
          const milestoneOptions = ref([
            "1.é¡¹ç›®å¯åŠ¨ï¼šå»ºè®¾æ–¹æ¡ˆé€šè¿‡å®¡æ ¸å¹¶å¤‡æ¡ˆ",
            "2.ä»»åŠ¡åˆ†è§£ä¸èµ„æºå‡†å¤‡ï¼šé¡¹ç›®ä»»åŠ¡ä¹¦ä¸‹è¾¾ï¼Œèµ„æºé…ç½®å®Œæˆï¼Œè¿›å…¥å®æ–½é˜¶æ®µ",
            "3.é¡¹ç›®å®æ–½ä¸è¿‡ç¨‹ç®¡ç†ï¼šä¸­æœŸæ£€æŸ¥",
            "4.æˆæœæ•´åˆä¸ç»“é¢˜å‡†å¤‡ï¼šç»“é¢˜éªŒæ”¶",
            "5.åç»­ç®¡ç†ä¸æˆæœè½¬åŒ–ï¼šé¡¹ç›®å½’æ¡£å®Œæˆï¼Œæˆæœè½¬åŒ–",
          ]);
          const addedMilestoneNames = computed(() => {
            if (!milestones.value || !Array.isArray(milestones.value)) {
              return [];
            }
            return milestones.value
              .map((m) => m.name)
              .filter((name) => name && name.trim());
          });
          const showMilestoneDialog = ref(false);
          const milestoneDraft = ref({
            name: "",
            startTime: "",
            endTime: "",
            description: "",
          });
          const documents = ref([]);
          const isDragOver = ref(false);
          const fileInput = ref(null);

          // æˆå‘˜æœç´¢å¤„ç†
          const handleMemberSearch = () => {
            if (!memberSearchKeyword.value.trim()) {
              memberSearchResults.value = [];
              return;
            }

            // æ¨¡æ‹Ÿæœç´¢API
            const keyword = memberSearchKeyword.value.toLowerCase();
            memberSearchResults.value = userList.value.filter(
              (user) =>
                user.name.toLowerCase().includes(keyword) ||
                user.id.toLowerCase().includes(keyword)
            );
          };

          // æ·»åŠ æˆå‘˜
          const handleAddMember = (user) => {
            // æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ 
            const exists = selectedMembers.value.find(
              (member) => member.id === user.id
            );
            if (exists) {
              ElMessage.warning("è¯¥æˆå‘˜å·²ç»æ·»åŠ ");
              return;
            }

            // æ·»åŠ åˆ°å·²é€‰åˆ—è¡¨
            selectedMembers.value.push({
              id: user.id,
              name: user.name,
              avatar: user.avatar,
              role: "member",
            });

            // æ¸…ç©ºæœç´¢
            memberSearchKeyword.value = "";
            memberSearchResults.value = [];

            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯ï¼Œå¹¶åœ¨æˆå‘˜åˆ—è¡¨ä¸­æ˜¾ç¤ºæ·»åŠ çŠ¶æ€
            ElMessage.success(`å·²æ·»åŠ æˆå‘˜ï¼š${user.name}`);

            // å»¶è¿Ÿå…³é—­å¯¹è¯æ¡†ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æ·»åŠ æ•ˆæœ
            setTimeout(() => {
              showMemberDialog.value = false;
            }, 1000);
          };

          // ç§»é™¤æˆå‘˜
          const handleRemoveMember = (memberId) => {
            const index = selectedMembers.value.findIndex(
              (member) => member.id === memberId
            );
            if (index > -1) {
              const memberName = selectedMembers.value[index].name;
              selectedMembers.value.splice(index, 1);
              ElMessage.success(`å·²ç§»é™¤æˆå‘˜ï¼š${memberName}`);
            }
          };

          // æ·»åŠ é‡Œç¨‹ç¢‘
          const openMilestoneDialog = () => {
            milestoneDraft.value = {
              name: "",
              startTime: "",
              endTime: "",
              description: "",
            };
            showMilestoneDialog.value = true;
          };

          const closeMilestoneDialog = () => {
            showMilestoneDialog.value = false;
          };

          const confirmAddMilestone = () => {
            const d = milestoneDraft.value;
            if (!d.name.trim()) {
              ElMessage.warning("è¯·è¾“å…¥é‡Œç¨‹ç¢‘åç§°");
              return;
            }
            if (addedMilestoneNames.value.includes(d.name.trim())) {
              ElMessage.warning("è¯¥é‡Œç¨‹ç¢‘å·²æ·»åŠ ");
              return;
            }
            if (!d.startTime || !d.endTime) {
              ElMessage.warning("è¯·é€‰æ‹©å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´");
              return;
            }
            if (new Date(d.startTime) >= new Date(d.endTime)) {
              ElMessage.warning("ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´");
              return;
            }
            milestones.value.push({
              name: d.name.trim(),
              startTime: d.startTime,
              endTime: d.endTime,
              description: d.description || "",
            });
            showMilestoneDialog.value = false;
            ElMessage.success("å·²æ·»åŠ é‡Œç¨‹ç¢‘");
          };

          // ç§»é™¤é‡Œç¨‹ç¢‘
          const handleRemoveMilestone = (index) => {
            milestones.value.splice(index, 1);
          };

          // è¡¨å•éªŒè¯
          const validateForm = async () => {
            try {
              await projectFormRef.value.validate();

              // éªŒè¯æ—¶é—´é€»è¾‘
              if (projectForm.startTime && projectForm.endTime) {
                const startDate = new Date(projectForm.startTime);
                const endDate = new Date(projectForm.endTime);
                if (startDate >= endDate) {
                  ElMessage.error("é¢„è®¡å®Œæˆæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´");
                  return false;
                }
              }

              // éªŒè¯é‡Œç¨‹ç¢‘
              for (let i = 0; i < milestones.value.length; i++) {
                const milestone = milestones.value[i];
                if (!milestone.name.trim()) {
                  ElMessage.error(`ç¬¬${i + 1}ä¸ªé‡Œç¨‹ç¢‘åç§°ä¸èƒ½ä¸ºç©º`);
                  return false;
                }
                if (milestone.startTime && milestone.endTime) {
                  const startDate = new Date(milestone.startTime);
                  const endDate = new Date(milestone.endTime);
                  if (startDate >= endDate) {
                    ElMessage.error(
                      `ç¬¬${i + 1}ä¸ªé‡Œç¨‹ç¢‘ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´`
                    );
                    return false;
                  }
                }
              }

              return true;
            } catch (error) {
              ElMessage.error("è¯·å®Œå–„è¡¨å•ä¿¡æ¯");
              return false;
            }
          };

          const openMemberDialog = () => {
            memberSearchKeyword.value = "";
            memberSearchResults.value = [];
            showMemberDialog.value = true;
          };
          const closeMemberDialog = () => {
            showMemberDialog.value = false;
          };

          // ä¿å­˜é¡¹ç›®
          const handleSaveProject = async () => {
            const isValid = await validateForm();
            if (!isValid) return;

            try {
              loading.value = true;

              // æ¨¡æ‹ŸAPIè°ƒç”¨
              await new Promise((resolve) => setTimeout(resolve, 2000));

              // æ„é€ é¡¹ç›®æ•°æ®
              const projectData = {
                ...projectForm,
                members: selectedMembers.value,
                milestones: milestones.value,
                documents: documents.value,
              };

              console.log("ä¿å­˜é¡¹ç›®æ•°æ®:", projectData);

              ElMessage.success("é¡¹ç›®åˆ›å»ºæˆåŠŸï¼");

              // è·³è½¬åˆ°é¡¹ç›®åˆ—è¡¨é¡µé¢
              if (window.parent !== window) {
                window.parent.postMessage(
                  {
                    type: "navigate",
                    path: "project/list",
                  },
                  "*"
                );
              } else {
                window.location.href = "é¡¹ç›®åˆ—è¡¨.html";
              }
            } catch (error) {
              ElMessage.error("é¡¹ç›®åˆ›å»ºå¤±è´¥ï¼Œè¯·é‡è¯•");
            } finally {
              loading.value = false;
            }
          };

          // æ–‡æ¡£ä¸Šä¼ /é¢„è§ˆ/åˆ é™¤ äº¤äº’
          const triggerUpload = () =>
            fileInput.value && fileInput.value.click();
          const handleFileSelect = (e) => {
            const files = e.target.files || [];
            if (!files.length) return;
            for (const f of files) {
              documents.value.push({
                id: Date.now() + Math.random(),
                name: f.name,
                type: (f.name.split(".").pop() || "file").toUpperCase(),
                uploader: "å½“å‰ç”¨æˆ·",
                uploadTime: new Date().toISOString().split("T")[0],
                size: Math.ceil(f.size / 1024) + "KB",
              });
            }
            ElMessage.success("æ–‡ä»¶å·²æ·»åŠ è‡³åˆ—è¡¨");
          };
          const handleDragOver = () => (isDragOver.value = true);
          const handleDragLeave = () => (isDragOver.value = false);
          const handleDrop = (e) => {
            e.preventDefault();
            isDragOver.value = false;
            const files = e.dataTransfer?.files || [];
            if (files.length) handleFileSelect({ target: { files } });
          };
          const handlePreview = (id) => ElMessage.info(`é¢„è§ˆæ–‡æ¡£: ${id}`);
          const handleDownload = (id) => ElMessage.info(`ä¸‹è½½æ–‡æ¡£: ${id}`);
          const handleDeleteDoc = (id) => {
            const idx = documents.value.findIndex((d) => d.id === id);
            if (idx > -1) {
              documents.value.splice(idx, 1);
              ElMessage.success("å·²åˆ é™¤æ–‡æ¡£");
            }
          };

          // è·å–è§’è‰²æ–‡æœ¬
          const getRoleText = (role) => {
            const roleMap = {
              manager: "é¡¹ç›®è´Ÿè´£äºº",
              core: "æ ¸å¿ƒæˆå‘˜",
              member: "æ™®é€šæˆå‘˜",
            };
            return roleMap[role] || "æ™®é€šæˆå‘˜";
          };

          // è·å–å½“å‰æ—¥æœŸ
          const getCurrentDate = () => {
            return new Date().toISOString().split("T")[0];
          };

          // å–æ¶ˆåˆ›å»º
          const handleCancel = () => {
            ElMessageBox.confirm(
              "ç¡®å®šè¦å–æ¶ˆåˆ›å»ºé¡¹ç›®å—ï¼Ÿæœªä¿å­˜çš„æ•°æ®å°†ä¸¢å¤±ã€‚",
              "ç¡®è®¤å–æ¶ˆ",
              {
                confirmButtonText: "ç¡®å®š",
                cancelButtonText: "ç»§ç»­ç¼–è¾‘",
                type: "warning",
              }
            )
              .then(() => {
                // è·³è½¬åˆ°é¡¹ç›®åˆ—è¡¨é¡µé¢
                if (window.parent !== window) {
                  window.parent.postMessage(
                    {
                      type: "navigate",
                      path: "project/list",
                    },
                    "*"
                  );
                } else {
                  window.location.href = "é¡¹ç›®åˆ—è¡¨.html";
                }
              })
              .catch(() => {
                // ç”¨æˆ·å–æ¶ˆï¼Œç»§ç»­ç¼–è¾‘
              });
          };

          // åˆå§‹åŒ–é»˜è®¤å€¼
          const initDefaultValues = () => {
            const today = new Date();
            const threeMonthsLater = new Date();
            threeMonthsLater.setMonth(today.getMonth() + 3);

            projectForm.startTime = today.toISOString().split("T")[0];
            projectForm.endTime = threeMonthsLater.toISOString().split("T")[0];
            projectForm.manager = userList.value[0].id; // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªç”¨æˆ·
          };

          // ç»„ä»¶æŒ‚è½½æ—¶åˆå§‹åŒ–
          nextTick(() => {
            initDefaultValues();
          });

          return {
            loading,
            projectFormRef,
            projectForm,
            formRules,
            userList,
            selectedMembers,
            milestones,
            milestoneOptions,
            addedMilestoneNames,
            showMilestoneDialog,
            milestoneDraft,
            memberSearchKeyword,
            memberSearchResults,
            showMemberDialog,
            openMemberDialog,
            closeMemberDialog,
            openMilestoneDialog,
            closeMilestoneDialog,
            confirmAddMilestone,
            handleMemberSearch,
            handleAddMember,
            handleRemoveMember,
            handleRemoveMilestone,
            documents,
            isDragOver,
            fileInput,
            triggerUpload,
            handleFileSelect,
            handleDragOver,
            handleDragLeave,
            handleDrop,
            handlePreview,
            handleDownload,
            handleDeleteDoc,
            handleSaveProject,
            handleCancel,
            getRoleText,
            getCurrentDate,
          };
        },
      })
        .use(ElementPlus, {
          locale: window.ElementPlusLocaleZhCn || {
            name: "zh-cn",
            el: {
              datepicker: {
                now: "æ­¤åˆ»",
                today: "ä»Šå¤©",
                cancel: "å–æ¶ˆ",
                clear: "æ¸…ç©º",
                confirm: "ç¡®è®¤",
                selectDate: "é€‰æ‹©æ—¥æœŸ",
                selectTime: "é€‰æ‹©æ—¶é—´",
                startDate: "å¼€å§‹æ—¥æœŸ",
                startTime: "å¼€å§‹æ—¶é—´",
                endDate: "ç»“æŸæ—¥æœŸ",
                endTime: "ç»“æŸæ—¶é—´",
                prevYear: "å‰ä¸€å¹´",
                nextYear: "åä¸€å¹´",
                prevMonth: "ä¸Šä¸ªæœˆ",
                nextMonth: "ä¸‹ä¸ªæœˆ",
                year: "å¹´",
                month1: "1æœˆ",
                month2: "2æœˆ",
                month3: "3æœˆ",
                month4: "4æœˆ",
                month5: "5æœˆ",
                month6: "6æœˆ",
                month7: "7æœˆ",
                month8: "8æœˆ",
                month9: "9æœˆ",
                month10: "10æœˆ",
                month11: "11æœˆ",
                month12: "12æœˆ",
                weeks: {
                  sun: "æ—¥",
                  mon: "ä¸€",
                  tue: "äºŒ",
                  wed: "ä¸‰",
                  thu: "å››",
                  fri: "äº”",
                  sat: "å…­",
                },
                months: {
                  jan: "ä¸€æœˆ",
                  feb: "äºŒæœˆ",
                  mar: "ä¸‰æœˆ",
                  apr: "å››æœˆ",
                  may: "äº”æœˆ",
                  jun: "å…­æœˆ",
                  jul: "ä¸ƒæœˆ",
                  aug: "å…«æœˆ",
                  sep: "ä¹æœˆ",
                  oct: "åæœˆ",
                  nov: "åä¸€æœˆ",
                  dec: "åäºŒæœˆ",
                },
              },
            },
          },
        })
        .mount("#app");
    </script>
  </body>
</html>
