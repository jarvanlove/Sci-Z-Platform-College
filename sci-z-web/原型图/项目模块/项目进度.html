<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>项目进度 - 高校科研项目管理平台</title>
    <link rel="icon" href="../images/favicon.ico" type="image/x-icon" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/element-plus@2.3.14/dist/index.css"
    />
    <script src="https://unpkg.com/vue@3.2.47/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/element-plus@2.3.14"></script>
    <link rel="stylesheet" href="../通用规范/样式.css" />
    <style>
      .project-progress-container {
        padding: 20px;
        background: #f7f9fc;
        min-height: calc(100vh - 56px);
      }

      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .page-title {
        font-size: 24px;
        font-weight: 600;
        color: #1e3a8a;
        margin: 0;
      }

      .content-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .card {
        background: #ffffff;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        border: 1px solid #e5e7eb;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e5e7eb;
      }

      .card-title {
        font-size: 16px;
        font-weight: 600;
        color: #111827;
        margin: 0;
      }

      /* 进度概览样式 */
      .progress-overview {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .overall-progress {
        text-align: center;
        padding: 20px;
        background: #f8fafc;
        border-radius: 8px;
      }

      .progress-percentage {
        font-size: 48px;
        font-weight: 700;
        color: #1e3a8a;
        margin-bottom: 8px;
      }

      .progress-label {
        font-size: 16px;
        color: #6b7280;
        margin-bottom: 16px;
      }

      .progress-bar-large {
        width: 100%;
        height: 12px;
        background: #e5e7eb;
        border-radius: 6px;
        overflow: hidden;
        margin-bottom: 16px;
      }

      .progress-fill-large {
        height: 100%;
        background: linear-gradient(90deg, #1e3a8a 0%, #0ea5e9 100%);
        border-radius: 6px;
        transition: width 0.5s ease;
      }

      .progress-time {
        display: flex;
        justify-content: space-between;
        font-size: 14px;
        color: #6b7280;
      }

      .progress-stats {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
      }

      .stat-item {
        text-align: center;
        padding: 16px;
        background: #f8fafc;
        border-radius: 8px;
      }

      .stat-number {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 4px;
      }

      .stat-label {
        font-size: 12px;
        color: #6b7280;
      }

      .stat-completed .stat-number {
        color: #16a34a;
      }

      .stat-progress .stat-number {
        color: #f59e0b;
      }

      .stat-planned .stat-number {
        color: #2563eb;
      }

      .stat-delayed .stat-number {
        color: #dc2626;
      }

      /* 里程碑列表样式 */
      .milestone-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .milestone-item {
        padding: 16px;
        background: #f8fafc;
        border-radius: 8px;
        border-left: 4px solid #e5e7eb;
      }

      .milestone-item.completed {
        border-left-color: #16a34a;
        background: #f0fdf4;
      }

      .milestone-item.progress {
        border-left-color: #f59e0b;
        background: #fffbeb;
      }

      .milestone-item.planned {
        border-left-color: #2563eb;
        background: #eff6ff;
      }

      .milestone-item.delayed {
        border-left-color: #dc2626;
        background: #fef2f2;
      }

      .milestone-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .milestone-name {
        font-size: 16px;
        font-weight: 600;
        color: #111827;
      }

      .milestone-status {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
      }

      .status-completed {
        background: #d1fae5;
        color: #059669;
      }

      .status-progress {
        background: #fef3c7;
        color: #d97706;
      }

      .status-planned {
        background: #dbeafe;
        color: #1e40af;
      }

      .status-delayed {
        background: #fee2e2;
        color: #dc2626;
      }

      .milestone-description {
        font-size: 14px;
        color: #6b7280;
        margin-bottom: 12px;
      }

      .milestone-progress {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 8px;
      }

      .milestone-progress-bar {
        flex: 1;
        height: 6px;
        background: #e5e7eb;
        border-radius: 3px;
        overflow: hidden;
      }

      .milestone-progress-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.3s ease;
      }

      .milestone-progress-fill.completed {
        background: #16a34a;
      }

      .milestone-progress-fill.progress {
        background: #f59e0b;
      }

      .milestone-progress-fill.planned {
        background: #2563eb;
      }

      .milestone-progress-fill.delayed {
        background: #dc2626;
      }

      .milestone-progress-text {
        font-size: 12px;
        color: #6b7280;
        min-width: 35px;
      }

      .milestone-time {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: #9ca3af;
      }

      .milestone-actions {
        display: flex;
        gap: 8px;
        margin-top: 12px;
      }

      /* 时间轴视图样式 */
      .timeline-container {
        position: relative;
        padding-left: 24px;
      }

      .timeline-line {
        position: absolute;
        left: 12px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #e5e7eb;
      }

      .timeline-item {
        position: relative;
        margin-bottom: 24px;
        padding-left: 24px;
      }

      .timeline-dot {
        position: absolute;
        left: -6px;
        top: 8px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 3px solid #ffffff;
        box-shadow: 0 0 0 2px #e5e7eb;
      }

      .timeline-dot.completed {
        background: #16a34a;
        box-shadow: 0 0 0 2px #16a34a;
      }

      .timeline-dot.progress {
        background: #f59e0b;
        box-shadow: 0 0 0 2px #f59e0b;
      }

      .timeline-dot.planned {
        background: #2563eb;
        box-shadow: 0 0 0 2px #2563eb;
      }

      .timeline-dot.delayed {
        background: #dc2626;
        box-shadow: 0 0 0 2px #dc2626;
      }

      .timeline-content {
        background: #ffffff;
        border-radius: 8px;
        padding: 16px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
      }

      .timeline-title {
        font-size: 16px;
        font-weight: 600;
        color: #111827;
        margin-bottom: 4px;
      }

      .timeline-time {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 8px;
      }

      .timeline-description {
        font-size: 14px;
        color: #374151;
        line-height: 1.5;
      }

      /* 添加里程碑对话框 */
      .milestone-form {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }

      .loading-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 40px;
        color: #6b7280;
        font-size: 14px;
      }

      .loading-container .el-icon {
        margin-right: 8px;
        font-size: 16px;
      }

      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #6b7280;
      }

      .empty-state-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
      }

      .empty-state-text {
        font-size: 16px;
        margin-bottom: 8px;
      }

      .empty-state-hint {
        font-size: 14px;
        color: #9ca3af;
      }

      /* 响应式设计 */
      @media (max-width: 768px) {
        .content-grid {
          grid-template-columns: 1fr;
        }

        .progress-stats {
          grid-template-columns: repeat(2, 1fr);
        }

        .form-row {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="project-progress-container">
        <!-- 页面头部 -->
        <div class="page-header">
          <h1 class="page-title">项目进度</h1>
          <div>
            <el-button @click="handleBack">
              <el-icon><ArrowLeft /></el-icon>
              返回详情
            </el-button>
            <el-button type="primary" @click="showAddDialog = true">
              <el-icon><Plus /></el-icon>
              添加里程碑
            </el-button>
          </div>
        </div>

        <!-- 加载状态 -->
        <div v-if="loading" class="loading-container">
          <el-icon class="is-loading"><Loading /></el-icon>
          <span>加载中...</span>
        </div>

        <!-- 主要内容 -->
        <div v-else class="content-grid">
          <!-- 左侧：进度概览 -->
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">进度概览</h2>
            </div>

            <div class="progress-overview">
              <!-- 整体进度 -->
              <div class="overall-progress">
                <div class="progress-percentage">{{ overallProgress }}%</div>
                <div class="progress-label">整体完成进度</div>
                <div class="progress-bar-large">
                  <div
                    class="progress-fill-large"
                    :style="{ width: overallProgress + '%' }"
                  ></div>
                </div>
                <div class="progress-time">
                  <span>开始时间：{{ projectStartTime }}</span>
                  <span>预计完成：{{ projectEndTime }}</span>
                </div>
              </div>

              <!-- 进度统计 -->
              <div class="progress-stats">
                <div class="stat-item stat-completed">
                  <div class="stat-number">{{ stats.completed }}</div>
                  <div class="stat-label">已完成</div>
                </div>
                <div class="stat-item stat-progress">
                  <div class="stat-number">{{ stats.progress }}</div>
                  <div class="stat-label">进行中</div>
                </div>
                <div class="stat-item stat-planned">
                  <div class="stat-number">{{ stats.planned }}</div>
                  <div class="stat-label">未开始</div>
                </div>
                <div class="stat-item stat-delayed">
                  <div class="stat-number">{{ stats.delayed }}</div>
                  <div class="stat-label">已延期</div>
                </div>
              </div>
            </div>
          </div>

          <!-- 右侧：里程碑列表 -->
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">里程碑管理</h2>
            </div>

            <div v-if="milestones.length > 0" class="milestone-list">
              <div
                v-for="milestone in milestones"
                :key="milestone.id"
                class="milestone-item"
                :class="milestone.status"
              >
                <div class="milestone-header">
                  <div class="milestone-name">{{ milestone.name }}</div>
                  <span :class="`milestone-status status-${milestone.status}`">
                    {{ getStatusText(milestone.status) }}
                  </span>
                </div>

                <div class="milestone-description">
                  {{ milestone.description }}
                </div>

                <div class="milestone-progress">
                  <div class="milestone-progress-bar">
                    <div
                      class="milestone-progress-fill"
                      :class="milestone.status"
                      :style="{ width: milestone.progress + '%' }"
                    ></div>
                  </div>
                  <span class="milestone-progress-text"
                    >{{ milestone.progress }}%</span
                  >
                </div>

                <div class="milestone-time">
                  <span>开始：{{ milestone.startTime }}</span>
                  <span>结束：{{ milestone.endTime }}</span>
                </div>

                <div class="milestone-actions">
                  <el-button
                    size="small"
                    @click="handleEditMilestone(milestone.id)"
                  >
                    编辑
                  </el-button>
                  <el-button
                    size="small"
                    type="danger"
                    @click="handleDeleteMilestone(milestone.id)"
                  >
                    删除
                  </el-button>
                </div>
              </div>
            </div>

            <!-- 空状态 -->
            <div v-else class="empty-state">
              <div class="empty-state-icon">📅</div>
              <div class="empty-state-text">暂无里程碑</div>
              <div class="empty-state-hint">添加项目里程碑</div>
            </div>
          </div>
        </div>

        <!-- 时间轴视图 -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">时间轴视图</h2>
          </div>

          <div v-if="milestones.length > 0" class="timeline-container">
            <div class="timeline-line"></div>
            <div
              v-for="milestone in milestones"
              :key="milestone.id"
              class="timeline-item"
            >
              <div :class="`timeline-dot ${milestone.status}`"></div>
              <div class="timeline-content">
                <div class="timeline-title">{{ milestone.name }}</div>
                <div class="timeline-time">
                  {{ milestone.startTime }} - {{ milestone.endTime }}
                </div>
                <div class="timeline-description">
                  {{ milestone.description }}
                </div>
              </div>
            </div>
          </div>

          <!-- 空状态 -->
          <div v-else class="empty-state">
            <div class="empty-state-icon">📅</div>
            <div class="empty-state-text">暂无时间轴数据</div>
            <div class="empty-state-hint">添加里程碑后显示时间轴</div>
          </div>
        </div>

        <!-- 添加里程碑对话框 -->
        <el-dialog
          v-model="showAddDialog"
          title="添加里程碑"
          width="600px"
          :before-close="handleCloseDialog"
        >
          <div class="milestone-form">
            <el-form :model="milestoneForm" label-width="100px">
              <el-form-item label="里程碑名称" required>
                <el-input
                  v-model="milestoneForm.name"
                  placeholder="请输入里程碑名称"
                />
              </el-form-item>

              <el-form-item label="描述">
                <el-input
                  v-model="milestoneForm.description"
                  type="textarea"
                  :rows="3"
                  placeholder="请输入里程碑描述"
                />
              </el-form-item>

              <div class="form-row">
                <el-form-item label="开始时间" required>
                  <el-date-picker
                    v-model="milestoneForm.startTime"
                    type="date"
                    placeholder="选择开始时间"
                    style="width: 100%"
                  />
                </el-form-item>

                <el-form-item label="结束时间" required>
                  <el-date-picker
                    v-model="milestoneForm.endTime"
                    type="date"
                    placeholder="选择结束时间"
                    style="width: 100%"
                  />
                </el-form-item>
              </div>

              <el-form-item label="优先级">
                <el-select
                  v-model="milestoneForm.priority"
                  placeholder="选择优先级"
                  style="width: 100%"
                >
                  <el-option label="高" value="high" />
                  <el-option label="中" value="medium" />
                  <el-option label="低" value="low" />
                </el-select>
              </el-form-item>
            </el-form>
          </div>

          <template #footer>
            <el-button @click="handleCloseDialog">取消</el-button>
            <el-button type="primary" @click="handleAddMilestone"
              >确定</el-button
            >
          </template>
        </el-dialog>
      </div>
    </div>

    <script>
      const { createApp, ref, onMounted } = Vue;
      const { ElMessage, ElMessageBox } = ElementPlus;

      // 注册Loading图标
      const Loading = {
        template:
          '<svg class="el-icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M512 64a32 32 0 0 1 32 32v192a32 32 0 0 1-64 0V96a32 32 0 0 1 32-32zm0 896a32 32 0 0 1-32-32V736a32 32 0 0 1 64 0v192a32 32 0 0 1-32 32zm448-480a32 32 0 0 1-32 32H736a32 32 0 0 1 0-64h192a32 32 0 0 1 32 32zM96 512a32 32 0 0 1 32-32h192a32 32 0 0 1 0 64H128a32 32 0 0 1-32-32zm778.24-200.96a32 32 0 0 1 45.248 45.248l-135.68 135.68a32 32 0 1 1-45.248-45.248l135.68-135.68zm-636.48 636.48a32 32 0 0 1 45.248 45.248l-135.68 135.68a32 32 0 1 1-45.248-45.248l135.68-135.68zM778.24 712.96a32 32 0 0 1-45.248 45.248l-135.68-135.68a32 32 0 1 1 45.248-45.248l135.68 135.68zM141.76 311.04a32 32 0 0 1-45.248-45.248l135.68-135.68a32 32 0 1 1 45.248 45.248l-135.68 135.68z"/></svg>',
      };

      createApp({
        components: {
          Loading,
        },
        setup() {
          // 响应式数据
          const loading = ref(false);
          const milestones = ref([]);
          const showAddDialog = ref(false);
          const milestoneForm = ref({
            name: "",
            description: "",
            startTime: "",
            endTime: "",
            priority: "medium",
          });

          // 计算属性
          const overallProgress = ref(0);
          const projectStartTime = ref("2024-01-15");
          const projectEndTime = ref("2024-06-30");
          const stats = ref({
            completed: 0,
            progress: 0,
            planned: 0,
            delayed: 0,
          });

          // 模拟里程碑数据
          const mockMilestones = [
            {
              id: 1,
              name: "需求分析完成",
              description: "完成项目需求调研和分析，确定技术方案",
              status: "completed",
              progress: 100,
              startTime: "2024-01-15",
              endTime: "2024-01-31",
            },
            {
              id: 2,
              name: "系统设计完成",
              description: "完成系统架构设计和数据库设计",
              status: "completed",
              progress: 100,
              startTime: "2024-02-01",
              endTime: "2024-02-15",
            },
            {
              id: 3,
              name: "核心功能开发",
              description: "开发系统核心功能模块",
              status: "progress",
              progress: 65,
              startTime: "2024-02-16",
              endTime: "2024-04-15",
            },
            {
              id: 4,
              name: "系统测试",
              description: "进行系统功能测试和性能测试",
              status: "planned",
              progress: 0,
              startTime: "2024-04-16",
              endTime: "2024-05-15",
            },
            {
              id: 5,
              name: "项目验收",
              description: "项目最终验收和交付",
              status: "planned",
              progress: 0,
              startTime: "2024-05-16",
              endTime: "2024-06-30",
            },
          ];

          // 获取状态文本
          const getStatusText = (status) => {
            const statusMap = {
              planned: "未开始",
              progress: "进行中",
              completed: "已完成",
              delayed: "已延期",
            };
            return statusMap[status] || "未知";
          };

          // 计算整体进度
          const calculateOverallProgress = () => {
            if (milestones.value.length === 0) {
              overallProgress.value = 0;
              return;
            }

            const totalProgress = milestones.value.reduce((sum, milestone) => {
              return sum + milestone.progress;
            }, 0);

            overallProgress.value = Math.round(
              totalProgress / milestones.value.length
            );
          };

          // 计算统计数据
          const calculateStats = () => {
            stats.value = {
              completed: milestones.value.filter(
                (m) => m.status === "completed"
              ).length,
              progress: milestones.value.filter((m) => m.status === "progress")
                .length,
              planned: milestones.value.filter((m) => m.status === "planned")
                .length,
              delayed: milestones.value.filter((m) => m.status === "delayed")
                .length,
            };
          };

          // 加载里程碑数据
          const loadMilestones = async () => {
            loading.value = true;
            try {
              // 模拟API调用
              await new Promise((resolve) => setTimeout(resolve, 1000));

              milestones.value = mockMilestones;
              calculateOverallProgress();
              calculateStats();
            } catch (error) {
              ElMessage.error("加载里程碑数据失败");
            } finally {
              loading.value = false;
            }
          };

          // 返回详情页
          const handleBack = () => {
            ElMessage.info("返回项目详情");
            // 检查是否在iframe中
            if (window.parent !== window) {
              window.parent.postMessage(
                {
                  type: "navigate",
                  path: "project/detail",
                },
                "*"
              );
            } else {
              window.location.href = "项目详情.html";
            }
          };

          // 编辑里程碑
          const handleEditMilestone = (milestoneId) => {
            ElMessage.info(`编辑里程碑: ${milestoneId}`);
            // 这里应该打开编辑里程碑对话框
          };

          // 删除里程碑
          const handleDeleteMilestone = async (milestoneId) => {
            try {
              await ElMessageBox.confirm(
                "确定要删除这个里程碑吗？",
                "确认删除",
                {
                  confirmButtonText: "确定",
                  cancelButtonText: "取消",
                  type: "warning",
                }
              );

              ElMessage.success("里程碑删除成功");
              // 这里应该调用API删除里程碑
              loadMilestones();
            } catch (error) {
              // 用户取消删除
            }
          };

          // 关闭对话框
          const handleCloseDialog = () => {
            showAddDialog.value = false;
            milestoneForm.value = {
              name: "",
              description: "",
              startTime: "",
              endTime: "",
              priority: "medium",
            };
          };

          // 添加里程碑
          const handleAddMilestone = () => {
            if (!milestoneForm.value.name.trim()) {
              ElMessage.warning("请输入里程碑名称");
              return;
            }

            if (
              !milestoneForm.value.startTime ||
              !milestoneForm.value.endTime
            ) {
              ElMessage.warning("请选择开始时间和结束时间");
              return;
            }

            ElMessage.success("里程碑添加成功");
            handleCloseDialog();
            loadMilestones();
          };

          // 组件挂载时加载数据
          onMounted(() => {
            console.log("项目进度页面加载中...");
            loadMilestones();
          });

          return {
            loading,
            milestones,
            showAddDialog,
            milestoneForm,
            overallProgress,
            projectStartTime,
            projectEndTime,
            stats,
            getStatusText,
            handleBack,
            handleEditMilestone,
            handleDeleteMilestone,
            handleCloseDialog,
            handleAddMilestone,
          };
        },
      })
        .use(ElementPlus)
        .mount("#app");
    </script>
  </body>
</html>
