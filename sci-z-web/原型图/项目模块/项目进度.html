<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>项目进度 - 高校科研项目管理平台</title>
    <link rel="icon" href="../images/favicon.ico" type="image/x-icon" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/element-plus@2.3.14/dist/index.css"
    />
    <script src="https://unpkg.com/vue@3.2.47/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/element-plus@2.3.14"></script>
    <link rel="stylesheet" href="../通用规范/样式.css" />
    <style>
      .project-progress-container {
        padding: 20px;
        background: #f7f9fc;
        min-height: calc(100vh - 56px);
      }

      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .page-title {
        font-size: 24px;
        font-weight: 600;
        color: #1e3a8a;
        margin: 0;
      }

      .content-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .card {
        background: #ffffff;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        border: 1px solid #e5e7eb;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e5e7eb;
      }

      .card-title {
        font-size: 16px;
        font-weight: 600;
        color: #111827;
        margin: 0;
      }

      /* 进度概览样式 */
      .progress-overview {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .overall-progress {
        text-align: center;
        padding: 20px;
        background: #f8fafc;
        border-radius: 8px;
      }

      .progress-percentage {
        font-size: 48px;
        font-weight: 700;
        color: #1e3a8a;
        margin-bottom: 8px;
      }

      .progress-label {
        font-size: 16px;
        color: #6b7280;
        margin-bottom: 16px;
      }

      .progress-bar-large {
        width: 100%;
        height: 12px;
        background: #e5e7eb;
        border-radius: 6px;
        overflow: hidden;
        margin-bottom: 16px;
      }

      .progress-fill-large {
        height: 100%;
        background: linear-gradient(90deg, #1e3a8a 0%, #0ea5e9 100%);
        border-radius: 6px;
        transition: width 0.5s ease;
      }

      .progress-time {
        display: flex;
        justify-content: space-between;
        font-size: 14px;
        color: #6b7280;
      }

      .progress-stats {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
      }

      .stat-item {
        text-align: center;
        padding: 16px;
        background: #f8fafc;
        border-radius: 8px;
      }

      .stat-number {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 4px;
      }

      .stat-label {
        font-size: 12px;
        color: #6b7280;
      }

      .stat-completed .stat-number {
        color: #16a34a;
      }

      .stat-progress .stat-number {
        color: #f59e0b;
      }

      .stat-planned .stat-number {
        color: #2563eb;
      }

      .stat-delayed .stat-number {
        color: #dc2626;
      }

      /* 里程碑列表样式 */
      .milestone-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .milestone-item {
        padding: 16px;
        background: #f8fafc;
        border-radius: 8px;
        border-left: 4px solid #e5e7eb;
      }

      .milestone-item.completed {
        border-left-color: #16a34a;
        background: #f0fdf4;
      }

      .milestone-item.progress {
        border-left-color: #f59e0b;
        background: #fffbeb;
      }

      .milestone-item.planned {
        border-left-color: #2563eb;
        background: #eff6ff;
      }

      .milestone-item.delayed {
        border-left-color: #dc2626;
        background: #fef2f2;
      }

      .milestone-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .milestone-name {
        font-size: 16px;
        font-weight: 600;
        color: #111827;
      }

      .milestone-status {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
      }

      .status-completed {
        background: #d1fae5;
        color: #059669;
      }

      .status-progress {
        background: #fef3c7;
        color: #d97706;
      }

      .status-planned {
        background: #dbeafe;
        color: #1e40af;
      }

      .status-delayed {
        background: #fee2e2;
        color: #dc2626;
      }

      .milestone-description {
        font-size: 14px;
        color: #6b7280;
        margin-bottom: 12px;
      }

      .milestone-progress {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 8px;
      }

      .milestone-progress-bar {
        flex: 1;
        height: 6px;
        background: #e5e7eb;
        border-radius: 3px;
        overflow: hidden;
      }

      .milestone-progress-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.3s ease;
      }

      .milestone-progress-fill.completed {
        background: #16a34a;
      }

      .milestone-progress-fill.progress {
        background: #f59e0b;
      }

      .milestone-progress-fill.planned {
        background: #2563eb;
      }

      .milestone-progress-fill.delayed {
        background: #dc2626;
      }

      .milestone-progress-text {
        font-size: 12px;
        color: #6b7280;
        min-width: 35px;
      }

      .milestone-time {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: #9ca3af;
      }

      .milestone-actions {
        display: flex;
        gap: 8px;
        margin-top: 12px;
      }

      /* 时间轴视图样式 */
      .timeline-container {
        position: relative;
        padding-left: 24px;
      }

      .timeline-line {
        position: absolute;
        left: 12px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #e5e7eb;
      }

      .timeline-item {
        position: relative;
        margin-bottom: 24px;
        padding-left: 24px;
      }

      .timeline-dot {
        position: absolute;
        left: -6px;
        top: 8px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 3px solid #ffffff;
        box-shadow: 0 0 0 2px #e5e7eb;
      }

      .timeline-dot.completed {
        background: #16a34a;
        box-shadow: 0 0 0 2px #16a34a;
      }

      .timeline-dot.progress {
        background: #f59e0b;
        box-shadow: 0 0 0 2px #f59e0b;
      }

      .timeline-dot.planned {
        background: #2563eb;
        box-shadow: 0 0 0 2px #2563eb;
      }

      .timeline-dot.delayed {
        background: #dc2626;
        box-shadow: 0 0 0 2px #dc2626;
      }

      .timeline-content {
        background: #ffffff;
        border-radius: 8px;
        padding: 16px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
      }

      .timeline-title {
        font-size: 16px;
        font-weight: 600;
        color: #111827;
        margin-bottom: 4px;
      }

      .timeline-time {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 8px;
      }

      .timeline-description {
        font-size: 14px;
        color: #374151;
        line-height: 1.5;
      }

      /* 添加里程碑对话框 */
      .milestone-form {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }

      .loading-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 40px;
        color: #6b7280;
        font-size: 14px;
      }

      .loading-container .el-icon {
        margin-right: 8px;
        font-size: 16px;
      }

      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #6b7280;
      }

      .empty-state-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
      }

      .empty-state-text {
        font-size: 16px;
        margin-bottom: 8px;
      }

      .empty-state-hint {
        font-size: 14px;
        color: #9ca3af;
      }

      /* 新增样式 */
      .info-section {
        padding: 16px;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
      }

      .stat-card {
        text-align: center;
        padding: 12px;
        background: #ffffff;
        border-radius: 6px;
        border: 1px solid #e5e7eb;
      }

      .timeline-progress {
        margin-top: 8px;
      }

      /* 响应式设计 */
      @media (max-width: 768px) {
        .content-grid {
          grid-template-columns: 1fr;
        }

        .progress-stats {
          grid-template-columns: repeat(2, 1fr);
        }

        .form-row {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="project-progress-container">
        <!-- 页面头部 -->
        <div class="page-header">
          <div style="display: flex; align-items: center; gap: 16px">
            <el-button @click="handleBack">
              <el-icon><ArrowLeft /></el-icon>
              返回列表
            </el-button>
            <h1 class="page-title">项目进度</h1>
          </div>
        </div>

        <!-- 加载状态 -->
        <div v-if="loading" class="loading-container">
          <el-icon class="is-loading"><Loading /></el-icon>
          <span>加载中...</span>
        </div>

        <!-- 主要内容 -->
        <div v-else>
          <!-- 项目概览 -->
          <div class="card" style="margin-bottom: 20px">
            <div class="card-header">
              <h2 class="card-title">项目概览</h2>
            </div>

            <div
              style="
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                gap: 20px;
              "
            >
              <!-- 项目基本信息 -->
              <div class="info-section">
                <h3
                  style="
                    font-size: 16px;
                    font-weight: 600;
                    color: #374151;
                    margin-bottom: 12px;
                  "
                >
                  项目信息
                </h3>
                <div style="display: flex; flex-direction: column; gap: 8px">
                  <div style="display: flex; justify-content: space-between">
                    <span style="color: #6b7280">项目名称：</span>
                    <span style="color: #111827; font-weight: 500"
                      >{{ projectInfo.name }}</span
                    >
                  </div>
                  <div style="display: flex; justify-content: space-between">
                    <span style="color: #6b7280">项目编号：</span>
                    <span style="color: #111827; font-weight: 500"
                      >{{ projectInfo.number }}</span
                    >
                  </div>
                  <div style="display: flex; justify-content: space-between">
                    <span style="color: #6b7280">项目负责人：</span>
                    <span style="color: #111827; font-weight: 500"
                      >{{ projectInfo.manager }}</span
                    >
                  </div>
                  <div style="display: flex; justify-content: space-between">
                    <span style="color: #6b7280">项目状态：</span>
                    <span
                      class="status-tag"
                      :class="`status-${projectInfo.status}`"
                      >{{ getStatusText(projectInfo.status) }}</span
                    >
                  </div>
                </div>
              </div>

              <!-- 进度统计 -->
              <div class="info-section">
                <h3
                  style="
                    font-size: 16px;
                    font-weight: 600;
                    color: #374151;
                    margin-bottom: 12px;
                  "
                >
                  进度统计
                </h3>
                <div
                  style="
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 12px;
                  "
                >
                  <div class="stat-card">
                    <div
                      style="font-size: 24px; font-weight: 700; color: #16a34a"
                    >
                      {{ stats.completed }}
                    </div>
                    <div style="font-size: 12px; color: #6b7280">已完成</div>
                  </div>
                  <div class="stat-card">
                    <div
                      style="font-size: 24px; font-weight: 700; color: #f59e0b"
                    >
                      {{ stats.progress }}
                    </div>
                    <div style="font-size: 12px; color: #6b7280">进行中</div>
                  </div>
                  <div class="stat-card">
                    <div
                      style="font-size: 24px; font-weight: 700; color: #2563eb"
                    >
                      {{ stats.planned }}
                    </div>
                    <div style="font-size: 12px; color: #6b7280">未开始</div>
                  </div>
                  <div class="stat-card">
                    <div
                      style="font-size: 24px; font-weight: 700; color: #dc2626"
                    >
                      {{ stats.delayed }}
                    </div>
                    <div style="font-size: 12px; color: #6b7280">已延期</div>
                  </div>
                </div>
              </div>

              <!-- 整体进度 -->
              <div class="info-section">
                <h3
                  style="
                    font-size: 16px;
                    font-weight: 600;
                    color: #374151;
                    margin-bottom: 12px;
                  "
                >
                  整体进度
                </h3>
                <div style="text-align: center">
                  <div
                    style="
                      font-size: 36px;
                      font-weight: 700;
                      color: #1e3a8a;
                      margin-bottom: 8px;
                    "
                  >
                    {{ overallProgress }}%
                  </div>
                  <div class="progress-bar-large" style="margin-bottom: 12px">
                    <div
                      class="progress-fill-large"
                      :style="{ width: overallProgress + '%' }"
                    ></div>
                  </div>
                  <div style="font-size: 12px; color: #6b7280">
                    <div>开始时间：{{ projectStartTime }}</div>
                    <div>预计完成：{{ projectEndTime }}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 时间轴视图 -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">时间轴视图</h2>
          </div>

          <div v-if="milestones.length > 0" class="timeline-container">
            <div class="timeline-line"></div>
            <div
              v-for="milestone in milestones"
              :key="milestone.id"
              class="timeline-item"
            >
              <div :class="`timeline-dot ${milestone.status}`"></div>
              <div class="timeline-content">
                <div class="timeline-title">{{ milestone.name }}</div>
                <div class="timeline-time">
                  {{ milestone.startTime }} - {{ milestone.endTime }}
                </div>
                <div class="timeline-description">
                  {{ milestone.description }}
                </div>
                <div class="timeline-progress">
                  <div
                    style="
                      display: flex;
                      align-items: center;
                      gap: 8px;
                      margin-top: 8px;
                    "
                  >
                    <div
                      style="
                        flex: 1;
                        height: 6px;
                        background: #e5e7eb;
                        border-radius: 3px;
                        overflow: hidden;
                      "
                    >
                      <div
                        :class="`milestone-progress-fill ${milestone.status}`"
                        :style="{ width: milestone.progress + '%' }"
                      ></div>
                    </div>
                    <span
                      style="font-size: 12px; color: #6b7280; min-width: 35px"
                      >{{ milestone.progress }}%</span
                    >
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 空状态 -->
          <div v-else class="empty-state">
            <div class="empty-state-icon">📅</div>
            <div class="empty-state-text">暂无时间轴数据</div>
            <div class="empty-state-hint">项目里程碑将在此显示</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const { createApp, ref, onMounted } = Vue;
      const { ElMessage, ElMessageBox } = ElementPlus;

      // 注册Loading图标
      const Loading = {
        template:
          '<svg class="el-icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M512 64a32 32 0 0 1 32 32v192a32 32 0 0 1-64 0V96a32 32 0 0 1 32-32zm0 896a32 32 0 0 1-32-32V736a32 32 0 0 1 64 0v192a32 32 0 0 1-32 32zm448-480a32 32 0 0 1-32 32H736a32 32 0 0 1 0-64h192a32 32 0 0 1 32 32zM96 512a32 32 0 0 1 32-32h192a32 32 0 0 1 0 64H128a32 32 0 0 1-32-32zm778.24-200.96a32 32 0 0 1 45.248 45.248l-135.68 135.68a32 32 0 1 1-45.248-45.248l135.68-135.68zm-636.48 636.48a32 32 0 0 1 45.248 45.248l-135.68 135.68a32 32 0 1 1-45.248-45.248l135.68-135.68zM778.24 712.96a32 32 0 0 1-45.248 45.248l-135.68-135.68a32 32 0 1 1 45.248-45.248l135.68 135.68zM141.76 311.04a32 32 0 0 1-45.248-45.248l135.68-135.68a32 32 0 1 1 45.248 45.248l-135.68 135.68z"/></svg>',
      };

      createApp({
        components: {
          Loading,
        },
        setup() {
          // 响应式数据
          const loading = ref(false);
          const milestones = ref([]);

          // 计算属性
          const overallProgress = ref(0);
          const projectStartTime = ref("2024-01-15");
          const projectEndTime = ref("2024-06-30");
          const stats = ref({
            completed: 0,
            progress: 0,
            planned: 0,
            delayed: 0,
          });

          // 项目信息（从外部传入）
          const projectInfo = ref({
            name: "基于人工智能的智能诊断系统研究",
            number: "PRJ-2024-001",
            manager: "张教授",
            status: "progress",
          });

          // 生成里程碑数据（基于传入的进度百分比动态生成）
          const generateMilestonesFromProgress = (progress) => {
            const baseMilestones = [
              {
                id: 1,
                name: "项目启动：建设方案通过审核并备案",
                description:
                  "项目启动阶段，完成建设方案的制定、审核和备案工作，确保项目合法合规进行",
                startTime: "2024-01-15",
                endTime: "2024-01-31",
              },
              {
                id: 2,
                name: "任务分解与资源准备：项目任务书下达，资源配置完成，进入实施阶段",
                description:
                  "完成项目任务分解，下达项目任务书，完成人员、设备等资源配置，正式进入项目实施阶段",
                startTime: "2024-02-01",
                endTime: "2024-02-15",
              },
              {
                id: 3,
                name: "项目实施与过程管理：中期检查",
                description:
                  "项目实施阶段，进行中期检查，评估项目进展，确保项目按计划推进",
                startTime: "2024-02-16",
                endTime: "2024-04-15",
              },
              {
                id: 4,
                name: "成果整合与结题准备：结题验收",
                description: "整合项目成果，准备结题材料，进行项目结题验收工作",
                startTime: "2024-04-16",
                endTime: "2024-05-31",
              },
              {
                id: 5,
                name: "后续管理与成果转化：项目归档完成，成果转化",
                description:
                  "完成项目归档工作，推进成果转化应用，确保项目价值的最大化实现",
                startTime: "2024-06-01",
                endTime: "2024-06-30",
              },
            ];

            // 根据进度百分比分配里程碑状态和进度
            return baseMilestones.map((milestone, index) => {
              let status, milestoneProgress;

              if (progress >= 80) {
                // 80%以上：前4个已完成，第5个进行中
                if (index < 4) {
                  status = "completed";
                  milestoneProgress = 100;
                } else {
                  status = "progress";
                  milestoneProgress = Math.min(100, (progress - 80) * 5);
                }
              } else if (progress >= 60) {
                // 60-80%：前3个已完成，第4个进行中，第5个未开始
                if (index < 3) {
                  status = "completed";
                  milestoneProgress = 100;
                } else if (index === 3) {
                  status = "progress";
                  milestoneProgress = Math.min(100, (progress - 60) * 5);
                } else {
                  status = "planned";
                  milestoneProgress = 0;
                }
              } else if (progress >= 40) {
                // 40-60%：前2个已完成，第3个进行中，后2个未开始
                if (index < 2) {
                  status = "completed";
                  milestoneProgress = 100;
                } else if (index === 2) {
                  status = "progress";
                  milestoneProgress = Math.min(100, (progress - 40) * 5);
                } else {
                  status = "planned";
                  milestoneProgress = 0;
                }
              } else if (progress >= 20) {
                // 20-40%：第1个已完成，第2个进行中，后3个未开始
                if (index === 0) {
                  status = "completed";
                  milestoneProgress = 100;
                } else if (index === 1) {
                  status = "progress";
                  milestoneProgress = Math.min(100, (progress - 20) * 5);
                } else {
                  status = "planned";
                  milestoneProgress = 0;
                }
              } else {
                // 20%以下：第1个进行中，其他未开始
                if (index === 0) {
                  status = "progress";
                  milestoneProgress = Math.min(100, progress * 5);
                } else {
                  status = "planned";
                  milestoneProgress = 0;
                }
              }

              return {
                ...milestone,
                status,
                progress: milestoneProgress,
              };
            });
          };

          // 模拟里程碑数据（基于新建项目.html中的5个里程碑）
          const mockMilestones = [
            {
              id: 1,
              name: "项目启动：建设方案通过审核并备案",
              description:
                "项目启动阶段，完成建设方案的制定、审核和备案工作，确保项目合法合规进行",
              status: "completed",
              progress: 100,
              startTime: "2024-01-15",
              endTime: "2024-01-31",
            },
            {
              id: 2,
              name: "任务分解与资源准备：项目任务书下达，资源配置完成，进入实施阶段",
              description:
                "完成项目任务分解，下达项目任务书，完成人员、设备等资源配置，正式进入项目实施阶段",
              status: "completed",
              progress: 100,
              startTime: "2024-02-01",
              endTime: "2024-02-15",
            },
            {
              id: 3,
              name: "项目实施与过程管理：中期检查",
              description:
                "项目实施阶段，进行中期检查，评估项目进展，确保项目按计划推进",
              status: "progress",
              progress: 75,
              startTime: "2024-02-16",
              endTime: "2024-04-15",
            },
            {
              id: 4,
              name: "成果整合与结题准备：结题验收",
              description: "整合项目成果，准备结题材料，进行项目结题验收工作",
              status: "planned",
              progress: 0,
              startTime: "2024-04-16",
              endTime: "2024-05-31",
            },
            {
              id: 5,
              name: "后续管理与成果转化：项目归档完成，成果转化",
              description:
                "完成项目归档工作，推进成果转化应用，确保项目价值的最大化实现",
              status: "planned",
              progress: 0,
              startTime: "2024-06-01",
              endTime: "2024-06-30",
            },
          ];

          // 获取状态文本
          const getStatusText = (status) => {
            const statusMap = {
              planned: "未开始",
              progress: "进行中",
              completed: "已完成",
              delayed: "已延期",
            };
            return statusMap[status] || "未知";
          };

          // 计算整体进度（基于传入的进度百分比）
          const calculateOverallProgress = () => {
            // 如果已经有进度值，不要覆盖
            if (overallProgress.value > 0) {
              console.log("使用已有的进度值:", overallProgress.value);
              return;
            }

            // 检查URL参数
            const params = new URLSearchParams(window.location.search);
            const progressFromURL = params.get("progress");

            if (progressFromURL) {
              // 如果已经有URL传入的进度值，不要覆盖
              console.log("使用URL传入的进度值:", overallProgress.value);
              return;
            } else {
              // 否则根据里程碑计算
              if (milestones.value.length === 0) {
                overallProgress.value = 0;
                return;
              }

              const totalProgress = milestones.value.reduce(
                (sum, milestone) => {
                  return sum + milestone.progress;
                },
                0
              );

              overallProgress.value = Math.round(
                totalProgress / milestones.value.length
              );
            }
          };

          // 计算统计数据（基于传入的进度百分比动态计算）
          const calculateStats = () => {
            // 直接使用当前的overallProgress值
            const progress = overallProgress.value;
            console.log("根据当前进度计算统计数据:", progress);

            if (progress >= 80) {
              stats.value = {
                completed: 4,
                progress: 1,
                planned: 0,
                delayed: 0,
              };
            } else if (progress >= 60) {
              stats.value = {
                completed: 3,
                progress: 1,
                planned: 2,
                delayed: 0,
              };
            } else if (progress >= 40) {
              stats.value = {
                completed: 2,
                progress: 1,
                planned: 2,
                delayed: 0,
              };
            } else if (progress >= 20) {
              stats.value = {
                completed: 1,
                progress: 1,
                planned: 3,
                delayed: 0,
              };
            } else {
              stats.value = {
                completed: 0,
                progress: 1,
                planned: 4,
                delayed: 0,
              };
            }
          };

          // 存储从外部传入的项目数据
          // 移除externalProjectData变量，直接使用Vue响应式数据

          // 解析URL参数获取项目数据
          const getProjectDataFromURL = () => {
            const params = new URLSearchParams(window.location.search);
            const projectId = params.get("id");
            const progress = params.get("progress");
            const name = params.get("name");
            const number = params.get("number");
            const manager = params.get("manager");
            const status = params.get("status");

            if (projectId && progress) {
              // 直接更新Vue响应式数据
              projectInfo.value = {
                name: name || "基于人工智能的智能诊断系统研究",
                number: number || "PRJ-2024-001",
                manager: manager || "张教授",
                status: status || "progress",
              };

              // 直接设置整体进度
              overallProgress.value = parseInt(progress) || 0;
              console.log("从URL设置进度:", overallProgress.value);

              return true; // 表示有URL参数
            }
            return false; // 表示没有URL参数
          };

          // 监听iframe消息
          const handleIframeMessage = (event) => {
            console.log("收到iframe消息:", event.data);
            if (
              event.data &&
              event.data.type === "navigate" &&
              event.data.path === "project/progress"
            ) {
              const params = event.data.params;
              if (params) {
                console.log("收到iframe参数:", params);

                // 直接更新Vue响应式数据
                projectInfo.value = {
                  name: params.name || "基于人工智能的智能诊断系统研究",
                  number: params.number || "PRJ-2024-001",
                  manager: params.manager || "张教授",
                  status: params.status || "progress",
                };

                // 直接设置整体进度
                overallProgress.value = parseInt(params.progress) || 0;
                console.log("直接设置进度:", overallProgress.value);

                // 根据进度生成里程碑数据
                milestones.value = generateMilestonesFromProgress(
                  overallProgress.value
                );

                // 计算统计数据
                calculateStats();

                console.log("最终进度值:", overallProgress.value);
                console.log("最终统计数据:", stats.value);
              }
            }
          };

          // 加载里程碑数据（不重新计算整体进度）
          const loadMilestonesWithoutRecalculatingProgress = async () => {
            loading.value = true;
            try {
              // 模拟API调用
              await new Promise((resolve) => setTimeout(resolve, 1000));

              // 检查URL参数
              const params = new URLSearchParams(window.location.search);
              const progressFromURL = params.get("progress");

              if (progressFromURL) {
                const progress = parseInt(progressFromURL);
                console.log("从URL动态生成里程碑数据，进度:", progress);
                milestones.value = generateMilestonesFromProgress(progress);
                overallProgress.value = progress;
              } else {
                console.log("使用默认里程碑数据");
                milestones.value = mockMilestones;
              }

              // 只计算统计数据，不重新计算整体进度
              calculateStats();

              console.log("最终进度值:", overallProgress.value);
              console.log("最终统计数据:", stats.value);
              console.log("最终里程碑数据:", milestones.value);
            } catch (error) {
              ElMessage.error("加载里程碑数据失败");
            } finally {
              loading.value = false;
            }
          };

          // 加载里程碑数据
          const loadMilestones = async () => {
            loading.value = true;
            try {
              // 模拟API调用
              await new Promise((resolve) => setTimeout(resolve, 1000));

              // 检查URL参数
              const params = new URLSearchParams(window.location.search);
              const progressFromURL = params.get("progress");

              if (progressFromURL) {
                const progress = parseInt(progressFromURL);
                console.log("从URL动态生成里程碑数据，进度:", progress);
                milestones.value = generateMilestonesFromProgress(progress);
                overallProgress.value = progress;
              } else {
                console.log("使用默认里程碑数据");
                milestones.value = mockMilestones;
              }

              // 先计算统计数据，再计算整体进度
              calculateStats();
              calculateOverallProgress();

              console.log("最终进度值:", overallProgress.value);
              console.log("最终统计数据:", stats.value);
              console.log("最终里程碑数据:", milestones.value);
            } catch (error) {
              console.error("加载里程碑数据失败:", error);
              ElMessage.error("加载里程碑数据失败");
            } finally {
              loading.value = false;
            }
          };

          // 返回列表页
          const handleBack = () => {
            ElMessage.info("返回项目列表");
            // 检查是否在iframe中
            if (window.parent !== window) {
              window.parent.postMessage(
                {
                  type: "navigate",
                  path: "project/list",
                },
                "*"
              );
            } else {
              window.location.href = "项目列表.html";
            }
          };

          // 组件挂载时加载数据
          onMounted(() => {
            console.log("项目进度页面加载中...");
            console.log("当前URL:", window.location.href);
            console.log(
              "URL参数:",
              new URLSearchParams(window.location.search).toString()
            );

            // 监听iframe消息
            window.addEventListener("message", handleIframeMessage);

            // 先尝试获取URL参数
            const hasURLParams = getProjectDataFromURL();

            // 如果没有URL参数，延迟加载默认数据，给iframe消息留出时间
            if (!hasURLParams) {
              console.log("没有URL参数，延迟加载默认数据");
              setTimeout(() => {
                // 检查是否已经通过iframe消息设置了数据
                if (overallProgress.value === 0) {
                  console.log("iframe消息未到达，使用默认数据");
                  loadMilestones();
                } else {
                  console.log("iframe消息已处理，跳过默认数据");
                }
              }, 200);
            }
          });

          return {
            loading,
            milestones,
            overallProgress,
            projectStartTime,
            projectEndTime,
            stats,
            projectInfo,
            getStatusText,
            handleBack,
          };
        },
      })
        .use(ElementPlus)
        .mount("#app");
    </script>
  </body>
</html>
