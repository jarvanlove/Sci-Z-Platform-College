<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>项目详情 - 高校科研项目管理平台</title>
    <link rel="icon" href="../images/favicon.ico" type="image/x-icon" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/element-plus@2.3.14/dist/index.css"
    />
    <script src="https://unpkg.com/vue@3.2.47/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/element-plus@2.3.14"></script>
    <!-- Element Plus 中文本地化（修复 locale undefined 报错） -->
    <script src="https://unpkg.com/element-plus@2.3.14/dist/locale/zh-cn.js"></script>
    <script>
      // 确保 Element Plus 中文本地化正确加载
      window.ElementPlusLocaleZhCn = window.ElementPlusLocaleZhCn || {
        name: "zh-cn",
        el: {
          datepicker: {
            now: "此刻",
            today: "今天",
            cancel: "取消",
            clear: "清空",
            confirm: "确认",
            selectDate: "选择日期",
            selectTime: "选择时间",
            startDate: "开始日期",
            startTime: "开始时间",
            endDate: "结束日期",
            endTime: "结束时间",
            prevYear: "前一年",
            nextYear: "后一年",
            prevMonth: "上个月",
            nextMonth: "下个月",
            year: "年",
            month1: "1月",
            month2: "2月",
            month3: "3月",
            month4: "4月",
            month5: "5月",
            month6: "6月",
            month7: "7月",
            month8: "8月",
            month9: "9月",
            month10: "10月",
            month11: "11月",
            month12: "12月",
            weeks: {
              sun: "日",
              mon: "一",
              tue: "二",
              wed: "三",
              thu: "四",
              fri: "五",
              sat: "六",
            },
            months: {
              jan: "一月",
              feb: "二月",
              mar: "三月",
              apr: "四月",
              may: "五月",
              jun: "六月",
              jul: "七月",
              aug: "八月",
              sep: "九月",
              oct: "十月",
              nov: "十一月",
              dec: "十二月",
            },
          },
        },
      };
    </script>
    <link rel="stylesheet" href="../通用规范/样式.css" />
    <style>
      .project-detail-container {
        padding: 20px;
        background: #f7f9fc;
        min-height: calc(100vh - 56px);
      }

      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .page-title {
        font-size: 24px;
        font-weight: 600;
        color: #1e3a8a;
        margin: 0;
      }

      .main-content-single {
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin-bottom: 20px;
      }

      .card {
        background: #ffffff;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        border: 1px solid #e5e7eb;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e5e7eb;
      }

      .footer-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #e5e7eb;
        position: sticky;
        bottom: 0;
        background: #ffffff;
        padding-bottom: 12px;
        z-index: 10;
        box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.03);
      }

      .card-title {
        font-size: 16px;
        font-weight: 600;
        color: #1e3a8a;
        margin: 0;
      }

      .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }

      .info-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .info-label {
        font-size: 14px;
        color: #6b7280;
        font-weight: 500;
      }

      .info-value {
        font-size: 14px;
        color: #374151;
      }

      .status-tag {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
      }

      .status-progress {
        display: inline-block;
        background-color: #fef3c7;
        color: #f59e0b;
        padding: 2px 8px;
        border-radius: 12px;
        max-width: 120px;
        white-space: nowrap;
      }

      /* 成员管理样式 */
      .member-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .member-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: #f8fafc;
        border-radius: 6px;
      }

      .member-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6b7280;
        font-weight: 600;
      }

      .member-info {
        flex: 1;
      }

      .member-name {
        font-size: 14px;
        font-weight: 500;
        color: #374151;
        margin-bottom: 2px;
      }

      .member-role {
        font-size: 12px;
        color: #6b7280;
      }

      .member-actions {
        display: flex;
        gap: 8px;
      }

      .add-member-section {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid #e5e7eb;
      }

      .search-member {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
      }

      .search-results {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        background: #ffffff;
      }

      .search-result-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f3f4f6;
      }

      .search-result-item:hover {
        background: #f8fafc;
      }

      .search-result-item:last-child {
        border-bottom: none;
      }

      /* 文档管理样式 */
      .document-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .document-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: #f8fafc;
        border-radius: 6px;
      }

      .document-icon {
        width: 32px;
        height: 32px;
        border-radius: 4px;
        background: #dbeafe;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #1e40af;
      }

      .document-info {
        flex: 1;
      }

      .document-name {
        font-size: 14px;
        font-weight: 500;
        color: #374151;
        margin-bottom: 2px;
      }

      .document-meta {
        font-size: 12px;
        color: #6b7280;
      }

      .document-actions {
        display: flex;
        gap: 8px;
      }

      .upload-section {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid #e5e7eb;
      }

      .upload-area {
        border: 2px dashed #d1d5db;
        border-radius: 6px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: border-color 0.3s;
      }

      .upload-area:hover {
        border-color: #1e3a8a;
      }

      .upload-area.dragover {
        border-color: #1e3a8a;
        background: #f0f9ff;
      }

      /* 里程碑拖拽区域样式 */
      .milestone-documents .upload-area {
        border: 2px dashed #d1d5db;
        border-radius: 6px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: border-color 0.3s, background-color 0.3s;
      }

      .milestone-documents .upload-area:hover {
        border-color: #1e3a8a;
      }

      .milestone-documents .upload-area.dragover {
        border-color: #1e3a8a;
        background: #f0f9ff;
      }

      .upload-icon {
        font-size: 24px;
        color: #9ca3af;
        margin-bottom: 8px;
      }

      .upload-text {
        font-size: 14px;
        color: #6b7280;
        margin-bottom: 4px;
      }

      .upload-hint {
        font-size: 12px;
        color: #9ca3af;
      }

      /* 操作按钮区域 */
      .action-buttons {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #e5e7eb;
      }

      .loading-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 40px;
        color: #6b7280;
        font-size: 14px;
      }

      .loading-container .el-icon {
        margin-right: 8px;
        font-size: 16px;
      }

      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #6b7280;
      }

      .empty-state-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
      }

      .empty-state-text {
        font-size: 16px;
        margin-bottom: 8px;
      }

      .empty-state-hint {
        font-size: 14px;
        color: #9ca3af;
      }

      /* 弹窗内表单可读性（修复文字看不清的问题） + 与页面统一风格 */
      .el-dialog {
        font-family: inherit;
        color: #1f2937;
        border-radius: 12px !important;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12) !important;
      }
      .el-dialog .el-dialog__title {
        font-weight: 600;
        color: #1e3a8a;
        font-size: 18px;
      }
      .el-dialog .el-form-item__label {
        color: #374151;
        font-weight: 500;
        font-size: 14px;
      }
      .el-dialog .el-input__inner,
      .el-dialog input,
      .el-dialog .el-textarea__inner,
      .el-dialog .el-select .el-input__inner {
        color: #1f2937;
        font-size: 14px;
      }
      .el-dialog .el-input__inner::placeholder,
      .el-dialog input::placeholder,
      .el-dialog .el-textarea__inner::placeholder,
      .el-dialog .el-select .el-input__inner::placeholder {
        color: #9ca3af;
        font-size: 14px;
      }
      .el-dialog .el-option {
        color: #1f2937;
        font-size: 14px;
      }
      .el-dialog .el-option:hover {
        background-color: #f8fafc;
        color: #1f2937;
      }

      /* 自定义弹窗样式 */
      .el-message-box {
        border-radius: 12px !important;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12) !important;
      }

      .el-message-box__header {
        padding: 20px 24px 16px 24px !important;
        border-bottom: 1px solid #f0f0f0 !important;
        background: #ffffff !important;
      }

      .el-message-box__title {
        font-size: 16px !important;
        font-weight: 600 !important;
        color: #1f2937 !important;
        line-height: 1.5 !important;
      }

      .el-message-box__headerbtn {
        top: 16px !important;
        right: 20px !important;
        width: 24px !important;
        height: 24px !important;
      }

      .el-message-box__close {
        color: #9ca3af !important;
        font-size: 16px !important;
      }

      .el-message-box__close:hover {
        color: #6b7280 !important;
      }

      .el-message-box__content {
        padding: 20px 24px !important;
        background: #ffffff !important;
      }

      .el-message-box__message {
        font-size: 14px !important;
        line-height: 1.6 !important;
        color: #374151 !important;
        margin: 0 !important;
        padding: 0 !important;
      }

      .el-message-box__btns {
        padding: 16px 24px 20px 24px !important;
        background: #ffffff !important;
        display: flex !important;
        justify-content: flex-end !important;
        gap: 12px !important;
      }

      .el-message-box__btns .el-button {
        padding: 8px 20px !important;
        border-radius: 8px !important;
        font-size: 14px !important;
        font-weight: 500 !important;
        border: 1px solid !important;
        transition: all 0.2s ease !important;
      }

      .el-message-box__btns .el-button--default {
        background: #ffffff !important;
        border-color: #d1d5db !important;
        color: #6b7280 !important;
      }

      .el-message-box__btns .el-button--default:hover {
        background: #f9fafb !important;
        border-color: #9ca3af !important;
        color: #374151 !important;
      }

      .el-message-box__btns .el-button--primary {
        background: #1e3a8a !important;
        border-color: #1e3a8a !important;
        color: #ffffff !important;
      }

      .el-message-box__btns .el-button--primary:hover {
        background: #1e40af !important;
        border-color: #1e40af !important;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
      }

      .el-message-box__btns .el-button--primary:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(30, 58, 138, 0.3);
      }

      /* 警告类型弹窗的特殊样式 */
      .el-message-box--warning .el-message-box__content {
        position: relative;
      }

      .el-message-box--warning .el-message-box__message::before {
        content: "⚠️";
        font-size: 18px !important;
        margin-right: 8px !important;
        vertical-align: -0.15em !important;
        display: inline-block !important;
      }

      /* 响应式设计 */
      @media (max-width: 768px) {
        .content-grid {
          grid-template-columns: 1fr;
        }

        .info-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="project-detail-container">
        <!-- 页面头部 -->
        <div class="page-header">
          <div style="display: flex; align-items: center; gap: 16px">
            <el-button @click="handleBack">
              <el-icon><ArrowLeft /></el-icon>
              返回列表
            </el-button>
            <h1 class="page-title">
              {{ isEditMode ? '项目编辑' : '项目详情' }}
            </h1>
          </div>
        </div>

        <!-- 加载状态 -->
        <div v-if="loading" class="loading-container">
          <el-icon class="is-loading"><Loading /></el-icon>
          <span>加载中...</span>
        </div>

        <!-- 主要内容 -->
        <div v-else class="main-content-single">
          <!-- 基本信息 -->
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">基本信息</h2>
            </div>
            <div class="info-grid">
              <!-- 第一行：项目编号、项目名称 -->
              <div class="info-item">
                <span class="info-label">项目编号</span>
                <span class="info-value">{{ project.number }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">项目名称</span>
                <span class="info-value">{{ project.name }}</span>
              </div>

              <!-- 第二行：项目负责人、项目状态 -->
              <div class="info-item">
                <span class="info-label">项目负责人</span>
                <span class="info-value">{{ project.manager }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">项目状态</span>
                <span class="status-tag status-progress"
                  >{{ getStatusText(project.status) }}</span
                >
              </div>

              <!-- 第三行：课题发布部门、研究方向 -->
              <div class="info-item">
                <span class="info-label">课题发布部门</span>
                <span class="info-value"
                  >{{ project.department || '暂无' }}</span
                >
              </div>
              <div class="info-item">
                <span class="info-label">研究方向</span>
                <span class="info-value"
                  >{{ project.researchDirection || '暂无' }}</span
                >
              </div>

              <!-- 第四行：项目开始时间、项目结束时间 -->
              <div class="info-item">
                <span class="info-label">项目开始时间</span>
                <span class="info-value">{{ project.createTime }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">项目结束时间</span>
                <span class="info-value">{{ project.updateTime }}</span>
              </div>

              <!-- 第五行：项目预算 -->
              <div class="info-item">
                <span class="info-label">项目预算</span>
                <template v-if="isEditMode">
                  <el-input-number
                    v-model="project.budget"
                    :min="0"
                    :precision="2"
                    style="width: 100%"
                  />
                </template>
                <template v-else>
                  <span class="info-value"
                    >{{ Number(project.budget||0).toFixed(2) }} 元</span
                  >
                </template>
              </div>
            </div>

            <!-- 项目描述单独一行 -->
            <div class="info-item" style="margin-top: 16px">
              <span class="info-label">项目描述</span>
              <template v-if="isEditMode">
                <el-input
                  type="textarea"
                  :rows="3"
                  v-model="project.description"
                  placeholder="请输入项目描述"
                />
              </template>
              <template v-else>
                <span class="info-value">{{ project.description }}</span>
              </template>
            </div>
          </div>

          <!-- 成员管理 -->
          <div class="card">
            <div
              class="card-header"
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <h2 class="card-title">项目成员</h2>
              <el-button
                v-if="isEditMode"
                type="primary"
                size="small"
                @click="openMemberDialog"
              >
                <el-icon><Plus /></el-icon>
                添加成员
              </el-button>
            </div>

            <!-- 已选成员列表 -->
            <div v-if="members.length > 0">
              <div
                v-for="member in members"
                :key="member.id"
                class="member-item"
                style="
                  display: flex;
                  align-items: center;
                  gap: 12px;
                  padding: 16px;
                  background: #f8fafc;
                  border-radius: 8px;
                  margin-bottom: 12px;
                  border: 1px solid #e5e7eb;
                "
              >
                <div
                  style="
                    width: 48px;
                    height: 48px;
                    border-radius: 50%;
                    background: #e5e7eb;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: #374151;
                    font-weight: 500;
                    font-size: 18px;
                  "
                >
                  {{ member.name.charAt(0) }}
                </div>
                <div style="flex: 1">
                  <div
                    style="
                      font-weight: 500;
                      color: #374151;
                      font-size: 16px;
                      margin-bottom: 4px;
                    "
                  >
                    {{ member.name }}
                  </div>
                  <div style="font-size: 12px; color: #6b7280">
                    {{ getRoleText(member.role) }} · 加入时间: {{
                    member.joinTime }}
                  </div>
                </div>
                <el-button
                  v-if="isEditMode"
                  type="danger"
                  size="small"
                  @click="handleRemoveMember(member.id)"
                >
                  移除
                </el-button>
              </div>
            </div>

            <div v-else class="empty-state">
              <div class="empty-state-icon">👥</div>
              <div class="empty-state-text">暂无项目成员</div>
              <div class="empty-state-hint">请搜索并添加项目成员</div>
            </div>
          </div>

          <!-- 添加成员对话框 -->
          <el-dialog
            v-model="showMemberDialog"
            title="添加成员"
            width="600px"
            :close-on-click-modal="false"
          >
            <el-input
              v-model="memberSearchKeyword"
              placeholder="搜索成员（姓名或学工号）"
              clearable
              @keyup.enter="handleMemberSearch"
              @input="handleMemberSearch"
            >
              <template #prefix>
                <el-icon><Search /></el-icon>
              </template>
            </el-input>
            <div
              v-if="memberSearchResults.length > 0"
              class="search-results"
              style="margin-top: 12px"
            >
              <div
                v-for="user in memberSearchResults"
                :key="user.id"
                class="search-result-item"
                style="
                  display: flex;
                  align-items: center;
                  justify-content: space-between;
                  padding: 12px;
                  border: 1px solid #e5e7eb;
                  border-radius: 6px;
                  margin-bottom: 8px;
                  background: #ffffff;
                "
              >
                <div style="display: flex; align-items: center; gap: 12px">
                  <div
                    style="
                      width: 40px;
                      height: 40px;
                      border-radius: 50%;
                      background: #f3f4f6;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      color: #374151;
                      font-weight: 500;
                      font-size: 16px;
                    "
                  >
                    {{ user.name.charAt(0) }}
                  </div>
                  <div>
                    <div
                      style="
                        font-weight: 500;
                        color: #374151;
                        font-size: 14px;
                        margin-bottom: 4px;
                      "
                    >
                      {{ user.name }}
                    </div>
                    <!-- <div style="font-size:12px;color:#6b7280;">工号: {{ user.id }}</div> -->
                  </div>
                </div>
                <el-button
                  type="primary"
                  size="small"
                  :disabled="members.some(m=>m.id===user.id)"
                  @click="handleAddMember(user)"
                  style="min-width: 60px"
                >
                  {{ members.some(m=>m.id===user.id) ? '已添加' : '添加' }}
                </el-button>
              </div>
            </div>
            <div v-else class="empty-state" style="padding: 20px 0">
              <div class="empty-state-text">请输入关键词进行搜索</div>
            </div>
            <template #footer>
              <el-button @click="closeMemberDialog">关闭</el-button>
            </template>
          </el-dialog>

          <!-- 项目里程碑 -->
          <div class="card">
            <div
              class="card-header"
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <h2 class="card-title">项目里程碑</h2>
              <el-button
                v-if="isEditMode"
                type="primary"
                size="small"
                @click="openMilestoneDialog"
              >
                <el-icon><Plus /></el-icon>
                添加里程碑
              </el-button>
            </div>

            <!-- 空态提示：仅当没有里程碑时显示 -->
            <div
              v-if="milestones.length === 0"
              class="empty-state"
              style="padding: 20px 0"
            >
              <div class="empty-state-icon">🎯</div>
              <div class="empty-state-text">暂无里程碑</div>
              <div class="empty-state-hint">请添加项目里程碑</div>
            </div>

            <!-- 里程碑列表 -->
            <div v-if="milestones.length > 0">
              <div
                v-for="(milestone, index) in milestones"
                :key="index"
                class="milestone-item"
                style="
                  border: 1px solid #e5e7eb;
                  border-radius: 6px;
                  padding: 16px;
                  margin-bottom: 12px;
                  background: #fafafa;
                "
              >
                <div
                  class="milestone-header"
                  style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 12px;
                  "
                >
                  <span
                    class="milestone-title"
                    style="font-weight: 600; color: #1e3a8a"
                    >里程碑 {{ index + 1 }}</span
                  >
                  <el-button
                    v-if="isEditMode"
                    type="danger"
                    size="small"
                    @click="handleRemoveMilestone(index)"
                  >
                    删除
                  </el-button>
                </div>
                <div
                  class="milestone-content"
                  style="
                    display: grid;
                    grid-template-columns: 1fr 1fr 1fr 1fr;
                    gap: 12px;
                  "
                >
                  <el-form-item label="里程碑名称">
                    <el-input
                      v-model="milestone.name"
                      placeholder="请输入里程碑名称"
                      :disabled="!isEditMode"
                    />
                  </el-form-item>
                  <el-form-item label="开始时间">
                    <el-date-picker
                      v-model="milestone.startTime"
                      type="date"
                      placeholder="选择开始时间"
                      style="width: 100%"
                      format="YYYY-MM-DD"
                      value-format="YYYY-MM-DD"
                      :disabled="!isEditMode"
                    />
                  </el-form-item>
                  <el-form-item label="结束时间">
                    <el-date-picker
                      v-model="milestone.endTime"
                      type="date"
                      placeholder="选择结束时间"
                      style="width: 100%"
                      format="YYYY-MM-DD"
                      value-format="YYYY-MM-DD"
                      :disabled="!isEditMode"
                    />
                  </el-form-item>
                </div>
                <el-form-item label="描述">
                  <el-input
                    v-model="milestone.description"
                    type="textarea"
                    :rows="2"
                    placeholder="请输入里程碑描述"
                    :disabled="!isEditMode"
                  />
                </el-form-item>

                <!-- 里程碑文档管理 -->
                <div
                  class="milestone-documents"
                  style="
                    margin-top: 16px;
                    padding-top: 16px;
                    border-top: 1px solid #e5e7eb;
                  "
                >
                  <div style="margin-bottom: 12px">
                    <h4
                      style="
                        margin: 0;
                        font-size: 14px;
                        font-weight: 600;
                        color: #1e3a8a;
                      "
                    >
                      里程碑文档
                    </h4>
                  </div>

                  <!-- 文档列表 -->
                  <div
                    v-if="milestone.documents && milestone.documents.length > 0"
                    class="document-list"
                  >
                    <div
                      v-for="doc in milestone.documents"
                      :key="doc.id"
                      class="document-item"
                      style="
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        padding: 12px;
                        background: #f8fafc;
                        border-radius: 6px;
                        margin-bottom: 12px;
                      "
                    >
                      <div
                        style="
                          width: 32px;
                          height: 32px;
                          border-radius: 4px;
                          background: #dbeafe;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                          color: #1e40af;
                        "
                      >
                        📄
                      </div>
                      <div style="flex: 1">
                        <div style="font-weight: 500; color: #374151">
                          {{ doc.name }}
                        </div>
                        <div style="font-size: 12px; color: #6b7280">
                          {{ doc.type }} · {{ doc.uploader }} · {{
                          doc.uploadTime }} · {{ doc.size }}
                        </div>
                      </div>
                      <div>
                        <el-button size="small" @click="handlePreview(doc.id)"
                          >预览</el-button
                        >
                        <el-button size="small" @click="handleDownload(doc.id)"
                          >下载</el-button
                        >
                        <el-button
                          v-if="isEditMode"
                          size="small"
                          type="danger"
                          @click="handleDeleteMilestoneDoc(index, doc.id)"
                        >
                          删除
                        </el-button>
                      </div>
                    </div>
                  </div>

                  <div v-else class="empty-state">
                    <div class="empty-state-icon">📄</div>
                    <div class="empty-state-text">暂无文档</div>
                    <div class="empty-state-hint">上传里程碑相关文档</div>
                  </div>

                  <!-- 上传区域 -->
                  <div class="upload-section" style="margin-top: 12px">
                    <div
                      class="upload-area"
                      @click="triggerMilestoneUpload(index)"
                      @dragover.prevent="handleMilestoneDragOver(index)"
                      @dragleave.prevent="handleMilestoneDragLeave(index)"
                      @drop.prevent="handleMilestoneDrop($event, index)"
                      :class="{ dragover: milestonesDragOver[index] }"
                      style="
                        border: 2px dashed #d1d5db;
                        border-radius: 6px;
                        padding: 20px;
                        text-align: center;
                        cursor: pointer;
                      "
                    >
                      <div
                        class="upload-icon"
                        style="
                          font-size: 24px;
                          color: #9ca3af;
                          margin-bottom: 8px;
                        "
                      >
                        <el-icon><Upload /></el-icon>
                      </div>
                      <div
                        class="upload-text"
                        style="
                          font-size: 14px;
                          color: #6b7280;
                          margin-bottom: 4px;
                        "
                      >
                        点击上传或拖拽文件到此处
                      </div>
                      <div
                        class="upload-hint"
                        style="font-size: 12px; color: #9ca3af"
                      >
                        支持
                        PDF、DOC、DOCX、XLS、XLSX、PPT、TXT、MD、图片、压缩包等格式
                      </div>
                    </div>
                    <input
                      :id="`milestoneFileInput${index}`"
                      type="file"
                      multiple
                      style="display: none"
                      @change="handleMilestoneFileSelect($event, index)"
                      accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.md,.rtf,.jpg,.jpeg,.png,.gif,.bmp,.svg,.webp,.zip,.rar,.7z,.tar,.gz,.mp4,.avi,.mov,.wmv,.flv,.mp3,.wav,.flac,.aac"
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 新增里程碑对话框 -->
          <el-dialog
            v-model="showMilestoneDialog"
            title="新增里程碑"
            width="700px"
            :close-on-click-modal="false"
          >
            <div
              class="form-row"
              style="display: flex; gap: 20px; margin-bottom: 20px"
            >
              <el-form-item label="里程碑名称" style="flex: 1 1 100%">
                <el-select
                  v-model="milestoneDraft.name"
                  placeholder="请选择里程碑名称"
                  style="width: 100%"
                >
                  <el-option
                    v-for="opt in milestoneOptions"
                    :key="opt"
                    :label="opt"
                    :value="opt"
                    :disabled="addedMilestoneNames && addedMilestoneNames.includes(opt)"
                  />
                </el-select>
              </el-form-item>
            </div>
            <div
              class="form-row"
              style="display: flex; gap: 20px; margin-bottom: 20px"
            >
              <el-form-item label="开始时间" style="flex: 1">
                <el-date-picker
                  v-model="milestoneDraft.startTime"
                  type="date"
                  placeholder="选择开始时间"
                  style="width: 100%"
                  format="YYYY-MM-DD"
                  value-format="YYYY-MM-DD"
                />
              </el-form-item>
              <el-form-item label="结束时间" style="flex: 1">
                <el-date-picker
                  v-model="milestoneDraft.endTime"
                  type="date"
                  placeholder="选择结束时间"
                  style="width: 100%"
                  format="YYYY-MM-DD"
                  value-format="YYYY-MM-DD"
                />
              </el-form-item>
            </div>
            <el-form-item label="描述">
              <el-input
                v-model="milestoneDraft.description"
                type="textarea"
                :rows="2"
                placeholder="请输入里程碑描述"
              />
            </el-form-item>
            <template #footer>
              <el-button @click="closeMilestoneDialog">取消</el-button>
              <el-button type="primary" @click="confirmAddMilestone"
                >确定添加</el-button
              >
            </template>
          </el-dialog>
        </div>

        <!-- 操作按钮 -->
        <div
          v-if="isEditMode"
          class="button-group"
          style="
            background: #fff;
            position: sticky;
            bottom: 0;
            border-top: 1px solid #e5e7eb;
            padding: 16px;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
          "
        >
          <el-button @click="handleBack">取消</el-button>
          <el-button type="primary" @click="handleSaveProject">
            <el-icon><Check /></el-icon>
            更新项目
          </el-button>
        </div>
      </div>
    </div>

    <script>
      const { createApp, ref, computed, onMounted, nextTick } = Vue;
      const { ElMessage, ElMessageBox } = ElementPlus;

      // 注册Loading图标
      const Loading = {
        template:
          '<svg class="el-icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M512 64a32 32 0 0 1 32 32v192a32 32 0 0 1-64 0V96a32 32 0 0 1 32-32zm0 896a32 32 0 0 1-32-32V736a32 32 0 0 1 64 0v192a32 32 0 0 1-32 32zm448-480a32 32 0 0 1-32 32H736a32 32 0 0 1 0-64h192a32 32 0 0 1 32 32zM96 512a32 32 0 0 1 32-32h192a32 32 0 0 1 0 64H128a32 32 0 0 1-32-32zm778.24-200.96a32 32 0 0 1 45.248 45.248l-135.68 135.68a32 32 0 1 1-45.248-45.248l135.68-135.68zm-636.48 636.48a32 32 0 0 1 45.248 45.248l-135.68 135.68a32 32 0 1 1-45.248-45.248l135.68-135.68zM778.24 712.96a32 32 0 0 1-45.248 45.248l-135.68-135.68a32 32 0 1 1 45.248-45.248l135.68 135.68zM141.76 311.04a32 32 0 0 1-45.248-45.248l135.68-135.68a32 32 0 1 1 45.248 45.248l-135.68 135.68z"/></svg>',
      };

      createApp({
        components: {
          Loading,
        },
        setup() {
          // 响应式数据
          const loading = ref(false);
          // 模式：view(查看) / edit(编辑)
          const isEditMode = ref(false);
          const project = ref({
            id: 0,
            number: "",
            name: "",
            description: "",
            manager: "",
            status: "progress",
            createTime: "",
            updateTime: "",
            budget: 0,
          });
          const members = ref([]);
          const documents = ref([]);
          const showAddMember = ref(false);
          const searchMemberKeyword = ref("");
          const searchResults = ref([]);
          const isDragOver = ref(false);
          const fileInput = ref(null);
          // 里程碑拖拽状态管理
          const milestonesDragOver = ref({});
          const milestones = ref([
            {
              name: "项目启动",
              description: "项目启动阶段",
              startTime: "2024-01-15",
              endTime: "2024-01-20",
              documents: [
                {
                  id: 1,
                  name: "项目启动会议纪要.pdf",
                  type: "PDF",
                  uploader: "张教授",
                  uploadTime: "2024-01-15",
                  size: "1.2MB",
                },
                {
                  id: 2,
                  name: "项目计划书.docx",
                  type: "DOCX",
                  uploader: "李博士",
                  uploadTime: "2024-01-16",
                  size: "2.1MB",
                },
              ],
            },
            {
              name: "需求分析",
              description: "需求分析阶段",
              startTime: "2024-01-21",
              endTime: "2024-01-31",
              documents: [
                {
                  id: 3,
                  name: "需求分析报告.pdf",
                  type: "PDF",
                  uploader: "王硕士",
                  uploadTime: "2024-01-25",
                  size: "3.5MB",
                },
              ],
            },
          ]);

          // 新增成员对话框相关
          const showMemberDialog = ref(false);
          const memberSearchKeyword = ref("");
          const memberSearchResults = ref([]);

          // 里程碑对话框相关
          const showMilestoneDialog = ref(false);
          const milestoneDraft = ref({
            name: "",
            startTime: "",
            endTime: "",
            description: "",
          });
          const milestoneOptions = ref([
            "项目启动：建设方案通过审核并备案",
            "任务分解与资源准备：项目任务书下达，资源配置完成，进入实施阶段",
            "项目实施与过程管理：中期检查",
            "成果整合与结题准备：结题验收",
            "后续管理与成果转化：项目归档完成，成果转化",
          ]);
          const addedMilestoneNames = computed(() => {
            if (!milestones.value || !Array.isArray(milestones.value)) {
              return [];
            }
            return milestones.value
              .map((m) => m.name)
              .filter((name) => name && name.trim());
          });

          // 模拟项目数据
          const mockProject = {
            id: 1,
            number: "PRJ-2024-001",
            name: "基于人工智能的智能诊断系统研究",
            description:
              "本项目旨在开发一套基于深度学习的智能诊断系统，能够自动分析医学影像数据，为医生提供辅助诊断建议。系统将采用卷积神经网络和循环神经网络相结合的方法，提高诊断准确率和效率。",
            manager: "张教授",
            department: "科委", // 新增：课题发布部门
            researchDirection:
              "基于深度学习的智能制造关键技术研究，重点围绕工业互联网、智能传感器、机器视觉等核心技术，推动制造业数字化转型升级。", // 新增：研究方向
            status: "progress",
            createTime: "2024-01-15",
            updateTime: "2024-01-20",
            budget: 120000,
          };

          // 模拟成员数据
          const mockMembers = [
            {
              id: 1,
              name: "张教授",
              role: "项目负责人",
              joinTime: "2024-01-15",
            },
            {
              id: 2,
              name: "李博士",
              role: "核心成员",
              joinTime: "2024-01-16",
            },
            {
              id: 3,
              name: "王硕士",
              role: "普通成员",
              joinTime: "2024-01-18",
            },
          ];

          // 模拟文档数据
          const mockDocuments = [
            {
              id: 1,
              name: "项目需求分析报告.pdf",
              type: "PDF",
              uploader: "张教授",
              uploadTime: "2024-01-15",
              size: "2.3MB",
            },
            {
              id: 2,
              name: "技术方案设计.docx",
              type: "DOCX",
              uploader: "李博士",
              uploadTime: "2024-01-18",
              size: "1.8MB",
            },
            {
              id: 3,
              name: "测试数据.xlsx",
              type: "XLSX",
              uploader: "王硕士",
              uploadTime: "2024-01-20",
              size: "856KB",
            },
          ];

          // 用户列表数据（与新建项目保持一致）
          const userList = [
            { id: "1", name: "张教授", avatar: "../images/favicon.ico" },
            { id: "2", name: "李博士", avatar: "../images/favicon.ico" },
            { id: "3", name: "王教授", avatar: "../images/favicon.ico" },
            { id: "4", name: "赵博士", avatar: "../images/favicon.ico" },
            { id: "5", name: "陈教授", avatar: "../images/favicon.ico" },
            { id: "6", name: "刘硕士", avatar: "../images/favicon.ico" },
            { id: "7", name: "周博士", avatar: "../images/favicon.ico" },
          ];

          // 获取状态文本
          const getStatusText = (status) => {
            const statusMap = {
              planned: "计划中",
              progress: "进行中",
              completed: "已完成",
              delayed: "已延期",
            };
            return statusMap[status] || "未知";
          };

          // 解析URL参数
          const getQueryParam = (key) => {
            const params = new URLSearchParams(window.location.search);
            return params.get(key);
          };

          const resolveMode = () => {
            // 优先URL参数，其次localStorage，默认view
            const qs = getQueryParam("mode");
            if (qs === "edit" || qs === "view") return qs;
            try {
              const ls = localStorage.getItem("projectDetailMode");
              if (ls === "edit" || ls === "view") return ls;
            } catch {}
            return "view";
          };

          // 加载项目详情
          const loadProjectDetail = async () => {
            loading.value = true;
            try {
              // 模拟API调用
              await new Promise((resolve) => setTimeout(resolve, 1000));

              project.value = mockProject;
              members.value = mockMembers;
              documents.value = mockDocuments;
              // 设置模式
              const mode = resolveMode();
              isEditMode.value = mode === "edit";
            } catch (error) {
              ElMessage.error("加载项目详情失败");
            } finally {
              loading.value = false;
            }
          };

          // 返回列表
          const handleBack = () => {
            ElMessage.info("返回项目列表");
            // 检查是否在iframe中
            if (window.parent !== window) {
              window.parent.postMessage(
                {
                  type: "navigate",
                  path: "project/list",
                },
                "*"
              );
            } else {
              window.location.href = "项目列表.html";
            }
          };

          // 搜索成员
          const searchMembers = () => {
            if (searchMemberKeyword.value.trim()) {
              searchResults.value = mockSearchResults.filter(
                (user) =>
                  user.name.includes(searchMemberKeyword.value) ||
                  user.studentId.includes(searchMemberKeyword.value)
              );
            } else {
              searchResults.value = [];
            }
          };

          // 实时搜索成员（旧版本，保留兼容性）
          const handleMemberSearchOld = () => {
            if (searchMemberKeyword.value.trim()) {
              searchResults.value = mockSearchResults.filter(
                (user) =>
                  user.name
                    .toLowerCase()
                    .includes(searchMemberKeyword.value.toLowerCase()) ||
                  user.studentId
                    .toLowerCase()
                    .includes(searchMemberKeyword.value.toLowerCase())
              );
            } else {
              searchResults.value = [];
            }
          };

          // 打开成员对话框
          const openMemberDialog = () => {
            memberSearchKeyword.value = "";
            memberSearchResults.value = [];
            showMemberDialog.value = true;
          };

          // 关闭成员对话框
          const closeMemberDialog = () => {
            showMemberDialog.value = false;
          };

          // 成员搜索处理
          const handleMemberSearch = () => {
            if (!memberSearchKeyword.value.trim()) {
              memberSearchResults.value = [];
              return;
            }

            // 模拟搜索API
            const keyword = memberSearchKeyword.value.toLowerCase();
            memberSearchResults.value = userList.filter(
              (user) =>
                user.name.toLowerCase().includes(keyword) ||
                user.id.toLowerCase().includes(keyword)
            );
          };

          // 添加成员
          const handleAddMember = (user) => {
            // 检查是否已经是成员
            const isAlreadyMember = members.value.some(
              (member) => member.id === user.id
            );
            if (isAlreadyMember) {
              ElMessage.warning("该用户已经是项目成员");
              return;
            }

            // 添加到成员列表
            const newMember = {
              id: user.id,
              name: user.name,
              role: "member", // 使用与新建项目一致的角色标识
              joinTime: new Date().toISOString().split("T")[0],
            };

            members.value.push(newMember);
            ElMessage.success(`成功添加成员: ${user.name}`);

            // 清空搜索
            memberSearchKeyword.value = "";
            memberSearchResults.value = [];

            // 延迟关闭对话框，让用户看到添加效果
            setTimeout(() => {
              showMemberDialog.value = false;
            }, 1000);
          };

          // 获取角色文本
          const getRoleText = (role) => {
            const roleMap = {
              manager: "项目负责人",
              core: "核心成员",
              member: "普通成员",
              项目负责人: "项目负责人",
              核心成员: "核心成员",
              普通成员: "普通成员",
            };
            return roleMap[role] || "普通成员";
          };

          // 取消添加成员
          const handleCancelAddMember = () => {
            showAddMember.value = false;
            searchMemberKeyword.value = "";
            searchResults.value = [];
          };

          // 移除成员
          const handleRemoveMember = async (memberId) => {
            const member = members.value.find((m) => m.id === memberId);
            if (!member) return;

            try {
              await ElMessageBox.confirm(
                `确定要移除成员"${member.name}"吗？移除后该成员将无法访问项目信息。`,
                "确认移除",
                {
                  confirmButtonText: "确定",
                  cancelButtonText: "取消",
                  type: "warning",
                }
              );

              // 从成员列表中移除
              const index = members.value.findIndex((m) => m.id === memberId);
              if (index > -1) {
                members.value.splice(index, 1);
                ElMessage.success(`已成功移除成员: ${member.name}`);
              }
            } catch (error) {
              // 用户取消操作
            }
          };

          // 预览文档
          const handlePreview = (docId) => {
            const doc = documents.value.find((d) => d.id === docId);
            if (!doc) return;

            ElMessage.info(`预览文档: ${doc.name}`);
            // 这里应该打开文档预览窗口或新标签页
            // 根据文档类型决定预览方式
            if (doc.type === "PDF") {
              // PDF预览
              window.open(`/api/documents/${docId}/preview`, "_blank");
            } else if (["DOC", "DOCX"].includes(doc.type)) {
              // Word文档预览
              window.open(`/api/documents/${docId}/preview`, "_blank");
            } else if (["XLS", "XLSX"].includes(doc.type)) {
              // Excel文档预览
              window.open(`/api/documents/${docId}/preview`, "_blank");
            } else {
              ElMessage.warning("该文档类型暂不支持预览");
            }
          };

          // 下载文档
          const handleDownload = (docId) => {
            ElMessage.info(`下载文档: ${docId}`);
            // 这里应该触发文档下载
          };

          // 删除文档
          const handleDeleteDoc = async (docId) => {
            try {
              await ElMessageBox.confirm("确定要删除这个文档吗？", "确认删除", {
                confirmButtonText: "确定",
                cancelButtonText: "取消",
                type: "warning",
              });

              ElMessage.success("文档删除成功");
              // 这里应该调用API删除文档
            } catch (error) {
              // 用户取消操作
            }
          };

          // 触发文件上传
          const triggerUpload = () => {
            fileInput.value.click();
          };

          // 处理文件选择
          const handleFileSelect = (event) => {
            const files = event.target.files;
            if (files.length > 0) {
              uploadFiles(files);
            }
          };

          // 处理拖拽事件
          const handleDragOver = (event) => {
            event.preventDefault();
            isDragOver.value = true;
          };

          const handleDragLeave = (event) => {
            event.preventDefault();
            isDragOver.value = false;
          };

          const handleDrop = (event) => {
            event.preventDefault();
            isDragOver.value = false;
            const files = event.dataTransfer.files;
            if (files.length > 0) {
              uploadFiles(files);
            }
          };

          // 上传文件
          const uploadFiles = (files) => {
            ElMessage.info(`开始上传 ${files.length} 个文件`);
            // 这里应该实现文件上传逻辑
            // 模拟上传进度
            setTimeout(() => {
              ElMessage.success("文件上传成功");
            }, 2000);
          };

          // 保存项目（编辑）
          const handleSaveProject = async () => {
            // 这里应进行表单校验与提交
            ElMessage.success("项目保存成功");
            handleBack();
          };

          // 里程碑对话框相关方法
          const openMilestoneDialog = () => {
            milestoneDraft.value = {
              name: "",
              startTime: "",
              endTime: "",
              description: "",
            };
            showMilestoneDialog.value = true;
          };

          const closeMilestoneDialog = () => {
            showMilestoneDialog.value = false;
          };

          const confirmAddMilestone = () => {
            const d = milestoneDraft.value;
            if (!d.name.trim()) {
              ElMessage.warning("请输入里程碑名称");
              return;
            }
            if (addedMilestoneNames.value.includes(d.name.trim())) {
              ElMessage.warning("该里程碑已添加");
              return;
            }
            if (!d.startTime || !d.endTime) {
              ElMessage.warning("请选择开始时间和结束时间");
              return;
            }
            if (new Date(d.startTime) >= new Date(d.endTime)) {
              ElMessage.warning("结束时间必须晚于开始时间");
              return;
            }
            milestones.value.push({
              name: d.name.trim(),
              startTime: d.startTime,
              endTime: d.endTime,
              description: d.description || "",
            });
            showMilestoneDialog.value = false;
            ElMessage.success("已添加里程碑");
          };

          const handleRemoveMilestone = (index) => {
            milestones.value.splice(index, 1);
          };

          // 里程碑文档管理方法
          const triggerMilestoneUpload = (milestoneIndex) => {
            // 使用nextTick确保DOM已更新
            nextTick(() => {
              const fileInput = document.getElementById(
                `milestoneFileInput${milestoneIndex}`
              );
              if (fileInput) {
                fileInput.click();
              } else {
                // 备用方法：通过查询选择器查找
                const allInputs =
                  document.querySelectorAll('input[type="file"]');
                const targetInput = Array.from(allInputs).find(
                  (input) => input.id === `milestoneFileInput${milestoneIndex}`
                );
                if (targetInput) {
                  targetInput.click();
                }
              }
            });
          };

          const handleMilestoneFileSelect = (event, milestoneIndex) => {
            const files = event.target.files;
            if (files.length > 0) {
              uploadMilestoneFiles(files, milestoneIndex);
              // 清空input值，允许重复选择同一文件
              event.target.value = "";
            }
          };

          const uploadMilestoneFiles = (files, milestoneIndex) => {
            // 验证文件 - 支持更多格式
            const allowedTypes = [
              ".pdf",
              ".doc",
              ".docx",
              ".xls",
              ".xlsx",
              ".ppt",
              ".pptx", // 办公文档
              ".txt",
              ".md",
              ".rtf", // 文本文档
              ".jpg",
              ".jpeg",
              ".png",
              ".gif",
              ".bmp",
              ".svg",
              ".webp", // 图片
              ".zip",
              ".rar",
              ".7z",
              ".tar",
              ".gz", // 压缩包
              ".mp4",
              ".avi",
              ".mov",
              ".wmv",
              ".flv", // 视频
              ".mp3",
              ".wav",
              ".flac",
              ".aac", // 音频
            ];
            const maxSize = 50 * 1024 * 1024; // 50MB

            for (let file of files) {
              const fileExt = "." + file.name.split(".").pop().toLowerCase();
              if (!allowedTypes.includes(fileExt)) {
                ElMessage.error(`不支持的文件类型: ${file.name}`);
                return;
              }
              if (file.size > maxSize) {
                ElMessage.error(`文件过大: ${file.name} (最大支持50MB)`);
                return;
              }
            }

            // 初始化文档数组
            if (!milestones.value[milestoneIndex].documents) {
              milestones.value[milestoneIndex].documents = [];
            }

            // 显示上传进度
            const loadingMessage = ElMessage({
              message: `正在上传 ${files.length} 个文件...`,
              type: "info",
              duration: 0,
              showClose: false,
            });

            // 模拟上传过程
            setTimeout(() => {
              loadingMessage.close();

              let successCount = 0;
              for (let i = 0; i < files.length; i++) {
                const file = files[i];

                // 检查是否已存在同名文件
                const existingDoc = milestones.value[
                  milestoneIndex
                ].documents.find((doc) => doc.name === file.name);

                if (existingDoc) {
                  ElMessage.warning(`文件已存在: ${file.name}`);
                  continue;
                }

                const newDoc = {
                  id: Date.now() + Math.random() + i,
                  name: file.name,
                  type: file.name.split(".").pop().toUpperCase(),
                  uploader: "当前用户",
                  uploadTime: new Date().toISOString().split("T")[0],
                  size: formatFileSize(file.size),
                };

                milestones.value[milestoneIndex].documents.push(newDoc);
                successCount++;
              }

              if (successCount > 0) {
                ElMessage.success(
                  `已为里程碑 ${
                    milestoneIndex + 1
                  } 成功添加 ${successCount} 个文档`
                );
              }
            }, 1000); // 模拟1秒上传时间
          };

          // 格式化文件大小
          const formatFileSize = (bytes) => {
            if (bytes === 0) return "0 B";
            const k = 1024;
            const sizes = ["B", "KB", "MB", "GB"];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return (
              parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + " " + sizes[i]
            );
          };

          const handleDeleteMilestoneDoc = (milestoneIndex, docId) => {
            const milestone = milestones.value[milestoneIndex];
            if (milestone.documents) {
              const docIndex = milestone.documents.findIndex(
                (doc) => doc.id === docId
              );
              if (docIndex > -1) {
                const docName = milestone.documents[docIndex].name;
                milestone.documents.splice(docIndex, 1);
                ElMessage.success(`已删除文档: ${docName}`);
              }
            }
          };

          // 里程碑拖拽事件处理
          const handleMilestoneDragOver = (milestoneIndex) => {
            milestonesDragOver.value[milestoneIndex] = true;
          };

          const handleMilestoneDragLeave = (milestoneIndex) => {
            milestonesDragOver.value[milestoneIndex] = false;
          };

          const handleMilestoneDrop = (event, milestoneIndex) => {
            event.preventDefault();
            milestonesDragOver.value[milestoneIndex] = false;
            const files = event.dataTransfer.files;
            if (files.length > 0) {
              uploadMilestoneFiles(files, milestoneIndex);
            }
          };

          // 组件挂载时加载数据
          onMounted(() => {
            console.log("项目详情页面加载中...");
            loadProjectDetail();
          });

          return {
            loading,
            isEditMode,
            project,
            members,
            documents,
            milestones,
            showAddMember,
            searchMemberKeyword,
            searchResults,
            isDragOver,
            fileInput,
            getStatusText,
            handleBack,
            searchMembers,
            handleMemberSearch,
            handleAddMember,
            handleCancelAddMember,
            handleRemoveMember,
            handlePreview,
            handleDownload,
            handleDeleteDoc,
            triggerUpload,
            handleFileSelect,
            handleDragOver,
            handleDragLeave,
            handleDrop,
            handleSaveProject,
            // 新增的成员对话框相关
            showMemberDialog,
            memberSearchKeyword,
            memberSearchResults,
            openMemberDialog,
            closeMemberDialog,
            getRoleText,
            // 新增的里程碑对话框相关
            showMilestoneDialog,
            milestoneDraft,
            milestoneOptions,
            addedMilestoneNames,
            openMilestoneDialog,
            closeMilestoneDialog,
            confirmAddMilestone,
            handleRemoveMilestone,
            // 里程碑文档管理相关
            triggerMilestoneUpload,
            handleMilestoneFileSelect,
            handleDeleteMilestoneDoc,
            formatFileSize,
            // 里程碑拖拽相关
            milestonesDragOver,
            handleMilestoneDragOver,
            handleMilestoneDragLeave,
            handleMilestoneDrop,
          };
        },
      })
        .use(ElementPlus, {
          locale: window.ElementPlusLocaleZhCn || {
            name: "zh-cn",
            el: {
              datepicker: {
                now: "此刻",
                today: "今天",
                cancel: "取消",
                clear: "清空",
                confirm: "确认",
                selectDate: "选择日期",
                selectTime: "选择时间",
                startDate: "开始日期",
                startTime: "开始时间",
                endDate: "结束日期",
                endTime: "结束时间",
                prevYear: "前一年",
                nextYear: "后一年",
                prevMonth: "上个月",
                nextMonth: "下个月",
                year: "年",
                month1: "1月",
                month2: "2月",
                month3: "3月",
                month4: "4月",
                month5: "5月",
                month6: "6月",
                month7: "7月",
                month8: "8月",
                month9: "9月",
                month10: "10月",
                month11: "11月",
                month12: "12月",
                weeks: {
                  sun: "日",
                  mon: "一",
                  tue: "二",
                  wed: "三",
                  thu: "四",
                  fri: "五",
                  sat: "六",
                },
                months: {
                  jan: "一月",
                  feb: "二月",
                  mar: "三月",
                  apr: "四月",
                  may: "五月",
                  jun: "六月",
                  jul: "七月",
                  aug: "八月",
                  sep: "九月",
                  oct: "十月",
                  nov: "十一月",
                  dec: "十二月",
                },
              },
            },
          },
        })
        .mount("#app");
    </script>
  </body>
</html>
