<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>é¡¹ç›®è¯¦æƒ… - é«˜æ ¡ç§‘ç ”é¡¹ç›®ç®¡ç†å¹³å°</title>
    <link rel="icon" href="../images/favicon.ico" type="image/x-icon" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/element-plus@2.3.14/dist/index.css"
    />
    <script src="https://unpkg.com/vue@3.2.47/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/element-plus@2.3.14"></script>
    <!-- Element Plus ä¸­æ–‡æœ¬åœ°åŒ–ï¼ˆä¿®å¤ locale undefined æŠ¥é”™ï¼‰ -->
    <script src="https://unpkg.com/element-plus@2.3.14/dist/locale/zh-cn.js"></script>
    <script>
      // ç¡®ä¿ Element Plus ä¸­æ–‡æœ¬åœ°åŒ–æ­£ç¡®åŠ è½½
      window.ElementPlusLocaleZhCn = window.ElementPlusLocaleZhCn || {
        name: "zh-cn",
        el: {
          datepicker: {
            now: "æ­¤åˆ»",
            today: "ä»Šå¤©",
            cancel: "å–æ¶ˆ",
            clear: "æ¸…ç©º",
            confirm: "ç¡®è®¤",
            selectDate: "é€‰æ‹©æ—¥æœŸ",
            selectTime: "é€‰æ‹©æ—¶é—´",
            startDate: "å¼€å§‹æ—¥æœŸ",
            startTime: "å¼€å§‹æ—¶é—´",
            endDate: "ç»“æŸæ—¥æœŸ",
            endTime: "ç»“æŸæ—¶é—´",
            prevYear: "å‰ä¸€å¹´",
            nextYear: "åä¸€å¹´",
            prevMonth: "ä¸Šä¸ªæœˆ",
            nextMonth: "ä¸‹ä¸ªæœˆ",
            year: "å¹´",
            month1: "1æœˆ",
            month2: "2æœˆ",
            month3: "3æœˆ",
            month4: "4æœˆ",
            month5: "5æœˆ",
            month6: "6æœˆ",
            month7: "7æœˆ",
            month8: "8æœˆ",
            month9: "9æœˆ",
            month10: "10æœˆ",
            month11: "11æœˆ",
            month12: "12æœˆ",
            weeks: {
              sun: "æ—¥",
              mon: "ä¸€",
              tue: "äºŒ",
              wed: "ä¸‰",
              thu: "å››",
              fri: "äº”",
              sat: "å…­",
            },
            months: {
              jan: "ä¸€æœˆ",
              feb: "äºŒæœˆ",
              mar: "ä¸‰æœˆ",
              apr: "å››æœˆ",
              may: "äº”æœˆ",
              jun: "å…­æœˆ",
              jul: "ä¸ƒæœˆ",
              aug: "å…«æœˆ",
              sep: "ä¹æœˆ",
              oct: "åæœˆ",
              nov: "åä¸€æœˆ",
              dec: "åäºŒæœˆ",
            },
          },
        },
      };
    </script>
    <link rel="stylesheet" href="../é€šç”¨è§„èŒƒ/æ ·å¼.css" />
    <style>
      .project-detail-container {
        padding: 20px;
        background: #f7f9fc;
        min-height: calc(100vh - 56px);
      }

      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .page-title {
        font-size: 24px;
        font-weight: 600;
        color: #1e3a8a;
        margin: 0;
      }

      .main-content-single {
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin-bottom: 20px;
      }

      .card {
        background: #ffffff;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        border: 1px solid #e5e7eb;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e5e7eb;
      }

      .footer-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #e5e7eb;
        position: sticky;
        bottom: 0;
        background: #ffffff;
        padding-bottom: 12px;
        z-index: 10;
        box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.03);
      }

      .card-title {
        font-size: 16px;
        font-weight: 600;
        color: #1e3a8a;
        margin: 0;
      }

      .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }

      .info-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .info-label {
        font-size: 14px;
        color: #6b7280;
        font-weight: 500;
      }

      .info-value {
        font-size: 14px;
        color: #374151;
      }

      .status-tag {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
      }

      .status-progress {
        display: inline-block;
        background-color: #fef3c7;
        color: #f59e0b;
        padding: 2px 8px;
        border-radius: 12px;
        max-width: 120px;
        white-space: nowrap;
      }

      /* æˆå‘˜ç®¡ç†æ ·å¼ */
      .member-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .member-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: #f8fafc;
        border-radius: 6px;
      }

      .member-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6b7280;
        font-weight: 600;
      }

      .member-info {
        flex: 1;
      }

      .member-name {
        font-size: 14px;
        font-weight: 500;
        color: #374151;
        margin-bottom: 2px;
      }

      .member-role {
        font-size: 12px;
        color: #6b7280;
      }

      .member-actions {
        display: flex;
        gap: 8px;
      }

      .add-member-section {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid #e5e7eb;
      }

      .search-member {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
      }

      .search-results {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        background: #ffffff;
      }

      .search-result-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f3f4f6;
      }

      .search-result-item:hover {
        background: #f8fafc;
      }

      .search-result-item:last-child {
        border-bottom: none;
      }

      /* æ–‡æ¡£ç®¡ç†æ ·å¼ */
      .document-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .document-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: #f8fafc;
        border-radius: 6px;
      }

      .document-icon {
        width: 32px;
        height: 32px;
        border-radius: 4px;
        background: #dbeafe;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #1e40af;
      }

      .document-info {
        flex: 1;
      }

      .document-name {
        font-size: 14px;
        font-weight: 500;
        color: #374151;
        margin-bottom: 2px;
      }

      .document-meta {
        font-size: 12px;
        color: #6b7280;
      }

      .document-actions {
        display: flex;
        gap: 8px;
      }

      .upload-section {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid #e5e7eb;
      }

      .upload-area {
        border: 2px dashed #d1d5db;
        border-radius: 6px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: border-color 0.3s;
      }

      .upload-area:hover {
        border-color: #1e3a8a;
      }

      .upload-area.dragover {
        border-color: #1e3a8a;
        background: #f0f9ff;
      }

      /* é‡Œç¨‹ç¢‘æ‹–æ‹½åŒºåŸŸæ ·å¼ */
      .milestone-documents .upload-area {
        border: 2px dashed #d1d5db;
        border-radius: 6px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: border-color 0.3s, background-color 0.3s;
      }

      .milestone-documents .upload-area:hover {
        border-color: #1e3a8a;
      }

      .milestone-documents .upload-area.dragover {
        border-color: #1e3a8a;
        background: #f0f9ff;
      }

      .upload-icon {
        font-size: 24px;
        color: #9ca3af;
        margin-bottom: 8px;
      }

      .upload-text {
        font-size: 14px;
        color: #6b7280;
        margin-bottom: 4px;
      }

      .upload-hint {
        font-size: 12px;
        color: #9ca3af;
      }

      /* æ“ä½œæŒ‰é’®åŒºåŸŸ */
      .action-buttons {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #e5e7eb;
      }

      .loading-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 40px;
        color: #6b7280;
        font-size: 14px;
      }

      .loading-container .el-icon {
        margin-right: 8px;
        font-size: 16px;
      }

      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #6b7280;
      }

      .empty-state-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
      }

      .empty-state-text {
        font-size: 16px;
        margin-bottom: 8px;
      }

      .empty-state-hint {
        font-size: 14px;
        color: #9ca3af;
      }

      /* å¼¹çª—å†…è¡¨å•å¯è¯»æ€§ï¼ˆä¿®å¤æ–‡å­—çœ‹ä¸æ¸…çš„é—®é¢˜ï¼‰ + ä¸é¡µé¢ç»Ÿä¸€é£æ ¼ */
      .el-dialog {
        font-family: inherit;
        color: #1f2937;
        border-radius: 12px !important;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12) !important;
      }
      .el-dialog .el-dialog__title {
        font-weight: 600;
        color: #1e3a8a;
        font-size: 18px;
      }
      .el-dialog .el-form-item__label {
        color: #374151;
        font-weight: 500;
        font-size: 14px;
      }
      .el-dialog .el-input__inner,
      .el-dialog input,
      .el-dialog .el-textarea__inner,
      .el-dialog .el-select .el-input__inner {
        color: #1f2937;
        font-size: 14px;
      }
      .el-dialog .el-input__inner::placeholder,
      .el-dialog input::placeholder,
      .el-dialog .el-textarea__inner::placeholder,
      .el-dialog .el-select .el-input__inner::placeholder {
        color: #9ca3af;
        font-size: 14px;
      }
      .el-dialog .el-option {
        color: #1f2937;
        font-size: 14px;
      }
      .el-dialog .el-option:hover {
        background-color: #f8fafc;
        color: #1f2937;
      }

      /* è‡ªå®šä¹‰å¼¹çª—æ ·å¼ */
      .el-message-box {
        border-radius: 12px !important;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12) !important;
      }

      .el-message-box__header {
        padding: 20px 24px 16px 24px !important;
        border-bottom: 1px solid #f0f0f0 !important;
        background: #ffffff !important;
      }

      .el-message-box__title {
        font-size: 16px !important;
        font-weight: 600 !important;
        color: #1f2937 !important;
        line-height: 1.5 !important;
      }

      .el-message-box__headerbtn {
        top: 16px !important;
        right: 20px !important;
        width: 24px !important;
        height: 24px !important;
      }

      .el-message-box__close {
        color: #9ca3af !important;
        font-size: 16px !important;
      }

      .el-message-box__close:hover {
        color: #6b7280 !important;
      }

      .el-message-box__content {
        padding: 20px 24px !important;
        background: #ffffff !important;
      }

      .el-message-box__message {
        font-size: 14px !important;
        line-height: 1.6 !important;
        color: #374151 !important;
        margin: 0 !important;
        padding: 0 !important;
      }

      .el-message-box__btns {
        padding: 16px 24px 20px 24px !important;
        background: #ffffff !important;
        display: flex !important;
        justify-content: flex-end !important;
        gap: 12px !important;
      }

      .el-message-box__btns .el-button {
        padding: 8px 20px !important;
        border-radius: 8px !important;
        font-size: 14px !important;
        font-weight: 500 !important;
        border: 1px solid !important;
        transition: all 0.2s ease !important;
      }

      .el-message-box__btns .el-button--default {
        background: #ffffff !important;
        border-color: #d1d5db !important;
        color: #6b7280 !important;
      }

      .el-message-box__btns .el-button--default:hover {
        background: #f9fafb !important;
        border-color: #9ca3af !important;
        color: #374151 !important;
      }

      .el-message-box__btns .el-button--primary {
        background: #1e3a8a !important;
        border-color: #1e3a8a !important;
        color: #ffffff !important;
      }

      .el-message-box__btns .el-button--primary:hover {
        background: #1e40af !important;
        border-color: #1e40af !important;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
      }

      .el-message-box__btns .el-button--primary:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(30, 58, 138, 0.3);
      }

      /* è­¦å‘Šç±»å‹å¼¹çª—çš„ç‰¹æ®Šæ ·å¼ */
      .el-message-box--warning .el-message-box__content {
        position: relative;
      }

      .el-message-box--warning .el-message-box__message::before {
        content: "âš ï¸";
        font-size: 18px !important;
        margin-right: 8px !important;
        vertical-align: -0.15em !important;
        display: inline-block !important;
      }

      /* å“åº”å¼è®¾è®¡ */
      @media (max-width: 768px) {
        .content-grid {
          grid-template-columns: 1fr;
        }

        .info-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="project-detail-container">
        <!-- é¡µé¢å¤´éƒ¨ -->
        <div class="page-header">
          <div style="display: flex; align-items: center; gap: 16px">
            <el-button @click="handleBack">
              <el-icon><ArrowLeft /></el-icon>
              è¿”å›åˆ—è¡¨
            </el-button>
            <h1 class="page-title">
              {{ isEditMode ? 'é¡¹ç›®ç¼–è¾‘' : 'é¡¹ç›®è¯¦æƒ…' }}
            </h1>
          </div>
        </div>

        <!-- åŠ è½½çŠ¶æ€ -->
        <div v-if="loading" class="loading-container">
          <el-icon class="is-loading"><Loading /></el-icon>
          <span>åŠ è½½ä¸­...</span>
        </div>

        <!-- ä¸»è¦å†…å®¹ -->
        <div v-else class="main-content-single">
          <!-- åŸºæœ¬ä¿¡æ¯ -->
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">åŸºæœ¬ä¿¡æ¯</h2>
            </div>
            <div class="info-grid">
              <!-- ç¬¬ä¸€è¡Œï¼šé¡¹ç›®ç¼–å·ã€é¡¹ç›®åç§° -->
              <div class="info-item">
                <span class="info-label">é¡¹ç›®ç¼–å·</span>
                <span class="info-value">{{ project.number }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">é¡¹ç›®åç§°</span>
                <span class="info-value">{{ project.name }}</span>
              </div>

              <!-- ç¬¬äºŒè¡Œï¼šé¡¹ç›®è´Ÿè´£äººã€é¡¹ç›®çŠ¶æ€ -->
              <div class="info-item">
                <span class="info-label">é¡¹ç›®è´Ÿè´£äºº</span>
                <span class="info-value">{{ project.manager }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">é¡¹ç›®çŠ¶æ€</span>
                <span class="status-tag status-progress"
                  >{{ getStatusText(project.status) }}</span
                >
              </div>

              <!-- ç¬¬ä¸‰è¡Œï¼šè¯¾é¢˜å‘å¸ƒéƒ¨é—¨ã€ç ”ç©¶æ–¹å‘ -->
              <div class="info-item">
                <span class="info-label">è¯¾é¢˜å‘å¸ƒéƒ¨é—¨</span>
                <span class="info-value"
                  >{{ project.department || 'æš‚æ— ' }}</span
                >
              </div>
              <div class="info-item">
                <span class="info-label">ç ”ç©¶æ–¹å‘</span>
                <span class="info-value"
                  >{{ project.researchDirection || 'æš‚æ— ' }}</span
                >
              </div>

              <!-- ç¬¬å››è¡Œï¼šé¡¹ç›®å¼€å§‹æ—¶é—´ã€é¡¹ç›®ç»“æŸæ—¶é—´ -->
              <div class="info-item">
                <span class="info-label">é¡¹ç›®å¼€å§‹æ—¶é—´</span>
                <span class="info-value">{{ project.createTime }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">é¡¹ç›®ç»“æŸæ—¶é—´</span>
                <span class="info-value">{{ project.updateTime }}</span>
              </div>

              <!-- ç¬¬äº”è¡Œï¼šé¡¹ç›®é¢„ç®— -->
              <div class="info-item">
                <span class="info-label">é¡¹ç›®é¢„ç®—</span>
                <template v-if="isEditMode">
                  <el-input-number
                    v-model="project.budget"
                    :min="0"
                    :precision="2"
                    style="width: 100%"
                  />
                </template>
                <template v-else>
                  <span class="info-value"
                    >{{ Number(project.budget||0).toFixed(2) }} å…ƒ</span
                  >
                </template>
              </div>
            </div>

            <!-- é¡¹ç›®æè¿°å•ç‹¬ä¸€è¡Œ -->
            <div class="info-item" style="margin-top: 16px">
              <span class="info-label">é¡¹ç›®æè¿°</span>
              <template v-if="isEditMode">
                <el-input
                  type="textarea"
                  :rows="3"
                  v-model="project.description"
                  placeholder="è¯·è¾“å…¥é¡¹ç›®æè¿°"
                />
              </template>
              <template v-else>
                <span class="info-value">{{ project.description }}</span>
              </template>
            </div>
          </div>

          <!-- æˆå‘˜ç®¡ç† -->
          <div class="card">
            <div
              class="card-header"
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <h2 class="card-title">é¡¹ç›®æˆå‘˜</h2>
              <el-button
                v-if="isEditMode"
                type="primary"
                size="small"
                @click="openMemberDialog"
              >
                <el-icon><Plus /></el-icon>
                æ·»åŠ æˆå‘˜
              </el-button>
            </div>

            <!-- å·²é€‰æˆå‘˜åˆ—è¡¨ -->
            <div v-if="members.length > 0">
              <div
                v-for="member in members"
                :key="member.id"
                class="member-item"
                style="
                  display: flex;
                  align-items: center;
                  gap: 12px;
                  padding: 16px;
                  background: #f8fafc;
                  border-radius: 8px;
                  margin-bottom: 12px;
                  border: 1px solid #e5e7eb;
                "
              >
                <div
                  style="
                    width: 48px;
                    height: 48px;
                    border-radius: 50%;
                    background: #e5e7eb;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: #374151;
                    font-weight: 500;
                    font-size: 18px;
                  "
                >
                  {{ member.name.charAt(0) }}
                </div>
                <div style="flex: 1">
                  <div
                    style="
                      font-weight: 500;
                      color: #374151;
                      font-size: 16px;
                      margin-bottom: 4px;
                    "
                  >
                    {{ member.name }}
                  </div>
                  <div style="font-size: 12px; color: #6b7280">
                    {{ getRoleText(member.role) }} Â· åŠ å…¥æ—¶é—´: {{
                    member.joinTime }}
                  </div>
                </div>
                <el-button
                  v-if="isEditMode"
                  type="danger"
                  size="small"
                  @click="handleRemoveMember(member.id)"
                >
                  ç§»é™¤
                </el-button>
              </div>
            </div>

            <div v-else class="empty-state">
              <div class="empty-state-icon">ğŸ‘¥</div>
              <div class="empty-state-text">æš‚æ— é¡¹ç›®æˆå‘˜</div>
              <div class="empty-state-hint">è¯·æœç´¢å¹¶æ·»åŠ é¡¹ç›®æˆå‘˜</div>
            </div>
          </div>

          <!-- æ·»åŠ æˆå‘˜å¯¹è¯æ¡† -->
          <el-dialog
            v-model="showMemberDialog"
            title="æ·»åŠ æˆå‘˜"
            width="600px"
            :close-on-click-modal="false"
          >
            <el-input
              v-model="memberSearchKeyword"
              placeholder="æœç´¢æˆå‘˜ï¼ˆå§“åæˆ–å­¦å·¥å·ï¼‰"
              clearable
              @keyup.enter="handleMemberSearch"
              @input="handleMemberSearch"
            >
              <template #prefix>
                <el-icon><Search /></el-icon>
              </template>
            </el-input>
            <div
              v-if="memberSearchResults.length > 0"
              class="search-results"
              style="margin-top: 12px"
            >
              <div
                v-for="user in memberSearchResults"
                :key="user.id"
                class="search-result-item"
                style="
                  display: flex;
                  align-items: center;
                  justify-content: space-between;
                  padding: 12px;
                  border: 1px solid #e5e7eb;
                  border-radius: 6px;
                  margin-bottom: 8px;
                  background: #ffffff;
                "
              >
                <div style="display: flex; align-items: center; gap: 12px">
                  <div
                    style="
                      width: 40px;
                      height: 40px;
                      border-radius: 50%;
                      background: #f3f4f6;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      color: #374151;
                      font-weight: 500;
                      font-size: 16px;
                    "
                  >
                    {{ user.name.charAt(0) }}
                  </div>
                  <div>
                    <div
                      style="
                        font-weight: 500;
                        color: #374151;
                        font-size: 14px;
                        margin-bottom: 4px;
                      "
                    >
                      {{ user.name }}
                    </div>
                    <!-- <div style="font-size:12px;color:#6b7280;">å·¥å·: {{ user.id }}</div> -->
                  </div>
                </div>
                <el-button
                  type="primary"
                  size="small"
                  :disabled="members.some(m=>m.id===user.id)"
                  @click="handleAddMember(user)"
                  style="min-width: 60px"
                >
                  {{ members.some(m=>m.id===user.id) ? 'å·²æ·»åŠ ' : 'æ·»åŠ ' }}
                </el-button>
              </div>
            </div>
            <div v-else class="empty-state" style="padding: 20px 0">
              <div class="empty-state-text">è¯·è¾“å…¥å…³é”®è¯è¿›è¡Œæœç´¢</div>
            </div>
            <template #footer>
              <el-button @click="closeMemberDialog">å…³é—­</el-button>
            </template>
          </el-dialog>

          <!-- é¡¹ç›®é‡Œç¨‹ç¢‘ -->
          <div class="card">
            <div
              class="card-header"
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <h2 class="card-title">é¡¹ç›®é‡Œç¨‹ç¢‘</h2>
              <el-button
                v-if="isEditMode"
                type="primary"
                size="small"
                @click="openMilestoneDialog"
              >
                <el-icon><Plus /></el-icon>
                æ·»åŠ é‡Œç¨‹ç¢‘
              </el-button>
            </div>

            <!-- ç©ºæ€æç¤ºï¼šä»…å½“æ²¡æœ‰é‡Œç¨‹ç¢‘æ—¶æ˜¾ç¤º -->
            <div
              v-if="milestones.length === 0"
              class="empty-state"
              style="padding: 20px 0"
            >
              <div class="empty-state-icon">ğŸ¯</div>
              <div class="empty-state-text">æš‚æ— é‡Œç¨‹ç¢‘</div>
              <div class="empty-state-hint">è¯·æ·»åŠ é¡¹ç›®é‡Œç¨‹ç¢‘</div>
            </div>

            <!-- é‡Œç¨‹ç¢‘åˆ—è¡¨ -->
            <div v-if="milestones.length > 0">
              <div
                v-for="(milestone, index) in milestones"
                :key="index"
                class="milestone-item"
                style="
                  border: 1px solid #e5e7eb;
                  border-radius: 6px;
                  padding: 16px;
                  margin-bottom: 12px;
                  background: #fafafa;
                "
              >
                <div
                  class="milestone-header"
                  style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 12px;
                  "
                >
                  <span
                    class="milestone-title"
                    style="font-weight: 600; color: #1e3a8a"
                    >é‡Œç¨‹ç¢‘ {{ index + 1 }}</span
                  >
                  <el-button
                    v-if="isEditMode"
                    type="danger"
                    size="small"
                    @click="handleRemoveMilestone(index)"
                  >
                    åˆ é™¤
                  </el-button>
                </div>
                <div
                  class="milestone-content"
                  style="
                    display: grid;
                    grid-template-columns: 1fr 1fr 1fr 1fr;
                    gap: 12px;
                  "
                >
                  <el-form-item label="é‡Œç¨‹ç¢‘åç§°">
                    <el-input
                      v-model="milestone.name"
                      placeholder="è¯·è¾“å…¥é‡Œç¨‹ç¢‘åç§°"
                      :disabled="!isEditMode"
                    />
                  </el-form-item>
                  <el-form-item label="å¼€å§‹æ—¶é—´">
                    <el-date-picker
                      v-model="milestone.startTime"
                      type="date"
                      placeholder="é€‰æ‹©å¼€å§‹æ—¶é—´"
                      style="width: 100%"
                      format="YYYY-MM-DD"
                      value-format="YYYY-MM-DD"
                      :disabled="!isEditMode"
                    />
                  </el-form-item>
                  <el-form-item label="ç»“æŸæ—¶é—´">
                    <el-date-picker
                      v-model="milestone.endTime"
                      type="date"
                      placeholder="é€‰æ‹©ç»“æŸæ—¶é—´"
                      style="width: 100%"
                      format="YYYY-MM-DD"
                      value-format="YYYY-MM-DD"
                      :disabled="!isEditMode"
                    />
                  </el-form-item>
                </div>
                <el-form-item label="æè¿°">
                  <el-input
                    v-model="milestone.description"
                    type="textarea"
                    :rows="2"
                    placeholder="è¯·è¾“å…¥é‡Œç¨‹ç¢‘æè¿°"
                    :disabled="!isEditMode"
                  />
                </el-form-item>

                <!-- é‡Œç¨‹ç¢‘æ–‡æ¡£ç®¡ç† -->
                <div
                  class="milestone-documents"
                  style="
                    margin-top: 16px;
                    padding-top: 16px;
                    border-top: 1px solid #e5e7eb;
                  "
                >
                  <div style="margin-bottom: 12px">
                    <h4
                      style="
                        margin: 0;
                        font-size: 14px;
                        font-weight: 600;
                        color: #1e3a8a;
                      "
                    >
                      é‡Œç¨‹ç¢‘æ–‡æ¡£
                    </h4>
                  </div>

                  <!-- æ–‡æ¡£åˆ—è¡¨ -->
                  <div
                    v-if="milestone.documents && milestone.documents.length > 0"
                    class="document-list"
                  >
                    <div
                      v-for="doc in milestone.documents"
                      :key="doc.id"
                      class="document-item"
                      style="
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        padding: 12px;
                        background: #f8fafc;
                        border-radius: 6px;
                        margin-bottom: 12px;
                      "
                    >
                      <div
                        style="
                          width: 32px;
                          height: 32px;
                          border-radius: 4px;
                          background: #dbeafe;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                          color: #1e40af;
                        "
                      >
                        ğŸ“„
                      </div>
                      <div style="flex: 1">
                        <div style="font-weight: 500; color: #374151">
                          {{ doc.name }}
                        </div>
                        <div style="font-size: 12px; color: #6b7280">
                          {{ doc.type }} Â· {{ doc.uploader }} Â· {{
                          doc.uploadTime }} Â· {{ doc.size }}
                        </div>
                      </div>
                      <div>
                        <el-button size="small" @click="handlePreview(doc.id)"
                          >é¢„è§ˆ</el-button
                        >
                        <el-button size="small" @click="handleDownload(doc.id)"
                          >ä¸‹è½½</el-button
                        >
                        <el-button
                          v-if="isEditMode"
                          size="small"
                          type="danger"
                          @click="handleDeleteMilestoneDoc(index, doc.id)"
                        >
                          åˆ é™¤
                        </el-button>
                      </div>
                    </div>
                  </div>

                  <div v-else class="empty-state">
                    <div class="empty-state-icon">ğŸ“„</div>
                    <div class="empty-state-text">æš‚æ— æ–‡æ¡£</div>
                    <div class="empty-state-hint">ä¸Šä¼ é‡Œç¨‹ç¢‘ç›¸å…³æ–‡æ¡£</div>
                  </div>

                  <!-- ä¸Šä¼ åŒºåŸŸ -->
                  <div class="upload-section" style="margin-top: 12px">
                    <div
                      class="upload-area"
                      @click="triggerMilestoneUpload(index)"
                      @dragover.prevent="handleMilestoneDragOver(index)"
                      @dragleave.prevent="handleMilestoneDragLeave(index)"
                      @drop.prevent="handleMilestoneDrop($event, index)"
                      :class="{ dragover: milestonesDragOver[index] }"
                      style="
                        border: 2px dashed #d1d5db;
                        border-radius: 6px;
                        padding: 20px;
                        text-align: center;
                        cursor: pointer;
                      "
                    >
                      <div
                        class="upload-icon"
                        style="
                          font-size: 24px;
                          color: #9ca3af;
                          margin-bottom: 8px;
                        "
                      >
                        <el-icon><Upload /></el-icon>
                      </div>
                      <div
                        class="upload-text"
                        style="
                          font-size: 14px;
                          color: #6b7280;
                          margin-bottom: 4px;
                        "
                      >
                        ç‚¹å‡»ä¸Šä¼ æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„
                      </div>
                      <div
                        class="upload-hint"
                        style="font-size: 12px; color: #9ca3af"
                      >
                        æ”¯æŒ
                        PDFã€DOCã€DOCXã€XLSã€XLSXã€PPTã€TXTã€MDã€å›¾ç‰‡ã€å‹ç¼©åŒ…ç­‰æ ¼å¼
                      </div>
                    </div>
                    <input
                      :id="`milestoneFileInput${index}`"
                      type="file"
                      multiple
                      style="display: none"
                      @change="handleMilestoneFileSelect($event, index)"
                      accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.md,.rtf,.jpg,.jpeg,.png,.gif,.bmp,.svg,.webp,.zip,.rar,.7z,.tar,.gz,.mp4,.avi,.mov,.wmv,.flv,.mp3,.wav,.flac,.aac"
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- æ–°å¢é‡Œç¨‹ç¢‘å¯¹è¯æ¡† -->
          <el-dialog
            v-model="showMilestoneDialog"
            title="æ–°å¢é‡Œç¨‹ç¢‘"
            width="700px"
            :close-on-click-modal="false"
          >
            <div
              class="form-row"
              style="display: flex; gap: 20px; margin-bottom: 20px"
            >
              <el-form-item label="é‡Œç¨‹ç¢‘åç§°" style="flex: 1 1 100%">
                <el-select
                  v-model="milestoneDraft.name"
                  placeholder="è¯·é€‰æ‹©é‡Œç¨‹ç¢‘åç§°"
                  style="width: 100%"
                >
                  <el-option
                    v-for="opt in milestoneOptions"
                    :key="opt"
                    :label="opt"
                    :value="opt"
                    :disabled="addedMilestoneNames && addedMilestoneNames.includes(opt)"
                  />
                </el-select>
              </el-form-item>
            </div>
            <div
              class="form-row"
              style="display: flex; gap: 20px; margin-bottom: 20px"
            >
              <el-form-item label="å¼€å§‹æ—¶é—´" style="flex: 1">
                <el-date-picker
                  v-model="milestoneDraft.startTime"
                  type="date"
                  placeholder="é€‰æ‹©å¼€å§‹æ—¶é—´"
                  style="width: 100%"
                  format="YYYY-MM-DD"
                  value-format="YYYY-MM-DD"
                />
              </el-form-item>
              <el-form-item label="ç»“æŸæ—¶é—´" style="flex: 1">
                <el-date-picker
                  v-model="milestoneDraft.endTime"
                  type="date"
                  placeholder="é€‰æ‹©ç»“æŸæ—¶é—´"
                  style="width: 100%"
                  format="YYYY-MM-DD"
                  value-format="YYYY-MM-DD"
                />
              </el-form-item>
            </div>
            <el-form-item label="æè¿°">
              <el-input
                v-model="milestoneDraft.description"
                type="textarea"
                :rows="2"
                placeholder="è¯·è¾“å…¥é‡Œç¨‹ç¢‘æè¿°"
              />
            </el-form-item>
            <template #footer>
              <el-button @click="closeMilestoneDialog">å–æ¶ˆ</el-button>
              <el-button type="primary" @click="confirmAddMilestone"
                >ç¡®å®šæ·»åŠ </el-button
              >
            </template>
          </el-dialog>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div
          v-if="isEditMode"
          class="button-group"
          style="
            background: #fff;
            position: sticky;
            bottom: 0;
            border-top: 1px solid #e5e7eb;
            padding: 16px;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
          "
        >
          <el-button @click="handleBack">å–æ¶ˆ</el-button>
          <el-button type="primary" @click="handleSaveProject">
            <el-icon><Check /></el-icon>
            æ›´æ–°é¡¹ç›®
          </el-button>
        </div>
      </div>
    </div>

    <script>
      const { createApp, ref, computed, onMounted, nextTick } = Vue;
      const { ElMessage, ElMessageBox } = ElementPlus;

      // æ³¨å†ŒLoadingå›¾æ ‡
      const Loading = {
        template:
          '<svg class="el-icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M512 64a32 32 0 0 1 32 32v192a32 32 0 0 1-64 0V96a32 32 0 0 1 32-32zm0 896a32 32 0 0 1-32-32V736a32 32 0 0 1 64 0v192a32 32 0 0 1-32 32zm448-480a32 32 0 0 1-32 32H736a32 32 0 0 1 0-64h192a32 32 0 0 1 32 32zM96 512a32 32 0 0 1 32-32h192a32 32 0 0 1 0 64H128a32 32 0 0 1-32-32zm778.24-200.96a32 32 0 0 1 45.248 45.248l-135.68 135.68a32 32 0 1 1-45.248-45.248l135.68-135.68zm-636.48 636.48a32 32 0 0 1 45.248 45.248l-135.68 135.68a32 32 0 1 1-45.248-45.248l135.68-135.68zM778.24 712.96a32 32 0 0 1-45.248 45.248l-135.68-135.68a32 32 0 1 1 45.248-45.248l135.68 135.68zM141.76 311.04a32 32 0 0 1-45.248-45.248l135.68-135.68a32 32 0 1 1 45.248 45.248l-135.68 135.68z"/></svg>',
      };

      createApp({
        components: {
          Loading,
        },
        setup() {
          // å“åº”å¼æ•°æ®
          const loading = ref(false);
          // æ¨¡å¼ï¼šview(æŸ¥çœ‹) / edit(ç¼–è¾‘)
          const isEditMode = ref(false);
          const project = ref({
            id: 0,
            number: "",
            name: "",
            description: "",
            manager: "",
            status: "progress",
            createTime: "",
            updateTime: "",
            budget: 0,
          });
          const members = ref([]);
          const documents = ref([]);
          const showAddMember = ref(false);
          const searchMemberKeyword = ref("");
          const searchResults = ref([]);
          const isDragOver = ref(false);
          const fileInput = ref(null);
          // é‡Œç¨‹ç¢‘æ‹–æ‹½çŠ¶æ€ç®¡ç†
          const milestonesDragOver = ref({});
          const milestones = ref([
            {
              name: "é¡¹ç›®å¯åŠ¨",
              description: "é¡¹ç›®å¯åŠ¨é˜¶æ®µ",
              startTime: "2024-01-15",
              endTime: "2024-01-20",
              documents: [
                {
                  id: 1,
                  name: "é¡¹ç›®å¯åŠ¨ä¼šè®®çºªè¦.pdf",
                  type: "PDF",
                  uploader: "å¼ æ•™æˆ",
                  uploadTime: "2024-01-15",
                  size: "1.2MB",
                },
                {
                  id: 2,
                  name: "é¡¹ç›®è®¡åˆ’ä¹¦.docx",
                  type: "DOCX",
                  uploader: "æåšå£«",
                  uploadTime: "2024-01-16",
                  size: "2.1MB",
                },
              ],
            },
            {
              name: "éœ€æ±‚åˆ†æ",
              description: "éœ€æ±‚åˆ†æé˜¶æ®µ",
              startTime: "2024-01-21",
              endTime: "2024-01-31",
              documents: [
                {
                  id: 3,
                  name: "éœ€æ±‚åˆ†ææŠ¥å‘Š.pdf",
                  type: "PDF",
                  uploader: "ç‹ç¡•å£«",
                  uploadTime: "2024-01-25",
                  size: "3.5MB",
                },
              ],
            },
          ]);

          // æ–°å¢æˆå‘˜å¯¹è¯æ¡†ç›¸å…³
          const showMemberDialog = ref(false);
          const memberSearchKeyword = ref("");
          const memberSearchResults = ref([]);

          // é‡Œç¨‹ç¢‘å¯¹è¯æ¡†ç›¸å…³
          const showMilestoneDialog = ref(false);
          const milestoneDraft = ref({
            name: "",
            startTime: "",
            endTime: "",
            description: "",
          });
          const milestoneOptions = ref([
            "é¡¹ç›®å¯åŠ¨ï¼šå»ºè®¾æ–¹æ¡ˆé€šè¿‡å®¡æ ¸å¹¶å¤‡æ¡ˆ",
            "ä»»åŠ¡åˆ†è§£ä¸èµ„æºå‡†å¤‡ï¼šé¡¹ç›®ä»»åŠ¡ä¹¦ä¸‹è¾¾ï¼Œèµ„æºé…ç½®å®Œæˆï¼Œè¿›å…¥å®æ–½é˜¶æ®µ",
            "é¡¹ç›®å®æ–½ä¸è¿‡ç¨‹ç®¡ç†ï¼šä¸­æœŸæ£€æŸ¥",
            "æˆæœæ•´åˆä¸ç»“é¢˜å‡†å¤‡ï¼šç»“é¢˜éªŒæ”¶",
            "åç»­ç®¡ç†ä¸æˆæœè½¬åŒ–ï¼šé¡¹ç›®å½’æ¡£å®Œæˆï¼Œæˆæœè½¬åŒ–",
          ]);
          const addedMilestoneNames = computed(() => {
            if (!milestones.value || !Array.isArray(milestones.value)) {
              return [];
            }
            return milestones.value
              .map((m) => m.name)
              .filter((name) => name && name.trim());
          });

          // æ¨¡æ‹Ÿé¡¹ç›®æ•°æ®
          const mockProject = {
            id: 1,
            number: "PRJ-2024-001",
            name: "åŸºäºäººå·¥æ™ºèƒ½çš„æ™ºèƒ½è¯Šæ–­ç³»ç»Ÿç ”ç©¶",
            description:
              "æœ¬é¡¹ç›®æ—¨åœ¨å¼€å‘ä¸€å¥—åŸºäºæ·±åº¦å­¦ä¹ çš„æ™ºèƒ½è¯Šæ–­ç³»ç»Ÿï¼Œèƒ½å¤Ÿè‡ªåŠ¨åˆ†æåŒ»å­¦å½±åƒæ•°æ®ï¼Œä¸ºåŒ»ç”Ÿæä¾›è¾…åŠ©è¯Šæ–­å»ºè®®ã€‚ç³»ç»Ÿå°†é‡‡ç”¨å·ç§¯ç¥ç»ç½‘ç»œå’Œå¾ªç¯ç¥ç»ç½‘ç»œç›¸ç»“åˆçš„æ–¹æ³•ï¼Œæé«˜è¯Šæ–­å‡†ç¡®ç‡å’Œæ•ˆç‡ã€‚",
            manager: "å¼ æ•™æˆ",
            department: "ç§‘å§”", // æ–°å¢ï¼šè¯¾é¢˜å‘å¸ƒéƒ¨é—¨
            researchDirection:
              "åŸºäºæ·±åº¦å­¦ä¹ çš„æ™ºèƒ½åˆ¶é€ å…³é”®æŠ€æœ¯ç ”ç©¶ï¼Œé‡ç‚¹å›´ç»•å·¥ä¸šäº’è”ç½‘ã€æ™ºèƒ½ä¼ æ„Ÿå™¨ã€æœºå™¨è§†è§‰ç­‰æ ¸å¿ƒæŠ€æœ¯ï¼Œæ¨åŠ¨åˆ¶é€ ä¸šæ•°å­—åŒ–è½¬å‹å‡çº§ã€‚", // æ–°å¢ï¼šç ”ç©¶æ–¹å‘
            status: "progress",
            createTime: "2024-01-15",
            updateTime: "2024-01-20",
            budget: 120000,
          };

          // æ¨¡æ‹Ÿæˆå‘˜æ•°æ®
          const mockMembers = [
            {
              id: 1,
              name: "å¼ æ•™æˆ",
              role: "é¡¹ç›®è´Ÿè´£äºº",
              joinTime: "2024-01-15",
            },
            {
              id: 2,
              name: "æåšå£«",
              role: "æ ¸å¿ƒæˆå‘˜",
              joinTime: "2024-01-16",
            },
            {
              id: 3,
              name: "ç‹ç¡•å£«",
              role: "æ™®é€šæˆå‘˜",
              joinTime: "2024-01-18",
            },
          ];

          // æ¨¡æ‹Ÿæ–‡æ¡£æ•°æ®
          const mockDocuments = [
            {
              id: 1,
              name: "é¡¹ç›®éœ€æ±‚åˆ†ææŠ¥å‘Š.pdf",
              type: "PDF",
              uploader: "å¼ æ•™æˆ",
              uploadTime: "2024-01-15",
              size: "2.3MB",
            },
            {
              id: 2,
              name: "æŠ€æœ¯æ–¹æ¡ˆè®¾è®¡.docx",
              type: "DOCX",
              uploader: "æåšå£«",
              uploadTime: "2024-01-18",
              size: "1.8MB",
            },
            {
              id: 3,
              name: "æµ‹è¯•æ•°æ®.xlsx",
              type: "XLSX",
              uploader: "ç‹ç¡•å£«",
              uploadTime: "2024-01-20",
              size: "856KB",
            },
          ];

          // ç”¨æˆ·åˆ—è¡¨æ•°æ®ï¼ˆä¸æ–°å»ºé¡¹ç›®ä¿æŒä¸€è‡´ï¼‰
          const userList = [
            { id: "1", name: "å¼ æ•™æˆ", avatar: "../images/favicon.ico" },
            { id: "2", name: "æåšå£«", avatar: "../images/favicon.ico" },
            { id: "3", name: "ç‹æ•™æˆ", avatar: "../images/favicon.ico" },
            { id: "4", name: "èµµåšå£«", avatar: "../images/favicon.ico" },
            { id: "5", name: "é™ˆæ•™æˆ", avatar: "../images/favicon.ico" },
            { id: "6", name: "åˆ˜ç¡•å£«", avatar: "../images/favicon.ico" },
            { id: "7", name: "å‘¨åšå£«", avatar: "../images/favicon.ico" },
          ];

          // è·å–çŠ¶æ€æ–‡æœ¬
          const getStatusText = (status) => {
            const statusMap = {
              planned: "è®¡åˆ’ä¸­",
              progress: "è¿›è¡Œä¸­",
              completed: "å·²å®Œæˆ",
              delayed: "å·²å»¶æœŸ",
            };
            return statusMap[status] || "æœªçŸ¥";
          };

          // è§£æURLå‚æ•°
          const getQueryParam = (key) => {
            const params = new URLSearchParams(window.location.search);
            return params.get(key);
          };

          const resolveMode = () => {
            // ä¼˜å…ˆURLå‚æ•°ï¼Œå…¶æ¬¡localStorageï¼Œé»˜è®¤view
            const qs = getQueryParam("mode");
            if (qs === "edit" || qs === "view") return qs;
            try {
              const ls = localStorage.getItem("projectDetailMode");
              if (ls === "edit" || ls === "view") return ls;
            } catch {}
            return "view";
          };

          // åŠ è½½é¡¹ç›®è¯¦æƒ…
          const loadProjectDetail = async () => {
            loading.value = true;
            try {
              // æ¨¡æ‹ŸAPIè°ƒç”¨
              await new Promise((resolve) => setTimeout(resolve, 1000));

              project.value = mockProject;
              members.value = mockMembers;
              documents.value = mockDocuments;
              // è®¾ç½®æ¨¡å¼
              const mode = resolveMode();
              isEditMode.value = mode === "edit";
            } catch (error) {
              ElMessage.error("åŠ è½½é¡¹ç›®è¯¦æƒ…å¤±è´¥");
            } finally {
              loading.value = false;
            }
          };

          // è¿”å›åˆ—è¡¨
          const handleBack = () => {
            ElMessage.info("è¿”å›é¡¹ç›®åˆ—è¡¨");
            // æ£€æŸ¥æ˜¯å¦åœ¨iframeä¸­
            if (window.parent !== window) {
              window.parent.postMessage(
                {
                  type: "navigate",
                  path: "project/list",
                },
                "*"
              );
            } else {
              window.location.href = "é¡¹ç›®åˆ—è¡¨.html";
            }
          };

          // æœç´¢æˆå‘˜
          const searchMembers = () => {
            if (searchMemberKeyword.value.trim()) {
              searchResults.value = mockSearchResults.filter(
                (user) =>
                  user.name.includes(searchMemberKeyword.value) ||
                  user.studentId.includes(searchMemberKeyword.value)
              );
            } else {
              searchResults.value = [];
            }
          };

          // å®æ—¶æœç´¢æˆå‘˜ï¼ˆæ—§ç‰ˆæœ¬ï¼Œä¿ç•™å…¼å®¹æ€§ï¼‰
          const handleMemberSearchOld = () => {
            if (searchMemberKeyword.value.trim()) {
              searchResults.value = mockSearchResults.filter(
                (user) =>
                  user.name
                    .toLowerCase()
                    .includes(searchMemberKeyword.value.toLowerCase()) ||
                  user.studentId
                    .toLowerCase()
                    .includes(searchMemberKeyword.value.toLowerCase())
              );
            } else {
              searchResults.value = [];
            }
          };

          // æ‰“å¼€æˆå‘˜å¯¹è¯æ¡†
          const openMemberDialog = () => {
            memberSearchKeyword.value = "";
            memberSearchResults.value = [];
            showMemberDialog.value = true;
          };

          // å…³é—­æˆå‘˜å¯¹è¯æ¡†
          const closeMemberDialog = () => {
            showMemberDialog.value = false;
          };

          // æˆå‘˜æœç´¢å¤„ç†
          const handleMemberSearch = () => {
            if (!memberSearchKeyword.value.trim()) {
              memberSearchResults.value = [];
              return;
            }

            // æ¨¡æ‹Ÿæœç´¢API
            const keyword = memberSearchKeyword.value.toLowerCase();
            memberSearchResults.value = userList.filter(
              (user) =>
                user.name.toLowerCase().includes(keyword) ||
                user.id.toLowerCase().includes(keyword)
            );
          };

          // æ·»åŠ æˆå‘˜
          const handleAddMember = (user) => {
            // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯æˆå‘˜
            const isAlreadyMember = members.value.some(
              (member) => member.id === user.id
            );
            if (isAlreadyMember) {
              ElMessage.warning("è¯¥ç”¨æˆ·å·²ç»æ˜¯é¡¹ç›®æˆå‘˜");
              return;
            }

            // æ·»åŠ åˆ°æˆå‘˜åˆ—è¡¨
            const newMember = {
              id: user.id,
              name: user.name,
              role: "member", // ä½¿ç”¨ä¸æ–°å»ºé¡¹ç›®ä¸€è‡´çš„è§’è‰²æ ‡è¯†
              joinTime: new Date().toISOString().split("T")[0],
            };

            members.value.push(newMember);
            ElMessage.success(`æˆåŠŸæ·»åŠ æˆå‘˜: ${user.name}`);

            // æ¸…ç©ºæœç´¢
            memberSearchKeyword.value = "";
            memberSearchResults.value = [];

            // å»¶è¿Ÿå…³é—­å¯¹è¯æ¡†ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æ·»åŠ æ•ˆæœ
            setTimeout(() => {
              showMemberDialog.value = false;
            }, 1000);
          };

          // è·å–è§’è‰²æ–‡æœ¬
          const getRoleText = (role) => {
            const roleMap = {
              manager: "é¡¹ç›®è´Ÿè´£äºº",
              core: "æ ¸å¿ƒæˆå‘˜",
              member: "æ™®é€šæˆå‘˜",
              é¡¹ç›®è´Ÿè´£äºº: "é¡¹ç›®è´Ÿè´£äºº",
              æ ¸å¿ƒæˆå‘˜: "æ ¸å¿ƒæˆå‘˜",
              æ™®é€šæˆå‘˜: "æ™®é€šæˆå‘˜",
            };
            return roleMap[role] || "æ™®é€šæˆå‘˜";
          };

          // å–æ¶ˆæ·»åŠ æˆå‘˜
          const handleCancelAddMember = () => {
            showAddMember.value = false;
            searchMemberKeyword.value = "";
            searchResults.value = [];
          };

          // ç§»é™¤æˆå‘˜
          const handleRemoveMember = async (memberId) => {
            const member = members.value.find((m) => m.id === memberId);
            if (!member) return;

            try {
              await ElMessageBox.confirm(
                `ç¡®å®šè¦ç§»é™¤æˆå‘˜"${member.name}"å—ï¼Ÿç§»é™¤åè¯¥æˆå‘˜å°†æ— æ³•è®¿é—®é¡¹ç›®ä¿¡æ¯ã€‚`,
                "ç¡®è®¤ç§»é™¤",
                {
                  confirmButtonText: "ç¡®å®š",
                  cancelButtonText: "å–æ¶ˆ",
                  type: "warning",
                }
              );

              // ä»æˆå‘˜åˆ—è¡¨ä¸­ç§»é™¤
              const index = members.value.findIndex((m) => m.id === memberId);
              if (index > -1) {
                members.value.splice(index, 1);
                ElMessage.success(`å·²æˆåŠŸç§»é™¤æˆå‘˜: ${member.name}`);
              }
            } catch (error) {
              // ç”¨æˆ·å–æ¶ˆæ“ä½œ
            }
          };

          // é¢„è§ˆæ–‡æ¡£
          const handlePreview = (docId) => {
            const doc = documents.value.find((d) => d.id === docId);
            if (!doc) return;

            ElMessage.info(`é¢„è§ˆæ–‡æ¡£: ${doc.name}`);
            // è¿™é‡Œåº”è¯¥æ‰“å¼€æ–‡æ¡£é¢„è§ˆçª—å£æˆ–æ–°æ ‡ç­¾é¡µ
            // æ ¹æ®æ–‡æ¡£ç±»å‹å†³å®šé¢„è§ˆæ–¹å¼
            if (doc.type === "PDF") {
              // PDFé¢„è§ˆ
              window.open(`/api/documents/${docId}/preview`, "_blank");
            } else if (["DOC", "DOCX"].includes(doc.type)) {
              // Wordæ–‡æ¡£é¢„è§ˆ
              window.open(`/api/documents/${docId}/preview`, "_blank");
            } else if (["XLS", "XLSX"].includes(doc.type)) {
              // Excelæ–‡æ¡£é¢„è§ˆ
              window.open(`/api/documents/${docId}/preview`, "_blank");
            } else {
              ElMessage.warning("è¯¥æ–‡æ¡£ç±»å‹æš‚ä¸æ”¯æŒé¢„è§ˆ");
            }
          };

          // ä¸‹è½½æ–‡æ¡£
          const handleDownload = (docId) => {
            ElMessage.info(`ä¸‹è½½æ–‡æ¡£: ${docId}`);
            // è¿™é‡Œåº”è¯¥è§¦å‘æ–‡æ¡£ä¸‹è½½
          };

          // åˆ é™¤æ–‡æ¡£
          const handleDeleteDoc = async (docId) => {
            try {
              await ElMessageBox.confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡æ¡£å—ï¼Ÿ", "ç¡®è®¤åˆ é™¤", {
                confirmButtonText: "ç¡®å®š",
                cancelButtonText: "å–æ¶ˆ",
                type: "warning",
              });

              ElMessage.success("æ–‡æ¡£åˆ é™¤æˆåŠŸ");
              // è¿™é‡Œåº”è¯¥è°ƒç”¨APIåˆ é™¤æ–‡æ¡£
            } catch (error) {
              // ç”¨æˆ·å–æ¶ˆæ“ä½œ
            }
          };

          // è§¦å‘æ–‡ä»¶ä¸Šä¼ 
          const triggerUpload = () => {
            fileInput.value.click();
          };

          // å¤„ç†æ–‡ä»¶é€‰æ‹©
          const handleFileSelect = (event) => {
            const files = event.target.files;
            if (files.length > 0) {
              uploadFiles(files);
            }
          };

          // å¤„ç†æ‹–æ‹½äº‹ä»¶
          const handleDragOver = (event) => {
            event.preventDefault();
            isDragOver.value = true;
          };

          const handleDragLeave = (event) => {
            event.preventDefault();
            isDragOver.value = false;
          };

          const handleDrop = (event) => {
            event.preventDefault();
            isDragOver.value = false;
            const files = event.dataTransfer.files;
            if (files.length > 0) {
              uploadFiles(files);
            }
          };

          // ä¸Šä¼ æ–‡ä»¶
          const uploadFiles = (files) => {
            ElMessage.info(`å¼€å§‹ä¸Šä¼  ${files.length} ä¸ªæ–‡ä»¶`);
            // è¿™é‡Œåº”è¯¥å®ç°æ–‡ä»¶ä¸Šä¼ é€»è¾‘
            // æ¨¡æ‹Ÿä¸Šä¼ è¿›åº¦
            setTimeout(() => {
              ElMessage.success("æ–‡ä»¶ä¸Šä¼ æˆåŠŸ");
            }, 2000);
          };

          // ä¿å­˜é¡¹ç›®ï¼ˆç¼–è¾‘ï¼‰
          const handleSaveProject = async () => {
            // è¿™é‡Œåº”è¿›è¡Œè¡¨å•æ ¡éªŒä¸æäº¤
            ElMessage.success("é¡¹ç›®ä¿å­˜æˆåŠŸ");
            handleBack();
          };

          // é‡Œç¨‹ç¢‘å¯¹è¯æ¡†ç›¸å…³æ–¹æ³•
          const openMilestoneDialog = () => {
            milestoneDraft.value = {
              name: "",
              startTime: "",
              endTime: "",
              description: "",
            };
            showMilestoneDialog.value = true;
          };

          const closeMilestoneDialog = () => {
            showMilestoneDialog.value = false;
          };

          const confirmAddMilestone = () => {
            const d = milestoneDraft.value;
            if (!d.name.trim()) {
              ElMessage.warning("è¯·è¾“å…¥é‡Œç¨‹ç¢‘åç§°");
              return;
            }
            if (addedMilestoneNames.value.includes(d.name.trim())) {
              ElMessage.warning("è¯¥é‡Œç¨‹ç¢‘å·²æ·»åŠ ");
              return;
            }
            if (!d.startTime || !d.endTime) {
              ElMessage.warning("è¯·é€‰æ‹©å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´");
              return;
            }
            if (new Date(d.startTime) >= new Date(d.endTime)) {
              ElMessage.warning("ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´");
              return;
            }
            milestones.value.push({
              name: d.name.trim(),
              startTime: d.startTime,
              endTime: d.endTime,
              description: d.description || "",
            });
            showMilestoneDialog.value = false;
            ElMessage.success("å·²æ·»åŠ é‡Œç¨‹ç¢‘");
          };

          const handleRemoveMilestone = (index) => {
            milestones.value.splice(index, 1);
          };

          // é‡Œç¨‹ç¢‘æ–‡æ¡£ç®¡ç†æ–¹æ³•
          const triggerMilestoneUpload = (milestoneIndex) => {
            // ä½¿ç”¨nextTickç¡®ä¿DOMå·²æ›´æ–°
            nextTick(() => {
              const fileInput = document.getElementById(
                `milestoneFileInput${milestoneIndex}`
              );
              if (fileInput) {
                fileInput.click();
              } else {
                // å¤‡ç”¨æ–¹æ³•ï¼šé€šè¿‡æŸ¥è¯¢é€‰æ‹©å™¨æŸ¥æ‰¾
                const allInputs =
                  document.querySelectorAll('input[type="file"]');
                const targetInput = Array.from(allInputs).find(
                  (input) => input.id === `milestoneFileInput${milestoneIndex}`
                );
                if (targetInput) {
                  targetInput.click();
                }
              }
            });
          };

          const handleMilestoneFileSelect = (event, milestoneIndex) => {
            const files = event.target.files;
            if (files.length > 0) {
              uploadMilestoneFiles(files, milestoneIndex);
              // æ¸…ç©ºinputå€¼ï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
              event.target.value = "";
            }
          };

          const uploadMilestoneFiles = (files, milestoneIndex) => {
            // éªŒè¯æ–‡ä»¶ - æ”¯æŒæ›´å¤šæ ¼å¼
            const allowedTypes = [
              ".pdf",
              ".doc",
              ".docx",
              ".xls",
              ".xlsx",
              ".ppt",
              ".pptx", // åŠå…¬æ–‡æ¡£
              ".txt",
              ".md",
              ".rtf", // æ–‡æœ¬æ–‡æ¡£
              ".jpg",
              ".jpeg",
              ".png",
              ".gif",
              ".bmp",
              ".svg",
              ".webp", // å›¾ç‰‡
              ".zip",
              ".rar",
              ".7z",
              ".tar",
              ".gz", // å‹ç¼©åŒ…
              ".mp4",
              ".avi",
              ".mov",
              ".wmv",
              ".flv", // è§†é¢‘
              ".mp3",
              ".wav",
              ".flac",
              ".aac", // éŸ³é¢‘
            ];
            const maxSize = 50 * 1024 * 1024; // 50MB

            for (let file of files) {
              const fileExt = "." + file.name.split(".").pop().toLowerCase();
              if (!allowedTypes.includes(fileExt)) {
                ElMessage.error(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${file.name}`);
                return;
              }
              if (file.size > maxSize) {
                ElMessage.error(`æ–‡ä»¶è¿‡å¤§: ${file.name} (æœ€å¤§æ”¯æŒ50MB)`);
                return;
              }
            }

            // åˆå§‹åŒ–æ–‡æ¡£æ•°ç»„
            if (!milestones.value[milestoneIndex].documents) {
              milestones.value[milestoneIndex].documents = [];
            }

            // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
            const loadingMessage = ElMessage({
              message: `æ­£åœ¨ä¸Šä¼  ${files.length} ä¸ªæ–‡ä»¶...`,
              type: "info",
              duration: 0,
              showClose: false,
            });

            // æ¨¡æ‹Ÿä¸Šä¼ è¿‡ç¨‹
            setTimeout(() => {
              loadingMessage.close();

              let successCount = 0;
              for (let i = 0; i < files.length; i++) {
                const file = files[i];

                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåæ–‡ä»¶
                const existingDoc = milestones.value[
                  milestoneIndex
                ].documents.find((doc) => doc.name === file.name);

                if (existingDoc) {
                  ElMessage.warning(`æ–‡ä»¶å·²å­˜åœ¨: ${file.name}`);
                  continue;
                }

                const newDoc = {
                  id: Date.now() + Math.random() + i,
                  name: file.name,
                  type: file.name.split(".").pop().toUpperCase(),
                  uploader: "å½“å‰ç”¨æˆ·",
                  uploadTime: new Date().toISOString().split("T")[0],
                  size: formatFileSize(file.size),
                };

                milestones.value[milestoneIndex].documents.push(newDoc);
                successCount++;
              }

              if (successCount > 0) {
                ElMessage.success(
                  `å·²ä¸ºé‡Œç¨‹ç¢‘ ${
                    milestoneIndex + 1
                  } æˆåŠŸæ·»åŠ  ${successCount} ä¸ªæ–‡æ¡£`
                );
              }
            }, 1000); // æ¨¡æ‹Ÿ1ç§’ä¸Šä¼ æ—¶é—´
          };

          // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
          const formatFileSize = (bytes) => {
            if (bytes === 0) return "0 B";
            const k = 1024;
            const sizes = ["B", "KB", "MB", "GB"];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return (
              parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + " " + sizes[i]
            );
          };

          const handleDeleteMilestoneDoc = (milestoneIndex, docId) => {
            const milestone = milestones.value[milestoneIndex];
            if (milestone.documents) {
              const docIndex = milestone.documents.findIndex(
                (doc) => doc.id === docId
              );
              if (docIndex > -1) {
                const docName = milestone.documents[docIndex].name;
                milestone.documents.splice(docIndex, 1);
                ElMessage.success(`å·²åˆ é™¤æ–‡æ¡£: ${docName}`);
              }
            }
          };

          // é‡Œç¨‹ç¢‘æ‹–æ‹½äº‹ä»¶å¤„ç†
          const handleMilestoneDragOver = (milestoneIndex) => {
            milestonesDragOver.value[milestoneIndex] = true;
          };

          const handleMilestoneDragLeave = (milestoneIndex) => {
            milestonesDragOver.value[milestoneIndex] = false;
          };

          const handleMilestoneDrop = (event, milestoneIndex) => {
            event.preventDefault();
            milestonesDragOver.value[milestoneIndex] = false;
            const files = event.dataTransfer.files;
            if (files.length > 0) {
              uploadMilestoneFiles(files, milestoneIndex);
            }
          };

          // ç»„ä»¶æŒ‚è½½æ—¶åŠ è½½æ•°æ®
          onMounted(() => {
            console.log("é¡¹ç›®è¯¦æƒ…é¡µé¢åŠ è½½ä¸­...");
            loadProjectDetail();
          });

          return {
            loading,
            isEditMode,
            project,
            members,
            documents,
            milestones,
            showAddMember,
            searchMemberKeyword,
            searchResults,
            isDragOver,
            fileInput,
            getStatusText,
            handleBack,
            searchMembers,
            handleMemberSearch,
            handleAddMember,
            handleCancelAddMember,
            handleRemoveMember,
            handlePreview,
            handleDownload,
            handleDeleteDoc,
            triggerUpload,
            handleFileSelect,
            handleDragOver,
            handleDragLeave,
            handleDrop,
            handleSaveProject,
            // æ–°å¢çš„æˆå‘˜å¯¹è¯æ¡†ç›¸å…³
            showMemberDialog,
            memberSearchKeyword,
            memberSearchResults,
            openMemberDialog,
            closeMemberDialog,
            getRoleText,
            // æ–°å¢çš„é‡Œç¨‹ç¢‘å¯¹è¯æ¡†ç›¸å…³
            showMilestoneDialog,
            milestoneDraft,
            milestoneOptions,
            addedMilestoneNames,
            openMilestoneDialog,
            closeMilestoneDialog,
            confirmAddMilestone,
            handleRemoveMilestone,
            // é‡Œç¨‹ç¢‘æ–‡æ¡£ç®¡ç†ç›¸å…³
            triggerMilestoneUpload,
            handleMilestoneFileSelect,
            handleDeleteMilestoneDoc,
            formatFileSize,
            // é‡Œç¨‹ç¢‘æ‹–æ‹½ç›¸å…³
            milestonesDragOver,
            handleMilestoneDragOver,
            handleMilestoneDragLeave,
            handleMilestoneDrop,
          };
        },
      })
        .use(ElementPlus, {
          locale: window.ElementPlusLocaleZhCn || {
            name: "zh-cn",
            el: {
              datepicker: {
                now: "æ­¤åˆ»",
                today: "ä»Šå¤©",
                cancel: "å–æ¶ˆ",
                clear: "æ¸…ç©º",
                confirm: "ç¡®è®¤",
                selectDate: "é€‰æ‹©æ—¥æœŸ",
                selectTime: "é€‰æ‹©æ—¶é—´",
                startDate: "å¼€å§‹æ—¥æœŸ",
                startTime: "å¼€å§‹æ—¶é—´",
                endDate: "ç»“æŸæ—¥æœŸ",
                endTime: "ç»“æŸæ—¶é—´",
                prevYear: "å‰ä¸€å¹´",
                nextYear: "åä¸€å¹´",
                prevMonth: "ä¸Šä¸ªæœˆ",
                nextMonth: "ä¸‹ä¸ªæœˆ",
                year: "å¹´",
                month1: "1æœˆ",
                month2: "2æœˆ",
                month3: "3æœˆ",
                month4: "4æœˆ",
                month5: "5æœˆ",
                month6: "6æœˆ",
                month7: "7æœˆ",
                month8: "8æœˆ",
                month9: "9æœˆ",
                month10: "10æœˆ",
                month11: "11æœˆ",
                month12: "12æœˆ",
                weeks: {
                  sun: "æ—¥",
                  mon: "ä¸€",
                  tue: "äºŒ",
                  wed: "ä¸‰",
                  thu: "å››",
                  fri: "äº”",
                  sat: "å…­",
                },
                months: {
                  jan: "ä¸€æœˆ",
                  feb: "äºŒæœˆ",
                  mar: "ä¸‰æœˆ",
                  apr: "å››æœˆ",
                  may: "äº”æœˆ",
                  jun: "å…­æœˆ",
                  jul: "ä¸ƒæœˆ",
                  aug: "å…«æœˆ",
                  sep: "ä¹æœˆ",
                  oct: "åæœˆ",
                  nov: "åä¸€æœˆ",
                  dec: "åäºŒæœˆ",
                },
              },
            },
          },
        })
        .mount("#app");
    </script>
  </body>
</html>
