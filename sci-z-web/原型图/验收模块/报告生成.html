<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>æŠ¥å‘Šç”Ÿæˆ - é«˜æ ¡ç§‘ç ”é¡¹ç›®ç®¡ç†å¹³å°</title>
    <link rel="icon" href="../images/favicon.ico" type="image/x-icon" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/element-plus/dist/index.css"
    />
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue@2.3.1/dist/index.iife.js"></script>

    <!-- å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ -->
    <script src="https://unpkg.com/quill@1.3.7/dist/quill.min.js"></script>
    <link
      href="https://unpkg.com/quill@1.3.7/dist/quill.snow.css"
      rel="stylesheet"
    />

    <!-- Markdown æ¸²æŸ“ -->
    <script src="https://unpkg.com/marked@4.3.0/marked.min.js"></script>
    <script src="https://unpkg.com/highlight.js@11.8.0/lib/index.min.js"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/highlight.js@11.8.0/styles/github.min.css"
    />

    <!-- æ–‡æ¡£å¯¼å‡º -->
    <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/docx@7.8.2/build/index.js"></script>

    <link rel="stylesheet" href="../é€šç”¨è§„èŒƒ/æ ·å¼.css" />
    <style>
      /* é¡µé¢å¸ƒå±€æ ·å¼ */
      .report-generation-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        background: #f7f9fc;
        font-family: "Inter", "PingFang SC", "Microsoft YaHei", sans-serif;
      }

      /* é¡µé¢å¤´éƒ¨ */
      .page-header {
        background: #ffffff;
        border-bottom: 1px solid #e5e7eb;
        padding: 20px 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .page-title {
        font-size: 24px;
        font-weight: 600;
        color: #1e3a8a;
        margin: 0;
      }

      .header-actions {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      /* ä¸»å†…å®¹åŒºåŸŸ */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
        padding: 24px;
        gap: 24px;
      }

      /* é…ç½®åŒºåŸŸ */
      .config-section {
        background: #ffffff;
        border-radius: 12px;
        padding: 32px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        border: 1px solid #e5e7eb;
      }

      .config-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 28px;
        padding-bottom: 20px;
        border-bottom: 2px solid #f3f4f6;
      }

      .config-title {
        font-size: 20px;
        font-weight: 700;
        color: #1e3a8a;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .config-title-icon {
        font-size: 24px;
      }

      .config-form {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
        margin-bottom: 24px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .form-label {
        font-size: 14px;
        font-weight: 500;
        color: #374151;
      }

      .form-label.required::after {
        content: " *";
        color: #dc2626;
      }

      .project-info {
        background: linear-gradient(135deg, #f0f9ff 0%, #dbeafe 100%);
        border: 2px solid #0ea5e9;
        border-radius: 12px;
        padding: 20px;
        margin-top: 12px;
        box-shadow: 0 2px 8px rgba(14, 165, 233, 0.1);
        position: relative;
        overflow: hidden;
      }

      .project-info::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #0ea5e9 0%, #1e3a8a 100%);
      }

      .project-info-title {
        font-size: 15px;
        font-weight: 700;
        color: #0369a1;
        margin: 0 0 16px 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .project-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
      }

      .stat-item {
        text-align: center;
        background: rgba(255, 255, 255, 0.6);
        padding: 12px;
        border-radius: 8px;
        transition: all 0.3s;
      }

      .stat-item:hover {
        background: rgba(255, 255, 255, 0.9);
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .stat-value {
        font-size: 24px;
        font-weight: 700;
        color: #0369a1;
        margin: 0;
      }

      .stat-label {
        font-size: 12px;
        color: #6b7280;
        margin: 8px 0 0 0;
        font-weight: 500;
      }

      /* æŠ¥å‘Šç±»å‹é€‰æ‹© */
      .report-type-selector {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        grid-column: 1 / -1;
      }

      .type-card {
        border: 3px solid #e5e7eb;
        border-radius: 12px;
        padding: 28px 24px;
        cursor: pointer;
        transition: all 0.3s;
        background: #fafbfc;
        position: relative;
        overflow: hidden;
      }

      .type-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #1e3a8a 0%, #0ea5e9 100%);
        transform: scaleX(0);
        transition: transform 0.3s;
      }

      .type-card:hover {
        border-color: #1e3a8a;
        background: #eef2ff;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(30, 58, 138, 0.15);
      }

      .type-card:hover::before {
        transform: scaleX(1);
      }

      .type-card.selected {
        border-color: #1e3a8a;
        background: linear-gradient(135deg, #eef2ff 0%, #f0f9ff 100%);
        box-shadow: 0 4px 16px rgba(30, 58, 138, 0.2);
      }

      .type-card.selected::before {
        transform: scaleX(1);
      }

      .type-card.selected .type-icon {
        transform: scale(1.1);
      }

      .type-icon {
        font-size: 48px;
        margin-bottom: 16px;
        transition: transform 0.3s;
        display: block;
      }

      .type-title {
        font-size: 18px;
        font-weight: 700;
        color: #1e3a8a;
        margin: 0 0 12px 0;
      }

      .type-description {
        font-size: 14px;
        color: #6b7280;
        line-height: 1.6;
        margin: 0;
      }

      .type-badge {
        position: absolute;
        top: 12px;
        right: 12px;
        background: #16a34a;
        color: #ffffff;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        opacity: 0;
        transform: scale(0.8);
        transition: all 0.3s;
      }

      .type-card.selected .type-badge {
        opacity: 1;
        transform: scale(1);
      }

      /* é«˜çº§é…ç½® */
      .advanced-config {
        grid-column: 1 / -1;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        overflow: hidden;
      }

      .advanced-header {
        background: #f9fafb;
        padding: 16px 20px;
        border-bottom: 1px solid #e5e7eb;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .advanced-title {
        font-size: 14px;
        font-weight: 500;
        color: #374151;
        margin: 0;
      }

      .advanced-content {
        padding: 20px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .advanced-content.collapsed {
        display: none;
      }

      /* å¼€å§‹ç”ŸæˆæŒ‰é’® */
      .generate-section {
        text-align: center;
        margin-top: 32px;
      }

      .generate-btn {
        background: linear-gradient(135deg, #1e3a8a 0%, #0ea5e9 100%);
        color: #ffffff;
        border: none;
        border-radius: 12px;
        padding: 18px 48px;
        font-size: 18px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 6px 20px rgba(30, 58, 138, 0.4);
        position: relative;
        overflow: hidden;
        display: inline-flex;
        align-items: center;
        gap: 12px;
      }

      .generate-btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.3),
          transparent
        );
        transition: left 0.5s;
      }

      .generate-btn:hover::before {
        left: 100%;
      }

      .generate-btn:hover {
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 8px 24px rgba(30, 58, 138, 0.5);
      }

      .generate-btn:active {
        transform: translateY(-1px) scale(0.98);
      }

      .generate-btn:disabled {
        background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
        cursor: not-allowed;
        transform: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .generate-btn-icon {
        font-size: 24px;
        animation: rotate 2s linear infinite;
      }

      .generate-btn:disabled .generate-btn-icon {
        animation: none;
      }

      @keyframes rotate {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      .generate-hint {
        margin-top: 16px;
        color: #9ca3af;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .generate-hint-icon {
        font-size: 16px;
      }

      /* ç”Ÿæˆå’Œé¢„è§ˆåŒºåŸŸ */
      .generation-preview-section {
        flex: 1;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
        min-height: 0;
      }

      /* ç”Ÿæˆäº¤äº’åŒºåŸŸ */
      .generation-area {
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border: 1px solid #e5e7eb;
      }

      .generation-header {
        padding: 24px 28px;
        border-bottom: 2px solid #dbeafe;
        background: linear-gradient(135deg, #f0f9ff 0%, #dbeafe 100%);
        position: relative;
      }

      .generation-header::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, #0ea5e9 0%, #1e3a8a 100%);
      }

      .generation-title {
        font-size: 18px;
        font-weight: 700;
        color: #0369a1;
        margin: 0 0 8px 0;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .generation-title-icon {
        font-size: 24px;
        animation: pulse 2s infinite;
      }

      @keyframes pulse-icon {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }

      .generation-subtitle {
        font-size: 14px;
        color: #0369a1;
        margin: 0;
        font-weight: 500;
      }

      .generation-content {
        flex: 1;
        padding: 28px;
        overflow-y: auto;
        background: linear-gradient(180deg, #f0f9ff 0%, #f8fafc 100%);
      }

      /* ç”Ÿæˆå‰çŠ¶æ€ */
      .generation-placeholder {
        text-align: center;
        padding: 80px 20px;
        background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
        border-radius: 12px;
        border: 2px dashed #cbd5e1;
      }

      .placeholder-icon {
        font-size: 64px;
        margin-bottom: 24px;
        animation: float 3s ease-in-out infinite;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      .placeholder-text {
        font-size: 18px;
        color: #374151;
        margin: 0 0 12px 0;
        font-weight: 600;
      }

      .placeholder-hint {
        font-size: 14px;
        color: #6b7280;
        margin: 0;
        line-height: 1.6;
      }

      /* ç”Ÿæˆè¿›åº¦ */
      .generation-progress {
        margin-bottom: 24px;
      }

      .progress-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }

      .progress-title {
        font-size: 14px;
        font-weight: 500;
        color: #374151;
      }

      .progress-time {
        font-size: 12px;
        color: #6b7280;
      }

      .progress-bar {
        height: 6px;
        background: #e5e7eb;
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 16px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #f59e0b 0%, #16a34a 100%);
        border-radius: 3px;
        transition: width 0.3s ease;
      }

      /* ç”Ÿæˆæ­¥éª¤ */
      .generation-steps {
        margin-bottom: 24px;
      }

      .step-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 0;
      }

      .step-icon {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        flex-shrink: 0;
      }

      .step-icon.pending {
        background: #f3f4f6;
        color: #9ca3af;
      }

      .step-icon.running {
        background: #fef3c7;
        color: #f59e0b;
        animation: pulse 2s infinite;
      }

      .step-icon.completed {
        background: #dcfce7;
        color: #16a34a;
      }

      .step-text {
        flex: 1;
        font-size: 14px;
        color: #374151;
      }

      .step-progress {
        font-size: 12px;
        color: #6b7280;
        font-weight: 500;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      /* ç”Ÿæˆæ¶ˆæ¯ */
      .generation-messages {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .message-bubble {
        background: #ffffff;
        border-radius: 16px;
        padding: 20px 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border-left: 5px solid #0ea5e9;
        position: relative;
        animation: slideIn 0.3s ease-out;
        transition: all 0.3s;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message-bubble:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        transform: translateX(4px);
      }

      .message-bubble::before {
        content: "";
        position: absolute;
        left: -5px;
        top: 20px;
        width: 5px;
        height: 40px;
        background: linear-gradient(180deg, #0ea5e9 0%, #1e3a8a 100%);
        border-radius: 4px;
      }

      .message-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
      }

      .message-type {
        font-size: 13px;
        font-weight: 600;
        color: #ffffff;
        background: linear-gradient(135deg, #0ea5e9 0%, #0369a1 100%);
        padding: 4px 12px;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(14, 165, 233, 0.3);
      }

      .message-time {
        font-size: 12px;
        color: #9ca3af;
        font-weight: 500;
      }

      .message-content {
        font-size: 15px;
        line-height: 1.7;
        color: #374151;
        font-weight: 400;
      }

      .typing-effect {
        display: inline-block;
        border-right: 3px solid #0ea5e9;
        animation: blink 1s infinite;
        padding-right: 2px;
      }

      @keyframes blink {
        0%,
        50% {
          border-color: #0ea5e9;
        }
        51%,
        100% {
          border-color: transparent;
        }
      }

      /* ç”Ÿæˆå®ŒæˆçŠ¶æ€ */
      .generation-complete {
        text-align: center;
        padding: 40px 24px;
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        border-radius: 12px;
        border: 2px solid #22c55e;
        animation: slideIn 0.5s ease-out;
      }

      .complete-icon {
        font-size: 72px;
        margin-bottom: 20px;
        animation: bounce 0.6s ease-out;
      }

      @keyframes bounce {
        0%,
        100% {
          transform: translateY(0) scale(1);
        }
        50% {
          transform: translateY(-20px) scale(1.1);
        }
      }

      .complete-title {
        font-size: 22px;
        font-weight: 700;
        color: #16a34a;
        margin: 0 0 12px 0;
      }

      .complete-summary {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin: 28px 0;
        padding: 24px;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .summary-item {
        text-align: center;
        padding: 16px;
        background: #ffffff;
        border-radius: 8px;
        transition: all 0.3s;
      }

      .summary-item:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 12px rgba(22, 163, 74, 0.2);
      }

      .summary-value {
        font-size: 28px;
        font-weight: 700;
        color: #16a34a;
        margin: 0;
      }

      .summary-label {
        font-size: 13px;
        color: #6b7280;
        margin: 8px 0 0 0;
        font-weight: 500;
      }

      .complete-actions {
        display: flex;
        gap: 16px;
        justify-content: center;
        margin-top: 28px;
        flex-wrap: wrap;
      }

      /* é¢„è§ˆåŒºåŸŸ */
      .preview-area {
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border: 1px solid #e5e7eb;
      }

      .preview-header {
        padding: 24px 28px;
        border-bottom: 2px solid #dbeafe;
        background: linear-gradient(135deg, #eef2ff 0%, #dbeafe 100%);
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: relative;
      }

      .preview-header::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, #1e3a8a 0%, #0ea5e9 100%);
      }

      .preview-title {
        font-size: 18px;
        font-weight: 700;
        color: #1e3a8a;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .preview-title-icon {
        font-size: 24px;
      }

      .preview-toolbar {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .toolbar-btn {
        padding: 8px 12px;
        border: 2px solid #d1d5db;
        border-radius: 8px;
        background: #ffffff;
        color: #6b7280;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 13px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .toolbar-btn:hover {
        background: #f3f4f6;
        color: #1e3a8a;
        border-color: #1e3a8a;
        transform: translateY(-1px);
      }

      .toolbar-btn.active {
        background: #1e3a8a;
        color: #ffffff;
        border-color: #1e3a8a;
        box-shadow: 0 2px 8px rgba(30, 58, 138, 0.3);
      }

      .preview-content {
        flex: 1;
        padding: 28px;
        overflow-y: auto;
        background: linear-gradient(180deg, #eef2ff 0%, #f8fafc 100%);
      }

      /* é¢„è§ˆå ä½ç¬¦ */
      .preview-placeholder {
        text-align: center;
        padding: 80px 20px;
        background: linear-gradient(135deg, #ffffff 0%, #eef2ff 100%);
        border-radius: 12px;
        border: 2px dashed #cbd5e1;
        min-height: 300px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      .preview-placeholder-icon {
        font-size: 64px;
        margin-bottom: 24px;
        animation: float 3s ease-in-out infinite;
      }

      .preview-placeholder-text {
        font-size: 18px;
        color: #374151;
        margin: 0;
        font-weight: 600;
      }

      /* æŠ¥å‘Šé¢„è§ˆå†…å®¹ */
      .report-preview {
        background: #ffffff;
        border-radius: 12px;
        padding: 48px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
        max-width: none;
        font-family: "Times New Roman", "SimSun", serif;
        border: 1px solid #e5e7eb;
        animation: fadeIn 0.5s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .report-header {
        text-align: center;
        margin-bottom: 48px;
        padding-bottom: 24px;
        border-bottom: 3px solid #1e3a8a;
        position: relative;
      }

      .report-header::after {
        content: "";
        position: absolute;
        bottom: -3px;
        left: 50%;
        transform: translateX(-50%);
        width: 120px;
        height: 3px;
        background: linear-gradient(90deg, #0ea5e9 0%, #1e3a8a 100%);
      }

      .report-title {
        font-size: 28px;
        font-weight: 700;
        color: #1e3a8a;
        margin: 0 0 20px 0;
        letter-spacing: 2px;
      }

      .report-meta {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
        font-size: 14px;
        color: #6b7280;
      }

      .meta-item {
        display: flex;
        justify-content: space-between;
      }

      .report-toc {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 20px;
        margin-bottom: 32px;
      }

      .toc-title {
        font-size: 16px;
        font-weight: 600;
        color: #111827;
        margin: 0 0 16px 0;
      }

      .toc-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .toc-item {
        padding: 4px 0;
      }

      .toc-link {
        color: #1e3a8a;
        text-decoration: none;
        font-size: 14px;
      }

      .toc-link:hover {
        text-decoration: underline;
      }

      .report-section {
        margin-bottom: 32px;
      }

      .section-title {
        font-size: 18px;
        font-weight: 600;
        color: #111827;
        margin: 0 0 16px 0;
        padding-bottom: 8px;
        border-bottom: 1px solid #e5e7eb;
      }

      .section-content {
        font-size: 14px;
        line-height: 1.8;
        color: #374151;
        text-align: justify;
      }

      /* å“åº”å¼è®¾è®¡ */
      @media (max-width: 1200px) {
        .generation-preview-section {
          grid-template-columns: 1fr;
          grid-template-rows: 1fr 1fr;
        }

        .config-form {
          grid-template-columns: 1fr;
        }

        .report-type-selector {
          grid-template-columns: 1fr;
        }

        .advanced-content {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 768px) {
        .main-content {
          padding: 16px;
        }

        .page-header {
          padding: 12px 16px;
        }

        .config-section,
        .generation-area,
        .preview-area {
          padding: 16px;
        }

        .report-preview {
          padding: 20px;
        }

        .project-stats {
          grid-template-columns: 1fr;
        }

        .complete-summary {
          grid-template-columns: 1fr;
        }
      }

      /* ç¼–è¾‘æ¨¡å¼æ ·å¼ */
      .edit-mode .report-preview {
        border: 2px dashed #1e3a8a;
      }

      .edit-toolbar {
        position: sticky;
        top: 0;
        background: #ffffff;
        border-bottom: 1px solid #e5e7eb;
        padding: 12px 20px;
        z-index: 10;
      }

      .edit-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
      }

      .edit-btn {
        padding: 6px 12px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        background: #ffffff;
        color: #374151;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
      }

      .edit-btn:hover {
        background: #f3f4f6;
      }

      .edit-btn.primary {
        background: #1e3a8a;
        color: #ffffff;
        border-color: #1e3a8a;
      }

      .edit-btn.primary:hover {
        background: #1e40af;
      }

      /* å¯Œæ–‡æœ¬ç¼–è¾‘å™¨æ ·å¼ */
      .ql-editor {
        font-family: "Times New Roman", serif;
        font-size: 14px;
        line-height: 1.8;
      }

      .ql-toolbar {
        border-top: 1px solid #e5e7eb;
        border-left: 1px solid #e5e7eb;
        border-right: 1px solid #e5e7eb;
      }

      .ql-container {
        border-bottom: 1px solid #e5e7eb;
        border-left: 1px solid #e5e7eb;
        border-right: 1px solid #e5e7eb;
      }

      /* åŠ è½½æç¤ºæ ·å¼ */
      .report-loading .el-loading-spinner {
        margin-top: -30px;
      }

      .report-loading .el-loading-text {
        font-size: 16px;
        font-weight: 500;
        color: #ffffff;
        margin-top: 10px;
      }

      .report-loading .el-loading-spinner .circular {
        width: 50px;
        height: 50px;
      }

      /* æŠ¥å‘Šæäº¤å¯¹è¯æ¡†æ ·å¼ */
      .report-submit-dialog {
        border-radius: 12px !important;
        overflow: hidden;
      }

      .report-submit-dialog .el-message-box__header {
        padding-top: 24px;
        padding-bottom: 16px;
      }

      .report-submit-dialog .el-message-box__title {
        font-size: 18px;
        font-weight: 600;
      }

      .report-submit-dialog .el-message-box__content {
        padding: 20px 24px;
      }

      .report-submit-dialog .el-message-box__message {
        font-size: 15px;
        line-height: 1.6;
        color: #374151;
      }

      .report-submit-dialog .el-message-box__btns {
        padding: 16px 24px 24px;
      }

      .report-submit-dialog .el-button--primary {
        padding: 10px 24px;
        border-radius: 8px;
        font-weight: 500;
      }

      /* é«˜çº§é…ç½®æ ·å¼ç»Ÿä¸€ */
      .advanced-content .el-radio__input.is-checked .el-radio__inner {
        background-color: #1e3a8a;
        border-color: #1e3a8a;
      }

      .advanced-content .el-radio__input.is-checked + .el-radio__label {
        color: #1e3a8a;
      }

      .advanced-content .el-radio__inner:hover {
        border-color: #1e3a8a;
      }

      .advanced-content .el-textarea__inner:focus {
        border-color: #1e3a8a;
      }

      .advanced-content .el-textarea__inner:hover {
        border-color: #1e3a8a;
      }

      /* å·¥ä½œæµé€‰æ‹©æ ·å¼ */
      .workflow-option {
        padding: 8px 0;
      }

      .workflow-name {
        font-size: 14px;
        font-weight: 500;
        color: #374151;
        line-height: 1.4;
      }

      .workflow-description {
        font-size: 12px;
        color: #6b7280;
        line-height: 1.3;
        margin-top: 2px;
      }

      .workflow-info {
        margin-top: 12px;
        padding: 16px;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
      }

      .workflow-info-title {
        font-size: 16px;
        font-weight: 600;
        color: #1e3a8a;
        margin-bottom: 8px;
      }

      .workflow-info-description {
        font-size: 14px;
        color: #64748b;
        line-height: 1.5;
      }

      /* ä¸‹æ‹‰æ¡†é€‰é¡¹æ ·å¼ä¼˜åŒ– */
      .el-select-dropdown__item {
        height: auto !important;
        padding: 8px 20px !important;
        line-height: normal !important;
      }

      /* æœç´¢æ¡†æ ·å¼ */
      .el-select .el-input__inner {
        cursor: pointer;
      }

      .el-select .el-input.is-focus .el-input__inner {
        cursor: text;
      }

      /* æœç´¢ç»“æœé«˜äº® */
      .workflow-option .highlight {
        background-color: #fef3c7;
        color: #92400e;
        padding: 0 2px;
        border-radius: 2px;
      }

      /* æ— æœç´¢ç»“æœæ—¶çš„æ ·å¼ */
      .el-select-dropdown__empty {
        padding: 20px 0 !important;
        color: #9ca3af !important;
        text-align: center !important;
        font-size: 14px !important;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="report-generation-container">
        <!-- é¡µé¢å¤´éƒ¨ -->
        <div class="page-header">
          <div class="header-left">
            <el-button
              class="back-button"
              @click="handleBack"
              :icon="ArrowLeft"
            >
              è¿”å›åˆ—è¡¨
            </el-button>
            <h1 class="page-title">æ™ºèƒ½æŠ¥å‘Šç”Ÿæˆ</h1>
          </div>
          <div class="header-actions">
            <el-button
              v-if="isGenerateComplete"
              @click="handleSaveReport"
              type="primary"
              size="large"
            >
              <el-icon><Document /></el-icon>
              ä¿å­˜æŠ¥å‘Š
            </el-button>
          </div>
        </div>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
          <!-- é…ç½®åŒºåŸŸ -->
          <div class="config-section">
            <div class="config-header">
              <h2 class="config-title">
                <span class="config-title-icon">âš™ï¸</span>
                æŠ¥å‘Šé…ç½®
              </h2>
            </div>

            <div class="config-form">
              <!-- é¡¹ç›®é€‰æ‹© -->
              <div class="form-group">
                <label class="form-label required">é€‰æ‹©é¡¹ç›®</label>
                <el-select
                  v-model="config.projectId"
                  placeholder="è¯·é€‰æ‹©è¦ç”ŸæˆæŠ¥å‘Šçš„é¡¹ç›®"
                  :loading="loadingProjects"
                  @change="handleProjectChange"
                  filterable
                  clearable
                  style="width: 100%"
                >
                  <el-option
                    v-for="project in projects"
                    :key="project.id"
                    :label="`${project.name} (${project.code})`"
                    :value="project.id"
                  >
                    <div
                      style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                      "
                    >
                      <span>{{ project.name }}</span>
                      <el-tag
                        size="small"
                        :type="project.status === 'completed' ? 'success' : 'warning'"
                      >
                        {{ project.statusText }}
                      </el-tag>
                    </div>
                  </el-option>
                </el-select>

                <!-- é¡¹ç›®ä¿¡æ¯å±•ç¤º -->
                <div v-if="config.projectInfo" class="project-info">
                  <h4 class="project-info-title">ğŸ“Š é¡¹ç›®çŸ¥è¯†åº“ä¿¡æ¯</h4>
                  <div class="project-stats">
                    <div class="stat-item">
                      <p class="stat-value">
                        {{ config.projectInfo.docCount }}
                      </p>
                      <p class="stat-label">æ–‡æ¡£æ•°é‡</p>
                    </div>
                    <div class="stat-item">
                      <p class="stat-value">
                        {{ config.projectInfo.wordCount }}
                      </p>
                      <p class="stat-label">æ€»å­—æ•°</p>
                    </div>
                    <div class="stat-item">
                      <p class="stat-value">
                        {{ config.projectInfo.progress }}%
                      </p>
                      <p class="stat-label">é¡¹ç›®è¿›åº¦</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- å·¥ä½œæµé€‰æ‹© -->
              <div class="form-group">
                <label class="form-label required">é€‰æ‹©å·¥ä½œæµ</label>
                <el-select
                  v-model="config.workflow"
                  placeholder="è¯·é€‰æ‹©å·¥ä½œæµ"
                  style="width: 100%"
                  filterable
                  :filter-method="filterWorkflow"
                  no-match-text="æœªæ‰¾åˆ°åŒ¹é…çš„å·¥ä½œæµ"
                  no-data-text="æš‚æ— å·¥ä½œæµæ•°æ®"
                >
                  <el-option
                    v-for="workflow in filteredWorkflowOptions"
                    :key="workflow.id"
                    :label="workflow.name"
                    :value="workflow.id"
                  >
                    <div class="workflow-option">
                      <div
                        class="workflow-name"
                        v-html="highlightText(workflow.name, workflowSearchQuery)"
                      ></div>
                      <div
                        class="workflow-description"
                        v-html="highlightText(workflow.description, workflowSearchQuery)"
                      ></div>
                    </div>
                  </el-option>
                </el-select>
                <div v-if="selectedWorkflow" class="workflow-info">
                  <div class="workflow-info-title">
                    {{ selectedWorkflow.name }}
                  </div>
                  <div class="workflow-info-description">
                    {{ selectedWorkflow.description }}
                  </div>
                </div>
              </div>

              <!-- æŠ¥å‘Šç±»å‹é€‰æ‹© -->
              <div class="form-group">
                <label class="form-label required">æŠ¥å‘Šç±»å‹</label>
                <div class="report-type-selector">
                  <div
                    class="type-card"
                    :class="{ selected: config.reportType === 'tech' }"
                    @click="config.reportType = 'tech'"
                  >
                    <span class="type-badge">å·²é€‰æ‹©</span>
                    <div class="type-icon">ğŸ“„</div>
                    <h4 class="type-title">ç§‘æŠ€æŠ¥å‘Š</h4>
                    <p class="type-description">
                      æè¿°é¡¹ç›®çš„ç§‘ç ”æˆæœã€æŠ€æœ¯åˆ›æ–°ã€å­¦æœ¯ä»·å€¼
                    </p>
                  </div>
                  <div
                    class="type-card"
                    :class="{ selected: config.reportType === 'self' }"
                    @click="config.reportType = 'self'"
                  >
                    <span class="type-badge">å·²é€‰æ‹©</span>
                    <div class="type-icon">ğŸ“Š</div>
                    <h4 class="type-title">è‡ªè¯„æŠ¥å‘Š</h4>
                    <p class="type-description">
                      å¯¹é¡¹ç›®æ‰§è¡Œæƒ…å†µã€å®Œæˆè´¨é‡è¿›è¡Œè‡ªæˆ‘è¯„ä»·
                    </p>
                  </div>
                </div>
              </div>

              <!-- é«˜çº§é…ç½® -->
              <div class="advanced-config">
                <div class="advanced-header" @click="toggleAdvanced">
                  <h4 class="advanced-title">é«˜çº§é…ç½®ï¼ˆå¯é€‰ï¼‰</h4>
                  <el-icon>
                    <component :is="showAdvanced ? 'ArrowUp' : 'ArrowDown'" />
                  </el-icon>
                </div>
                <div
                  class="advanced-content"
                  :class="{ collapsed: !showAdvanced }"
                >
                  <div class="form-group">
                    <label class="form-label">æŠ¥å‘Šé£æ ¼</label>
                    <el-radio-group v-model="config.style">
                      <el-radio label="formal">æ­£å¼</el-radio>
                      <el-radio label="academic">å­¦æœ¯</el-radio>
                      <el-radio label="concise">ç®€æ´</el-radio>
                    </el-radio-group>
                  </div>
                  <div class="form-group">
                    <label class="form-label">è¯¦ç»†ç¨‹åº¦</label>
                    <el-radio-group v-model="config.detail">
                      <el-radio label="brief">ç®€è¦</el-radio>
                      <el-radio label="standard">æ ‡å‡†</el-radio>
                      <el-radio label="detailed">è¯¦ç»†</el-radio>
                    </el-radio-group>
                  </div>
                  <div class="form-group" style="grid-column: 1 / -1">
                    <label class="form-label">ç‰¹æ®Šè¦æ±‚</label>
                    <el-input
                      v-model="config.specialRequirements"
                      type="textarea"
                      :rows="3"
                      placeholder="æ‚¨å¯ä»¥è¾“å…¥å¯¹æŠ¥å‘Šçš„ç‰¹æ®Šè¦æ±‚ï¼Œå¦‚ä¾§é‡ç‚¹ã€æ ¼å¼è¦æ±‚ç­‰..."
                    />
                  </div>
                </div>
              </div>
            </div>

            <!-- å¼€å§‹ç”ŸæˆæŒ‰é’® -->
            <div class="generate-section">
              <button
                class="generate-btn"
                :disabled="!canGenerate || generating"
                @click="handleStartGenerate"
              >
                <span v-if="generating" class="generate-btn-icon">âŸ³</span>
                <span v-else class="generate-btn-icon">ğŸš€</span>
                {{ generating ? 'æ­£åœ¨ç”Ÿæˆä¸­...' : 'å¼€å§‹ç”ŸæˆæŠ¥å‘Š' }}
              </button>
              <div v-if="!canGenerate" class="generate-hint">
                <span class="generate-hint-icon">ğŸ’¡</span>
                è¯·é€‰æ‹©é¡¹ç›®ã€å·¥ä½œæµå’ŒæŠ¥å‘Šç±»å‹
              </div>
            </div>
          </div>

          <!-- ç”Ÿæˆå’Œé¢„è§ˆåŒºåŸŸ -->
          <div class="generation-preview-section">
            <!-- ç”Ÿæˆäº¤äº’åŒºåŸŸ -->
            <div class="generation-area">
              <div class="generation-header">
                <h3 class="generation-title">
                  <span class="generation-title-icon">ğŸ¤–</span>
                  AI ç”Ÿæˆè¿‡ç¨‹
                </h3>
                <p class="generation-subtitle">âœ¨ å®æ—¶å±•ç¤ºæŠ¥å‘Šç”Ÿæˆçš„æ¯ä¸ªæ­¥éª¤</p>
              </div>
              <div class="generation-content">
                <!-- ç”Ÿæˆå‰çŠ¶æ€ -->
                <div
                  v-if="!generating && !isGenerateComplete"
                  class="generation-placeholder"
                >
                  <div class="placeholder-icon">ğŸš€</div>
                  <p class="placeholder-text">
                    è¯·é€‰æ‹©é¡¹ç›®å’ŒæŠ¥å‘Šç±»å‹ï¼Œç„¶åç‚¹å‡»"å¼€å§‹ç”Ÿæˆ"
                  </p>
                  <p class="placeholder-hint">
                    AI å°†åŸºäºé¡¹ç›®çŸ¥è¯†åº“æ™ºèƒ½ç”Ÿæˆä¸“ä¸šæŠ¥å‘Š
                  </p>
                </div>

                <!-- ç”Ÿæˆä¸­çŠ¶æ€ -->
                <div v-if="generating">
                  <!-- æ•´ä½“è¿›åº¦ -->
                  <div class="generation-progress">
                    <div class="progress-header">
                      <span class="progress-title">ç”Ÿæˆè¿›åº¦</span>
                      <span class="progress-time"
                        >é¢„è®¡è¿˜éœ€ {{ estimatedTime }} ç§’</span
                      >
                    </div>
                    <div class="progress-bar">
                      <div
                        class="progress-fill"
                        :style="{ width: generateProgress + '%' }"
                      ></div>
                    </div>
                  </div>

                  <!-- ç”Ÿæˆæ­¥éª¤ -->
                  <div class="generation-steps">
                    <div
                      v-for="(step, index) in generateSteps"
                      :key="index"
                      class="step-item"
                    >
                      <div class="step-icon" :class="step.status">
                        <span v-if="step.status === 'completed'">âœ“</span>
                        <span v-else-if="step.status === 'running'">âŸ³</span>
                        <span v-else>â—‹</span>
                      </div>
                      <span class="step-text">{{ step.name }}</span>
                      <span
                        v-if="step.status === 'running'"
                        class="step-progress"
                        >{{ step.progress }}%</span
                      >
                    </div>
                  </div>

                  <!-- ç”Ÿæˆæ¶ˆæ¯ -->
                  <div class="generation-messages">
                    <div
                      v-for="(message, index) in generateMessages"
                      :key="index"
                      class="message-bubble"
                    >
                      <div class="message-header">
                        <span class="message-type">{{ message.type }}</span>
                        <span class="message-time"
                          >{{ formatTime(message.time) }}</span
                        >
                      </div>
                      <div
                        class="message-content"
                        :class="{ 'typing-effect': message.typing }"
                      >
                        {{ message.content }}
                      </div>
                    </div>
                  </div>

                  <!-- å–æ¶ˆæŒ‰é’® -->
                  <div style="text-align: center; margin-top: 24px">
                    <el-button
                      @click="handleCancelGenerate"
                      type="danger"
                      plain
                    >
                      å–æ¶ˆç”Ÿæˆ
                    </el-button>
                  </div>
                </div>

                <!-- ç”Ÿæˆå®ŒæˆçŠ¶æ€ -->
                <div v-if="isGenerateComplete" class="generation-complete">
                  <div class="complete-icon">ğŸ‰</div>
                  <h3 class="complete-title">æŠ¥å‘Šç”ŸæˆæˆåŠŸï¼</h3>

                  <div class="complete-summary">
                    <div class="summary-item">
                      <p class="summary-value">
                        {{ reportMetadata.generatedTime }}s
                      </p>
                      <p class="summary-label">ç”Ÿæˆæ—¶é—´</p>
                    </div>
                    <div class="summary-item">
                      <p class="summary-value">
                        {{ reportMetadata.refDocsCount }}
                      </p>
                      <p class="summary-label">å¼•ç”¨æ–‡æ¡£</p>
                    </div>
                    <div class="summary-item">
                      <p class="summary-value">
                        {{ reportMetadata.wordCount }}
                      </p>
                      <p class="summary-label">æŠ¥å‘Šå­—æ•°</p>
                    </div>
                  </div>

                  <div class="complete-actions">
                    <el-button @click="handleSaveReport" type="primary">
                      <el-icon><Document /></el-icon>
                      ä¿å­˜æŠ¥å‘Š
                    </el-button>
                    <el-dropdown @command="handleDownloadReport">
                      <el-button type="primary" plain>
                        <el-icon><Download /></el-icon>
                        ä¸‹è½½æŠ¥å‘Š
                        <el-icon class="el-icon--right"><ArrowDown /></el-icon>
                      </el-button>
                      <template #dropdown>
                        <el-dropdown-menu>
                          <el-dropdown-item command="pdf"
                            >PDF æ ¼å¼</el-dropdown-item
                          >
                          <el-dropdown-item command="word"
                            >Word æ ¼å¼</el-dropdown-item
                          >
                          <el-dropdown-item command="markdown"
                            >Markdown æ ¼å¼</el-dropdown-item
                          >
                        </el-dropdown-menu>
                      </template>
                    </el-dropdown>
                    <el-button @click="handleRegenerate" plain>
                      <el-icon><Refresh /></el-icon>
                      é‡æ–°ç”Ÿæˆ
                    </el-button>
                  </div>
                </div>
              </div>
            </div>

            <!-- é¢„è§ˆåŒºåŸŸ -->
            <div class="preview-area">
              <div class="preview-header">
                <h3 class="preview-title">
                  <span class="preview-title-icon">ğŸ“„</span>
                  æŠ¥å‘Šé¢„è§ˆ
                </h3>
                <div class="preview-toolbar">
                  <button
                    class="toolbar-btn"
                    :class="{ active: previewFontSize === 'small' }"
                    @click="previewFontSize = 'small'"
                    title="å°å­—ä½“"
                  >
                    <span>A</span>
                  </button>
                  <button
                    class="toolbar-btn"
                    :class="{ active: previewFontSize === 'medium' }"
                    @click="previewFontSize = 'medium'"
                    title="ä¸­å­—ä½“"
                  >
                    <span style="font-size: 16px">A</span>
                  </button>
                  <button
                    class="toolbar-btn"
                    :class="{ active: previewFontSize === 'large' }"
                    @click="previewFontSize = 'large'"
                    title="å¤§å­—ä½“"
                  >
                    <span style="font-size: 18px">A</span>
                  </button>
                  <button
                    class="toolbar-btn"
                    @click="toggleFullscreen"
                    title="å…¨å±"
                  >
                    <el-icon><FullScreen /></el-icon>
                  </button>
                  <button
                    v-if="isGenerateComplete"
                    class="toolbar-btn"
                    :class="{ active: editMode }"
                    @click="toggleEditMode"
                    title="ç¼–è¾‘æ¨¡å¼"
                  >
                    <el-icon><Edit /></el-icon>
                    ç¼–è¾‘
                  </button>
                </div>
              </div>
              <div class="preview-content" :class="'font-' + previewFontSize">
                <!-- é¢„è§ˆå ä½ç¬¦ -->
                <div
                  v-if="!reportContent && !generating"
                  class="preview-placeholder"
                >
                  <div class="preview-placeholder-icon">ğŸ“„</div>
                  <p class="preview-placeholder-text">
                    æŠ¥å‘Šé¢„è§ˆå°†åœ¨ç”Ÿæˆæ—¶å®æ—¶æ˜¾ç¤º
                  </p>
                </div>

                <!-- æŠ¥å‘Šé¢„è§ˆ -->
                <div
                  v-if="reportContent"
                  class="report-preview"
                  :class="{ 'edit-mode': editMode }"
                >
                  <!-- ç¼–è¾‘å·¥å…·æ  -->
                  <div v-if="editMode" class="edit-toolbar">
                    <div class="edit-actions">
                      <button class="edit-btn" @click="exitEditMode">
                        å–æ¶ˆç¼–è¾‘
                      </button>
                      <button class="edit-btn primary" @click="saveEditChanges">
                        ä¿å­˜ä¿®æ”¹
                      </button>
                    </div>
                  </div>

                  <!-- æŠ¥å‘Šå¤´éƒ¨ -->
                  <div class="report-header">
                    <h1 class="report-title">{{ reportTitle }}</h1>
                    <div class="report-meta">
                      <div class="meta-item">
                        <span>é¡¹ç›®åç§°ï¼š</span>
                        <span>{{ config.projectInfo?.name }}</span>
                      </div>
                      <div class="meta-item">
                        <span>æŠ¥å‘Šç±»å‹ï¼š</span>
                        <span>{{ reportTypeText }}</span>
                      </div>
                      <div class="meta-item">
                        <span>ç”Ÿæˆæ—¶é—´ï¼š</span>
                        <span>{{ formatDate(new Date()) }}</span>
                      </div>
                      <div class="meta-item">
                        <span>ç”Ÿæˆæ–¹å¼ï¼š</span>
                        <span>AI æ™ºèƒ½ç”Ÿæˆ</span>
                      </div>
                    </div>
                  </div>

                  <!-- æŠ¥å‘Šç›®å½• -->
                  <div class="report-toc">
                    <h3 class="toc-title">ç›®å½•</h3>
                    <ul class="toc-list">
                      <li class="toc-item">
                        <a href="#section-1" class="toc-link">1. é¡¹ç›®æ¦‚è¿°</a>
                      </li>
                      <li class="toc-item">
                        <a href="#section-2" class="toc-link"
                          >2. ç ”ç©¶å†…å®¹ä¸æ–¹æ³•</a
                        >
                      </li>
                      <li class="toc-item">
                        <a href="#section-3" class="toc-link"
                          >3. ä¸»è¦æˆæœä¸åˆ›æ–°</a
                        >
                      </li>
                      <li class="toc-item">
                        <a href="#section-4" class="toc-link"
                          >4. æŠ€æœ¯æŒ‡æ ‡å®Œæˆæƒ…å†µ</a
                        >
                      </li>
                      <li class="toc-item">
                        <a href="#section-5" class="toc-link"
                          >5. ç»æµç¤¾ä¼šæ•ˆç›Š</a
                        >
                      </li>
                      <li class="toc-item">
                        <a href="#section-6" class="toc-link"
                          >6. å­˜åœ¨é—®é¢˜ä¸å»ºè®®</a
                        >
                      </li>
                    </ul>
                  </div>

                  <!-- å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ -->
                  <div
                    v-if="editMode"
                    id="quill-editor"
                    style="min-height: 400px"
                  ></div>

                  <!-- æŠ¥å‘Šå†…å®¹ -->
                  <div v-else v-html="reportContent"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const { createApp, ref, computed, onMounted, nextTick } = Vue;
      const { ElMessage, ElMessageBox, ElLoading } = ElementPlus;
      const {
        ArrowLeft,
        Document,
        Download,
        ArrowDown,
        Refresh,
        Loading,
        ArrowUp,
        FullScreen,
        Edit,
        Folder,
      } = ElementPlusIconsVue;

      createApp({
        components: {
          ArrowLeft,
          Document,
          Download,
          ArrowDown,
          Refresh,
          Loading,
          ArrowUp,
          FullScreen,
          Edit,
          Folder,
        },
        setup() {
          // é…ç½®æ•°æ®
          const config = ref({
            projectId: "",
            projectInfo: null,
            workflow: "", // å·¥ä½œæµ
            reportType: "tech",
            style: "formal",
            detail: "standard",
            specialRequirements: "",
          });

          // é¡¹ç›®åˆ—è¡¨
          const projects = ref([
            {
              id: "1",
              name: "åŸºäºæ·±åº¦å­¦ä¹ çš„å›¾åƒè¯†åˆ«æŠ€æœ¯ç ”ç©¶",
              code: "AI2024001",
              status: "completed",
              statusText: "å·²å®Œæˆ",
              docCount: 45,
              wordCount: "12.5ä¸‡",
              progress: 100,
            },
            {
              id: "2",
              name: "æ™ºèƒ½ç‰©è”ç½‘ç³»ç»Ÿå…³é”®æŠ€æœ¯ç ”å‘",
              code: "IOT2024002",
              status: "completed",
              statusText: "å·²å®Œæˆ",
              docCount: 32,
              wordCount: "8.7ä¸‡",
              progress: 85,
            },
            {
              id: "3",
              name: "åŒºå—é“¾æŠ€æœ¯åœ¨ä¾›åº”é“¾ç®¡ç†ä¸­çš„åº”ç”¨",
              code: "BC2024003",
              status: "completed",
              statusText: "å·²å®Œæˆ",
              docCount: 28,
              wordCount: "9.2ä¸‡",
              progress: 100,
            },
          ]);
          const loadingProjects = ref(false);

          // å·¥ä½œæµé€‰é¡¹
          const workflowOptions = [
            {
              id: "workflow_001",
              name: "ç§‘ç ”é¡¹ç›®ç”³æŠ¥å®¡æ ¸æµç¨‹",
              description:
                "é€‚ç”¨äºç§‘ç ”é¡¹ç›®çš„æ ‡å‡†ç”³æŠ¥å®¡æ ¸ï¼ŒåŒ…å«åˆå®¡ã€ä¸“å®¶è¯„å®¡ã€ç»ˆå®¡ç­‰ç¯èŠ‚",
            },
            {
              id: "workflow_002",
              name: "å¿«é€Ÿç”³æŠ¥æµç¨‹",
              description: "ç®€åŒ–çš„ç”³æŠ¥æµç¨‹ï¼Œé€‚ç”¨äºå°å‹é¡¹ç›®æˆ–ç´§æ€¥é¡¹ç›®çš„å¿«é€Ÿå®¡æ‰¹",
            },
            {
              id: "workflow_003",
              name: "é‡ç‚¹é¡¹ç›®ä¸“é¡¹æµç¨‹",
              description:
                "é’ˆå¯¹é‡ç‚¹ç§‘ç ”é¡¹ç›®çš„ä¸“é¡¹å®¡æ ¸æµç¨‹ï¼ŒåŒ…å«å¤šè½®ä¸“å®¶è¯„å®¡å’Œç­”è¾©ç¯èŠ‚",
            },
            {
              id: "workflow_004",
              name: "äº§å­¦ç ”åˆä½œé¡¹ç›®æµç¨‹",
              description:
                "ä¸“é—¨ç”¨äºäº§å­¦ç ”åˆä½œé¡¹ç›®çš„å®¡æ ¸æµç¨‹ï¼Œæ¶‰åŠä¼ä¸šå‚ä¸å’Œæˆæœè½¬åŒ–è¯„ä¼°",
            },
          ];

          // ç”ŸæˆçŠ¶æ€
          const generating = ref(false);
          const generateProgress = ref(0);
          const estimatedTime = ref(0);
          const generateSteps = ref([
            { name: "è¯»å–é¡¹ç›®çŸ¥è¯†åº“", status: "pending", progress: 0 },
            { name: "åˆ†æé¡¹ç›®æ–‡æ¡£å†…å®¹", status: "pending", progress: 0 },
            { name: "æå–å…³é”®ä¿¡æ¯", status: "pending", progress: 0 },
            { name: "ç”ŸæˆæŠ¥å‘Šå¤§çº²", status: "pending", progress: 0 },
            { name: "ç”ŸæˆæŠ¥å‘Šå†…å®¹", status: "pending", progress: 0 },
            { name: "ä¼˜åŒ–æŠ¥å‘Šæ ¼å¼", status: "pending", progress: 0 },
          ]);

          // ç”Ÿæˆå†…å®¹
          const generateMessages = ref([]);
          const reportContent = ref(null);
          const reportMetadata = ref({
            generatedTime: 0,
            wordCount: 0,
            refDocsCount: 0,
          });

          // é¢„è§ˆçŠ¶æ€
          const previewFontSize = ref("medium");
          const previewFullscreen = ref(false);
          const editMode = ref(false);
          const showAdvanced = ref(false);

          // å·¥ä½œæµæœç´¢
          const workflowSearchQuery = ref("");
          const filteredWorkflowOptions = ref([...workflowOptions]);

          // å¯Œæ–‡æœ¬ç¼–è¾‘å™¨
          let quillEditor = null;

          // è®¡ç®—å±æ€§
          const canGenerate = computed(() => {
            return (
              config.value.projectId &&
              config.value.workflow &&
              config.value.reportType &&
              !generating.value
            );
          });

          const isGenerateComplete = computed(() => {
            return reportContent.value !== null && !generating.value;
          });

          const reportTitle = computed(() => {
            const typeMap = { tech: "ç§‘æŠ€æŠ¥å‘Š", self: "è‡ªè¯„æŠ¥å‘Š" };
            return config.value.projectInfo
              ? `${config.value.projectInfo.name} - ${
                  typeMap[config.value.reportType]
                }`
              : "æŠ¥å‘Šæ ‡é¢˜";
          });

          const reportTypeText = computed(() => {
            const typeMap = { tech: "ç§‘æŠ€æŠ¥å‘Š", self: "è‡ªè¯„æŠ¥å‘Š" };
            return typeMap[config.value.reportType];
          });

          const selectedWorkflow = computed(() => {
            return workflowOptions.find(
              (workflow) => workflow.id === config.value.workflow
            );
          });

          // æ–¹æ³•
          const handleBack = () => {
            if (isGenerateComplete.value) {
              ElMessageBox.confirm("æœ‰æœªä¿å­˜çš„æŠ¥å‘Šï¼Œæ˜¯å¦ä¿å­˜ï¼Ÿ", "æç¤º", {
                confirmButtonText: "ä¿å­˜",
                cancelButtonText: "ä¸ä¿å­˜",
                type: "warning",
              })
                .then(() => {
                  handleSaveReport();
                })
                .catch(() => {
                  window.parent.postMessage(
                    { type: "navigate", path: "acceptance/list" },
                    "*"
                  );
                });
            } else {
              window.parent.postMessage(
                { type: "navigate", path: "acceptance/list" },
                "*"
              );
            }
          };

          const handleProjectChange = (projectId) => {
            const project = projects.value.find((p) => p.id === projectId);
            if (project) {
              config.value.projectInfo = project;
              ElMessage.success(`å·²é€‰æ‹©é¡¹ç›®ï¼š${project.name}`);
            }
          };

          const toggleAdvanced = () => {
            showAdvanced.value = !showAdvanced.value;
          };

          // å·¥ä½œæµè¿‡æ»¤æ–¹æ³•
          const filterWorkflow = (query) => {
            workflowSearchQuery.value = query;
            if (!query) {
              filteredWorkflowOptions.value = [...workflowOptions];
              return;
            }

            const lowerQuery = query.toLowerCase();
            filteredWorkflowOptions.value = workflowOptions.filter(
              (workflow) => {
                return (
                  workflow.name.toLowerCase().includes(lowerQuery) ||
                  workflow.description.toLowerCase().includes(lowerQuery)
                );
              }
            );
          };

          // æ–‡æœ¬é«˜äº®æ–¹æ³•
          const highlightText = (text, query) => {
            if (!query || !text) return text;

            const regex = new RegExp(`(${query})`, "gi");
            return text.replace(regex, '<span class="highlight">$1</span>');
          };

          const handleStartGenerate = async () => {
            if (!canGenerate.value) return;

            // æ˜¾ç¤ºåŠ¨æ€åŠ è½½æç¤º
            const loadingTexts = [
              "æ­£åœ¨æäº¤æŠ¥å‘Šç”Ÿæˆä»»åŠ¡...",
              "æ­£åœ¨è¿æ¥ Dify å·¥ä½œæµ...",
              "æ­£åœ¨å¯åŠ¨ AI åˆ†æå¼•æ“...",
            ];
            let textIndex = 0;

            const loading = ElLoading.service({
              lock: true,
              text: loadingTexts[0],
              background: "rgba(0, 0, 0, 0.7)",
              spinner: "el-icon-loading",
              customClass: "report-loading",
            });

            // åŠ¨æ€æ›´æ–°åŠ è½½æ–‡æ¡ˆ
            const textInterval = setInterval(() => {
              textIndex = (textIndex + 1) % loadingTexts.length;
              if (loading.$el) {
                const textEl = loading.$el.querySelector(".el-loading-text");
                if (textEl) {
                  textEl.textContent = loadingTexts[textIndex];
                }
              }
            }, 800);

            try {
              // æ¨¡æ‹Ÿæäº¤åˆ°åç«¯API
              await new Promise((resolve) => setTimeout(resolve, 2000));

              // æ¸…é™¤æ–‡æ¡ˆæ›´æ–°å®šæ—¶å™¨
              clearInterval(textInterval);

              // å…³é—­åŠ è½½æç¤º
              loading.close();

              // æç¤ºç”¨æˆ·ä»»åŠ¡å·²æäº¤
              ElMessageBox.alert(
                "æŠ¥å‘Šç”Ÿæˆä»»åŠ¡å·²æˆåŠŸæäº¤åˆ°åå°å¤„ç†ï¼Œè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ã€‚ç³»ç»Ÿå°†è°ƒç”¨ Dify å·¥ä½œæµè‡ªåŠ¨ç”ŸæˆæŠ¥å‘Šï¼Œå®Œæˆåæ‚¨å¯ä»¥åœ¨æŠ¥å‘Šåˆ—è¡¨ä¸­æŸ¥çœ‹ã€‚",
                "ä»»åŠ¡å·²æäº¤",
                {
                  confirmButtonText: "å‰å¾€æŠ¥å‘Šåˆ—è¡¨",
                  type: "success",
                  center: true,
                  customClass: "report-submit-dialog",
                  callback: () => {
                    // è·³è½¬åˆ°æŠ¥å‘Šåˆ—è¡¨
                    window.parent.postMessage(
                      { type: "navigate", path: "acceptance/list" },
                      "*"
                    );
                  },
                }
              );
            } catch (error) {
              clearInterval(textInterval);
              loading.close();
              ElMessage.error("æäº¤æŠ¥å‘Šç”Ÿæˆä»»åŠ¡å¤±è´¥ï¼Œè¯·é‡è¯•");
            }
          };

          const simulateGeneration = async () => {
            const steps = generateSteps.value;
            const totalSteps = steps.length;

            for (let i = 0; i < totalSteps; i++) {
              if (!generating.value) break; // å¦‚æœè¢«å–æ¶ˆåˆ™åœæ­¢

              // æ›´æ–°å½“å‰æ­¥éª¤çŠ¶æ€
              steps[i].status = "running";

              // æ·»åŠ ç”Ÿæˆæ¶ˆæ¯
              addGenerateMessage("ç³»ç»Ÿ", `å¼€å§‹${steps[i].name}...`);

              // æ¨¡æ‹Ÿæ­¥éª¤è¿›åº¦
              for (let progress = 0; progress <= 100; progress += 10) {
                if (!generating.value) break;

                steps[i].progress = progress;
                generateProgress.value = (i * 100 + progress) / totalSteps;
                estimatedTime.value = Math.max(
                  0,
                  120 - Math.floor(generateProgress.value * 1.2)
                );

                await new Promise((resolve) => setTimeout(resolve, 200));
              }

              steps[i].status = "completed";
              addGenerateMessage("AIåŠ©æ‰‹", `${steps[i].name}å®Œæˆï¼`);

              // åœ¨ç”ŸæˆæŠ¥å‘Šå†…å®¹é˜¶æ®µï¼Œæ¨¡æ‹Ÿå®æ—¶å†…å®¹ç”Ÿæˆ
              if (i === 4) {
                await simulateContentGeneration();
              }
            }

            if (generating.value) {
              // ç”Ÿæˆå®Œæˆ
              generating.value = false;
              generateProgress.value = 100;
              estimatedTime.value = 0;

              // è®¾ç½®æŠ¥å‘Šå…ƒæ•°æ®
              reportMetadata.value = {
                generatedTime: 85,
                wordCount: 8500,
                refDocsCount: config.value.projectInfo?.docCount || 0,
              };

              ElMessage.success("æŠ¥å‘Šç”ŸæˆæˆåŠŸï¼");
            }
          };

          const simulateContentGeneration = async () => {
            const sections = [
              {
                title: "1. é¡¹ç›®æ¦‚è¿°",
                content: `
                  <h2 id="section-1" class="section-title">1. é¡¹ç›®æ¦‚è¿°</h2>
                  <div class="section-content">
                    <p>æœ¬é¡¹ç›®"${config.value.projectInfo?.name}"æ˜¯ä¸€é¡¹é‡è¦çš„ç§‘ç ”é¡¹ç›®ï¼Œæ—¨åœ¨é€šè¿‡åˆ›æ–°æŠ€æœ¯æ‰‹æ®µè§£å†³è¡Œä¸šå…³é”®é—®é¢˜ã€‚é¡¹ç›®è‡ªç«‹é¡¹ä»¥æ¥ï¼Œä¸¥æ ¼æŒ‰ç…§ç ”ç©¶è®¡åˆ’æ‰§è¡Œï¼Œåœ¨ç†è®ºç ”ç©¶ã€æŠ€æœ¯å¼€å‘ã€å®éªŒéªŒè¯ç­‰æ–¹é¢å–å¾—äº†æ˜¾è‘—è¿›å±•ã€‚</p>
                    <p>é¡¹ç›®ç ”ç©¶å‘¨æœŸä¸º24ä¸ªæœˆï¼Œæ€»æŠ•å…¥èµ„é‡‘500ä¸‡å…ƒï¼Œå‚ä¸ç ”ç©¶äººå‘˜15äººï¼Œå…¶ä¸­é«˜çº§èŒç§°8äººï¼Œåšå£«å­¦ä½10äººã€‚é¡¹ç›®ä¾æ‰˜å…ˆè¿›çš„å®éªŒè®¾å¤‡å’Œå®Œå–„çš„ç ”ç©¶ç¯å¢ƒï¼Œç¡®ä¿äº†ç ”ç©¶å·¥ä½œçš„é¡ºåˆ©å¼€å±•ã€‚</p>
                  </div>
                `,
              },
              {
                title: "2. ç ”ç©¶å†…å®¹ä¸æ–¹æ³•",
                content: `
                  <h2 id="section-2" class="section-title">2. ç ”ç©¶å†…å®¹ä¸æ–¹æ³•</h2>
                  <div class="section-content">
                    <p>æœ¬é¡¹ç›®é‡‡ç”¨ç†è®ºåˆ†æä¸å®éªŒéªŒè¯ç›¸ç»“åˆçš„ç ”ç©¶æ–¹æ³•ï¼Œä¸»è¦ç ”ç©¶å†…å®¹åŒ…æ‹¬ï¼š</p>
                    <ul>
                      <li>æ ¸å¿ƒç®—æ³•è®¾è®¡ä¸ä¼˜åŒ–</li>
                      <li>ç³»ç»Ÿæ¶æ„è®¾è®¡ä¸å®ç°</li>
                      <li>æ€§èƒ½æµ‹è¯•ä¸è¯„ä¼°</li>
                      <li>åº”ç”¨åœºæ™¯éªŒè¯ä¸æ¨å¹¿</li>
                    </ul>
                    <p>ç ”ç©¶æ–¹æ³•ç§‘å­¦ä¸¥è°¨ï¼Œå®éªŒè®¾è®¡åˆç†ï¼Œæ•°æ®é‡‡é›†å‡†ç¡®ï¼Œä¸ºé¡¹ç›®æˆæœçš„å¯é æ€§æä¾›äº†æœ‰åŠ›ä¿éšœã€‚</p>
                  </div>
                `,
              },
              {
                title: "3. ä¸»è¦æˆæœä¸åˆ›æ–°",
                content: `
                  <h2 id="section-3" class="section-title">3. ä¸»è¦æˆæœä¸åˆ›æ–°</h2>
                  <div class="section-content">
                    <p>é¡¹ç›®åœ¨ç ”ç©¶è¿‡ç¨‹ä¸­å–å¾—äº†å¤šé¡¹é‡è¦æˆæœå’ŒæŠ€æœ¯åˆ›æ–°ï¼š</p>
                    <ol>
                      <li><strong>ç†è®ºåˆ›æ–°</strong>ï¼šæå‡ºäº†æ–°çš„ç†è®ºæ¨¡å‹ï¼Œä¸ºç›¸å…³é¢†åŸŸç ”ç©¶æä¾›äº†æ–°çš„æ€è·¯å’Œæ–¹æ³•ã€‚</li>
                      <li><strong>æŠ€æœ¯çªç ´</strong>ï¼šçªç ´äº†å¤šé¡¹å…³é”®æŠ€æœ¯éš¾é¢˜ï¼Œå½¢æˆäº†å…·æœ‰è‡ªä¸»çŸ¥è¯†äº§æƒçš„æ ¸å¿ƒæŠ€æœ¯ã€‚</li>
                      <li><strong>åº”ç”¨æˆæœ</strong>ï¼šå¼€å‘äº†å®Œæ•´çš„åº”ç”¨ç³»ç»Ÿï¼Œåœ¨å®é™…åœºæ™¯ä¸­å¾—åˆ°äº†æˆåŠŸéªŒè¯ã€‚</li>
                    </ol>
                    <p>è¿™äº›æˆæœä¸ä»…å…·æœ‰é‡è¦çš„å­¦æœ¯ä»·å€¼ï¼Œä¹Ÿå…·æœ‰å¹¿é˜”çš„åº”ç”¨å‰æ™¯å’Œå•†ä¸šä»·å€¼ã€‚</p>
                  </div>
                `,
              },
            ];

            let fullContent = "";

            for (const section of sections) {
              // æ·»åŠ ç« èŠ‚ç”Ÿæˆæ¶ˆæ¯
              addGenerateMessage("AIåŠ©æ‰‹", `æ­£åœ¨ç”Ÿæˆ"${section.title}"...`);

              // æ¨¡æ‹Ÿæ‰“å­—æœºæ•ˆæœç”Ÿæˆå†…å®¹
              fullContent += section.content;
              reportContent.value = fullContent;

              await new Promise((resolve) => setTimeout(resolve, 1500));
            }

            // æ·»åŠ å‰©ä½™ç« èŠ‚
            const remainingSections = `
              <h2 id="section-4" class="section-title">4. æŠ€æœ¯æŒ‡æ ‡å®Œæˆæƒ…å†µ</h2>
              <div class="section-content">
                <p>é¡¹ç›®å„é¡¹æŠ€æœ¯æŒ‡æ ‡å‡å·²è¾¾åˆ°æˆ–è¶…è¿‡é¢„æœŸç›®æ ‡ï¼š</p>
                <table style="width: 100%; border-collapse: collapse; margin: 16px 0;">
                  <thead>
                    <tr style="background: #f9fafb;">
                      <th style="border: 1px solid #e5e7eb; padding: 8px; text-align: left;">æŠ€æœ¯æŒ‡æ ‡</th>
                      <th style="border: 1px solid #e5e7eb; padding: 8px; text-align: center;">ç›®æ ‡å€¼</th>
                      <th style="border: 1px solid #e5e7eb; padding: 8px; text-align: center;">å®é™…å€¼</th>
                      <th style="border: 1px solid #e5e7eb; padding: 8px; text-align: center;">å®Œæˆåº¦</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td style="border: 1px solid #e5e7eb; padding: 8px;">ç³»ç»Ÿå“åº”æ—¶é—´</td>
                      <td style="border: 1px solid #e5e7eb; padding: 8px; text-align: center;">â‰¤100ms</td>
                      <td style="border: 1px solid #e5e7eb; padding: 8px; text-align: center;">85ms</td>
                      <td style="border: 1px solid #e5e7eb; padding: 8px; text-align: center;">115%</td>
                    </tr>
                    <tr>
                      <td style="border: 1px solid #e5e7eb; padding: 8px;">å‡†ç¡®ç‡</td>
                      <td style="border: 1px solid #e5e7eb; padding: 8px; text-align: center;">â‰¥95%</td>
                      <td style="border: 1px solid #e5e7eb; padding: 8px; text-align: center;">97.5%</td>
                      <td style="border: 1px solid #e5e7eb; padding: 8px; text-align: center;">103%</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <h2 id="section-5" class="section-title">5. ç»æµç¤¾ä¼šæ•ˆç›Š</h2>
              <div class="section-content">
                <p>é¡¹ç›®æˆæœå…·æœ‰æ˜¾è‘—çš„ç»æµç¤¾ä¼šæ•ˆç›Šï¼š</p>
                <p><strong>ç»æµæ•ˆç›Šï¼š</strong>é¢„è®¡å¯ä¸ºç›¸å…³ä¼ä¸šèŠ‚çº¦æˆæœ¬30%ä»¥ä¸Šï¼Œæé«˜æ•ˆç‡50%ä»¥ä¸Šï¼Œå…·æœ‰å·¨å¤§çš„å¸‚åœºæ½œåŠ›ã€‚</p>
                <p><strong>ç¤¾ä¼šæ•ˆç›Šï¼š</strong>æ¨åŠ¨äº†è¡Œä¸šæŠ€æœ¯è¿›æ­¥ï¼Œæå‡äº†æˆ‘å›½åœ¨ç›¸å…³é¢†åŸŸçš„å›½é™…ç«äº‰åŠ›ï¼Œå…·æœ‰é‡è¦çš„æˆ˜ç•¥æ„ä¹‰ã€‚</p>
              </div>

              <h2 id="section-6" class="section-title">6. å­˜åœ¨é—®é¢˜ä¸å»ºè®®</h2>
              <div class="section-content">
                <p>è™½ç„¶é¡¹ç›®å–å¾—äº†é¢„æœŸæˆæœï¼Œä½†åœ¨ç ”ç©¶è¿‡ç¨‹ä¸­ä¹Ÿå‘ç°äº†ä¸€äº›é—®é¢˜å’Œæ”¹è¿›ç©ºé—´ï¼š</p>
                <ul>
                  <li>éƒ¨åˆ†ç®—æ³•åœ¨ç‰¹æ®Šåœºæ™¯ä¸‹çš„é€‚åº”æ€§æœ‰å¾…è¿›ä¸€æ­¥æå‡</li>
                  <li>ç³»ç»Ÿçš„å¯æ‰©å±•æ€§éœ€è¦æŒç»­ä¼˜åŒ–</li>
                  <li>äº§ä¸šåŒ–æ¨å¹¿è¿˜éœ€è¦æ›´å¤šçš„æ”¿ç­–æ”¯æŒ</li>
                </ul>
                <p>å»ºè®®åœ¨åç»­å·¥ä½œä¸­ç»§ç»­æ·±å…¥ç ”ç©¶ï¼Œä¸æ–­å®Œå–„æŠ€æœ¯æ–¹æ¡ˆï¼ŒåŠ å¿«æˆæœè½¬åŒ–å’Œäº§ä¸šåŒ–è¿›ç¨‹ã€‚</p>
              </div>
            `;

            reportContent.value += remainingSections;
          };

          const addGenerateMessage = (type, content) => {
            generateMessages.value.push({
              type,
              content,
              time: new Date(),
              typing: false,
            });

            // æ»šåŠ¨åˆ°åº•éƒ¨
            nextTick(() => {
              const container = document.querySelector(".generation-content");
              if (container) {
                container.scrollTop = container.scrollHeight;
              }
            });
          };

          const handleCancelGenerate = () => {
            ElMessageBox.confirm("ç¡®å®šè¦å–æ¶ˆç”Ÿæˆå—ï¼Ÿ", "æç¤º", {
              confirmButtonText: "ç¡®å®š",
              cancelButtonText: "ç»§ç»­ç”Ÿæˆ",
              type: "warning",
            }).then(() => {
              generating.value = false;
              generateProgress.value = 0;
              estimatedTime.value = 0;
              ElMessage.info("å·²å–æ¶ˆç”Ÿæˆ");
            });
          };

          const handleSaveReport = () => {
            if (!reportContent.value) return;

            ElMessage.success("æŠ¥å‘Šä¿å­˜æˆåŠŸï¼");
            setTimeout(() => {
              window.parent.postMessage(
                { type: "navigate", path: "acceptance/list" },
                "*"
              );
            }, 1000);
          };

          const handleDownloadReport = (format) => {
            if (!reportContent.value) return;

            ElMessage.info(`æ­£åœ¨ç”Ÿæˆ ${format.toUpperCase()} æ–‡ä»¶...`);

            // æ¨¡æ‹Ÿä¸‹è½½è¿‡ç¨‹
            setTimeout(() => {
              const fileName = `${config.value.projectInfo?.name || "æŠ¥å‘Š"}_${
                reportTypeText.value
              }_${formatDate(new Date(), "YYYYMMDD")}.${format}`;

              if (format === "markdown") {
                // ç®€å•çš„ Markdown å¯¼å‡º
                const markdownContent = reportContent.value
                  .replace(/<h2[^>]*>/g, "## ")
                  .replace(/<\/h2>/g, "\n\n")
                  .replace(/<p>/g, "")
                  .replace(/<\/p>/g, "\n\n")
                  .replace(/<[^>]*>/g, "");

                const blob = new Blob([markdownContent], {
                  type: "text/markdown",
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = fileName;
                a.click();
                URL.revokeObjectURL(url);
              }

              ElMessage.success(`${format.toUpperCase()} æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼`);
            }, 2000);
          };

          const handleRegenerate = () => {
            ElMessageBox.confirm(
              "å½“å‰å†…å®¹å°†è¢«è¦†ç›–ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ",
              "é‡æ–°ç”Ÿæˆç¡®è®¤",
              {
                confirmButtonText: "ç»§ç»­",
                cancelButtonText: "å–æ¶ˆ",
                type: "warning",
              }
            ).then(() => {
              reportContent.value = null;
              handleStartGenerate();
            });
          };

          const toggleFullscreen = () => {
            previewFullscreen.value = !previewFullscreen.value;
            // è¿™é‡Œå¯ä»¥å®ç°å…¨å±é€»è¾‘
            ElMessage.info(
              previewFullscreen.value ? "è¿›å…¥å…¨å±æ¨¡å¼" : "é€€å‡ºå…¨å±æ¨¡å¼"
            );
          };

          const toggleEditMode = () => {
            if (!isGenerateComplete.value) return;

            editMode.value = !editMode.value;

            if (editMode.value) {
              nextTick(() => {
                initQuillEditor();
              });
            } else {
              if (quillEditor) {
                quillEditor = null;
              }
            }
          };

          const initQuillEditor = () => {
            const editorElement = document.getElementById("quill-editor");
            if (editorElement && window.Quill) {
              quillEditor = new Quill("#quill-editor", {
                theme: "snow",
                modules: {
                  toolbar: [
                    ["bold", "italic", "underline"],
                    ["blockquote", "code-block"],
                    [{ header: 1 }, { header: 2 }],
                    [{ list: "ordered" }, { list: "bullet" }],
                    [{ align: [] }],
                    ["link"],
                    ["clean"],
                  ],
                },
              });

              // è®¾ç½®åˆå§‹å†…å®¹
              quillEditor.root.innerHTML = reportContent.value;
            }
          };

          const exitEditMode = () => {
            editMode.value = false;
            if (quillEditor) {
              quillEditor = null;
            }
          };

          const saveEditChanges = () => {
            if (quillEditor) {
              reportContent.value = quillEditor.root.innerHTML;
              ElMessage.success("ä¿®æ”¹å·²ä¿å­˜");
              exitEditMode();
            }
          };

          // å·¥å…·å‡½æ•°
          const formatTime = (time) => {
            return time.toLocaleTimeString();
          };

          const formatDate = (date, format = "YYYY-MM-DD") => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, "0");
            const day = String(date.getDate()).padStart(2, "0");

            if (format === "YYYYMMDD") {
              return `${year}${month}${day}`;
            }
            return `${year}-${month}-${day}`;
          };

          // ç»„ä»¶æŒ‚è½½
          onMounted(() => {
            // åˆå§‹åŒ–
            console.log("æŠ¥å‘Šç”Ÿæˆé¡µé¢å·²åŠ è½½");
          });

          return {
            // æ•°æ®
            config,
            projects,
            loadingProjects,
            workflowOptions,
            filteredWorkflowOptions,
            workflowSearchQuery,
            generating,
            generateProgress,
            estimatedTime,
            generateSteps,
            generateMessages,
            reportContent,
            reportMetadata,
            previewFontSize,
            previewFullscreen,
            editMode,
            showAdvanced,

            // è®¡ç®—å±æ€§
            canGenerate,
            isGenerateComplete,
            reportTitle,
            reportTypeText,
            selectedWorkflow,

            // æ–¹æ³•
            handleBack,
            handleProjectChange,
            toggleAdvanced,
            filterWorkflow,
            highlightText,
            handleStartGenerate,
            handleCancelGenerate,
            handleSaveReport,
            handleDownloadReport,
            handleRegenerate,
            toggleFullscreen,
            toggleEditMode,
            exitEditMode,
            saveEditChanges,
            formatTime,
            formatDate,
          };
        },
      })
        .use(ElementPlus)
        .mount("#app");
    </script>
  </body>
</html>
