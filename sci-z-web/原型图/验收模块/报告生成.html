<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>报告生成 - 高校科研项目管理平台</title>
    <link rel="icon" href="../images/favicon.ico" type="image/x-icon" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/element-plus/dist/index.css"
    />
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue@2.3.1/dist/index.iife.js"></script>

    <!-- 富文本编辑器 -->
    <script src="https://unpkg.com/quill@1.3.7/dist/quill.min.js"></script>
    <link
      href="https://unpkg.com/quill@1.3.7/dist/quill.snow.css"
      rel="stylesheet"
    />

    <!-- Markdown 渲染 -->
    <script src="https://unpkg.com/marked@4.3.0/marked.min.js"></script>
    <script src="https://unpkg.com/highlight.js@11.8.0/lib/index.min.js"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/highlight.js@11.8.0/styles/github.min.css"
    />

    <!-- 文档导出 -->
    <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/docx@7.8.2/build/index.js"></script>

    <link rel="stylesheet" href="../通用规范/样式.css" />
    <style>
      /* 页面布局样式 */
      .report-generation-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        background: #f7f9fc;
        font-family: "Inter", "PingFang SC", "Microsoft YaHei", sans-serif;
      }

      /* 页面头部 */
      .page-header {
        background: #ffffff;
        border-bottom: 1px solid #e5e7eb;
        padding: 20px 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .page-title {
        font-size: 24px;
        font-weight: 600;
        color: #1e3a8a;
        margin: 0;
      }

      .header-actions {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      /* 主内容区域 */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
        padding: 24px;
        gap: 24px;
      }

      /* 配置区域 */
      .config-section {
        background: #ffffff;
        border-radius: 12px;
        padding: 32px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        border: 1px solid #e5e7eb;
      }

      .config-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 28px;
        padding-bottom: 20px;
        border-bottom: 2px solid #f3f4f6;
      }

      .config-title {
        font-size: 20px;
        font-weight: 700;
        color: #1e3a8a;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .config-title-icon {
        font-size: 24px;
      }

      .config-form {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
        margin-bottom: 24px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .form-label {
        font-size: 14px;
        font-weight: 500;
        color: #374151;
      }

      .form-label.required::after {
        content: " *";
        color: #dc2626;
      }

      .project-info {
        background: linear-gradient(135deg, #f0f9ff 0%, #dbeafe 100%);
        border: 2px solid #0ea5e9;
        border-radius: 12px;
        padding: 20px;
        margin-top: 12px;
        box-shadow: 0 2px 8px rgba(14, 165, 233, 0.1);
        position: relative;
        overflow: hidden;
      }

      .project-info::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #0ea5e9 0%, #1e3a8a 100%);
      }

      .project-info-title {
        font-size: 15px;
        font-weight: 700;
        color: #0369a1;
        margin: 0 0 16px 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .project-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
      }

      .stat-item {
        text-align: center;
        background: rgba(255, 255, 255, 0.6);
        padding: 12px;
        border-radius: 8px;
        transition: all 0.3s;
      }

      .stat-item:hover {
        background: rgba(255, 255, 255, 0.9);
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .stat-value {
        font-size: 24px;
        font-weight: 700;
        color: #0369a1;
        margin: 0;
      }

      .stat-label {
        font-size: 12px;
        color: #6b7280;
        margin: 8px 0 0 0;
        font-weight: 500;
      }

      /* 报告类型选择 */
      .report-type-selector {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        grid-column: 1 / -1;
      }

      .type-card {
        border: 3px solid #e5e7eb;
        border-radius: 12px;
        padding: 28px 24px;
        cursor: pointer;
        transition: all 0.3s;
        background: #fafbfc;
        position: relative;
        overflow: hidden;
      }

      .type-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #1e3a8a 0%, #0ea5e9 100%);
        transform: scaleX(0);
        transition: transform 0.3s;
      }

      .type-card:hover {
        border-color: #1e3a8a;
        background: #eef2ff;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(30, 58, 138, 0.15);
      }

      .type-card:hover::before {
        transform: scaleX(1);
      }

      .type-card.selected {
        border-color: #1e3a8a;
        background: linear-gradient(135deg, #eef2ff 0%, #f0f9ff 100%);
        box-shadow: 0 4px 16px rgba(30, 58, 138, 0.2);
      }

      .type-card.selected::before {
        transform: scaleX(1);
      }

      .type-card.selected .type-icon {
        transform: scale(1.1);
      }

      .type-icon {
        font-size: 48px;
        margin-bottom: 16px;
        transition: transform 0.3s;
        display: block;
      }

      .type-title {
        font-size: 18px;
        font-weight: 700;
        color: #1e3a8a;
        margin: 0 0 12px 0;
      }

      .type-description {
        font-size: 14px;
        color: #6b7280;
        line-height: 1.6;
        margin: 0;
      }

      .type-badge {
        position: absolute;
        top: 12px;
        right: 12px;
        background: #16a34a;
        color: #ffffff;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        opacity: 0;
        transform: scale(0.8);
        transition: all 0.3s;
      }

      .type-card.selected .type-badge {
        opacity: 1;
        transform: scale(1);
      }

      /* 高级配置 */
      .advanced-config {
        grid-column: 1 / -1;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        overflow: hidden;
      }

      .advanced-header {
        background: #f9fafb;
        padding: 16px 20px;
        border-bottom: 1px solid #e5e7eb;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .advanced-title {
        font-size: 14px;
        font-weight: 500;
        color: #374151;
        margin: 0;
      }

      .advanced-content {
        padding: 20px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .advanced-content.collapsed {
        display: none;
      }

      /* 开始生成按钮 */
      .generate-section {
        text-align: center;
        margin-top: 32px;
      }

      .generate-btn {
        background: linear-gradient(135deg, #1e3a8a 0%, #0ea5e9 100%);
        color: #ffffff;
        border: none;
        border-radius: 12px;
        padding: 18px 48px;
        font-size: 18px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 6px 20px rgba(30, 58, 138, 0.4);
        position: relative;
        overflow: hidden;
        display: inline-flex;
        align-items: center;
        gap: 12px;
      }

      .generate-btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.3),
          transparent
        );
        transition: left 0.5s;
      }

      .generate-btn:hover::before {
        left: 100%;
      }

      .generate-btn:hover {
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 8px 24px rgba(30, 58, 138, 0.5);
      }

      .generate-btn:active {
        transform: translateY(-1px) scale(0.98);
      }

      .generate-btn:disabled {
        background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
        cursor: not-allowed;
        transform: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .generate-btn-icon {
        font-size: 24px;
        animation: rotate 2s linear infinite;
      }

      .generate-btn:disabled .generate-btn-icon {
        animation: none;
      }

      @keyframes rotate {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      .generate-hint {
        margin-top: 16px;
        color: #9ca3af;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .generate-hint-icon {
        font-size: 16px;
      }

      /* 生成和预览区域 */
      .generation-preview-section {
        flex: 1;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
        min-height: 0;
      }

      /* 生成交互区域 */
      .generation-area {
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border: 1px solid #e5e7eb;
      }

      .generation-header {
        padding: 24px 28px;
        border-bottom: 2px solid #dbeafe;
        background: linear-gradient(135deg, #f0f9ff 0%, #dbeafe 100%);
        position: relative;
      }

      .generation-header::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, #0ea5e9 0%, #1e3a8a 100%);
      }

      .generation-title {
        font-size: 18px;
        font-weight: 700;
        color: #0369a1;
        margin: 0 0 8px 0;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .generation-title-icon {
        font-size: 24px;
        animation: pulse 2s infinite;
      }

      @keyframes pulse-icon {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }

      .generation-subtitle {
        font-size: 14px;
        color: #0369a1;
        margin: 0;
        font-weight: 500;
      }

      .generation-content {
        flex: 1;
        padding: 28px;
        overflow-y: auto;
        background: linear-gradient(180deg, #f0f9ff 0%, #f8fafc 100%);
      }

      /* 生成前状态 */
      .generation-placeholder {
        text-align: center;
        padding: 80px 20px;
        background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
        border-radius: 12px;
        border: 2px dashed #cbd5e1;
      }

      .placeholder-icon {
        font-size: 64px;
        margin-bottom: 24px;
        animation: float 3s ease-in-out infinite;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      .placeholder-text {
        font-size: 18px;
        color: #374151;
        margin: 0 0 12px 0;
        font-weight: 600;
      }

      .placeholder-hint {
        font-size: 14px;
        color: #6b7280;
        margin: 0;
        line-height: 1.6;
      }

      /* 生成进度 */
      .generation-progress {
        margin-bottom: 24px;
      }

      .progress-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }

      .progress-title {
        font-size: 14px;
        font-weight: 500;
        color: #374151;
      }

      .progress-time {
        font-size: 12px;
        color: #6b7280;
      }

      .progress-bar {
        height: 6px;
        background: #e5e7eb;
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 16px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #f59e0b 0%, #16a34a 100%);
        border-radius: 3px;
        transition: width 0.3s ease;
      }

      /* 生成步骤 */
      .generation-steps {
        margin-bottom: 24px;
      }

      .step-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 0;
      }

      .step-icon {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        flex-shrink: 0;
      }

      .step-icon.pending {
        background: #f3f4f6;
        color: #9ca3af;
      }

      .step-icon.running {
        background: #fef3c7;
        color: #f59e0b;
        animation: pulse 2s infinite;
      }

      .step-icon.completed {
        background: #dcfce7;
        color: #16a34a;
      }

      .step-text {
        flex: 1;
        font-size: 14px;
        color: #374151;
      }

      .step-progress {
        font-size: 12px;
        color: #6b7280;
        font-weight: 500;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      /* 生成消息 */
      .generation-messages {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .message-bubble {
        background: #ffffff;
        border-radius: 16px;
        padding: 20px 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border-left: 5px solid #0ea5e9;
        position: relative;
        animation: slideIn 0.3s ease-out;
        transition: all 0.3s;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message-bubble:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        transform: translateX(4px);
      }

      .message-bubble::before {
        content: "";
        position: absolute;
        left: -5px;
        top: 20px;
        width: 5px;
        height: 40px;
        background: linear-gradient(180deg, #0ea5e9 0%, #1e3a8a 100%);
        border-radius: 4px;
      }

      .message-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
      }

      .message-type {
        font-size: 13px;
        font-weight: 600;
        color: #ffffff;
        background: linear-gradient(135deg, #0ea5e9 0%, #0369a1 100%);
        padding: 4px 12px;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(14, 165, 233, 0.3);
      }

      .message-time {
        font-size: 12px;
        color: #9ca3af;
        font-weight: 500;
      }

      .message-content {
        font-size: 15px;
        line-height: 1.7;
        color: #374151;
        font-weight: 400;
      }

      .typing-effect {
        display: inline-block;
        border-right: 3px solid #0ea5e9;
        animation: blink 1s infinite;
        padding-right: 2px;
      }

      @keyframes blink {
        0%,
        50% {
          border-color: #0ea5e9;
        }
        51%,
        100% {
          border-color: transparent;
        }
      }

      /* 生成完成状态 */
      .generation-complete {
        text-align: center;
        padding: 40px 24px;
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        border-radius: 12px;
        border: 2px solid #22c55e;
        animation: slideIn 0.5s ease-out;
      }

      .complete-icon {
        font-size: 72px;
        margin-bottom: 20px;
        animation: bounce 0.6s ease-out;
      }

      @keyframes bounce {
        0%,
        100% {
          transform: translateY(0) scale(1);
        }
        50% {
          transform: translateY(-20px) scale(1.1);
        }
      }

      .complete-title {
        font-size: 22px;
        font-weight: 700;
        color: #16a34a;
        margin: 0 0 12px 0;
      }

      .complete-summary {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin: 28px 0;
        padding: 24px;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .summary-item {
        text-align: center;
        padding: 16px;
        background: #ffffff;
        border-radius: 8px;
        transition: all 0.3s;
      }

      .summary-item:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 12px rgba(22, 163, 74, 0.2);
      }

      .summary-value {
        font-size: 28px;
        font-weight: 700;
        color: #16a34a;
        margin: 0;
      }

      .summary-label {
        font-size: 13px;
        color: #6b7280;
        margin: 8px 0 0 0;
        font-weight: 500;
      }

      .complete-actions {
        display: flex;
        gap: 16px;
        justify-content: center;
        margin-top: 28px;
        flex-wrap: wrap;
      }

      /* 预览区域 */
      .preview-area {
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border: 1px solid #e5e7eb;
      }

      .preview-header {
        padding: 24px 28px;
        border-bottom: 2px solid #dbeafe;
        background: linear-gradient(135deg, #eef2ff 0%, #dbeafe 100%);
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: relative;
      }

      .preview-header::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, #1e3a8a 0%, #0ea5e9 100%);
      }

      .preview-title {
        font-size: 18px;
        font-weight: 700;
        color: #1e3a8a;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .preview-title-icon {
        font-size: 24px;
      }

      .preview-toolbar {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .toolbar-btn {
        padding: 8px 12px;
        border: 2px solid #d1d5db;
        border-radius: 8px;
        background: #ffffff;
        color: #6b7280;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 13px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .toolbar-btn:hover {
        background: #f3f4f6;
        color: #1e3a8a;
        border-color: #1e3a8a;
        transform: translateY(-1px);
      }

      .toolbar-btn.active {
        background: #1e3a8a;
        color: #ffffff;
        border-color: #1e3a8a;
        box-shadow: 0 2px 8px rgba(30, 58, 138, 0.3);
      }

      .preview-content {
        flex: 1;
        padding: 28px;
        overflow-y: auto;
        background: linear-gradient(180deg, #eef2ff 0%, #f8fafc 100%);
      }

      /* 预览占位符 */
      .preview-placeholder {
        text-align: center;
        padding: 80px 20px;
        background: linear-gradient(135deg, #ffffff 0%, #eef2ff 100%);
        border-radius: 12px;
        border: 2px dashed #cbd5e1;
        min-height: 300px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      .preview-placeholder-icon {
        font-size: 64px;
        margin-bottom: 24px;
        animation: float 3s ease-in-out infinite;
      }

      .preview-placeholder-text {
        font-size: 18px;
        color: #374151;
        margin: 0;
        font-weight: 600;
      }

      /* 报告预览内容 */
      .report-preview {
        background: #ffffff;
        border-radius: 12px;
        padding: 48px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
        max-width: none;
        font-family: "Times New Roman", "SimSun", serif;
        border: 1px solid #e5e7eb;
        animation: fadeIn 0.5s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .report-header {
        text-align: center;
        margin-bottom: 48px;
        padding-bottom: 24px;
        border-bottom: 3px solid #1e3a8a;
        position: relative;
      }

      .report-header::after {
        content: "";
        position: absolute;
        bottom: -3px;
        left: 50%;
        transform: translateX(-50%);
        width: 120px;
        height: 3px;
        background: linear-gradient(90deg, #0ea5e9 0%, #1e3a8a 100%);
      }

      .report-title {
        font-size: 28px;
        font-weight: 700;
        color: #1e3a8a;
        margin: 0 0 20px 0;
        letter-spacing: 2px;
      }

      .report-meta {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
        font-size: 14px;
        color: #6b7280;
      }

      .meta-item {
        display: flex;
        justify-content: space-between;
      }

      .report-toc {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 20px;
        margin-bottom: 32px;
      }

      .toc-title {
        font-size: 16px;
        font-weight: 600;
        color: #111827;
        margin: 0 0 16px 0;
      }

      .toc-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .toc-item {
        padding: 4px 0;
      }

      .toc-link {
        color: #1e3a8a;
        text-decoration: none;
        font-size: 14px;
      }

      .toc-link:hover {
        text-decoration: underline;
      }

      .report-section {
        margin-bottom: 32px;
      }

      .section-title {
        font-size: 18px;
        font-weight: 600;
        color: #111827;
        margin: 0 0 16px 0;
        padding-bottom: 8px;
        border-bottom: 1px solid #e5e7eb;
      }

      .section-content {
        font-size: 14px;
        line-height: 1.8;
        color: #374151;
        text-align: justify;
      }

      /* 响应式设计 */
      @media (max-width: 1200px) {
        .generation-preview-section {
          grid-template-columns: 1fr;
          grid-template-rows: 1fr 1fr;
        }

        .config-form {
          grid-template-columns: 1fr;
        }

        .report-type-selector {
          grid-template-columns: 1fr;
        }

        .advanced-content {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 768px) {
        .main-content {
          padding: 16px;
        }

        .page-header {
          padding: 12px 16px;
        }

        .config-section,
        .generation-area,
        .preview-area {
          padding: 16px;
        }

        .report-preview {
          padding: 20px;
        }

        .project-stats {
          grid-template-columns: 1fr;
        }

        .complete-summary {
          grid-template-columns: 1fr;
        }
      }

      /* 编辑模式样式 */
      .edit-mode .report-preview {
        border: 2px dashed #1e3a8a;
      }

      .edit-toolbar {
        position: sticky;
        top: 0;
        background: #ffffff;
        border-bottom: 1px solid #e5e7eb;
        padding: 12px 20px;
        z-index: 10;
      }

      .edit-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
      }

      .edit-btn {
        padding: 6px 12px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        background: #ffffff;
        color: #374151;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
      }

      .edit-btn:hover {
        background: #f3f4f6;
      }

      .edit-btn.primary {
        background: #1e3a8a;
        color: #ffffff;
        border-color: #1e3a8a;
      }

      .edit-btn.primary:hover {
        background: #1e40af;
      }

      /* 富文本编辑器样式 */
      .ql-editor {
        font-family: "Times New Roman", serif;
        font-size: 14px;
        line-height: 1.8;
      }

      .ql-toolbar {
        border-top: 1px solid #e5e7eb;
        border-left: 1px solid #e5e7eb;
        border-right: 1px solid #e5e7eb;
      }

      .ql-container {
        border-bottom: 1px solid #e5e7eb;
        border-left: 1px solid #e5e7eb;
        border-right: 1px solid #e5e7eb;
      }

      /* 加载提示样式 */
      .report-loading .el-loading-spinner {
        margin-top: -30px;
      }

      .report-loading .el-loading-text {
        font-size: 16px;
        font-weight: 500;
        color: #ffffff;
        margin-top: 10px;
      }

      .report-loading .el-loading-spinner .circular {
        width: 50px;
        height: 50px;
      }

      /* 报告提交对话框样式 */
      .report-submit-dialog {
        border-radius: 12px !important;
        overflow: hidden;
      }

      .report-submit-dialog .el-message-box__header {
        padding-top: 24px;
        padding-bottom: 16px;
      }

      .report-submit-dialog .el-message-box__title {
        font-size: 18px;
        font-weight: 600;
      }

      .report-submit-dialog .el-message-box__content {
        padding: 20px 24px;
      }

      .report-submit-dialog .el-message-box__message {
        font-size: 15px;
        line-height: 1.6;
        color: #374151;
      }

      .report-submit-dialog .el-message-box__btns {
        padding: 16px 24px 24px;
      }

      .report-submit-dialog .el-button--primary {
        padding: 10px 24px;
        border-radius: 8px;
        font-weight: 500;
      }

      /* 高级配置样式统一 */
      .advanced-content .el-radio__input.is-checked .el-radio__inner {
        background-color: #1e3a8a;
        border-color: #1e3a8a;
      }

      .advanced-content .el-radio__input.is-checked + .el-radio__label {
        color: #1e3a8a;
      }

      .advanced-content .el-radio__inner:hover {
        border-color: #1e3a8a;
      }

      .advanced-content .el-textarea__inner:focus {
        border-color: #1e3a8a;
      }

      .advanced-content .el-textarea__inner:hover {
        border-color: #1e3a8a;
      }

      /* 工作流选择样式 */
      .workflow-option {
        padding: 8px 0;
      }

      .workflow-name {
        font-size: 14px;
        font-weight: 500;
        color: #374151;
        line-height: 1.4;
      }

      .workflow-description {
        font-size: 12px;
        color: #6b7280;
        line-height: 1.3;
        margin-top: 2px;
      }

      .workflow-info {
        margin-top: 12px;
        padding: 16px;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
      }

      .workflow-info-title {
        font-size: 16px;
        font-weight: 600;
        color: #1e3a8a;
        margin-bottom: 8px;
      }

      .workflow-info-description {
        font-size: 14px;
        color: #64748b;
        line-height: 1.5;
      }

      /* 下拉框选项样式优化 */
      .el-select-dropdown__item {
        height: auto !important;
        padding: 8px 20px !important;
        line-height: normal !important;
      }

      /* 搜索框样式 */
      .el-select .el-input__inner {
        cursor: pointer;
      }

      .el-select .el-input.is-focus .el-input__inner {
        cursor: text;
      }

      /* 搜索结果高亮 */
      .workflow-option .highlight {
        background-color: #fef3c7;
        color: #92400e;
        padding: 0 2px;
        border-radius: 2px;
      }

      /* 无搜索结果时的样式 */
      .el-select-dropdown__empty {
        padding: 20px 0 !important;
        color: #9ca3af !important;
        text-align: center !important;
        font-size: 14px !important;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="report-generation-container">
        <!-- 页面头部 -->
        <div class="page-header">
          <div class="header-left">
            <el-button
              class="back-button"
              @click="handleBack"
              :icon="ArrowLeft"
            >
              返回列表
            </el-button>
            <h1 class="page-title">智能报告生成</h1>
          </div>
          <div class="header-actions">
            <el-button
              v-if="isGenerateComplete"
              @click="handleSaveReport"
              type="primary"
              size="large"
            >
              <el-icon><Document /></el-icon>
              保存报告
            </el-button>
          </div>
        </div>

        <!-- 主内容区域 -->
        <div class="main-content">
          <!-- 配置区域 -->
          <div class="config-section">
            <div class="config-header">
              <h2 class="config-title">
                <span class="config-title-icon">⚙️</span>
                报告配置
              </h2>
            </div>

            <div class="config-form">
              <!-- 项目选择 -->
              <div class="form-group">
                <label class="form-label required">选择项目</label>
                <el-select
                  v-model="config.projectId"
                  placeholder="请选择要生成报告的项目"
                  :loading="loadingProjects"
                  @change="handleProjectChange"
                  filterable
                  clearable
                  style="width: 100%"
                >
                  <el-option
                    v-for="project in projects"
                    :key="project.id"
                    :label="`${project.name} (${project.code})`"
                    :value="project.id"
                  >
                    <div
                      style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                      "
                    >
                      <span>{{ project.name }}</span>
                      <el-tag
                        size="small"
                        :type="project.status === 'completed' ? 'success' : 'warning'"
                      >
                        {{ project.statusText }}
                      </el-tag>
                    </div>
                  </el-option>
                </el-select>

                <!-- 项目信息展示 -->
                <div v-if="config.projectInfo" class="project-info">
                  <h4 class="project-info-title">📊 项目知识库信息</h4>
                  <div class="project-stats">
                    <div class="stat-item">
                      <p class="stat-value">
                        {{ config.projectInfo.docCount }}
                      </p>
                      <p class="stat-label">文档数量</p>
                    </div>
                    <div class="stat-item">
                      <p class="stat-value">
                        {{ config.projectInfo.wordCount }}
                      </p>
                      <p class="stat-label">总字数</p>
                    </div>
                    <div class="stat-item">
                      <p class="stat-value">
                        {{ config.projectInfo.progress }}%
                      </p>
                      <p class="stat-label">项目进度</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 工作流选择 -->
              <div class="form-group">
                <label class="form-label required">选择工作流</label>
                <el-select
                  v-model="config.workflow"
                  placeholder="请选择工作流"
                  style="width: 100%"
                  filterable
                  :filter-method="filterWorkflow"
                  no-match-text="未找到匹配的工作流"
                  no-data-text="暂无工作流数据"
                >
                  <el-option
                    v-for="workflow in filteredWorkflowOptions"
                    :key="workflow.id"
                    :label="workflow.name"
                    :value="workflow.id"
                  >
                    <div class="workflow-option">
                      <div
                        class="workflow-name"
                        v-html="highlightText(workflow.name, workflowSearchQuery)"
                      ></div>
                      <div
                        class="workflow-description"
                        v-html="highlightText(workflow.description, workflowSearchQuery)"
                      ></div>
                    </div>
                  </el-option>
                </el-select>
                <div v-if="selectedWorkflow" class="workflow-info">
                  <div class="workflow-info-title">
                    {{ selectedWorkflow.name }}
                  </div>
                  <div class="workflow-info-description">
                    {{ selectedWorkflow.description }}
                  </div>
                </div>
              </div>

              <!-- 报告类型选择 -->
              <div class="form-group">
                <label class="form-label required">报告类型</label>
                <div class="report-type-selector">
                  <div
                    class="type-card"
                    :class="{ selected: config.reportType === 'tech' }"
                    @click="config.reportType = 'tech'"
                  >
                    <span class="type-badge">已选择</span>
                    <div class="type-icon">📄</div>
                    <h4 class="type-title">科技报告</h4>
                    <p class="type-description">
                      描述项目的科研成果、技术创新、学术价值
                    </p>
                  </div>
                  <div
                    class="type-card"
                    :class="{ selected: config.reportType === 'self' }"
                    @click="config.reportType = 'self'"
                  >
                    <span class="type-badge">已选择</span>
                    <div class="type-icon">📊</div>
                    <h4 class="type-title">自评报告</h4>
                    <p class="type-description">
                      对项目执行情况、完成质量进行自我评价
                    </p>
                  </div>
                </div>
              </div>

              <!-- 高级配置 -->
              <div class="advanced-config">
                <div class="advanced-header" @click="toggleAdvanced">
                  <h4 class="advanced-title">高级配置（可选）</h4>
                  <el-icon>
                    <component :is="showAdvanced ? 'ArrowUp' : 'ArrowDown'" />
                  </el-icon>
                </div>
                <div
                  class="advanced-content"
                  :class="{ collapsed: !showAdvanced }"
                >
                  <div class="form-group">
                    <label class="form-label">报告风格</label>
                    <el-radio-group v-model="config.style">
                      <el-radio label="formal">正式</el-radio>
                      <el-radio label="academic">学术</el-radio>
                      <el-radio label="concise">简洁</el-radio>
                    </el-radio-group>
                  </div>
                  <div class="form-group">
                    <label class="form-label">详细程度</label>
                    <el-radio-group v-model="config.detail">
                      <el-radio label="brief">简要</el-radio>
                      <el-radio label="standard">标准</el-radio>
                      <el-radio label="detailed">详细</el-radio>
                    </el-radio-group>
                  </div>
                  <div class="form-group" style="grid-column: 1 / -1">
                    <label class="form-label">特殊要求</label>
                    <el-input
                      v-model="config.specialRequirements"
                      type="textarea"
                      :rows="3"
                      placeholder="您可以输入对报告的特殊要求，如侧重点、格式要求等..."
                    />
                  </div>
                </div>
              </div>
            </div>

            <!-- 开始生成按钮 -->
            <div class="generate-section">
              <button
                class="generate-btn"
                :disabled="!canGenerate || generating"
                @click="handleStartGenerate"
              >
                <span v-if="generating" class="generate-btn-icon">⟳</span>
                <span v-else class="generate-btn-icon">🚀</span>
                {{ generating ? '正在生成中...' : '开始生成报告' }}
              </button>
              <div v-if="!canGenerate" class="generate-hint">
                <span class="generate-hint-icon">💡</span>
                请选择项目、工作流和报告类型
              </div>
            </div>
          </div>

          <!-- 生成和预览区域 -->
          <div class="generation-preview-section">
            <!-- 生成交互区域 -->
            <div class="generation-area">
              <div class="generation-header">
                <h3 class="generation-title">
                  <span class="generation-title-icon">🤖</span>
                  AI 生成过程
                </h3>
                <p class="generation-subtitle">✨ 实时展示报告生成的每个步骤</p>
              </div>
              <div class="generation-content">
                <!-- 生成前状态 -->
                <div
                  v-if="!generating && !isGenerateComplete"
                  class="generation-placeholder"
                >
                  <div class="placeholder-icon">🚀</div>
                  <p class="placeholder-text">
                    请选择项目和报告类型，然后点击"开始生成"
                  </p>
                  <p class="placeholder-hint">
                    AI 将基于项目知识库智能生成专业报告
                  </p>
                </div>

                <!-- 生成中状态 -->
                <div v-if="generating">
                  <!-- 整体进度 -->
                  <div class="generation-progress">
                    <div class="progress-header">
                      <span class="progress-title">生成进度</span>
                      <span class="progress-time"
                        >预计还需 {{ estimatedTime }} 秒</span
                      >
                    </div>
                    <div class="progress-bar">
                      <div
                        class="progress-fill"
                        :style="{ width: generateProgress + '%' }"
                      ></div>
                    </div>
                  </div>

                  <!-- 生成步骤 -->
                  <div class="generation-steps">
                    <div
                      v-for="(step, index) in generateSteps"
                      :key="index"
                      class="step-item"
                    >
                      <div class="step-icon" :class="step.status">
                        <span v-if="step.status === 'completed'">✓</span>
                        <span v-else-if="step.status === 'running'">⟳</span>
                        <span v-else>○</span>
                      </div>
                      <span class="step-text">{{ step.name }}</span>
                      <span
                        v-if="step.status === 'running'"
                        class="step-progress"
                        >{{ step.progress }}%</span
                      >
                    </div>
                  </div>

                  <!-- 生成消息 -->
                  <div class="generation-messages">
                    <div
                      v-for="(message, index) in generateMessages"
                      :key="index"
                      class="message-bubble"
                    >
                      <div class="message-header">
                        <span class="message-type">{{ message.type }}</span>
                        <span class="message-time"
                          >{{ formatTime(message.time) }}</span
                        >
                      </div>
                      <div
                        class="message-content"
                        :class="{ 'typing-effect': message.typing }"
                      >
                        {{ message.content }}
                      </div>
                    </div>
                  </div>

                  <!-- 取消按钮 -->
                  <div style="text-align: center; margin-top: 24px">
                    <el-button
                      @click="handleCancelGenerate"
                      type="danger"
                      plain
                    >
                      取消生成
                    </el-button>
                  </div>
                </div>

                <!-- 生成完成状态 -->
                <div v-if="isGenerateComplete" class="generation-complete">
                  <div class="complete-icon">🎉</div>
                  <h3 class="complete-title">报告生成成功！</h3>

                  <div class="complete-summary">
                    <div class="summary-item">
                      <p class="summary-value">
                        {{ reportMetadata.generatedTime }}s
                      </p>
                      <p class="summary-label">生成时间</p>
                    </div>
                    <div class="summary-item">
                      <p class="summary-value">
                        {{ reportMetadata.refDocsCount }}
                      </p>
                      <p class="summary-label">引用文档</p>
                    </div>
                    <div class="summary-item">
                      <p class="summary-value">
                        {{ reportMetadata.wordCount }}
                      </p>
                      <p class="summary-label">报告字数</p>
                    </div>
                  </div>

                  <div class="complete-actions">
                    <el-button @click="handleSaveReport" type="primary">
                      <el-icon><Document /></el-icon>
                      保存报告
                    </el-button>
                    <el-dropdown @command="handleDownloadReport">
                      <el-button type="primary" plain>
                        <el-icon><Download /></el-icon>
                        下载报告
                        <el-icon class="el-icon--right"><ArrowDown /></el-icon>
                      </el-button>
                      <template #dropdown>
                        <el-dropdown-menu>
                          <el-dropdown-item command="pdf"
                            >PDF 格式</el-dropdown-item
                          >
                          <el-dropdown-item command="word"
                            >Word 格式</el-dropdown-item
                          >
                          <el-dropdown-item command="markdown"
                            >Markdown 格式</el-dropdown-item
                          >
                        </el-dropdown-menu>
                      </template>
                    </el-dropdown>
                    <el-button @click="handleRegenerate" plain>
                      <el-icon><Refresh /></el-icon>
                      重新生成
                    </el-button>
                  </div>
                </div>
              </div>
            </div>

            <!-- 预览区域 -->
            <div class="preview-area">
              <div class="preview-header">
                <h3 class="preview-title">
                  <span class="preview-title-icon">📄</span>
                  报告预览
                </h3>
                <div class="preview-toolbar">
                  <button
                    class="toolbar-btn"
                    :class="{ active: previewFontSize === 'small' }"
                    @click="previewFontSize = 'small'"
                    title="小字体"
                  >
                    <span>A</span>
                  </button>
                  <button
                    class="toolbar-btn"
                    :class="{ active: previewFontSize === 'medium' }"
                    @click="previewFontSize = 'medium'"
                    title="中字体"
                  >
                    <span style="font-size: 16px">A</span>
                  </button>
                  <button
                    class="toolbar-btn"
                    :class="{ active: previewFontSize === 'large' }"
                    @click="previewFontSize = 'large'"
                    title="大字体"
                  >
                    <span style="font-size: 18px">A</span>
                  </button>
                  <button
                    class="toolbar-btn"
                    @click="toggleFullscreen"
                    title="全屏"
                  >
                    <el-icon><FullScreen /></el-icon>
                  </button>
                  <button
                    v-if="isGenerateComplete"
                    class="toolbar-btn"
                    :class="{ active: editMode }"
                    @click="toggleEditMode"
                    title="编辑模式"
                  >
                    <el-icon><Edit /></el-icon>
                    编辑
                  </button>
                </div>
              </div>
              <div class="preview-content" :class="'font-' + previewFontSize">
                <!-- 预览占位符 -->
                <div
                  v-if="!reportContent && !generating"
                  class="preview-placeholder"
                >
                  <div class="preview-placeholder-icon">📄</div>
                  <p class="preview-placeholder-text">
                    报告预览将在生成时实时显示
                  </p>
                </div>

                <!-- 报告预览 -->
                <div
                  v-if="reportContent"
                  class="report-preview"
                  :class="{ 'edit-mode': editMode }"
                >
                  <!-- 编辑工具栏 -->
                  <div v-if="editMode" class="edit-toolbar">
                    <div class="edit-actions">
                      <button class="edit-btn" @click="exitEditMode">
                        取消编辑
                      </button>
                      <button class="edit-btn primary" @click="saveEditChanges">
                        保存修改
                      </button>
                    </div>
                  </div>

                  <!-- 报告头部 -->
                  <div class="report-header">
                    <h1 class="report-title">{{ reportTitle }}</h1>
                    <div class="report-meta">
                      <div class="meta-item">
                        <span>项目名称：</span>
                        <span>{{ config.projectInfo?.name }}</span>
                      </div>
                      <div class="meta-item">
                        <span>报告类型：</span>
                        <span>{{ reportTypeText }}</span>
                      </div>
                      <div class="meta-item">
                        <span>生成时间：</span>
                        <span>{{ formatDate(new Date()) }}</span>
                      </div>
                      <div class="meta-item">
                        <span>生成方式：</span>
                        <span>AI 智能生成</span>
                      </div>
                    </div>
                  </div>

                  <!-- 报告目录 -->
                  <div class="report-toc">
                    <h3 class="toc-title">目录</h3>
                    <ul class="toc-list">
                      <li class="toc-item">
                        <a href="#section-1" class="toc-link">1. 项目概述</a>
                      </li>
                      <li class="toc-item">
                        <a href="#section-2" class="toc-link"
                          >2. 研究内容与方法</a
                        >
                      </li>
                      <li class="toc-item">
                        <a href="#section-3" class="toc-link"
                          >3. 主要成果与创新</a
                        >
                      </li>
                      <li class="toc-item">
                        <a href="#section-4" class="toc-link"
                          >4. 技术指标完成情况</a
                        >
                      </li>
                      <li class="toc-item">
                        <a href="#section-5" class="toc-link"
                          >5. 经济社会效益</a
                        >
                      </li>
                      <li class="toc-item">
                        <a href="#section-6" class="toc-link"
                          >6. 存在问题与建议</a
                        >
                      </li>
                    </ul>
                  </div>

                  <!-- 富文本编辑器 -->
                  <div
                    v-if="editMode"
                    id="quill-editor"
                    style="min-height: 400px"
                  ></div>

                  <!-- 报告内容 -->
                  <div v-else v-html="reportContent"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const { createApp, ref, computed, onMounted, nextTick } = Vue;
      const { ElMessage, ElMessageBox, ElLoading } = ElementPlus;
      const {
        ArrowLeft,
        Document,
        Download,
        ArrowDown,
        Refresh,
        Loading,
        ArrowUp,
        FullScreen,
        Edit,
        Folder,
      } = ElementPlusIconsVue;

      createApp({
        components: {
          ArrowLeft,
          Document,
          Download,
          ArrowDown,
          Refresh,
          Loading,
          ArrowUp,
          FullScreen,
          Edit,
          Folder,
        },
        setup() {
          // 配置数据
          const config = ref({
            projectId: "",
            projectInfo: null,
            workflow: "", // 工作流
            reportType: "tech",
            style: "formal",
            detail: "standard",
            specialRequirements: "",
          });

          // 项目列表
          const projects = ref([
            {
              id: "1",
              name: "基于深度学习的图像识别技术研究",
              code: "AI2024001",
              status: "completed",
              statusText: "已完成",
              docCount: 45,
              wordCount: "12.5万",
              progress: 100,
            },
            {
              id: "2",
              name: "智能物联网系统关键技术研发",
              code: "IOT2024002",
              status: "completed",
              statusText: "已完成",
              docCount: 32,
              wordCount: "8.7万",
              progress: 85,
            },
            {
              id: "3",
              name: "区块链技术在供应链管理中的应用",
              code: "BC2024003",
              status: "completed",
              statusText: "已完成",
              docCount: 28,
              wordCount: "9.2万",
              progress: 100,
            },
          ]);
          const loadingProjects = ref(false);

          // 工作流选项
          const workflowOptions = [
            {
              id: "workflow_001",
              name: "科研项目申报审核流程",
              description:
                "适用于科研项目的标准申报审核，包含初审、专家评审、终审等环节",
            },
            {
              id: "workflow_002",
              name: "快速申报流程",
              description: "简化的申报流程，适用于小型项目或紧急项目的快速审批",
            },
            {
              id: "workflow_003",
              name: "重点项目专项流程",
              description:
                "针对重点科研项目的专项审核流程，包含多轮专家评审和答辩环节",
            },
            {
              id: "workflow_004",
              name: "产学研合作项目流程",
              description:
                "专门用于产学研合作项目的审核流程，涉及企业参与和成果转化评估",
            },
          ];

          // 生成状态
          const generating = ref(false);
          const generateProgress = ref(0);
          const estimatedTime = ref(0);
          const generateSteps = ref([
            { name: "读取项目知识库", status: "pending", progress: 0 },
            { name: "分析项目文档内容", status: "pending", progress: 0 },
            { name: "提取关键信息", status: "pending", progress: 0 },
            { name: "生成报告大纲", status: "pending", progress: 0 },
            { name: "生成报告内容", status: "pending", progress: 0 },
            { name: "优化报告格式", status: "pending", progress: 0 },
          ]);

          // 生成内容
          const generateMessages = ref([]);
          const reportContent = ref(null);
          const reportMetadata = ref({
            generatedTime: 0,
            wordCount: 0,
            refDocsCount: 0,
          });

          // 预览状态
          const previewFontSize = ref("medium");
          const previewFullscreen = ref(false);
          const editMode = ref(false);
          const showAdvanced = ref(false);

          // 工作流搜索
          const workflowSearchQuery = ref("");
          const filteredWorkflowOptions = ref([...workflowOptions]);

          // 富文本编辑器
          let quillEditor = null;

          // 计算属性
          const canGenerate = computed(() => {
            return (
              config.value.projectId &&
              config.value.workflow &&
              config.value.reportType &&
              !generating.value
            );
          });

          const isGenerateComplete = computed(() => {
            return reportContent.value !== null && !generating.value;
          });

          const reportTitle = computed(() => {
            const typeMap = { tech: "科技报告", self: "自评报告" };
            return config.value.projectInfo
              ? `${config.value.projectInfo.name} - ${
                  typeMap[config.value.reportType]
                }`
              : "报告标题";
          });

          const reportTypeText = computed(() => {
            const typeMap = { tech: "科技报告", self: "自评报告" };
            return typeMap[config.value.reportType];
          });

          const selectedWorkflow = computed(() => {
            return workflowOptions.find(
              (workflow) => workflow.id === config.value.workflow
            );
          });

          // 方法
          const handleBack = () => {
            if (isGenerateComplete.value) {
              ElMessageBox.confirm("有未保存的报告，是否保存？", "提示", {
                confirmButtonText: "保存",
                cancelButtonText: "不保存",
                type: "warning",
              })
                .then(() => {
                  handleSaveReport();
                })
                .catch(() => {
                  window.parent.postMessage(
                    { type: "navigate", path: "acceptance/list" },
                    "*"
                  );
                });
            } else {
              window.parent.postMessage(
                { type: "navigate", path: "acceptance/list" },
                "*"
              );
            }
          };

          const handleProjectChange = (projectId) => {
            const project = projects.value.find((p) => p.id === projectId);
            if (project) {
              config.value.projectInfo = project;
              ElMessage.success(`已选择项目：${project.name}`);
            }
          };

          const toggleAdvanced = () => {
            showAdvanced.value = !showAdvanced.value;
          };

          // 工作流过滤方法
          const filterWorkflow = (query) => {
            workflowSearchQuery.value = query;
            if (!query) {
              filteredWorkflowOptions.value = [...workflowOptions];
              return;
            }

            const lowerQuery = query.toLowerCase();
            filteredWorkflowOptions.value = workflowOptions.filter(
              (workflow) => {
                return (
                  workflow.name.toLowerCase().includes(lowerQuery) ||
                  workflow.description.toLowerCase().includes(lowerQuery)
                );
              }
            );
          };

          // 文本高亮方法
          const highlightText = (text, query) => {
            if (!query || !text) return text;

            const regex = new RegExp(`(${query})`, "gi");
            return text.replace(regex, '<span class="highlight">$1</span>');
          };

          const handleStartGenerate = async () => {
            if (!canGenerate.value) return;

            // 显示动态加载提示
            const loadingTexts = [
              "正在提交报告生成任务...",
              "正在连接 Dify 工作流...",
              "正在启动 AI 分析引擎...",
            ];
            let textIndex = 0;

            const loading = ElLoading.service({
              lock: true,
              text: loadingTexts[0],
              background: "rgba(0, 0, 0, 0.7)",
              spinner: "el-icon-loading",
              customClass: "report-loading",
            });

            // 动态更新加载文案
            const textInterval = setInterval(() => {
              textIndex = (textIndex + 1) % loadingTexts.length;
              if (loading.$el) {
                const textEl = loading.$el.querySelector(".el-loading-text");
                if (textEl) {
                  textEl.textContent = loadingTexts[textIndex];
                }
              }
            }, 800);

            try {
              // 模拟提交到后端API
              await new Promise((resolve) => setTimeout(resolve, 2000));

              // 清除文案更新定时器
              clearInterval(textInterval);

              // 关闭加载提示
              loading.close();

              // 提示用户任务已提交
              ElMessageBox.alert(
                "报告生成任务已成功提交到后台处理，这可能需要几分钟时间。系统将调用 Dify 工作流自动生成报告，完成后您可以在报告列表中查看。",
                "任务已提交",
                {
                  confirmButtonText: "前往报告列表",
                  type: "success",
                  center: true,
                  customClass: "report-submit-dialog",
                  callback: () => {
                    // 跳转到报告列表
                    window.parent.postMessage(
                      { type: "navigate", path: "acceptance/list" },
                      "*"
                    );
                  },
                }
              );
            } catch (error) {
              clearInterval(textInterval);
              loading.close();
              ElMessage.error("提交报告生成任务失败，请重试");
            }
          };

          const simulateGeneration = async () => {
            const steps = generateSteps.value;
            const totalSteps = steps.length;

            for (let i = 0; i < totalSteps; i++) {
              if (!generating.value) break; // 如果被取消则停止

              // 更新当前步骤状态
              steps[i].status = "running";

              // 添加生成消息
              addGenerateMessage("系统", `开始${steps[i].name}...`);

              // 模拟步骤进度
              for (let progress = 0; progress <= 100; progress += 10) {
                if (!generating.value) break;

                steps[i].progress = progress;
                generateProgress.value = (i * 100 + progress) / totalSteps;
                estimatedTime.value = Math.max(
                  0,
                  120 - Math.floor(generateProgress.value * 1.2)
                );

                await new Promise((resolve) => setTimeout(resolve, 200));
              }

              steps[i].status = "completed";
              addGenerateMessage("AI助手", `${steps[i].name}完成！`);

              // 在生成报告内容阶段，模拟实时内容生成
              if (i === 4) {
                await simulateContentGeneration();
              }
            }

            if (generating.value) {
              // 生成完成
              generating.value = false;
              generateProgress.value = 100;
              estimatedTime.value = 0;

              // 设置报告元数据
              reportMetadata.value = {
                generatedTime: 85,
                wordCount: 8500,
                refDocsCount: config.value.projectInfo?.docCount || 0,
              };

              ElMessage.success("报告生成成功！");
            }
          };

          const simulateContentGeneration = async () => {
            const sections = [
              {
                title: "1. 项目概述",
                content: `
                  <h2 id="section-1" class="section-title">1. 项目概述</h2>
                  <div class="section-content">
                    <p>本项目"${config.value.projectInfo?.name}"是一项重要的科研项目，旨在通过创新技术手段解决行业关键问题。项目自立项以来，严格按照研究计划执行，在理论研究、技术开发、实验验证等方面取得了显著进展。</p>
                    <p>项目研究周期为24个月，总投入资金500万元，参与研究人员15人，其中高级职称8人，博士学位10人。项目依托先进的实验设备和完善的研究环境，确保了研究工作的顺利开展。</p>
                  </div>
                `,
              },
              {
                title: "2. 研究内容与方法",
                content: `
                  <h2 id="section-2" class="section-title">2. 研究内容与方法</h2>
                  <div class="section-content">
                    <p>本项目采用理论分析与实验验证相结合的研究方法，主要研究内容包括：</p>
                    <ul>
                      <li>核心算法设计与优化</li>
                      <li>系统架构设计与实现</li>
                      <li>性能测试与评估</li>
                      <li>应用场景验证与推广</li>
                    </ul>
                    <p>研究方法科学严谨，实验设计合理，数据采集准确，为项目成果的可靠性提供了有力保障。</p>
                  </div>
                `,
              },
              {
                title: "3. 主要成果与创新",
                content: `
                  <h2 id="section-3" class="section-title">3. 主要成果与创新</h2>
                  <div class="section-content">
                    <p>项目在研究过程中取得了多项重要成果和技术创新：</p>
                    <ol>
                      <li><strong>理论创新</strong>：提出了新的理论模型，为相关领域研究提供了新的思路和方法。</li>
                      <li><strong>技术突破</strong>：突破了多项关键技术难题，形成了具有自主知识产权的核心技术。</li>
                      <li><strong>应用成果</strong>：开发了完整的应用系统，在实际场景中得到了成功验证。</li>
                    </ol>
                    <p>这些成果不仅具有重要的学术价值，也具有广阔的应用前景和商业价值。</p>
                  </div>
                `,
              },
            ];

            let fullContent = "";

            for (const section of sections) {
              // 添加章节生成消息
              addGenerateMessage("AI助手", `正在生成"${section.title}"...`);

              // 模拟打字机效果生成内容
              fullContent += section.content;
              reportContent.value = fullContent;

              await new Promise((resolve) => setTimeout(resolve, 1500));
            }

            // 添加剩余章节
            const remainingSections = `
              <h2 id="section-4" class="section-title">4. 技术指标完成情况</h2>
              <div class="section-content">
                <p>项目各项技术指标均已达到或超过预期目标：</p>
                <table style="width: 100%; border-collapse: collapse; margin: 16px 0;">
                  <thead>
                    <tr style="background: #f9fafb;">
                      <th style="border: 1px solid #e5e7eb; padding: 8px; text-align: left;">技术指标</th>
                      <th style="border: 1px solid #e5e7eb; padding: 8px; text-align: center;">目标值</th>
                      <th style="border: 1px solid #e5e7eb; padding: 8px; text-align: center;">实际值</th>
                      <th style="border: 1px solid #e5e7eb; padding: 8px; text-align: center;">完成度</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td style="border: 1px solid #e5e7eb; padding: 8px;">系统响应时间</td>
                      <td style="border: 1px solid #e5e7eb; padding: 8px; text-align: center;">≤100ms</td>
                      <td style="border: 1px solid #e5e7eb; padding: 8px; text-align: center;">85ms</td>
                      <td style="border: 1px solid #e5e7eb; padding: 8px; text-align: center;">115%</td>
                    </tr>
                    <tr>
                      <td style="border: 1px solid #e5e7eb; padding: 8px;">准确率</td>
                      <td style="border: 1px solid #e5e7eb; padding: 8px; text-align: center;">≥95%</td>
                      <td style="border: 1px solid #e5e7eb; padding: 8px; text-align: center;">97.5%</td>
                      <td style="border: 1px solid #e5e7eb; padding: 8px; text-align: center;">103%</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <h2 id="section-5" class="section-title">5. 经济社会效益</h2>
              <div class="section-content">
                <p>项目成果具有显著的经济社会效益：</p>
                <p><strong>经济效益：</strong>预计可为相关企业节约成本30%以上，提高效率50%以上，具有巨大的市场潜力。</p>
                <p><strong>社会效益：</strong>推动了行业技术进步，提升了我国在相关领域的国际竞争力，具有重要的战略意义。</p>
              </div>

              <h2 id="section-6" class="section-title">6. 存在问题与建议</h2>
              <div class="section-content">
                <p>虽然项目取得了预期成果，但在研究过程中也发现了一些问题和改进空间：</p>
                <ul>
                  <li>部分算法在特殊场景下的适应性有待进一步提升</li>
                  <li>系统的可扩展性需要持续优化</li>
                  <li>产业化推广还需要更多的政策支持</li>
                </ul>
                <p>建议在后续工作中继续深入研究，不断完善技术方案，加快成果转化和产业化进程。</p>
              </div>
            `;

            reportContent.value += remainingSections;
          };

          const addGenerateMessage = (type, content) => {
            generateMessages.value.push({
              type,
              content,
              time: new Date(),
              typing: false,
            });

            // 滚动到底部
            nextTick(() => {
              const container = document.querySelector(".generation-content");
              if (container) {
                container.scrollTop = container.scrollHeight;
              }
            });
          };

          const handleCancelGenerate = () => {
            ElMessageBox.confirm("确定要取消生成吗？", "提示", {
              confirmButtonText: "确定",
              cancelButtonText: "继续生成",
              type: "warning",
            }).then(() => {
              generating.value = false;
              generateProgress.value = 0;
              estimatedTime.value = 0;
              ElMessage.info("已取消生成");
            });
          };

          const handleSaveReport = () => {
            if (!reportContent.value) return;

            ElMessage.success("报告保存成功！");
            setTimeout(() => {
              window.parent.postMessage(
                { type: "navigate", path: "acceptance/list" },
                "*"
              );
            }, 1000);
          };

          const handleDownloadReport = (format) => {
            if (!reportContent.value) return;

            ElMessage.info(`正在生成 ${format.toUpperCase()} 文件...`);

            // 模拟下载过程
            setTimeout(() => {
              const fileName = `${config.value.projectInfo?.name || "报告"}_${
                reportTypeText.value
              }_${formatDate(new Date(), "YYYYMMDD")}.${format}`;

              if (format === "markdown") {
                // 简单的 Markdown 导出
                const markdownContent = reportContent.value
                  .replace(/<h2[^>]*>/g, "## ")
                  .replace(/<\/h2>/g, "\n\n")
                  .replace(/<p>/g, "")
                  .replace(/<\/p>/g, "\n\n")
                  .replace(/<[^>]*>/g, "");

                const blob = new Blob([markdownContent], {
                  type: "text/markdown",
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = fileName;
                a.click();
                URL.revokeObjectURL(url);
              }

              ElMessage.success(`${format.toUpperCase()} 文件下载成功！`);
            }, 2000);
          };

          const handleRegenerate = () => {
            ElMessageBox.confirm(
              "当前内容将被覆盖，是否继续？",
              "重新生成确认",
              {
                confirmButtonText: "继续",
                cancelButtonText: "取消",
                type: "warning",
              }
            ).then(() => {
              reportContent.value = null;
              handleStartGenerate();
            });
          };

          const toggleFullscreen = () => {
            previewFullscreen.value = !previewFullscreen.value;
            // 这里可以实现全屏逻辑
            ElMessage.info(
              previewFullscreen.value ? "进入全屏模式" : "退出全屏模式"
            );
          };

          const toggleEditMode = () => {
            if (!isGenerateComplete.value) return;

            editMode.value = !editMode.value;

            if (editMode.value) {
              nextTick(() => {
                initQuillEditor();
              });
            } else {
              if (quillEditor) {
                quillEditor = null;
              }
            }
          };

          const initQuillEditor = () => {
            const editorElement = document.getElementById("quill-editor");
            if (editorElement && window.Quill) {
              quillEditor = new Quill("#quill-editor", {
                theme: "snow",
                modules: {
                  toolbar: [
                    ["bold", "italic", "underline"],
                    ["blockquote", "code-block"],
                    [{ header: 1 }, { header: 2 }],
                    [{ list: "ordered" }, { list: "bullet" }],
                    [{ align: [] }],
                    ["link"],
                    ["clean"],
                  ],
                },
              });

              // 设置初始内容
              quillEditor.root.innerHTML = reportContent.value;
            }
          };

          const exitEditMode = () => {
            editMode.value = false;
            if (quillEditor) {
              quillEditor = null;
            }
          };

          const saveEditChanges = () => {
            if (quillEditor) {
              reportContent.value = quillEditor.root.innerHTML;
              ElMessage.success("修改已保存");
              exitEditMode();
            }
          };

          // 工具函数
          const formatTime = (time) => {
            return time.toLocaleTimeString();
          };

          const formatDate = (date, format = "YYYY-MM-DD") => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, "0");
            const day = String(date.getDate()).padStart(2, "0");

            if (format === "YYYYMMDD") {
              return `${year}${month}${day}`;
            }
            return `${year}-${month}-${day}`;
          };

          // 组件挂载
          onMounted(() => {
            // 初始化
            console.log("报告生成页面已加载");
          });

          return {
            // 数据
            config,
            projects,
            loadingProjects,
            workflowOptions,
            filteredWorkflowOptions,
            workflowSearchQuery,
            generating,
            generateProgress,
            estimatedTime,
            generateSteps,
            generateMessages,
            reportContent,
            reportMetadata,
            previewFontSize,
            previewFullscreen,
            editMode,
            showAdvanced,

            // 计算属性
            canGenerate,
            isGenerateComplete,
            reportTitle,
            reportTypeText,
            selectedWorkflow,

            // 方法
            handleBack,
            handleProjectChange,
            toggleAdvanced,
            filterWorkflow,
            highlightText,
            handleStartGenerate,
            handleCancelGenerate,
            handleSaveReport,
            handleDownloadReport,
            handleRegenerate,
            toggleFullscreen,
            toggleEditMode,
            exitEditMode,
            saveEditChanges,
            formatTime,
            formatDate,
          };
        },
      })
        .use(ElementPlus)
        .mount("#app");
    </script>
  </body>
</html>
