<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>æ–°å»ºç”³æŠ¥ - é«˜æ ¡ç§‘ç ”é¡¹ç›®ç®¡ç†å¹³å°</title>
    <link rel="icon" href="../images/favicon.ico" type="image/x-icon" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/element-plus@2.4.4/dist/index.css"
    />
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/element-plus@2.4.4"></script>
    <script src="https://unpkg.com/element-plus@2.4.4/dist/locale/zh-cn.min.js"></script>
    <link rel="stylesheet" href="../é€šç”¨è§„èŒƒ/æ ·å¼.css" />
    <style>
      .new-declaration-container {
        padding: 20px;
        background: #f7f9fc;
        min-height: calc(100vh - 56px);
      }

      .page-header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
      }

      .back-button {
        margin-right: 12px;
      }

      .page-title {
        font-size: 24px;
        font-weight: 600;
        color: #1e3a8a;
        margin: 0;
      }

      .form-card {
        background: #ffffff;
        border-radius: 8px;
        padding: 24px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        border: 1px solid #e5e7eb;
        max-width: 800px;
        margin: 0 auto;
      }

      .form-group {
        margin-bottom: 40px;
        background: #ffffff;
        border-radius: 12px;
        padding: 32px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        border: 1px solid #f1f5f9;
      }

      .group-title {
        font-size: 18px;
        font-weight: 600;
        color: #1e3a8a;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 2px solid #e0e7ff;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .group-title::before {
        content: "";
        width: 4px;
        height: 20px;
        background: linear-gradient(135deg, #1e3a8a, #3b82f6);
        border-radius: 2px;
      }

      /* è¡¨å•é¡¹å¸ƒå±€ä¼˜åŒ– */
      .form-row {
        display: flex;
        gap: 24px;
        margin-bottom: 28px;
        align-items: flex-start;
      }

      .form-row .form-item {
        flex: 1;
        min-width: 0;
      }

      .form-row.single {
        margin-bottom: 24px;
      }

      .form-row.single .form-item {
        flex: none;
        width: 100%;
      }

      /* å“åº”å¼å¸ƒå±€ */
      @media (max-width: 768px) {
        .form-row {
          flex-direction: column;
          gap: 16px;
        }

        .form-row .form-item {
          flex: none;
          width: 100%;
        }
      }

      .form-item {
        margin-bottom: 24px;
      }

      .form-item:last-child {
        margin-bottom: 0;
      }

      /* Element Plus è¡¨å•é¡¹é—´è·ä¼˜åŒ– */
      .el-form-item {
        margin-bottom: 24px !important;
      }

      .el-form-item__label {
        padding-bottom: 8px !important;
        font-weight: 500 !important;
        color: #374151 !important;
      }

      .el-form-item__content {
        line-height: 1.5 !important;
      }

      .rich-text-editor {
        min-height: 200px;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        padding: 12px;
      }

      .rich-text-editor:focus-within {
        border-color: #1e3a8a;
        box-shadow: 0 0 0 2px rgba(30, 58, 138, 0.1);
      }

      .toolbar {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e5e7eb;
      }

      .toolbar-button {
        padding: 6px 12px;
        border: 1px solid #e5e7eb;
        background: #ffffff;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
      }

      .toolbar-button:hover {
        background: #f8fafc;
        border-color: #1e3a8a;
      }

      .toolbar-button.active {
        background: #1e3a8a;
        color: #ffffff;
        border-color: #1e3a8a;
      }

      .editor-content {
        min-height: 120px;
        outline: none;
        font-size: 14px;
        line-height: 1.6;
        color: #374151;
      }

      .editor-content:empty:before {
        content: "è¯·è¯¦ç»†æè¿°æ‚¨çš„ç ”ç©¶æ–¹å‘...";
        color: #9ca3af;
      }

      .char-count {
        text-align: right;
        font-size: 12px;
        color: #6b7280;
        margin-top: 8px;
      }

      .char-count.warning {
        color: #f59e0b;
      }

      .char-count.error {
        color: #dc2626;
      }

      .tag-input-container {
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        padding: 8px;
        min-height: 40px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }

      .tag-input-container:focus-within {
        border-color: #1e3a8a;
        box-shadow: 0 0 0 2px rgba(30, 58, 138, 0.1);
      }

      .tag-input {
        border: none;
        outline: none;
        flex: 1;
        min-width: 120px;
        font-size: 14px;
      }

      .tag-input::placeholder {
        color: #9ca3af;
      }

      .tag-item {
        background: #e0e7ff;
        color: #1e3a8a;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .tag-remove {
        cursor: pointer;
        color: #6b7280;
        font-weight: bold;
      }

      .tag-remove:hover {
        color: #dc2626;
      }

      .suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
      }

      .suggestion-item {
        padding: 8px 12px;
        cursor: pointer;
        font-size: 14px;
        color: #374151;
      }

      .suggestion-item:hover {
        background: #f8fafc;
      }

      .form-actions {
        display: flex;
        justify-content: center;
        gap: 16px;
        margin-top: 32px;
        padding-top: 24px;
        border-top: 1px solid #e5e7eb;
      }

      .auto-save-indicator {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        padding: 8px 12px;
        font-size: 12px;
        color: #6b7280;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        z-index: 1000;
      }

      .auto-save-indicator.saving {
        color: #f59e0b;
      }

      .auto-save-indicator.saved {
        color: #16a34a;
      }

      /* æ–‡ä»¶ä¸Šä¼ æ ·å¼ */
      .upload-area {
        border: 2px dashed #d1d5db;
        border-radius: 12px;
        padding: 32px;
        text-align: center;
        background: #fafbfc;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .upload-area:hover {
        border-color: #1e3a8a;
        background: #f8fafc;
      }

      .upload-area.dragover {
        border-color: #1e3a8a;
        background: #eff6ff;
      }

      .upload-icon {
        font-size: 48px;
        color: #9ca3af;
        margin-bottom: 16px;
      }

      .upload-text {
        font-size: 16px;
        color: #374151;
        margin-bottom: 8px;
      }

      .upload-hint {
        font-size: 14px;
        color: #6b7280;
      }

      .upload-progress {
        margin-top: 16px;
      }

      .upload-status {
        margin-top: 16px;
        padding: 12px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .upload-status.success {
        background: #f0fdf4;
        color: #166534;
        border: 1px solid #bbf7d0;
      }

      .upload-status.analyzing {
        background: #fffbeb;
        color: #92400e;
        border: 1px solid #fde68a;
      }

      .upload-status.error {
        background: #fef2f2;
        color: #dc2626;
        border: 1px solid #fecaca;
      }

      .file-info {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        background: #f8fafc;
        border-radius: 8px;
        margin-top: 12px;
      }

      .file-name {
        font-weight: 500;
        color: #374151;
      }

      .file-actions {
        display: flex;
        gap: 8px;
      }

      .analysis-result {
        margin-top: 16px;
        padding: 16px;
        background: #f0fdf4;
        border-radius: 8px;
        border: 1px solid #bbf7d0;
      }

      .analysis-title {
        font-weight: 600;
        color: #166534;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      /* è‡ªåŠ¨å¡«å……å­—æ®µæ ·å¼ - ä¿æŒé»˜è®¤æ ·å¼ */

      .error-message {
        color: #dc2626;
        font-size: 12px;
        margin-top: 4px;
      }

      .success-icon {
        color: #16a34a;
        font-size: 12px;
        margin-top: 4px;
      }

      /* è‡ªå®šä¹‰å¼¹çª—æ ·å¼ */
      .el-message-box {
        border-radius: 12px !important;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12) !important;
      }

      .el-message-box__header {
        padding: 20px 24px 16px 24px !important;
        border-bottom: 1px solid #f0f0f0 !important;
        background: #ffffff !important;
      }

      .el-message-box__title {
        font-size: 16px !important;
        font-weight: 600 !important;
        color: #1e3a8a !important;
        line-height: 1.5 !important;
      }

      .el-message-box__headerbtn {
        top: 16px !important;
        right: 20px !important;
        width: 24px !important;
        height: 24px !important;
      }

      .el-message-box__close {
        color: #9ca3af !important;
        font-size: 16px !important;
      }

      .el-message-box__close:hover {
        color: #6b7280 !important;
      }

      .el-message-box__content {
        padding: 20px 24px !important;
        background: #ffffff !important;
      }

      .el-message-box__message {
        font-size: 14px !important;
        line-height: 1.6 !important;
        color: #374151 !important;
        margin: 0 !important;
        padding: 0 !important;
      }

      .el-message-box__btns {
        padding: 16px 24px 20px 24px !important;
        background: #ffffff !important;
        display: flex !important;
        justify-content: flex-end !important;
        gap: 12px !important;
      }

      .el-message-box__btns .el-button {
        padding: 8px 20px !important;
        border-radius: 8px !important;
        font-size: 14px !important;
        font-weight: 500 !important;
        border: 1px solid !important;
        transition: all 0.2s ease !important;
      }

      .el-message-box__btns .el-button--default {
        background: #ffffff !important;
        border-color: #d1d5db !important;
        color: #6b7280 !important;
      }

      .el-message-box__btns .el-button--default:hover {
        background: #f9fafb !important;
        border-color: #9ca3af !important;
        color: #374151 !important;
      }

      .el-message-box__btns .el-button--primary {
        background: #1e3a8a !important;
        border-color: #1e3a8a !important;
        color: #ffffff !important;
      }

      .el-message-box__btns .el-button--primary:hover {
        background: #1e40af !important;
        border-color: #1e40af !important;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
      }

      .el-message-box__btns .el-button--primary:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(30, 58, 138, 0.3);
      }

      /* ç§»é™¤æ‰€æœ‰å¼¹çª—å›¾æ ‡ */
      .el-message-box__status {
        display: none !important;
      }

      .el-message-box__message {
        margin-left: 0 !important;
        padding-left: 0 !important;
      }

      .el-message-box--warning .el-message-box__message::before {
        display: none !important;
      }

      /* å·¥ä½œæµé€‰æ‹©æ ·å¼ */
      .workflow-option {
        padding: 8px 0;
      }

      .workflow-name {
        font-size: 14px;
        font-weight: 500;
        color: #374151;
        line-height: 1.4;
      }

      .workflow-description {
        font-size: 12px;
        color: #6b7280;
        line-height: 1.3;
        margin-top: 2px;
      }

      .workflow-info {
        margin-top: 12px;
        padding: 16px;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
      }

      .workflow-info-title {
        font-size: 16px;
        font-weight: 600;
        color: #1e3a8a;
        margin-bottom: 8px;
      }

      .workflow-info-description {
        font-size: 14px;
        color: #64748b;
        line-height: 1.5;
      }

      /* ä¸‹æ‹‰æ¡†é€‰é¡¹æ ·å¼ä¼˜åŒ– */
      .el-select-dropdown__item {
        height: auto !important;
        padding: 8px 20px !important;
        line-height: normal !important;
      }

      /* æœç´¢æ¡†æ ·å¼ */
      .el-select .el-input__inner {
        cursor: pointer;
      }

      .el-select .el-input.is-focus .el-input__inner {
        cursor: text;
      }

      /* æœç´¢ç»“æœé«˜äº® */
      .workflow-option .highlight {
        background-color: #fef3c7;
        color: #92400e;
        padding: 0 2px;
        border-radius: 2px;
      }

      /* æ— æœç´¢ç»“æœæ—¶çš„æ ·å¼ */
      .el-select-dropdown__empty {
        padding: 20px 0 !important;
        color: #9ca3af !important;
        text-align: center !important;
        font-size: 14px !important;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <el-config-provider :locale="locale">
        <div class="new-declaration-container">
          <!-- é¡µé¢æ ‡é¢˜å’Œè¿”å›æŒ‰é’® -->
          <div class="page-header">
            <el-button
              class="back-button"
              @click="handleBack"
              :icon="ArrowLeft"
            >
              è¿”å›åˆ—è¡¨
            </el-button>
            <h1 class="page-title">æ–°å»ºç”³æŠ¥</h1>
          </div>

          <!-- ç”³æŠ¥è¡¨å• -->
          <div class="form-card">
            <el-form
              :model="form"
              :rules="rules"
              ref="formRef"
              label-width="100px"
            >
              <!-- çº¢å¤´æ–‡ä»¶ä¸Šä¼  -->
              <div class="form-group">
                <div class="group-title">çº¢å¤´æ–‡ä»¶ä¸Šä¼ </div>

                <div
                  v-if="!form.documentFile"
                  class="upload-area"
                  @click="$refs.fileInput.click()"
                >
                  <div class="upload-icon">ğŸ“</div>
                  <div class="upload-text">ç‚¹å‡»ä¸Šä¼ çº¢å¤´æ–‡ä»¶</div>
                  <div class="upload-hint">
                    æ”¯æŒ PDFã€Wordã€å›¾ç‰‡æ ¼å¼ï¼Œæ–‡ä»¶å¤§å°ä¸è¶…è¿‡ 10MB
                  </div>
                  <input
                    ref="fileInput"
                    type="file"
                    accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                    style="display: none"
                    @change="handleFileChange"
                  />
                </div>

                <div v-else>
                  <div class="file-info">
                    <span class="file-name">{{ form.documentFile.name }}</span>
                    <div class="file-actions">
                      <el-button
                        size="small"
                        @click="reAnalyzeDocument"
                        :disabled="uploadStatus === 'analyzing'"
                      >
                        é‡æ–°åˆ†æ
                      </el-button>
                      <el-button
                        size="small"
                        type="danger"
                        @click="clearUploadedFile"
                      >
                        åˆ é™¤
                      </el-button>
                    </div>
                  </div>

                  <!-- ä¸Šä¼ è¿›åº¦ -->
                  <div
                    v-if="uploadStatus === 'uploading'"
                    class="upload-progress"
                  >
                    <el-progress
                      :percentage="uploadProgress"
                      :show-text="true"
                    />
                  </div>

                  <!-- åˆ†æçŠ¶æ€ -->
                  <div
                    v-if="uploadStatus === 'analyzing'"
                    class="upload-status analyzing"
                  >
                    <el-icon class="is-loading"><Loading /></el-icon>
                    æ­£åœ¨åˆ†ææ–‡æ¡£å†…å®¹ï¼Œè¯·ç¨å€™...
                  </div>

                  <div
                    v-if="uploadStatus === 'success'"
                    class="upload-status success"
                  >
                    <el-icon><Check /></el-icon>
                    æ–‡æ¡£åˆ†æå®Œæˆï¼Œå·²è‡ªåŠ¨å¡«å……ç›¸å…³å­—æ®µ
                  </div>

                  <div
                    v-if="uploadStatus === 'error'"
                    class="upload-status error"
                  >
                    <el-icon><Close /></el-icon>
                    æ–‡æ¡£åˆ†æå¤±è´¥ï¼Œè¯·é‡æ–°ä¸Šä¼ æˆ–æ‰‹åŠ¨å¡«å†™
                  </div>

                  <!-- åˆ†æç»“æœé¢„è§ˆ -->
                  <div
                    v-if="analysisResult && uploadStatus === 'success'"
                    class="analysis-result"
                  >
                    <div class="analysis-title">
                      <el-icon><MagicStick /></el-icon>
                      AI åˆ†æç»“æœ
                    </div>
                    <p v-if="analysisResult.researchField && analysisResult.researchField.length > 0">
                      <strong>ç ”ç©¶é¢†åŸŸï¼š</strong>{{ analysisResult.researchField.join('ã€') }}
                    </p>
                    <p>
                      <strong>ç ”ç©¶æ–¹å‘ï¼š</strong>{{
                      analysisResult.researchDirection }}
                    </p>
                    <p>
                      <strong>ç ”ç©¶è¯¾é¢˜ï¼š</strong>{{ analysisResult.researchTopic
                      }}
                    </p>
                    <div
                      style="margin-top: 8px; font-size: 12px; color: #6b7280"
                    >
                      ğŸ’¡ æç¤ºï¼šAI ç”Ÿæˆçš„å†…å®¹ä»…ä¾›å‚è€ƒï¼Œæ‚¨å¯ä»¥åœ¨ä¸‹æ–¹è¡¨å•ä¸­è¿›è¡Œä¿®æ”¹
                    </div>
                  </div>
                </div>
              </div>

              <!-- åŸºæœ¬ä¿¡æ¯ -->
              <div class="form-group">
                <div class="group-title">åŸºæœ¬ä¿¡æ¯</div>

                <!-- ç¬¬ä¸€è¡Œï¼šéƒ¨é—¨å’Œè´Ÿè´£äºº -->
                <div class="form-row">
                  <div class="form-item">
                    <el-form-item label="è¯¾é¢˜å‘å¸ƒéƒ¨é—¨" prop="department">
                      <el-select
                        v-model="form.department"
                        placeholder="è¯·é€‰æ‹©è¯¾é¢˜å‘å¸ƒéƒ¨é—¨"
                        style="width: 100%"
                      >
                        <el-option
                          v-for="option in departmentOptions"
                          :key="option.value"
                          :label="option.label"
                          :value="option.value"
                        />
                      </el-select>
                    </el-form-item>
                  </div>

                  <div class="form-item">
                    <el-form-item label="é¡¹ç›®è´Ÿè´£äºº" prop="projectLeader">
                      <el-input
                        v-model="form.projectLeader"
                        placeholder="è¯·è¾“å…¥é¡¹ç›®è´Ÿè´£äººå§“å"
                      />
                    </el-form-item>
                  </div>
                </div>

                <!-- ç¬¬äºŒè¡Œï¼šçº¢å¤´æ–‡ä»¶å‘å¸ƒæ—¶é—´ -->
                <div class="form-row">
                  <div class="form-item">
                    <el-form-item
                      label="çº¢å¤´æ–‡ä»¶å‘å¸ƒæ—¶é—´"
                      prop="documentPublishTime"
                    >
                      <el-date-picker
                        v-model="form.documentPublishTime"
                        type="date"
                        placeholder="è¯·é€‰æ‹©çº¢å¤´æ–‡ä»¶å‘å¸ƒæ—¶é—´"
                        style="width: 100%"
                        format="YYYYå¹´MMæœˆDDæ—¥"
                        value-format="YYYY-MM-DD"
                      />
                    </el-form-item>
                  </div>
                  <div class="form-item"></div>
                </div>

                <!-- ç¬¬ä¸‰è¡Œï¼šé¡¹ç›®æ—¶é—´ -->
                <div class="form-row">
                  <div class="form-item">
                    <el-form-item label="é¡¹ç›®å¼€å§‹æ—¶é—´" prop="projectStartTime">
                      <el-date-picker
                        v-model="form.projectStartTime"
                        type="date"
                        placeholder="è¯·é€‰æ‹©é¡¹ç›®å¼€å§‹æ—¶é—´"
                        style="width: 100%"
                        format="YYYYå¹´MMæœˆDDæ—¥"
                        value-format="YYYY-MM-DD"
                      />
                    </el-form-item>
                  </div>

                  <div class="form-item">
                    <el-form-item label="é¡¹ç›®ç»“æŸæ—¶é—´" prop="projectEndTime">
                      <el-date-picker
                        v-model="form.projectEndTime"
                        type="date"
                        placeholder="è¯·é€‰æ‹©é¡¹ç›®ç»“æŸæ—¶é—´"
                        style="width: 100%"
                        format="YYYYå¹´MMæœˆDDæ—¥"
                        value-format="YYYY-MM-DD"
                      />
                    </el-form-item>
                  </div>
                </div>
              </div>

              <!-- ç ”ç©¶é¢†åŸŸ -->
              <div class="form-group">
                <div class="group-title">
                  ç ”ç©¶é¢†åŸŸ <span style="color: #dc2626">*</span>
                </div>
                <div class="form-item">
                  <div class="tag-input-container" ref="tagInputRef">
                    <div
                      v-for="(tag, index) in form.researchField"
                      :key="index"
                      class="tag-item"
                    >
                      {{ tag }}
                      <span class="tag-remove" @click="removeTag(index)">
                        Ã—
                      </span>
                    </div>
                    <input
                      v-model="tagInput"
                      class="tag-input"
                      placeholder="è¯·è¾“å…¥ç ”ç©¶é¢†åŸŸï¼Œå›è½¦æ·»åŠ "
                      @keydown.enter="addTag"
                      @keydown.backspace="handleBackspace"
                      @input="handleTagInput"
                      ref="tagInputElementRef"
                    />
                    <div
                      v-if="showSuggestions && suggestions.length > 0"
                      class="suggestions"
                    >
                      <div
                        v-for="suggestion in suggestions"
                        :key="suggestion"
                        class="suggestion-item"
                        @click="selectSuggestion(suggestion)"
                      >
                        {{ suggestion }}
                      </div>
                    </div>
                  </div>
                  <div style="margin-top: 8px; font-size: 12px; color: #6b7280">
                    å·²é€‰æ‹© {{ form.researchField.length }} / 10 ä¸ªé¢†åŸŸ
                  </div>
                  <div
                    v-if="analysisResult && uploadStatus === 'success' && analysisResult.researchField"
                    style="margin-top: 4px; font-size: 12px; color: #16a34a"
                  >
                    âœ¨ æ­¤å­—æ®µå·²ç”±AIè‡ªåŠ¨å¡«å……ï¼Œæ‚¨å¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œä¿®æ”¹
                  </div>
                  <div v-if="formErrors.researchField" class="error-message">
                    {{ formErrors.researchField }}
                  </div>
                  <div v-if="formSuccess.researchField" class="success-icon">
                    âœ“ ç ”ç©¶é¢†åŸŸé€‰æ‹©å®Œæˆ
                  </div>
                </div>
              </div>

              <!-- ç ”ç©¶ä¿¡æ¯ -->
              <div class="form-group">
                <div class="group-title">ç ”ç©¶ä¿¡æ¯</div>

                <div class="form-row single">
                  <el-form-item
                    label="ç ”ç©¶æ–¹å‘"
                    prop="researchDirection"
                    class="form-item"
                  >
                    <el-input
                      v-model="form.researchDirection"
                      type="textarea"
                      :rows="4"
                      placeholder="è¯·æ ¹æ®çº¢å¤´æ–‡ä»¶æ–¹å‘è‡ªè¡Œå¡«å†™ç ”ç©¶æ–¹å‘ï¼Œæˆ–ç­‰å¾…AIè‡ªåŠ¨åˆ†æå¡«å……"
                    />
                    <div
                      v-if="analysisResult && uploadStatus === 'success'"
                      style="margin-top: 4px; font-size: 12px; color: #16a34a"
                    >
                      âœ¨ æ­¤å­—æ®µå·²ç”±AIè‡ªåŠ¨å¡«å……ï¼Œæ‚¨å¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œä¿®æ”¹
                    </div>
                  </el-form-item>
                </div>

                <div class="form-row single">
                  <el-form-item
                    label="ç ”ç©¶è¯¾é¢˜"
                    prop="researchTopic"
                    class="form-item"
                  >
                    <el-input
                      v-model="form.researchTopic"
                      type="textarea"
                      :rows="3"
                      placeholder="è¯·è¾“å…¥å…·ä½“çš„ç ”ç©¶è¯¾é¢˜ï¼Œæˆ–ç­‰å¾…AIè‡ªåŠ¨åˆ†æå¡«å……"
                    />
                    <div
                      v-if="analysisResult && uploadStatus === 'success'"
                      style="margin-top: 4px; font-size: 12px; color: #16a34a"
                    >
                      âœ¨ æ­¤å­—æ®µå·²ç”±AIè‡ªåŠ¨å¡«å……ï¼Œæ‚¨å¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œä¿®æ”¹
                    </div>
                  </el-form-item>
                </div>
              </div>

              <!-- å·¥ä½œæµé€‰æ‹© -->
              <div class="form-group">
                <div class="group-title">
                  å·¥ä½œæµ <span style="color: #dc2626">*</span>
                </div>
                <div class="form-item">
                  <el-form-item label="é€‰æ‹©å·¥ä½œæµ" prop="workflow">
                    <el-select
                      v-model="form.workflow"
                      placeholder="è¯·é€‰æ‹©å·¥ä½œæµ"
                      style="width: 100%"
                      filterable
                      :filter-method="filterWorkflow"
                      no-match-text="æœªæ‰¾åˆ°åŒ¹é…çš„å·¥ä½œæµ"
                      no-data-text="æš‚æ— å·¥ä½œæµæ•°æ®"
                    >
                      <el-option
                        v-for="workflow in filteredWorkflowOptions"
                        :key="workflow.id"
                        :label="workflow.name"
                        :value="workflow.id"
                      >
                        <div class="workflow-option">
                          <div
                            class="workflow-name"
                            v-html="highlightText(workflow.name, workflowSearchQuery)"
                          ></div>
                          <div
                            class="workflow-description"
                            v-html="highlightText(workflow.description, workflowSearchQuery)"
                          ></div>
                        </div>
                      </el-option>
                    </el-select>
                  </el-form-item>
                  <div v-if="selectedWorkflow" class="workflow-info">
                    <div class="workflow-info-title">
                      {{ selectedWorkflow.name }}
                    </div>
                    <div class="workflow-info-description">
                      {{ selectedWorkflow.description }}
                    </div>
                  </div>
                </div>
              </div>

              <!-- è¡¨å•æ“ä½œæŒ‰é’® -->
              <div class="form-actions">
                <el-button
                  type="primary"
                  size="large"
                  :loading="submitting"
                  @click="handleSubmit"
                >
                  <el-icon><Check /></el-icon>
                  {{ submitting ? "æäº¤ä¸­..." : "æäº¤ç”³æŠ¥" }}
                </el-button>
                <el-button size="large" @click="handleBack">
                  <el-icon><Close /></el-icon>
                  å–æ¶ˆ
                </el-button>
              </div>
            </el-form>
          </div>

        </div>
      </el-config-provider>
    </div>

    <script>
      const { createApp, ref, reactive, computed, onMounted } = Vue;
      const { ElMessage, ElMessageBox, ElConfigProvider } = ElementPlus;
      const zhCn = ElementPlusLocaleZhCn;

      createApp({
        setup() {
          // è¡¨å•æ•°æ®
          const form = reactive({
            documentFile: null, // çº¢å¤´æ–‡ä»¶
            department: "", // è¯¾é¢˜å‘å¸ƒéƒ¨é—¨
            projectLeader: "", // é¡¹ç›®è´Ÿè´£äºº
            documentPublishTime: "", // çº¢å¤´æ–‡ä»¶å‘å¸ƒæ—¶é—´
            projectStartTime: "", // é¡¹ç›®å¼€å§‹æ—¶é—´
            projectEndTime: "", // é¡¹ç›®ç»“æŸæ—¶é—´
            researchDirection: "", // ç ”ç©¶æ–¹å‘
            researchField: [], // ç ”ç©¶é¢†åŸŸ
            researchTopic: "", // ç ”ç©¶è¯¾é¢˜
            workflow: "", // å·¥ä½œæµ
          });

          // è¡¨å•éªŒè¯è§„åˆ™
          const rules = {
            department: [
              {
                required: true,
                message: "è¯·é€‰æ‹©è¯¾é¢˜å‘å¸ƒéƒ¨é—¨",
                trigger: "change",
              },
            ],
            projectLeader: [
              {
                required: true,
                message: "é¡¹ç›®è´Ÿè´£äººä¸èƒ½ä¸ºç©º",
                trigger: "blur",
              },
            ],
            documentPublishTime: [
              {
                required: true,
                message: "è¯·é€‰æ‹©çº¢å¤´æ–‡ä»¶å‘å¸ƒæ—¶é—´",
                trigger: "change",
              },
            ],
            projectStartTime: [
              {
                required: true,
                message: "è¯·é€‰æ‹©é¡¹ç›®å¼€å§‹æ—¶é—´",
                trigger: "change",
              },
            ],
            projectEndTime: [
              {
                required: true,
                message: "è¯·é€‰æ‹©é¡¹ç›®ç»“æŸæ—¶é—´",
                trigger: "change",
              },
            ],
            researchDirection: [
              {
                required: true,
                message: "ç ”ç©¶æ–¹å‘ä¸èƒ½ä¸ºç©º",
                trigger: "change",
              },
            ],
            researchField: [
              {
                required: true,
                message: "è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç ”ç©¶é¢†åŸŸ",
                trigger: "submit",
              },
            ],
            researchTopic: [
              {
                required: true,
                message: "ç ”ç©¶è¯¾é¢˜ä¸èƒ½ä¸ºç©º",
                trigger: "change",
              },
            ],
            workflow: [
              {
                required: true,
                message: "è¯·é€‰æ‹©å·¥ä½œæµ",
                trigger: "change",
              },
            ],
          };

          // çŠ¶æ€ç®¡ç†
          const submitting = ref(false);
          const formRef = ref();
          const editorRef = ref();
          const editorContentRef = ref();
          const tagInputRef = ref();
          const tagInputElementRef = ref();

          // ç¼–è¾‘å™¨çŠ¶æ€
          const editorState = reactive({
            bold: false,
            italic: false,
            underline: false,
          });

          // æ ‡ç­¾è¾“å…¥
          const tagInput = ref("");
          const showSuggestions = ref(false);
          const suggestions = ref([]);

          // è¯¾é¢˜å‘å¸ƒéƒ¨é—¨é€‰é¡¹
          const departmentOptions = [
            { label: "å›½è‡ªç„¶-é’å¹´åŸºé‡‘", value: "å›½è‡ªç„¶-é’å¹´åŸºé‡‘" },
            { label: "å›½è‡ªç„¶-é¢ä¸ŠåŸºé‡‘", value: "å›½è‡ªç„¶-é¢ä¸ŠåŸºé‡‘" },
            { label: "å›½è‡ªç„¶-åœ°åŒºé¡¹ç›®", value: "å›½è‡ªç„¶-åœ°åŒºé¡¹ç›®" },
            { label: "çœå¸‚çº§é¡¹ç›®", value: "çœå¸‚çº§é¡¹ç›®" },
            { label: "å…¶ä»–", value: "å…¶ä»–" },
          ];

          // å·¥ä½œæµé€‰é¡¹
          const workflowOptions = [
            {
              id: "workflow_001",
              name: "ç§‘ç ”é¡¹ç›®ç”³æŠ¥å®¡æ ¸æµç¨‹",
              description:
                "é€‚ç”¨äºç§‘ç ”é¡¹ç›®çš„æ ‡å‡†ç”³æŠ¥å®¡æ ¸ï¼ŒåŒ…å«åˆå®¡ã€ä¸“å®¶è¯„å®¡ã€ç»ˆå®¡ç­‰ç¯èŠ‚",
            },
            {
              id: "workflow_002",
              name: "å¿«é€Ÿç”³æŠ¥æµç¨‹",
              description: "ç®€åŒ–çš„ç”³æŠ¥æµç¨‹ï¼Œé€‚ç”¨äºå°å‹é¡¹ç›®æˆ–ç´§æ€¥é¡¹ç›®çš„å¿«é€Ÿå®¡æ‰¹",
            },
            {
              id: "workflow_003",
              name: "é‡ç‚¹é¡¹ç›®ä¸“é¡¹æµç¨‹",
              description:
                "é’ˆå¯¹é‡ç‚¹ç§‘ç ”é¡¹ç›®çš„ä¸“é¡¹å®¡æ ¸æµç¨‹ï¼ŒåŒ…å«å¤šè½®ä¸“å®¶è¯„å®¡å’Œç­”è¾©ç¯èŠ‚",
            },
            {
              id: "workflow_004",
              name: "äº§å­¦ç ”åˆä½œé¡¹ç›®æµç¨‹",
              description:
                "ä¸“é—¨ç”¨äºäº§å­¦ç ”åˆä½œé¡¹ç›®çš„å®¡æ ¸æµç¨‹ï¼Œæ¶‰åŠä¼ä¸šå‚ä¸å’Œæˆæœè½¬åŒ–è¯„ä¼°",
            },
          ];

          // é¢„è®¾ç ”ç©¶é¢†åŸŸ
          const presetFields = [
            "äººå·¥æ™ºèƒ½",
            "æœºå™¨å­¦ä¹ ",
            "æ·±åº¦å­¦ä¹ ",
            "è‡ªç„¶è¯­è¨€å¤„ç†",
            "è®¡ç®—æœºè§†è§‰",
            "æ•°æ®æŒ–æ˜",
            "åŒºå—é“¾",
            "ç‰©è”ç½‘",
            "ç½‘ç»œå®‰å…¨",
            "äº‘è®¡ç®—",
            "å¤§æ•°æ®",
            "ç”Ÿç‰©ä¿¡æ¯å­¦",
            "åŒ»å­¦å½±åƒ",
            "ææ–™ç§‘å­¦",
            "æ•°å­¦",
            "ç‰©ç†",
            "åŒ–å­¦",
            "ç”Ÿç‰©å­¦",
            "å¿ƒç†å­¦",
            "ç»æµå­¦",
            "ç®¡ç†å­¦",
            "æ•™è‚²å­¦",
          ];

          // å­—ç¬¦è®¡æ•°ï¼ˆä¿ç•™ä»¥é˜²éœ€è¦ï¼‰
          const charCount = computed(() => {
            return form.researchDirection ? form.researchDirection.length : 0;
          });

          // é€‰ä¸­çš„å·¥ä½œæµ
          const selectedWorkflow = computed(() => {
            return workflowOptions.find(
              (workflow) => workflow.id === form.workflow
            );
          });

          // å·¥ä½œæµæœç´¢
          const workflowSearchQuery = ref("");
          const filteredWorkflowOptions = ref([...workflowOptions]);

          // å·¥ä½œæµè¿‡æ»¤æ–¹æ³•
          const filterWorkflow = (query) => {
            workflowSearchQuery.value = query;
            if (!query) {
              filteredWorkflowOptions.value = [...workflowOptions];
              return;
            }

            const lowerQuery = query.toLowerCase();
            filteredWorkflowOptions.value = workflowOptions.filter(
              (workflow) => {
                return (
                  workflow.name.toLowerCase().includes(lowerQuery) ||
                  workflow.description.toLowerCase().includes(lowerQuery)
                );
              }
            );
          };

          // æ–‡æœ¬é«˜äº®æ–¹æ³•
          const highlightText = (text, query) => {
            if (!query || !text) return text;

            const regex = new RegExp(`(${query})`, "gi");
            return text.replace(regex, '<span class="highlight">$1</span>');
          };

          // è¡¨å•éªŒè¯çŠ¶æ€
          const formErrors = reactive({
            department: "",
            projectLeader: "",
            documentPublishTime: "",
            projectStartTime: "",
            projectEndTime: "",
            researchDirection: "",
            researchField: "",
            researchTopic: "",
            workflow: "",
          });

          const formSuccess = reactive({
            department: false,
            projectLeader: false,
            documentPublishTime: false,
            projectStartTime: false,
            projectEndTime: false,
            researchDirection: false,
            researchField: false,
            researchTopic: false,
            workflow: false,
          });

          // æ–‡ä»¶ä¸Šä¼ çŠ¶æ€
          const uploadStatus = ref("idle"); // idle, uploading, analyzing, success, error
          const analysisResult = ref(null);
          const uploadProgress = ref(0);

          // æ–‡ä»¶ä¸Šä¼ å¤„ç†
          const handleFileUpload = async (file) => {
            try {
              uploadStatus.value = "uploading";
              uploadProgress.value = 0;

              // æ¨¡æ‹Ÿæ–‡ä»¶ä¸Šä¼ è¿›åº¦
              const uploadInterval = setInterval(() => {
                uploadProgress.value += 10;
                if (uploadProgress.value >= 100) {
                  clearInterval(uploadInterval);
                  uploadStatus.value = "analyzing";
                  analyzeDocument(file);
                }
              }, 200);

              form.documentFile = file;
              return false; // é˜»æ­¢é»˜è®¤ä¸Šä¼ è¡Œä¸º
            } catch (error) {
              uploadStatus.value = "error";
              ElMessage.error("æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•");
              return false;
            }
          };

          // æ–‡æ¡£åˆ†æå¤„ç†
          const analyzeDocument = async (file) => {
            try {
              // æ¨¡æ‹ŸAIåˆ†æè¿‡ç¨‹
              await new Promise((resolve) => setTimeout(resolve, 3000));

              // æ¨¡æ‹Ÿåˆ†æç»“æœ
              const mockResult = {
                researchDirection: "ç§‘å­¦å®¶æ™ºèƒ½ä½“å‰æ²¿æŠ€æœ¯ç ”ç©¶",
                researchTopic: "å…·èº«æ™ºèƒ½ä½“æ“ä½œç³»ç»Ÿä¸å·¥å…·é“¾æŠ€æœ¯",
                researchField: ["äººå·¥æ™ºèƒ½", "å‰æ²¿æŠ€æœ¯ç ”ç©¶ä¸åº”ç”¨"],
              };

              analysisResult.value = mockResult;

              // è‡ªåŠ¨å¡«å……è¡¨å•
              form.researchDirection = mockResult.researchDirection;
              form.researchTopic = mockResult.researchTopic;
              
              // è‡ªåŠ¨å¡«å……ç ”ç©¶é¢†åŸŸï¼ˆåˆå¹¶åˆ°ç°æœ‰å­—æ®µä¸­ï¼Œä¸è¦†ç›–ç”¨æˆ·å·²æ·»åŠ çš„ï¼‰
              if (mockResult.researchField && mockResult.researchField.length > 0) {
                mockResult.researchField.forEach((field) => {
                  if (
                    !form.researchField.includes(field) &&
                    form.researchField.length < 10
                  ) {
                    form.researchField.push(field);
                  }
                });
              }

              uploadStatus.value = "success";
              ElMessage.success("çº¢å¤´æ–‡ä»¶åˆ†æå®Œæˆï¼Œå·²è‡ªåŠ¨å¡«å……ç›¸å…³å­—æ®µ");
            } catch (error) {
              uploadStatus.value = "error";
              ElMessage.error("æ–‡æ¡£åˆ†æå¤±è´¥ï¼Œè¯·é‡è¯•");
            }
          };

          // é‡æ–°åˆ†ææ–‡æ¡£
          const reAnalyzeDocument = () => {
            if (form.documentFile) {
              uploadStatus.value = "analyzing";
              analyzeDocument(form.documentFile);
            }
          };

          // æ¸…é™¤ä¸Šä¼ çš„æ–‡ä»¶
          const clearUploadedFile = () => {
            form.documentFile = null;
            analysisResult.value = null;
            uploadStatus.value = "idle";
            uploadProgress.value = 0;
          };

          // æ–‡ä»¶é€‰æ‹©å¤„ç†
          const handleFileChange = (event) => {
            const file = event.target.files[0];
            if (file) {
              // æ–‡ä»¶å¤§å°æ£€æŸ¥ (10MB)
              if (file.size > 10 * 1024 * 1024) {
                ElMessage.error("æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 10MB");
                return;
              }

              // æ–‡ä»¶ç±»å‹æ£€æŸ¥
              const allowedTypes = [
                "application/pdf",
                "application/msword",
                "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                "image/jpeg",
                "image/jpg",
                "image/png",
              ];

              if (!allowedTypes.includes(file.type)) {
                ElMessage.error(
                  "ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼Œè¯·ä¸Šä¼  PDFã€Word æˆ–å›¾ç‰‡æ–‡ä»¶"
                );
                return;
              }

              handleFileUpload(file);
            }
          };

          // è¡¨å•éªŒè¯å‡½æ•°
          const validateForm = () => {
            return formRef.value.validate();
          };

          // æ ‡ç­¾åŠŸèƒ½
          const addTag = (e) => {
            e.preventDefault();
            const value = tagInput.value.trim();
            if (
              value &&
              !form.researchField.includes(value) &&
              form.researchField.length < 10
            ) {
              form.researchField.push(value);
              tagInput.value = "";
            }
          };

          const removeTag = (index) => {
            form.researchField.splice(index, 1);
          };

          const handleBackspace = () => {
            if (tagInput.value === "" && form.researchField.length > 0) {
              form.researchField.pop();
            }
          };

          const handleTagInput = () => {
            const value = tagInput.value.toLowerCase();
            if (value) {
              suggestions.value = presetFields.filter(
                (field) =>
                  field.toLowerCase().includes(value) &&
                  !form.researchField.includes(field)
              );
              showSuggestions.value = suggestions.value.length > 0;
            } else {
              showSuggestions.value = false;
            }
          };

          const selectSuggestion = (suggestion) => {
            if (
              !form.researchField.includes(suggestion) &&
              form.researchField.length < 10
            ) {
              form.researchField.push(suggestion);
              tagInput.value = "";
              showSuggestions.value = false;
            }
          };

          // äº‹ä»¶å¤„ç†
          const handleSubmit = async () => {
            try {
              await validateForm();
            } catch (error) {
              ElMessage.error("è¯·å®Œå–„ç”³æŠ¥ä¿¡æ¯");
              return;
            }

            try {
              await ElMessageBox.confirm(
                "ç¡®å®šè¦æäº¤æ­¤ç”³æŠ¥å—ï¼Ÿæäº¤åå°†è§¦å‘Difyå·¥ä½œæµå¤„ç†ã€‚",
                "ç¡®è®¤æäº¤",
                {
                  confirmButtonText: "ç¡®å®š",
                  cancelButtonText: "å–æ¶ˆ",
                }
              );

              submitting.value = true;

              // æ¨¡æ‹Ÿæäº¤ç”³æŠ¥
              await new Promise((resolve) => setTimeout(resolve, 2000));

              ElMessage.success("ç”³æŠ¥æäº¤æˆåŠŸï¼æ­£åœ¨å¤„ç†ä¸­...");

              // è·³è½¬åˆ°ç”³æŠ¥è¯¦æƒ…é¡µé¢
              setTimeout(() => {
                if (window.parent !== window) {
                  window.parent.postMessage(
                    {
                      type: "navigate",
                      path: "declaration/detail",
                    },
                    "*"
                  );
                } else {
                  window.location.href = "ç”³æŠ¥è¯¦æƒ….html";
                }
              }, 1000);
            } catch (error) {
              if (error !== "cancel") {
                ElMessage.error("æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•");
              }
            } finally {
              submitting.value = false;
            }
          };

          const handleBack = () => {
            ElMessageBox.confirm(
              "ç¡®å®šè¦ç¦»å¼€å—ï¼Ÿæœªä¿å­˜çš„å†…å®¹å°†ä¸¢å¤±ã€‚",
              "ç¡®è®¤ç¦»å¼€",
              {
                confirmButtonText: "ç¡®å®š",
                cancelButtonText: "ç»§ç»­ç¼–è¾‘",
                type: "warning",
              }
            )
              .then(() => {
                if (window.parent !== window) {
                  window.parent.postMessage(
                    {
                      type: "navigate",
                      path: "declaration/list",
                    },
                    "*"
                  );
                } else {
                  window.location.href = "ç”³æŠ¥åˆ—è¡¨.html";
                }
              })
              .catch(() => {
                // ç”¨æˆ·å–æ¶ˆç¦»å¼€
              });
          };

          // ç”Ÿå‘½å‘¨æœŸ
          onMounted(() => {
            // é¡µé¢åˆå§‹åŒ–æ—¶ç¡®ä¿æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§æ•°æ®
            try {
              localStorage.removeItem("declaration_draft");
            } catch (error) {
              // å¿½ç•¥æ¸…ç†é”™è¯¯
            }
          });

          return {
            form,
            rules,
            submitting,
            formRef,
            tagInputRef,
            tagInputElementRef,
            tagInput,
            showSuggestions,
            suggestions,
            charCount,
            formErrors,
            formSuccess,
            uploadStatus,
            analysisResult,
            uploadProgress,
            departmentOptions,
            workflowOptions,
            filteredWorkflowOptions,
            selectedWorkflow,
            workflowSearchQuery,
            locale: zhCn,
            handleFileChange,
            handleFileUpload,
            analyzeDocument,
            reAnalyzeDocument,
            clearUploadedFile,
            addTag,
            removeTag,
            handleBackspace,
            handleTagInput,
            selectSuggestion,
            filterWorkflow,
            highlightText,
            validateForm,
            handleSubmit,
            handleBack,
          };
        },
      })
        .use(ElementPlus)
        .mount("#app");
    </script>
  </body>
</html>
