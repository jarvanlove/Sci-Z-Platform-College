<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>新建申报 - 高校科研项目管理平台</title>
    <link rel="icon" href="../images/favicon.ico" type="image/x-icon" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/element-plus@2.4.4/dist/index.css"
    />
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/element-plus@2.4.4"></script>
    <script src="https://unpkg.com/element-plus@2.4.4/dist/locale/zh-cn.min.js"></script>
    <link rel="stylesheet" href="../通用规范/样式.css" />
    <style>
      .new-declaration-container {
        padding: 20px;
        background: #f7f9fc;
        min-height: calc(100vh - 56px);
      }

      .page-header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
      }

      .back-button {
        margin-right: 12px;
      }

      .page-title {
        font-size: 24px;
        font-weight: 600;
        color: #1e3a8a;
        margin: 0;
      }

      .form-card {
        background: #ffffff;
        border-radius: 8px;
        padding: 24px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        border: 1px solid #e5e7eb;
        max-width: 800px;
        margin: 0 auto;
      }

      .form-group {
        margin-bottom: 40px;
        background: #ffffff;
        border-radius: 12px;
        padding: 32px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        border: 1px solid #f1f5f9;
      }

      .group-title {
        font-size: 18px;
        font-weight: 600;
        color: #1e3a8a;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 2px solid #e0e7ff;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .group-title::before {
        content: "";
        width: 4px;
        height: 20px;
        background: linear-gradient(135deg, #1e3a8a, #3b82f6);
        border-radius: 2px;
      }

      /* 表单项布局优化 */
      .form-row {
        display: flex;
        gap: 24px;
        margin-bottom: 28px;
        align-items: flex-start;
      }

      .form-row .form-item {
        flex: 1;
        min-width: 0;
      }

      .form-row.single {
        margin-bottom: 24px;
      }

      .form-row.single .form-item {
        flex: none;
        width: 100%;
      }

      /* 响应式布局 */
      @media (max-width: 768px) {
        .form-row {
          flex-direction: column;
          gap: 16px;
        }

        .form-row .form-item {
          flex: none;
          width: 100%;
        }
      }

      .form-item {
        margin-bottom: 24px;
      }

      .form-item:last-child {
        margin-bottom: 0;
      }

      /* Element Plus 表单项间距优化 */
      .el-form-item {
        margin-bottom: 24px !important;
      }

      .el-form-item__label {
        padding-bottom: 8px !important;
        font-weight: 500 !important;
        color: #374151 !important;
      }

      .el-form-item__content {
        line-height: 1.5 !important;
      }

      .rich-text-editor {
        min-height: 200px;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        padding: 12px;
      }

      .rich-text-editor:focus-within {
        border-color: #1e3a8a;
        box-shadow: 0 0 0 2px rgba(30, 58, 138, 0.1);
      }

      .toolbar {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e5e7eb;
      }

      .toolbar-button {
        padding: 6px 12px;
        border: 1px solid #e5e7eb;
        background: #ffffff;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
      }

      .toolbar-button:hover {
        background: #f8fafc;
        border-color: #1e3a8a;
      }

      .toolbar-button.active {
        background: #1e3a8a;
        color: #ffffff;
        border-color: #1e3a8a;
      }

      .editor-content {
        min-height: 120px;
        outline: none;
        font-size: 14px;
        line-height: 1.6;
        color: #374151;
      }

      .editor-content:empty:before {
        content: "请详细描述您的研究方向...";
        color: #9ca3af;
      }

      .char-count {
        text-align: right;
        font-size: 12px;
        color: #6b7280;
        margin-top: 8px;
      }

      .char-count.warning {
        color: #f59e0b;
      }

      .char-count.error {
        color: #dc2626;
      }

      .tag-input-container {
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        padding: 8px;
        min-height: 40px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }

      .tag-input-container:focus-within {
        border-color: #1e3a8a;
        box-shadow: 0 0 0 2px rgba(30, 58, 138, 0.1);
      }

      .tag-input {
        border: none;
        outline: none;
        flex: 1;
        min-width: 120px;
        font-size: 14px;
      }

      .tag-input::placeholder {
        color: #9ca3af;
      }

      .tag-item {
        background: #e0e7ff;
        color: #1e3a8a;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .tag-remove {
        cursor: pointer;
        color: #6b7280;
        font-weight: bold;
      }

      .tag-remove:hover {
        color: #dc2626;
      }

      .suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
      }

      .suggestion-item {
        padding: 8px 12px;
        cursor: pointer;
        font-size: 14px;
        color: #374151;
      }

      .suggestion-item:hover {
        background: #f8fafc;
      }

      .form-actions {
        display: flex;
        justify-content: center;
        gap: 16px;
        margin-top: 32px;
        padding-top: 24px;
        border-top: 1px solid #e5e7eb;
      }

      .auto-save-indicator {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        padding: 8px 12px;
        font-size: 12px;
        color: #6b7280;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        z-index: 1000;
      }

      .auto-save-indicator.saving {
        color: #f59e0b;
      }

      .auto-save-indicator.saved {
        color: #16a34a;
      }

      /* 文件上传样式 */
      .upload-area {
        border: 2px dashed #d1d5db;
        border-radius: 12px;
        padding: 32px;
        text-align: center;
        background: #fafbfc;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .upload-area:hover {
        border-color: #1e3a8a;
        background: #f8fafc;
      }

      .upload-area.dragover {
        border-color: #1e3a8a;
        background: #eff6ff;
      }

      .upload-icon {
        font-size: 48px;
        color: #9ca3af;
        margin-bottom: 16px;
      }

      .upload-text {
        font-size: 16px;
        color: #374151;
        margin-bottom: 8px;
      }

      .upload-hint {
        font-size: 14px;
        color: #6b7280;
      }

      .upload-progress {
        margin-top: 16px;
      }

      .upload-status {
        margin-top: 16px;
        padding: 12px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .upload-status.success {
        background: #f0fdf4;
        color: #166534;
        border: 1px solid #bbf7d0;
      }

      .upload-status.analyzing {
        background: #fffbeb;
        color: #92400e;
        border: 1px solid #fde68a;
      }

      .upload-status.error {
        background: #fef2f2;
        color: #dc2626;
        border: 1px solid #fecaca;
      }

      .file-info {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        background: #f8fafc;
        border-radius: 8px;
        margin-top: 12px;
      }

      .file-name {
        font-weight: 500;
        color: #374151;
      }

      .file-actions {
        display: flex;
        gap: 8px;
      }

      .analysis-result {
        margin-top: 16px;
        padding: 16px;
        background: #f0fdf4;
        border-radius: 8px;
        border: 1px solid #bbf7d0;
      }

      .analysis-title {
        font-weight: 600;
        color: #166534;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      /* 自动填充字段样式 - 保持默认样式 */

      .error-message {
        color: #dc2626;
        font-size: 12px;
        margin-top: 4px;
      }

      .success-icon {
        color: #16a34a;
        font-size: 12px;
        margin-top: 4px;
      }

      /* 自定义弹窗样式 */
      .el-message-box {
        border-radius: 12px !important;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12) !important;
      }

      .el-message-box__header {
        padding: 20px 24px 16px 24px !important;
        border-bottom: 1px solid #f0f0f0 !important;
        background: #ffffff !important;
      }

      .el-message-box__title {
        font-size: 16px !important;
        font-weight: 600 !important;
        color: #1e3a8a !important;
        line-height: 1.5 !important;
      }

      .el-message-box__headerbtn {
        top: 16px !important;
        right: 20px !important;
        width: 24px !important;
        height: 24px !important;
      }

      .el-message-box__close {
        color: #9ca3af !important;
        font-size: 16px !important;
      }

      .el-message-box__close:hover {
        color: #6b7280 !important;
      }

      .el-message-box__content {
        padding: 20px 24px !important;
        background: #ffffff !important;
      }

      .el-message-box__message {
        font-size: 14px !important;
        line-height: 1.6 !important;
        color: #374151 !important;
        margin: 0 !important;
        padding: 0 !important;
      }

      .el-message-box__btns {
        padding: 16px 24px 20px 24px !important;
        background: #ffffff !important;
        display: flex !important;
        justify-content: flex-end !important;
        gap: 12px !important;
      }

      .el-message-box__btns .el-button {
        padding: 8px 20px !important;
        border-radius: 8px !important;
        font-size: 14px !important;
        font-weight: 500 !important;
        border: 1px solid !important;
        transition: all 0.2s ease !important;
      }

      .el-message-box__btns .el-button--default {
        background: #ffffff !important;
        border-color: #d1d5db !important;
        color: #6b7280 !important;
      }

      .el-message-box__btns .el-button--default:hover {
        background: #f9fafb !important;
        border-color: #9ca3af !important;
        color: #374151 !important;
      }

      .el-message-box__btns .el-button--primary {
        background: #1e3a8a !important;
        border-color: #1e3a8a !important;
        color: #ffffff !important;
      }

      .el-message-box__btns .el-button--primary:hover {
        background: #1e40af !important;
        border-color: #1e40af !important;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
      }

      .el-message-box__btns .el-button--primary:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(30, 58, 138, 0.3);
      }

      /* 移除所有弹窗图标 */
      .el-message-box__status {
        display: none !important;
      }

      .el-message-box__message {
        margin-left: 0 !important;
        padding-left: 0 !important;
      }

      .el-message-box--warning .el-message-box__message::before {
        display: none !important;
      }

      /* 工作流选择样式 */
      .workflow-option {
        padding: 8px 0;
      }

      .workflow-name {
        font-size: 14px;
        font-weight: 500;
        color: #374151;
        line-height: 1.4;
      }

      .workflow-description {
        font-size: 12px;
        color: #6b7280;
        line-height: 1.3;
        margin-top: 2px;
      }

      .workflow-info {
        margin-top: 12px;
        padding: 16px;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
      }

      .workflow-info-title {
        font-size: 16px;
        font-weight: 600;
        color: #1e3a8a;
        margin-bottom: 8px;
      }

      .workflow-info-description {
        font-size: 14px;
        color: #64748b;
        line-height: 1.5;
      }

      /* 下拉框选项样式优化 */
      .el-select-dropdown__item {
        height: auto !important;
        padding: 8px 20px !important;
        line-height: normal !important;
      }

      /* 搜索框样式 */
      .el-select .el-input__inner {
        cursor: pointer;
      }

      .el-select .el-input.is-focus .el-input__inner {
        cursor: text;
      }

      /* 搜索结果高亮 */
      .workflow-option .highlight {
        background-color: #fef3c7;
        color: #92400e;
        padding: 0 2px;
        border-radius: 2px;
      }

      /* 无搜索结果时的样式 */
      .el-select-dropdown__empty {
        padding: 20px 0 !important;
        color: #9ca3af !important;
        text-align: center !important;
        font-size: 14px !important;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <el-config-provider :locale="locale">
        <div class="new-declaration-container">
          <!-- 页面标题和返回按钮 -->
          <div class="page-header">
            <el-button
              class="back-button"
              @click="handleBack"
              :icon="ArrowLeft"
            >
              返回列表
            </el-button>
            <h1 class="page-title">新建申报</h1>
          </div>

          <!-- 申报表单 -->
          <div class="form-card">
            <el-form
              :model="form"
              :rules="rules"
              ref="formRef"
              label-width="100px"
            >
              <!-- 红头文件上传 -->
              <div class="form-group">
                <div class="group-title">红头文件上传</div>

                <div
                  v-if="!form.documentFile"
                  class="upload-area"
                  @click="$refs.fileInput.click()"
                >
                  <div class="upload-icon">📁</div>
                  <div class="upload-text">点击上传红头文件</div>
                  <div class="upload-hint">
                    支持 PDF、Word、图片格式，文件大小不超过 10MB
                  </div>
                  <input
                    ref="fileInput"
                    type="file"
                    accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                    style="display: none"
                    @change="handleFileChange"
                  />
                </div>

                <div v-else>
                  <div class="file-info">
                    <span class="file-name">{{ form.documentFile.name }}</span>
                    <div class="file-actions">
                      <el-button
                        size="small"
                        @click="reAnalyzeDocument"
                        :disabled="uploadStatus === 'analyzing'"
                      >
                        重新分析
                      </el-button>
                      <el-button
                        size="small"
                        type="danger"
                        @click="clearUploadedFile"
                      >
                        删除
                      </el-button>
                    </div>
                  </div>

                  <!-- 上传进度 -->
                  <div
                    v-if="uploadStatus === 'uploading'"
                    class="upload-progress"
                  >
                    <el-progress
                      :percentage="uploadProgress"
                      :show-text="true"
                    />
                  </div>

                  <!-- 分析状态 -->
                  <div
                    v-if="uploadStatus === 'analyzing'"
                    class="upload-status analyzing"
                  >
                    <el-icon class="is-loading"><Loading /></el-icon>
                    正在分析文档内容，请稍候...
                  </div>

                  <div
                    v-if="uploadStatus === 'success'"
                    class="upload-status success"
                  >
                    <el-icon><Check /></el-icon>
                    文档分析完成，已自动填充相关字段
                  </div>

                  <div
                    v-if="uploadStatus === 'error'"
                    class="upload-status error"
                  >
                    <el-icon><Close /></el-icon>
                    文档分析失败，请重新上传或手动填写
                  </div>

                  <!-- 分析结果预览 -->
                  <div
                    v-if="analysisResult && uploadStatus === 'success'"
                    class="analysis-result"
                  >
                    <div class="analysis-title">
                      <el-icon><MagicStick /></el-icon>
                      AI 分析结果
                    </div>
                    <p>
                      <strong>研究方向：</strong>{{
                      analysisResult.researchDirection }}
                    </p>
                    <p>
                      <strong>研究课题：</strong>{{ analysisResult.researchTopic
                      }}
                    </p>
                    <div
                      style="margin-top: 8px; font-size: 12px; color: #6b7280"
                    >
                      💡 提示：AI 生成的内容仅供参考，您可以在下方表单中进行修改
                    </div>
                  </div>
                </div>
              </div>

              <!-- 基本信息 -->
              <div class="form-group">
                <div class="group-title">基本信息</div>

                <!-- 第一行：部门和负责人 -->
                <div class="form-row">
                  <div class="form-item">
                    <el-form-item label="课题发布部门" prop="department">
                      <el-select
                        v-model="form.department"
                        placeholder="请选择课题发布部门"
                        style="width: 100%"
                      >
                        <el-option
                          v-for="option in departmentOptions"
                          :key="option.value"
                          :label="option.label"
                          :value="option.value"
                        />
                      </el-select>
                    </el-form-item>
                  </div>

                  <div class="form-item">
                    <el-form-item label="项目负责人" prop="projectLeader">
                      <el-input
                        v-model="form.projectLeader"
                        placeholder="请输入项目负责人姓名"
                      />
                    </el-form-item>
                  </div>
                </div>

                <!-- 第二行：红头文件发布时间 -->
                <div class="form-row">
                  <div class="form-item">
                    <el-form-item
                      label="红头文件发布时间"
                      prop="documentPublishTime"
                    >
                      <el-date-picker
                        v-model="form.documentPublishTime"
                        type="date"
                        placeholder="请选择红头文件发布时间"
                        style="width: 100%"
                        format="YYYY年MM月DD日"
                        value-format="YYYY-MM-DD"
                      />
                    </el-form-item>
                  </div>
                  <div class="form-item"></div>
                </div>

                <!-- 第三行：项目时间 -->
                <div class="form-row">
                  <div class="form-item">
                    <el-form-item label="项目开始时间" prop="projectStartTime">
                      <el-date-picker
                        v-model="form.projectStartTime"
                        type="date"
                        placeholder="请选择项目开始时间"
                        style="width: 100%"
                        format="YYYY年MM月DD日"
                        value-format="YYYY-MM-DD"
                      />
                    </el-form-item>
                  </div>

                  <div class="form-item">
                    <el-form-item label="项目结束时间" prop="projectEndTime">
                      <el-date-picker
                        v-model="form.projectEndTime"
                        type="date"
                        placeholder="请选择项目结束时间"
                        style="width: 100%"
                        format="YYYY年MM月DD日"
                        value-format="YYYY-MM-DD"
                      />
                    </el-form-item>
                  </div>
                </div>
              </div>

              <!-- 研究信息 -->
              <div class="form-group">
                <div class="group-title">研究信息</div>

                <div class="form-row single">
                  <el-form-item
                    label="研究方向"
                    prop="researchDirection"
                    class="form-item"
                  >
                    <el-input
                      v-model="form.researchDirection"
                      type="textarea"
                      :rows="4"
                      placeholder="请根据红头文件方向自行填写研究方向，或等待AI自动分析填充"
                    />
                    <div
                      v-if="analysisResult && uploadStatus === 'success'"
                      style="margin-top: 4px; font-size: 12px; color: #16a34a"
                    >
                      ✨ 此字段已由AI自动填充，您可以根据需要进行修改
                    </div>
                  </el-form-item>
                </div>

                <div class="form-row single">
                  <el-form-item
                    label="研究课题"
                    prop="researchTopic"
                    class="form-item"
                  >
                    <el-input
                      v-model="form.researchTopic"
                      type="textarea"
                      :rows="3"
                      placeholder="请输入具体的研究课题，或等待AI自动分析填充"
                    />
                    <div
                      v-if="analysisResult && uploadStatus === 'success'"
                      style="margin-top: 4px; font-size: 12px; color: #16a34a"
                    >
                      ✨ 此字段已由AI自动填充，您可以根据需要进行修改
                    </div>
                  </el-form-item>
                </div>
              </div>

              <!-- 研究领域 -->
              <div class="form-group">
                <div class="group-title">
                  研究领域 <span style="color: #dc2626">*</span>
                </div>
                <div class="form-item">
                  <div class="tag-input-container" ref="tagInputRef">
                    <div
                      v-for="(tag, index) in form.researchField"
                      :key="index"
                      class="tag-item"
                    >
                      {{ tag }}
                      <span class="tag-remove" @click="removeTag(index)">
                        ×
                      </span>
                    </div>
                    <input
                      v-model="tagInput"
                      class="tag-input"
                      placeholder="请输入研究领域，回车添加"
                      @keydown.enter="addTag"
                      @keydown.backspace="handleBackspace"
                      @input="handleTagInput"
                      ref="tagInputElementRef"
                    />
                    <div
                      v-if="showSuggestions && suggestions.length > 0"
                      class="suggestions"
                    >
                      <div
                        v-for="suggestion in suggestions"
                        :key="suggestion"
                        class="suggestion-item"
                        @click="selectSuggestion(suggestion)"
                      >
                        {{ suggestion }}
                      </div>
                    </div>
                  </div>
                  <div style="margin-top: 8px; font-size: 12px; color: #6b7280">
                    已选择 {{ form.researchField.length }} / 10 个领域
                  </div>
                  <div v-if="formErrors.researchField" class="error-message">
                    {{ formErrors.researchField }}
                  </div>
                  <div v-if="formSuccess.researchField" class="success-icon">
                    ✓ 研究领域选择完成
                  </div>
                </div>
              </div>

              <!-- 工作流选择 -->
              <div class="form-group">
                <div class="group-title">
                  工作流 <span style="color: #dc2626">*</span>
                </div>
                <div class="form-item">
                  <el-form-item label="选择工作流" prop="workflow">
                    <el-select
                      v-model="form.workflow"
                      placeholder="请选择工作流"
                      style="width: 100%"
                      filterable
                      :filter-method="filterWorkflow"
                      no-match-text="未找到匹配的工作流"
                      no-data-text="暂无工作流数据"
                    >
                      <el-option
                        v-for="workflow in filteredWorkflowOptions"
                        :key="workflow.id"
                        :label="workflow.name"
                        :value="workflow.id"
                      >
                        <div class="workflow-option">
                          <div
                            class="workflow-name"
                            v-html="highlightText(workflow.name, workflowSearchQuery)"
                          ></div>
                          <div
                            class="workflow-description"
                            v-html="highlightText(workflow.description, workflowSearchQuery)"
                          ></div>
                        </div>
                      </el-option>
                    </el-select>
                  </el-form-item>
                  <div v-if="selectedWorkflow" class="workflow-info">
                    <div class="workflow-info-title">
                      {{ selectedWorkflow.name }}
                    </div>
                    <div class="workflow-info-description">
                      {{ selectedWorkflow.description }}
                    </div>
                  </div>
                </div>
              </div>

              <!-- 表单操作按钮 -->
              <div class="form-actions">
                <el-button
                  type="primary"
                  size="large"
                  :loading="submitting"
                  @click="handleSubmit"
                >
                  <el-icon><Check /></el-icon>
                  {{ submitting ? "提交中..." : "提交申报" }}
                </el-button>
                <el-button size="large" @click="handleBack">
                  <el-icon><Close /></el-icon>
                  取消
                </el-button>
              </div>
            </el-form>
          </div>

          <!-- 自动保存指示器 -->
          <div
            v-if="autoSaveStatus !== 'idle'"
            class="auto-save-indicator"
            :class="autoSaveStatus"
          >
            <span v-if="autoSaveStatus === 'saving'">
              <el-icon><Loading /></el-icon>
              正在保存草稿...
            </span>
            <span v-if="autoSaveStatus === 'saved'">
              <el-icon><Check /></el-icon>
              草稿已保存
            </span>
          </div>
        </div>
      </el-config-provider>
    </div>

    <script>
      const { createApp, ref, reactive, computed, onMounted, onUnmounted } =
        Vue;
      const { ElMessage, ElMessageBox, ElConfigProvider } = ElementPlus;
      const zhCn = ElementPlusLocaleZhCn;

      createApp({
        setup() {
          // 表单数据
          const form = reactive({
            documentFile: null, // 红头文件
            department: "", // 课题发布部门
            projectLeader: "", // 项目负责人
            documentPublishTime: "", // 红头文件发布时间
            projectStartTime: "", // 项目开始时间
            projectEndTime: "", // 项目结束时间
            researchDirection: "", // 研究方向
            researchField: [], // 研究领域
            researchTopic: "", // 研究课题
            workflow: "", // 工作流
          });

          // 表单验证规则
          const rules = {
            department: [
              {
                required: true,
                message: "请选择课题发布部门",
                trigger: "change",
              },
            ],
            projectLeader: [
              {
                required: true,
                message: "项目负责人不能为空",
                trigger: "blur",
              },
            ],
            documentPublishTime: [
              {
                required: true,
                message: "请选择红头文件发布时间",
                trigger: "change",
              },
            ],
            projectStartTime: [
              {
                required: true,
                message: "请选择项目开始时间",
                trigger: "change",
              },
            ],
            projectEndTime: [
              {
                required: true,
                message: "请选择项目结束时间",
                trigger: "change",
              },
            ],
            researchDirection: [
              {
                required: true,
                message: "研究方向不能为空",
                trigger: "change",
              },
            ],
            researchField: [
              {
                required: true,
                message: "请至少选择一个研究领域",
                trigger: "submit",
              },
            ],
            researchTopic: [
              {
                required: true,
                message: "研究课题不能为空",
                trigger: "change",
              },
            ],
            workflow: [
              {
                required: true,
                message: "请选择工作流",
                trigger: "change",
              },
            ],
          };

          // 状态管理
          const submitting = ref(false);
          const formRef = ref();
          const editorRef = ref();
          const editorContentRef = ref();
          const tagInputRef = ref();
          const tagInputElementRef = ref();

          // 编辑器状态
          const editorState = reactive({
            bold: false,
            italic: false,
            underline: false,
          });

          // 标签输入
          const tagInput = ref("");
          const showSuggestions = ref(false);
          const suggestions = ref([]);

          // 课题发布部门选项
          const departmentOptions = [
            { label: "国自然-青年基金", value: "国自然-青年基金" },
            { label: "国自然-面上基金", value: "国自然-面上基金" },
            { label: "国自然-地区项目", value: "国自然-地区项目" },
            { label: "省市级项目", value: "省市级项目" },
            { label: "其他", value: "其他" },
          ];

          // 工作流选项
          const workflowOptions = [
            {
              id: "workflow_001",
              name: "科研项目申报审核流程",
              description:
                "适用于科研项目的标准申报审核，包含初审、专家评审、终审等环节",
            },
            {
              id: "workflow_002",
              name: "快速申报流程",
              description: "简化的申报流程，适用于小型项目或紧急项目的快速审批",
            },
            {
              id: "workflow_003",
              name: "重点项目专项流程",
              description:
                "针对重点科研项目的专项审核流程，包含多轮专家评审和答辩环节",
            },
            {
              id: "workflow_004",
              name: "产学研合作项目流程",
              description:
                "专门用于产学研合作项目的审核流程，涉及企业参与和成果转化评估",
            },
          ];

          // 预设研究领域
          const presetFields = [
            "人工智能",
            "机器学习",
            "深度学习",
            "自然语言处理",
            "计算机视觉",
            "数据挖掘",
            "区块链",
            "物联网",
            "网络安全",
            "云计算",
            "大数据",
            "生物信息学",
            "医学影像",
            "材料科学",
            "数学",
            "物理",
            "化学",
            "生物学",
            "心理学",
            "经济学",
            "管理学",
            "教育学",
          ];

          // 字符计数（保留以防需要）
          const charCount = computed(() => {
            return form.researchDirection ? form.researchDirection.length : 0;
          });

          // 选中的工作流
          const selectedWorkflow = computed(() => {
            return workflowOptions.find(
              (workflow) => workflow.id === form.workflow
            );
          });

          // 工作流搜索
          const workflowSearchQuery = ref("");
          const filteredWorkflowOptions = ref([...workflowOptions]);

          // 工作流过滤方法
          const filterWorkflow = (query) => {
            workflowSearchQuery.value = query;
            if (!query) {
              filteredWorkflowOptions.value = [...workflowOptions];
              return;
            }

            const lowerQuery = query.toLowerCase();
            filteredWorkflowOptions.value = workflowOptions.filter(
              (workflow) => {
                return (
                  workflow.name.toLowerCase().includes(lowerQuery) ||
                  workflow.description.toLowerCase().includes(lowerQuery)
                );
              }
            );
          };

          // 文本高亮方法
          const highlightText = (text, query) => {
            if (!query || !text) return text;

            const regex = new RegExp(`(${query})`, "gi");
            return text.replace(regex, '<span class="highlight">$1</span>');
          };

          // 表单验证状态
          const formErrors = reactive({
            department: "",
            projectLeader: "",
            documentPublishTime: "",
            projectStartTime: "",
            projectEndTime: "",
            researchDirection: "",
            researchField: "",
            researchTopic: "",
            workflow: "",
          });

          const formSuccess = reactive({
            department: false,
            projectLeader: false,
            documentPublishTime: false,
            projectStartTime: false,
            projectEndTime: false,
            researchDirection: false,
            researchField: false,
            researchTopic: false,
            workflow: false,
          });

          // 文件上传状态
          const uploadStatus = ref("idle"); // idle, uploading, analyzing, success, error
          const analysisResult = ref(null);
          const uploadProgress = ref(0);

          // 自动保存
          const autoSaveStatus = ref("idle");
          let autoSaveTimer = null;

          // 文件上传处理
          const handleFileUpload = async (file) => {
            try {
              uploadStatus.value = "uploading";
              uploadProgress.value = 0;

              // 模拟文件上传进度
              const uploadInterval = setInterval(() => {
                uploadProgress.value += 10;
                if (uploadProgress.value >= 100) {
                  clearInterval(uploadInterval);
                  uploadStatus.value = "analyzing";
                  analyzeDocument(file);
                }
              }, 200);

              form.documentFile = file;
              return false; // 阻止默认上传行为
            } catch (error) {
              uploadStatus.value = "error";
              ElMessage.error("文件上传失败，请重试");
              return false;
            }
          };

          // 文档分析处理
          const analyzeDocument = async (file) => {
            try {
              // 模拟AI分析过程
              await new Promise((resolve) => setTimeout(resolve, 3000));

              // 模拟分析结果
              const mockResult = {
                researchDirection:
                  "基于深度学习的智能制造关键技术研究，重点围绕工业互联网、智能传感器、机器视觉等核心技术，推动制造业数字化转型升级。",
                researchTopic: "面向智能制造的多模态数据融合与决策优化技术研究",
              };

              analysisResult.value = mockResult;

              // 自动填充表单
              form.researchDirection = mockResult.researchDirection;
              form.researchTopic = mockResult.researchTopic;

              uploadStatus.value = "success";
              ElMessage.success("红头文件分析完成，已自动填充相关字段");
            } catch (error) {
              uploadStatus.value = "error";
              ElMessage.error("文档分析失败，请重试");
            }
          };

          // 重新分析文档
          const reAnalyzeDocument = () => {
            if (form.documentFile) {
              uploadStatus.value = "analyzing";
              analyzeDocument(form.documentFile);
            }
          };

          // 清除上传的文件
          const clearUploadedFile = () => {
            form.documentFile = null;
            analysisResult.value = null;
            uploadStatus.value = "idle";
            uploadProgress.value = 0;
          };

          // 文件选择处理
          const handleFileChange = (event) => {
            const file = event.target.files[0];
            if (file) {
              // 文件大小检查 (10MB)
              if (file.size > 10 * 1024 * 1024) {
                ElMessage.error("文件大小不能超过 10MB");
                return;
              }

              // 文件类型检查
              const allowedTypes = [
                "application/pdf",
                "application/msword",
                "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                "image/jpeg",
                "image/jpg",
                "image/png",
              ];

              if (!allowedTypes.includes(file.type)) {
                ElMessage.error(
                  "不支持的文件格式，请上传 PDF、Word 或图片文件"
                );
                return;
              }

              handleFileUpload(file);
            }
          };

          // 表单验证函数
          const validateForm = () => {
            return formRef.value.validate();
          };

          // 标签功能
          const addTag = (e) => {
            e.preventDefault();
            const value = tagInput.value.trim();
            if (
              value &&
              !form.researchField.includes(value) &&
              form.researchField.length < 10
            ) {
              form.researchField.push(value);
              tagInput.value = "";
              triggerAutoSave();
            }
          };

          const removeTag = (index) => {
            form.researchField.splice(index, 1);
            triggerAutoSave();
          };

          const handleBackspace = () => {
            if (tagInput.value === "" && form.researchField.length > 0) {
              form.researchField.pop();
              triggerAutoSave();
            }
          };

          const handleTagInput = () => {
            const value = tagInput.value.toLowerCase();
            if (value) {
              suggestions.value = presetFields.filter(
                (field) =>
                  field.toLowerCase().includes(value) &&
                  !form.researchField.includes(field)
              );
              showSuggestions.value = suggestions.value.length > 0;
            } else {
              showSuggestions.value = false;
            }
          };

          const selectSuggestion = (suggestion) => {
            if (
              !form.researchField.includes(suggestion) &&
              form.researchField.length < 10
            ) {
              form.researchField.push(suggestion);
              tagInput.value = "";
              showSuggestions.value = false;
              triggerAutoSave();
            }
          };

          // 自动保存
          const triggerAutoSave = () => {
            if (autoSaveTimer) {
              clearTimeout(autoSaveTimer);
            }
            autoSaveTimer = setTimeout(() => {
              saveDraft();
            }, 30000); // 30秒后自动保存
          };

          const saveDraft = async () => {
            try {
              autoSaveStatus.value = "saving";
              // 模拟保存草稿
              await new Promise((resolve) => setTimeout(resolve, 1000));
              localStorage.setItem("declaration_draft", JSON.stringify(form));
              autoSaveStatus.value = "saved";
              setTimeout(() => {
                autoSaveStatus.value = "idle";
              }, 2000);
            } catch (error) {
              console.error("保存草稿失败:", error);
              autoSaveStatus.value = "idle";
            }
          };

          // 事件处理
          const handleSubmit = async () => {
            try {
              await validateForm();
            } catch (error) {
              ElMessage.error("请完善申报信息");
              return;
            }

            try {
              await ElMessageBox.confirm(
                "确定要提交此申报吗？提交后将触发Dify工作流处理。",
                "确认提交",
                {
                  confirmButtonText: "确定",
                  cancelButtonText: "取消",
                }
              );

              submitting.value = true;

              // 模拟提交申报
              await new Promise((resolve) => setTimeout(resolve, 2000));

              ElMessage.success("申报提交成功！正在处理中...");

              // 清除草稿
              clearDraft();

              // 跳转到申报详情页面
              setTimeout(() => {
                if (window.parent !== window) {
                  window.parent.postMessage(
                    {
                      type: "navigate",
                      path: "declaration/detail",
                    },
                    "*"
                  );
                } else {
                  window.location.href = "申报详情.html";
                }
              }, 1000);
            } catch (error) {
              if (error !== "cancel") {
                ElMessage.error("提交失败，请重试");
              }
            } finally {
              submitting.value = false;
            }
          };

          const handleBack = () => {
            ElMessageBox.confirm(
              "确定要离开吗？未保存的内容将丢失。",
              "确认离开",
              {
                confirmButtonText: "确定",
                cancelButtonText: "继续编辑",
                type: "warning",
              }
            )
              .then(() => {
                if (window.parent !== window) {
                  window.parent.postMessage(
                    {
                      type: "navigate",
                      path: "declaration/list",
                    },
                    "*"
                  );
                } else {
                  window.location.href = "申报列表.html";
                }
              })
              .catch(() => {
                // 用户取消离开
              });
          };

          // 清理草稿
          const clearDraft = () => {
            try {
              localStorage.removeItem("declaration_draft");
              // 清空表单
              Object.keys(form).forEach((key) => {
                if (Array.isArray(form[key])) {
                  form[key] = [];
                } else {
                  form[key] = "";
                }
              });
              // 清空验证状态
              Object.keys(formErrors).forEach((key) => {
                formErrors[key] = "";
              });
              Object.keys(formSuccess).forEach((key) => {
                formSuccess[key] = false;
              });
            } catch (error) {
              console.error("清理草稿失败:", error);
            }
          };

          // 加载草稿
          const loadDraft = () => {
            try {
              const draft = localStorage.getItem("declaration_draft");
              if (draft) {
                const draftData = JSON.parse(draft);
                // 加载所有表单字段
                Object.keys(form).forEach((key) => {
                  if (draftData[key] !== undefined) {
                    form[key] = draftData[key];
                  }
                });
                ElMessage.info("已加载草稿内容");
              }
            } catch (error) {
              console.error("加载草稿失败:", error);
            }
          };

          // 生命周期
          onMounted(() => {
            loadDraft();
            triggerAutoSave();
          });

          onUnmounted(() => {
            if (autoSaveTimer) {
              clearTimeout(autoSaveTimer);
            }
          });

          return {
            form,
            rules,
            submitting,
            formRef,
            tagInputRef,
            tagInputElementRef,
            tagInput,
            showSuggestions,
            suggestions,
            charCount,
            formErrors,
            formSuccess,
            autoSaveStatus,
            uploadStatus,
            analysisResult,
            uploadProgress,
            departmentOptions,
            workflowOptions,
            filteredWorkflowOptions,
            selectedWorkflow,
            workflowSearchQuery,
            locale: zhCn,
            handleFileChange,
            handleFileUpload,
            analyzeDocument,
            reAnalyzeDocument,
            clearUploadedFile,
            addTag,
            removeTag,
            handleBackspace,
            handleTagInput,
            selectSuggestion,
            filterWorkflow,
            highlightText,
            validateForm,
            handleSubmit,
            handleBack,
            clearDraft,
          };
        },
      })
        .use(ElementPlus)
        .mount("#app");
    </script>
  </body>
</html>
