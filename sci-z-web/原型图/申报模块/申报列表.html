<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>ç”³æŠ¥åˆ—è¡¨ - é«˜æ ¡ç§‘ç ”é¡¹ç›®ç®¡ç†å¹³å°</title>
    <link rel="icon" href="../images/favicon.ico" type="image/x-icon" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/element-plus@2.3.14/dist/index.css"
    />
    <script src="https://unpkg.com/vue@3.2.47/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/element-plus@2.3.14"></script>
    <link rel="stylesheet" href="../é€šç”¨è§„èŒƒ/æ ·å¼.css" />
    <style>
      .declaration-list-container {
        padding: 20px;
        background: #f7f9fc;
        min-height: calc(100vh - 56px);
      }

      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .page-title {
        font-size: 24px;
        font-weight: 600;
        color: #1e3a8a;
        margin: 0;
      }

      .search-card {
        background: #ffffff;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        border: 1px solid #e5e7eb;
      }

      .search-form {
        display: flex;
        gap: 16px;
        align-items: end;
      }

      .search-form .el-form-item {
        margin-bottom: 0;
      }

      .table-card {
        background: #ffffff;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        border: 1px solid #e5e7eb;
      }

      .status-tag {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
      }

      .status-submitting {
        background-color: #fef3c7;
        color: #f59e0b;
      }

      .status-success {
        background-color: #dcfce7;
        color: #16a34a;
      }

      .status-failed {
        background-color: #fee2e2;
        color: #dc2626;
      }

      .operation-buttons {
        display: flex;
        gap: 8px;
      }

      .operation-buttons .el-button {
        padding: 4px 8px;
        font-size: 12px;
      }

      /* ä¸‹æ‹‰èœå•æ ·å¼ */
      .operation-buttons .el-dropdown {
        margin-right: 8px;
      }

      .operation-buttons .el-dropdown .el-button {
        padding: 4px 8px;
        font-size: 12px;
      }

      /* é¢„è§ˆå¯¹è¯æ¡†æ ·å¼ */
      .preview-dialog {
        width: 600px;
      }

      .preview-dialog .el-message-box__message {
        white-space: pre-line;
        line-height: 1.6;
      }

      /* çŠ¶æ€ä¸‹æ‹‰æ¡†æ ·å¼ */
      .status-dropdown {
        width: 100%;
        display: flex;
        justify-content: center;
      }

      .status-clickable {
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        transition: all 0.2s ease;
        position: relative;
      }

      .status-clickable:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .status-arrow {
        font-size: 12px;
        opacity: 0.6;
        transition: transform 0.2s ease;
      }

      .status-clickable:hover .status-arrow {
        opacity: 1;
        transform: translateY(1px);
      }

      /* çŠ¶æ€ä¸‹æ‹‰èœå•æ ·å¼ */
      .status-dropdown-menu {
        min-width: 120px;
        padding: 8px 0;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        border: 1px solid #e5e7eb;
      }

      .status-dropdown-menu .el-dropdown-menu__item {
        padding: 8px 16px;
        line-height: 1.4;
        transition: background-color 0.2s ease;
      }

      .status-dropdown-menu .el-dropdown-menu__item:hover {
        background-color: #f8fafc;
      }

      .status-dropdown-menu .el-dropdown-menu__item.is-disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .status-dropdown-menu .el-dropdown-menu__item.is-disabled:hover {
        background-color: transparent;
      }

      .status-dropdown-menu .status-tag {
        width: 100%;
        text-align: center;
        display: block;
        margin: 0;
      }

      /* ç®€æ´ç¡®è®¤å¯¹è¯æ¡†æ ·å¼ */
      .modern-confirm-dialog {
        border-radius: 8px !important;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
        border: none !important;
        width: 400px !important;
        z-index: 9999 !important;
      }

      .modern-confirm-dialog .el-overlay {
        z-index: 9998 !important;
      }

      .modern-confirm-dialog .el-message-box__header {
        background: white !important;
        color: #333 !important;
        padding: 20px 24px 16px 24px !important;
        border-bottom: 1px solid #f0f0f0 !important;
      }

      .modern-confirm-dialog .el-message-box__title {
        color: #1e3a8a !important;
        font-size: 16px !important;
        font-weight: 600 !important;
      }

      .modern-confirm-dialog .el-message-box__headerbtn {
        top: 16px !important;
        right: 20px !important;
        width: 24px !important;
        height: 24px !important;
      }

      .modern-confirm-dialog .el-message-box__close {
        color: #999 !important;
        font-size: 16px !important;
      }

      .modern-confirm-dialog .el-message-box__close:hover {
        color: #666 !important;
      }

      .modern-confirm-dialog .el-message-box__content {
        padding: 20px 24px !important;
        background: white !important;
      }

      .modern-confirm-dialog .el-message-box__message {
        font-size: 14px !important;
        line-height: 1.5 !important;
        color: #666 !important;
        margin: 0 !important;
        display: flex !important;
        align-items: center !important;
      }

      .modern-confirm-dialog .el-message-box__message::before {
        content: "" !important;
        font-size: 16px !important;
        margin-right: 8px !important;
        flex-shrink: 0 !important;
      }

      .modern-confirm-dialog .el-message-box__btns {
        padding: 16px 24px 20px 24px !important;
        background: white !important;
        display: flex !important;
        justify-content: flex-end !important;
        gap: 12px !important;
      }

      .modern-confirm-dialog .el-message-box__btns .el-button {
        padding: 8px 20px !important;
        border-radius: 4px !important;
        font-size: 14px !important;
        font-weight: 400 !important;
        border: 1px solid !important;
        transition: all 0.2s ease !important;
        min-width: 80px !important;
      }

      .modern-confirm-dialog .el-message-box__btns .el-button--default {
        background: white !important;
        border-color: #d9d9d9 !important;
        color: #333 !important;
      }

      .modern-confirm-dialog .el-message-box__btns .el-button--default:hover {
        background: #f5f5f5 !important;
        border-color: #b3b3b3 !important;
        color: #333 !important;
      }

      .modern-confirm-dialog .el-message-box__btns .el-button--primary {
        background: #1e3a8a !important;
        border-color: #1e3a8a !important;
        color: white !important;
      }

      .modern-confirm-dialog .el-message-box__btns .el-button--primary:hover {
        background: #1e40af !important;
        border-color: #1e40af !important;
      }

      /* çŠ¶æ€é€‰æ‹©å™¨ä¸‹æ‹‰é€‰é¡¹æ ·å¼ */
      .el-select-dropdown .el-select-dropdown__item {
        padding: 8px 16px !important;
      }

      .el-select-dropdown .el-select-dropdown__item .status-tag {
        width: 100%;
        text-align: center;
        display: block;
      }

      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #6b7280;
      }

      .empty-state-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
      }

      .empty-state-text {
        font-size: 16px;
        margin-bottom: 8px;
      }

      .empty-state-hint {
        font-size: 14px;
        color: #9ca3af;
      }

      /* åŠ è½½çŠ¶æ€æ ·å¼ */
      .loading-container {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px;
        color: #6b7280;
        font-size: 14px;
      }

      .loading-container .el-icon {
        margin-right: 8px;
        font-size: 16px;
      }

      /* åŸç”ŸHTMLè¡¨æ ¼æ ·å¼ */
      .table-wrapper {
        overflow-x: auto;
        min-width: 100%;
      }

      .native-table {
        width: 100%;
        min-width: 1200px; /* è®¾ç½®æœ€å°å®½åº¦ç¡®ä¿æ‰€æœ‰åˆ—æ­£å¸¸æ˜¾ç¤º */
        border-collapse: collapse;
        font-size: 14px;
        color: #374151;
        background-color: #ffffff;
        border: 1px solid #e5e7eb;
        table-layout: fixed; /* å›ºå®šè¡¨æ ¼å¸ƒå±€ */
      }

      /* è¡¨å¤´æ ·å¼ */
      .native-table thead th {
        background-color: #f5f5f5;
        color: #374151;
        font-weight: 600;
        padding: 12px 8px;
        border-right: 1px solid #e5e7eb;
        border-bottom: 1px solid #e5e7eb;
        text-align: left;
        white-space: nowrap;
      }

      /* è¡¨æ ¼å†…å®¹æ ·å¼ */
      .native-table tbody td {
        padding: 12px 8px;
        border-right: 1px solid #e5e7eb;
        border-bottom: 1px solid #e5e7eb;
        vertical-align: top;
        word-wrap: break-word;
        word-break: break-all;
      }

      /* æ–‘é©¬çº¹æ•ˆæœ */
      .native-table tbody tr:nth-child(even) {
        background-color: #f9fafb;
      }

      /* æ‚¬åœæ•ˆæœ */
      .native-table tbody tr:hover {
        background-color: #f3f4f6;
      }

      /* åˆ—å®½åº¦è®¾ç½® - ä½¿ç”¨ç™¾åˆ†æ¯”å’Œæœ€å°å®½åº¦ */
      .native-table .col-number {
        width: 12%;
        min-width: 110px;
      }

      .native-table .col-applicant {
        width: 8%;
        min-width: 80px;
        text-align: center;
      }

      .native-table .col-time {
        width: 10%;
        min-width: 100px;
        text-align: center;
      }

      .native-table .col-direction {
        width: 20%;
        min-width: 180px;
      }

      .native-table .col-fields {
        width: 15%;
        min-width: 120px;
        line-height: 1.4;
      }

      .native-table .col-fields .el-tag {
        margin-right: 4px !important;
        margin-bottom: 4px !important;
        display: inline-block;
      }

      .native-table .col-topic {
        width: 20%;
        min-width: 160px;
        line-height: 1.4;
        word-break: break-word;
        white-space: normal;
      }

      .native-table .col-status {
        width: 8%;
        min-width: 80px;
        text-align: center;
      }

      .native-table .col-actions {
        width: 12%;
        min-width: 180px;
        text-align: center;
      }

      .operation-buttons {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
        gap: 4px;
        line-height: 1.2;
      }

      .operation-buttons .el-button {
        margin: 0 !important;
        padding: 4px 8px !important;
        font-size: 12px !important;
        height: auto !important;
        min-height: 24px !important;
      }

      /* æœ€åä¸€åˆ—ä¸æ˜¾ç¤ºå³è¾¹æ¡† */
      .native-table thead th:last-child,
      .native-table tbody td:last-child {
        border-right: none;
      }

      /* å“åº”å¼è®¾è®¡ */
      @media (max-width: 1400px) {
        .native-table {
          min-width: 1100px;
        }

        .native-table .col-direction {
          width: 18%;
          min-width: 160px;
        }

        .native-table .col-topic {
          width: 18%;
          min-width: 140px;
        }
      }

      @media (max-width: 1200px) {
        .native-table {
          min-width: 1000px;
        }

        .native-table .col-direction {
          width: 15%;
          min-width: 140px;
        }

        .native-table .col-topic {
          width: 15%;
          min-width: 120px;
        }

        .native-table .col-fields {
          width: 13%;
          min-width: 100px;
        }

        .native-table .col-actions {
          width: 13%;
          min-width: 160px;
        }
      }

      /* ç¡®ä¿è¡¨æ ¼åœ¨å°å±å¹•ä¸Šå¯ä»¥æ°´å¹³æ»šåŠ¨ */
      @media (max-width: 768px) {
        .table-wrapper {
          overflow-x: scroll;
          -webkit-overflow-scrolling: touch;
        }

        .native-table {
          min-width: 900px;
        }

        .native-table .col-actions {
          min-width: 140px;
        }

        .operation-buttons .el-button {
          font-size: 11px !important;
          padding: 2px 6px !important;
        }
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="declaration-list-container">
        <!-- é¡µé¢æ ‡é¢˜å’Œæ“ä½œ -->
        <div class="page-header">
          <h1 class="page-title">ç”³æŠ¥ç®¡ç†</h1>
          <el-button type="primary" size="large" @click="handleNewDeclaration">
            <el-icon><Plus /></el-icon>
            æ–°å»ºç”³æŠ¥
          </el-button>
        </div>

        <!-- æœç´¢ç­›é€‰åŒºåŸŸ -->
        <div class="search-card">
          <el-form :model="searchForm" class="search-form" label-width="100px">
            <el-form-item label="å…³é”®è¯æœç´¢">
              <el-input
                v-model="searchForm.keyword"
                placeholder="è¯·è¾“å…¥ç ”ç©¶æ–¹å‘æˆ–ç ”ç©¶é¢†åŸŸå…³é”®è¯"
                clearable
                style="width: 300px"
                @keyup.enter="handleSearch"
              >
                <template #prefix>
                  <el-icon><Search /></el-icon>
                </template>
              </el-input>
            </el-form-item>
            <el-form-item label="çŠ¶æ€ç­›é€‰">
              <el-select
                v-model="searchForm.status"
                placeholder="è¯·é€‰æ‹©çŠ¶æ€"
                clearable
                style="width: 150px"
                @change="handleStatusChange"
              >
                <el-option
                  v-for="option in statusOptions"
                  :key="option.value"
                  :label="option.label"
                  :value="option.value"
                />
              </el-select>
            </el-form-item>
            <el-form-item>
              <el-button type="primary" @click="handleSearch">
                <el-icon><Search /></el-icon>
                æœç´¢
              </el-button>
              <el-button @click="handleReset">
                <el-icon><Refresh /></el-icon>
                é‡ç½®
              </el-button>
            </el-form-item>
          </el-form>
        </div>

        <!-- ç”³æŠ¥åˆ—è¡¨è¡¨æ ¼ -->
        <div class="table-card">
          <!-- åŠ è½½çŠ¶æ€ -->
          <div v-if="loading" class="loading-container">
            <el-icon class="is-loading"><Loading /></el-icon>
            <span>åŠ è½½ä¸­...</span>
          </div>

          <!-- åŸç”ŸHTMLè¡¨æ ¼ -->
          <div v-else class="table-wrapper">
            <table class="native-table">
              <thead>
                <tr>
                  <th class="col-number">ç”³æŠ¥ç¼–å·</th>
                  <th class="col-applicant">ç”³æŠ¥äºº</th>
                  <th class="col-time">ç”³æŠ¥æ—¶é—´</th>
                  <th class="col-direction">ç ”ç©¶æ–¹å‘</th>
                  <th class="col-fields">ç ”ç©¶é¢†åŸŸ</th>
                  <th class="col-topic">ç ”ç©¶è¯¾é¢˜</th>
                  <th class="col-status">çŠ¶æ€</th>
                  <th class="col-actions">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="declaration in declarations" :key="declaration.id">
                  <td class="col-number">{{ declaration.number }}</td>
                  <td class="col-applicant">{{ declaration.applicant }}</td>
                  <td class="col-time">{{ declaration.submitTime }}</td>
                  <td class="col-direction">{{ declaration.direction }}</td>
                  <td class="col-fields">
                    <el-tag
                      v-for="field in declaration.fields"
                      :key="field"
                      size="small"
                      style="margin-right: 4px; margin-bottom: 2px"
                    >
                      {{ field }}
                    </el-tag>
                  </td>
                  <td class="col-topic">{{ declaration.topic || 'æš‚æ— ' }}</td>
                  <td class="col-status">
                    <el-dropdown
                      @command="(command) => handleStatusEdit(declaration.id, command)"
                      trigger="click"
                      class="status-dropdown"
                    >
                      <span
                        class="status-tag status-clickable"
                        :class="`status-${declaration.statusType}`"
                      >
                        {{ declaration.status }}
                        <el-icon class="status-arrow"><ArrowDown /></el-icon>
                      </span>
                      <template #dropdown>
                        <el-dropdown-menu class="status-dropdown-menu">
                          <el-dropdown-item
                            v-for="option in editableStatusOptions"
                            :key="option.value"
                            :command="option.value"
                            :disabled="option.value === declaration.statusType"
                          >
                            <span
                              class="status-tag"
                              :class="`status-${option.value}`"
                            >
                              {{ option.label }}
                            </span>
                          </el-dropdown-item>
                        </el-dropdown-menu>
                      </template>
                    </el-dropdown>
                  </td>
                  <td class="col-actions">
                    <div class="operation-buttons">
                      <el-button
                        type="primary"
                        size="small"
                        link
                        @click="handleView(declaration.id)"
                      >
                        æŸ¥çœ‹è¯¦æƒ…
                      </el-button>
                      <el-dropdown
                        v-if="declaration.statusType === 'success'"
                        @command="handleDownload"
                        trigger="click"
                      >
                        <el-button type="success" size="small" link>
                          ä¸‹è½½
                          <el-icon class="el-icon--right"
                            ><ArrowDown
                          /></el-icon>
                        </el-button>
                        <template #dropdown>
                          <el-dropdown-menu>
                            <el-dropdown-item
                              :command="{id: declaration.id, format: 'pdf'}"
                            >
                              <el-icon><Document /></el-icon>
                              PDFæ ¼å¼
                            </el-dropdown-item>
                            <el-dropdown-item
                              :command="{id: declaration.id, format: 'word'}"
                            >
                              <el-icon><Document /></el-icon>
                              Wordæ ¼å¼
                            </el-dropdown-item>
                            <el-dropdown-item
                              :command="{id: declaration.id, format: 'markdown'}"
                            >
                              <el-icon><Document /></el-icon>
                              Markdownæ ¼å¼
                            </el-dropdown-item>
                          </el-dropdown-menu>
                        </template>
                      </el-dropdown>
                      <el-button
                        v-if="declaration.statusType === 'success'"
                        type="info"
                        size="small"
                        link
                        @click="handlePreview(declaration.id)"
                      >
                        é¢„è§ˆ
                      </el-button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- ç©ºçŠ¶æ€ -->
          <div v-if="!loading && declarations.length === 0" class="empty-state">
            <div class="empty-state-icon">ğŸ“</div>
            <div class="empty-state-text">æš‚æ— ç”³æŠ¥è®°å½•</div>
            <div class="empty-state-hint">
              ç‚¹å‡»"æ–°å»ºç”³æŠ¥"æŒ‰é’®å¼€å§‹æ‚¨çš„ç¬¬ä¸€ä¸ªç”³æŠ¥
            </div>
          </div>

          <!-- åˆ†é¡µ -->
          <div v-if="declarations.length > 0" class="pagination-container">
            <!-- é€šç”¨åˆ†é¡µç»„ä»¶ -->
            <div id="pagination-component"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const { createApp, ref, reactive, onMounted } = Vue;
      const { ElMessage, ElMessageBox } = ElementPlus;

      // æ³¨å†ŒLoadingå›¾æ ‡
      const Loading = {
        template:
          '<svg class="el-icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M512 64a32 32 0 0 1 32 32v192a32 32 0 0 1-64 0V96a32 32 0 0 1 32-32zm0 896a32 32 0 0 1-32-32V736a32 32 0 0 1 64 0v192a32 32 0 0 1-32 32zm448-480a32 32 0 0 1-32 32H736a32 32 0 0 1 0-64h192a32 32 0 0 1 32 32zM96 512a32 32 0 0 1 32-32h192a32 32 0 0 1 0 64H128a32 32 0 0 1-32-32zm778.24-200.96a32 32 0 0 1 45.248 45.248l-135.68 135.68a32 32 0 1 1-45.248-45.248l135.68-135.68zm-636.48 636.48a32 32 0 0 1 45.248 45.248l-135.68 135.68a32 32 0 1 1-45.248-45.248l135.68-135.68zM778.24 712.96a32 32 0 0 1-45.248 45.248l-135.68-135.68a32 32 0 1 1 45.248-45.248l135.68 135.68zM141.76 311.04a32 32 0 0 1-45.248-45.248l135.68-135.68a32 32 0 1 1 45.248 45.248l-135.68 135.68z"/></svg>',
      };

      createApp({
        components: {
          Loading,
        },
        setup() {
          // æ•°æ®çŠ¶æ€
          const loading = ref(false);

          // æœç´¢è¡¨å•
          const searchForm = reactive({
            keyword: "",
            status: "",
          });

          // ç”³æŠ¥åˆ—è¡¨æ•°æ®
          const declarations = ref([]);

          // åˆ†é¡µä¿¡æ¯
          const pagination = reactive({
            current: 1,
            size: 10,
            total: 0,
          });

          // çŠ¶æ€é€‰é¡¹
          const statusOptions = ref([
            { label: "å…¨éƒ¨", value: "" },
            { label: "ç”³æŠ¥ä¸­", value: "submitting" },
            { label: "ç”³æŠ¥æˆåŠŸ", value: "success" },
            { label: "ç”³æŠ¥å¤±è´¥", value: "failed" },
          ]);

          // å¯ç¼–è¾‘çŠ¶æ€é€‰é¡¹
          const editableStatusOptions = ref([
            { label: "ç”³æŠ¥ä¸­", value: "submitting" },
            { label: "ç”³æŠ¥æˆåŠŸ", value: "success" },
            { label: "ç”³æŠ¥å¤±è´¥", value: "failed" },
          ]);

          // åŠ è½½ç”³æŠ¥åˆ—è¡¨
          const loadDeclarations = async () => {
            try {
              loading.value = true;

              // æ¨¡æ‹ŸAPIè°ƒç”¨å»¶è¿Ÿ
              await new Promise((resolve) => setTimeout(resolve, 1000));

              // æ¨¡æ‹Ÿç”³æŠ¥æ•°æ®
              declarations.value = [
                {
                  id: 1,
                  number: "SB2024001",
                  applicant: "å¼ æ•™æˆ",
                  direction: "äººå·¥æ™ºèƒ½åœ¨æ•™è‚²é¢†åŸŸçš„åº”ç”¨ç ”ç©¶",
                  topic: "åŸºäºæ·±åº¦å­¦ä¹ çš„ä¸ªæ€§åŒ–å­¦ä¹ ç³»ç»Ÿç ”ç©¶",
                  fields: ["äººå·¥æ™ºèƒ½", "æ•™è‚²æŠ€æœ¯", "æœºå™¨å­¦ä¹ "],
                  submitTime: "2024-01-15",
                  status: "ç”³æŠ¥ä¸­",
                  statusType: "submitting",
                },
                {
                  id: 2,
                  number: "SB2024002",
                  applicant: "æåšå£«",
                  direction: "åŒºå—é“¾æŠ€æœ¯åœ¨ä¾›åº”é“¾ç®¡ç†ä¸­çš„åº”ç”¨",
                  topic: "é¢å‘ä¾›åº”é“¾é€æ˜åº¦çš„åŒºå—é“¾æº¯æºæŠ€æœ¯ç ”ç©¶",
                  fields: ["åŒºå—é“¾", "ä¾›åº”é“¾", "åˆ†å¸ƒå¼ç³»ç»Ÿ"],
                  submitTime: "2024-01-14",
                  status: "ç”³æŠ¥æˆåŠŸ",
                  statusType: "success",
                },
                {
                  id: 3,
                  number: "SB2024003",
                  applicant: "ç‹ç ”ç©¶å‘˜",
                  direction: "é‡å­è®¡ç®—ç®—æ³•ä¼˜åŒ–ç ”ç©¶",
                  topic: "é‡å­è¿‘ä¼¼ä¼˜åŒ–ç®—æ³•çš„æ”¹è¿›ä¸åº”ç”¨",
                  fields: ["é‡å­è®¡ç®—", "ç®—æ³•ä¼˜åŒ–", "ç‰©ç†"],
                  submitTime: "2024-01-13",
                  status: "ç”³æŠ¥å¤±è´¥",
                  statusType: "failed",
                },
                {
                  id: 4,
                  number: "SB2024004",
                  applicant: "åˆ˜æ•™æˆ",
                  direction: "ç”Ÿç‰©ä¿¡æ¯å­¦æ•°æ®åˆ†ææ–¹æ³•ç ”ç©¶",
                  topic: "å¤šç»„å­¦æ•°æ®æ•´åˆåˆ†ææ–°æ–¹æ³•ç ”ç©¶",
                  fields: ["ç”Ÿç‰©ä¿¡æ¯å­¦", "æ•°æ®åˆ†æ", "ç»Ÿè®¡å­¦"],
                  submitTime: "2024-01-12",
                  status: "ç”³æŠ¥æˆåŠŸ",
                  statusType: "success",
                },
                {
                  id: 5,
                  number: "SB2024005",
                  applicant: "é™ˆåšå£«",
                  direction: "ç‰©è”ç½‘å®‰å…¨é˜²æŠ¤æŠ€æœ¯ç ”ç©¶",
                  topic: "è½»é‡çº§ç‰©è”ç½‘è®¾å¤‡å®‰å…¨è®¤è¯æœºåˆ¶ç ”ç©¶",
                  fields: ["ç‰©è”ç½‘", "ç½‘ç»œå®‰å…¨", "åŠ å¯†æŠ€æœ¯"],
                  submitTime: "2024-01-11",
                  status: "ç”³æŠ¥å¤±è´¥",
                  statusType: "failed",
                },
                {
                  id: 6,
                  number: "SB2024006",
                  applicant: "èµµæ•™æˆ",
                  direction: "æœºå™¨å­¦ä¹ åœ¨åŒ»ç–—è¯Šæ–­ä¸­çš„åº”ç”¨",
                  topic: "åŸºäºè”é‚¦å­¦ä¹ çš„åŒ»ç–—å½±åƒè¯Šæ–­ç³»ç»Ÿ",
                  fields: ["æœºå™¨å­¦ä¹ ", "åŒ»ç–—è¯Šæ–­", "æ·±åº¦å­¦ä¹ "],
                  submitTime: "2024-01-10",
                  status: "ç”³æŠ¥ä¸­",
                  statusType: "submitting",
                },
                {
                  id: 7,
                  number: "SB2024007",
                  applicant: "å­™ç ”ç©¶å‘˜",
                  direction: "æ–°ææ–™è®¾è®¡ä¸æ€§èƒ½é¢„æµ‹",
                  topic: "æœºå™¨å­¦ä¹ è¾…åŠ©çš„é«˜æ€§èƒ½å¤åˆææ–™è®¾è®¡",
                  fields: ["ææ–™ç§‘å­¦", "è®¡ç®—åŒ–å­¦", "æœºå™¨å­¦ä¹ "],
                  submitTime: "2024-01-09",
                  status: "ç”³æŠ¥æˆåŠŸ",
                  statusType: "success",
                },
                {
                  id: 8,
                  number: "SB2024008",
                  applicant: "å‘¨åšå£«",
                  direction: "å¯å†ç”Ÿèƒ½æºç³»ç»Ÿä¼˜åŒ–",
                  topic: "é£å…‰å‚¨ä¸€ä½“åŒ–ç³»ç»Ÿæ™ºèƒ½è°ƒåº¦ç­–ç•¥ç ”ç©¶",
                  fields: ["å¯å†ç”Ÿèƒ½æº", "ç³»ç»Ÿä¼˜åŒ–", "èƒ½æºå·¥ç¨‹"],
                  submitTime: "2024-01-08",
                  status: "ç”³æŠ¥å¤±è´¥",
                  statusType: "failed",
                },
                {
                  id: 9,
                  number: "SB2024009",
                  applicant: "å´æ•™æˆ",
                  direction: "æ•°å­—å­ªç”ŸæŠ€æœ¯åœ¨æ™ºèƒ½åˆ¶é€ ä¸­çš„åº”ç”¨",
                  topic: "åˆ¶é€ è®¾å¤‡æ•°å­—å­ªç”Ÿå»ºæ¨¡ä¸é¢„æµ‹ç»´æŠ¤",
                  fields: ["æ•°å­—å­ªç”Ÿ", "æ™ºèƒ½åˆ¶é€ ", "å·¥ä¸š4.0"],
                  submitTime: "2024-01-07",
                  status: "ç”³æŠ¥ä¸­",
                  statusType: "submitting",
                },
              ];

              // æ¨¡æ‹Ÿåˆ†é¡µæ•°æ®
              const start = (pagination.current - 1) * pagination.size;
              const end = start + pagination.size;
              declarations.value = declarations.value.slice(start, end);
              pagination.total = 9; // æ¨¡æ‹Ÿæ€»æ•°
            } catch (error) {
              ElMessage.error("åŠ è½½ç”³æŠ¥åˆ—è¡¨å¤±è´¥ï¼Œè¯·é‡è¯•");
            } finally {
              loading.value = false;
              // æ•°æ®åŠ è½½å®Œæˆåé‡æ–°åˆå§‹åŒ–åˆ†é¡µç»„ä»¶
              setTimeout(() => {
                initPagination();
              }, 100);
            }
          };

          // æœç´¢å¤„ç†
          const handleSearch = () => {
            pagination.current = 1;
            loadDeclarations();
            ElMessage.info("æœç´¢å®Œæˆ");
          };

          // çŠ¶æ€ç­›é€‰å¤„ç†
          const handleStatusChange = () => {
            pagination.current = 1;
            loadDeclarations();
          };

          // é‡ç½®æœç´¢
          const handleReset = () => {
            searchForm.keyword = "";
            searchForm.status = "";
            pagination.current = 1;
            loadDeclarations();
            ElMessage.info("å·²é‡ç½®æœç´¢æ¡ä»¶");
          };

          // æ–°å»ºç”³æŠ¥
          const handleNewDeclaration = () => {
            ElMessage.info("è·³è½¬åˆ°æ–°å»ºç”³æŠ¥é¡µé¢");
            // æ£€æŸ¥æ˜¯å¦åœ¨iframeä¸­
            if (window.parent !== window) {
              window.parent.postMessage(
                {
                  type: "navigate",
                  path: "declaration/create",
                },
                "*"
              );
            }
          };

          // æŸ¥çœ‹è¯¦æƒ…
          const handleView = (id) => {
            ElMessage.info(`æŸ¥çœ‹ç”³æŠ¥è¯¦æƒ…ï¼šID ${id}`);
            // æ£€æŸ¥æ˜¯å¦åœ¨iframeä¸­
            if (window.parent !== window) {
              window.parent.postMessage(
                {
                  type: "navigate",
                  path: "declaration/detail",
                },
                "*"
              );
            }
          };

          // ä¸‹è½½å¤„ç†
          const handleDownload = (command) => {
            const { id, format } = command;
            const formatNames = {
              pdf: "PDF",
              word: "Word",
              markdown: "Markdown",
            };

            ElMessage.success(
              `æ­£åœ¨ä¸‹è½½ç”³æŠ¥æ–‡æ¡£ (ID: ${id}, æ ¼å¼: ${formatNames[format]})`
            );

            // æ¨¡æ‹Ÿä¸‹è½½è¿‡ç¨‹
            setTimeout(() => {
              // åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿçš„ä¸‹è½½é“¾æ¥
              const link = document.createElement("a");
              link.href = "#"; // å®é™…åº”ç”¨ä¸­è¿™é‡Œåº”è¯¥æ˜¯çœŸå®çš„æ–‡ä»¶URL
              link.download = `ç”³æŠ¥æ–‡æ¡£_${id}.${
                format === "word" ? "docx" : format
              }`;

              // æ¨¡æ‹Ÿæ–‡ä»¶å†…å®¹ï¼ˆå®é™…åº”ç”¨ä¸­åº”è¯¥ä»æœåŠ¡å™¨è·å–ï¼‰
              const blob = new Blob(
                [`ç”³æŠ¥æ–‡æ¡£å†…å®¹ - ID: ${id}, æ ¼å¼: ${formatNames[format]}`],
                {
                  type:
                    format === "pdf"
                      ? "application/pdf"
                      : format === "word"
                      ? "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                      : "text/markdown",
                }
              );

              link.href = URL.createObjectURL(blob);
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              URL.revokeObjectURL(link.href);

              ElMessage.success(`${formatNames[format]}æ ¼å¼æ–‡æ¡£ä¸‹è½½å®Œæˆ`);
            }, 1000);
          };

          // é¢„è§ˆå¤„ç†
          const handlePreview = (id) => {
            ElMessage.info(`æ­£åœ¨æ‰“å¼€ç”³æŠ¥é¢„è§ˆï¼šID ${id}`);

            // æ¨¡æ‹Ÿé¢„è§ˆåŠŸèƒ½
            ElMessageBox.alert(
              `è¿™é‡Œå°†æ˜¾ç¤ºç”³æŠ¥æ–‡æ¡£çš„é¢„è§ˆå†…å®¹ã€‚\n\nç”³æŠ¥ç¼–å·ï¼šSB2024${String(
                id
              ).padStart(
                3,
                "0"
              )}\nç ”ç©¶æ–¹å‘ï¼šäººå·¥æ™ºèƒ½ç›¸å…³ç ”ç©¶\nç”³æŠ¥çŠ¶æ€ï¼šç”³æŠ¥æˆåŠŸ\n\nå®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºå®Œæ•´çš„ç”³æŠ¥æ–‡æ¡£å†…å®¹æˆ–æ‰“å¼€é¢„è§ˆçª—å£ã€‚`,
              "ç”³æŠ¥æ–‡æ¡£é¢„è§ˆ",
              {
                confirmButtonText: "å…³é—­é¢„è§ˆ",
                type: "info",
                customClass: "preview-dialog",
              }
            );
          };

          // çŠ¶æ€ç¼–è¾‘å¤„ç†
          const handleStatusEdit = async (id, newStatus) => {
            console.log("handleStatusEdit called:", id, newStatus);

            const statusLabels = {
              submitting: "ç”³æŠ¥ä¸­",
              success: "ç”³æŠ¥æˆåŠŸ",
              failed: "ç”³æŠ¥å¤±è´¥",
            };

            // æ‰¾åˆ°å½“å‰ç”³æŠ¥è®°å½•
            const declaration = declarations.value.find((d) => d.id === id);
            if (!declaration) {
              console.log("Declaration not found:", id);
              return;
            }

            const oldStatus = declaration.statusType;
            const oldStatusLabel = declaration.status;

            console.log("Status change:", oldStatus, "->", newStatus);

            // å¦‚æœçŠ¶æ€æ²¡æœ‰å˜åŒ–ï¼Œç›´æ¥è¿”å›
            if (newStatus === oldStatus) {
              console.log("No status change, returning");
              return;
            }

            try {
              await ElMessageBox.confirm(
                `ç¡®å®šè¦å°†ç”³æŠ¥çŠ¶æ€ä¿®æ”¹ä¸º"${statusLabels[newStatus]}"å—ï¼Ÿ`,
                "ç¡®è®¤ä¿®æ”¹",
                {
                  confirmButtonText: "ç¡®å®š",
                  cancelButtonText: "å–æ¶ˆ",
                  type: "warning",
                  customClass: "modern-confirm-dialog",
                  center: false,
                  showClose: true,
                  closeOnClickModal: false,
                  closeOnPressEscape: true,
                  beforeClose: (action, instance, done) => {
                    if (action === "confirm") {
                      instance.confirmButtonLoading = true;
                      instance.confirmButtonText = "ä¿®æ”¹ä¸­...";
                      setTimeout(() => {
                        done();
                        setTimeout(() => {
                          instance.confirmButtonLoading = false;
                        }, 300);
                      }, 800);
                    } else {
                      done();
                    }
                  },
                }
              );

              // æ›´æ–°ç”³æŠ¥çŠ¶æ€
              declaration.statusType = newStatus;
              declaration.status = statusLabels[newStatus];

              ElMessage.success(`ç”³æŠ¥çŠ¶æ€å·²ä¿®æ”¹ä¸º"${statusLabels[newStatus]}"`);
            } catch {
              // ç”¨æˆ·å–æ¶ˆï¼Œæ¢å¤åŸçŠ¶æ€
              declaration.statusType = oldStatus;
              declaration.status = oldStatusLabel;
              ElMessage.info("å·²å–æ¶ˆä¿®æ”¹");
            }
          };

          // åˆ†é¡µå¤§å°å˜åŒ–
          const handleSizeChange = (size) => {
            pagination.size = size;
            pagination.current = 1;
            loadDeclarations();
          };

          // å½“å‰é¡µå˜åŒ–
          const handleCurrentChange = (current) => {
            pagination.current = current;
            loadDeclarations();
          };

          // åˆå§‹åŒ–åˆ†é¡µç»„ä»¶
          const initPagination = () => {
            const paginationContainer = document.getElementById(
              "pagination-component"
            );
            if (paginationContainer) {
              // åˆ›å»ºåˆ†é¡µç»„ä»¶HTML
              const paginationHTML = `
                <div class="pagination-container">
                  <!-- åˆ†é¡µä¿¡æ¯ -->
                  <div class="pagination-info">
                    å…± ${pagination.total} æ¡è®°å½•
                  </div>

                  <!-- æ¯é¡µæ˜¾ç¤ºæ•°é‡é€‰æ‹©å™¨ -->
                  <div class="page-size-selector">
                    æ¯é¡µæ˜¾ç¤º
                    <select id="page-size-select">
                      <option value="10" ${
                        pagination.size === 10 ? "selected" : ""
                      }>10 æ¡</option>
                      <option value="20" ${
                        pagination.size === 20 ? "selected" : ""
                      }>20 æ¡</option>
                      <option value="50" ${
                        pagination.size === 50 ? "selected" : ""
                      }>50 æ¡</option>
                    </select>
                  </div>

                  <!-- åˆ†é¡µæ§åˆ¶å™¨ -->
                  <div class="pagination-controls">
                    <!-- ä¸Šä¸€é¡µæŒ‰é’® -->
                    <a href="javascript:void(0)" class="page-btn ${
                      pagination.current === 1 ? "disabled" : ""
                    }" id="prev-btn">
                      ä¸Šä¸€é¡µ
                    </a>

                    <!-- é¡µç æŒ‰é’® -->
                    <div class="page-nav" id="page-nav">
                      ${generatePageButtons()}
                    </div>

                    <!-- ä¸‹ä¸€é¡µæŒ‰é’® -->
                    <a href="javascript:void(0)" class="page-btn ${
                      pagination.current ===
                      Math.ceil(pagination.total / pagination.size)
                        ? "disabled"
                        : ""
                    }" id="next-btn">
                      ä¸‹ä¸€é¡µ
                    </a>
                  </div>

                  <!-- å¿«é€Ÿè·³è½¬ -->
                  <div class="page-jumper">
                    è·³è‡³
                    <input type="number" id="jump-input" value="${
                      pagination.current
                    }" min="1" max="${Math.ceil(
                pagination.total / pagination.size
              )}">
                    é¡µ
                    <button class="jump-btn" id="jump-btn">ç¡®å®š</button>
                  </div>
                </div>
              `;

              paginationContainer.innerHTML = paginationHTML;

              // ç»‘å®šäº‹ä»¶
              bindPaginationEvents();
            }
          };

          // ç”Ÿæˆé¡µç æŒ‰é’®
          const generatePageButtons = () => {
            const totalPages = Math.ceil(pagination.total / pagination.size);
            const current = pagination.current;
            const pagerCount = 7; // æ˜¾ç¤ºçš„é¡µç æ•°é‡

            let buttons = "";

            if (totalPages <= pagerCount) {
              // æ€»é¡µæ•°å°äºç­‰äºæ˜¾ç¤ºæ•°é‡ï¼Œæ˜¾ç¤ºæ‰€æœ‰é¡µç 
              for (let i = 1; i <= totalPages; i++) {
                buttons += `<a href="javascript:void(0)" class="page-btn ${
                  i === current ? "active" : ""
                }" data-page="${i}">${i}</a>`;
              }
            } else {
              // è®¡ç®—ä¸­é—´é¡µç èŒƒå›´
              const half = Math.floor(pagerCount / 2);
              let start = Math.max(1, current - half);
              let end = Math.min(totalPages, start + pagerCount - 1);

              // è°ƒæ•´èµ·å§‹ä½ç½®
              if (end - start + 1 < pagerCount) {
                start = Math.max(1, end - pagerCount + 1);
              }

              // ç¬¬ä¸€é¡µ
              if (start > 1) {
                buttons += `<a href="javascript:void(0)" class="page-btn ${
                  1 === current ? "active" : ""
                }" data-page="1">1</a>`;
                if (start > 2) {
                  buttons += '<span class="page-ellipsis">...</span>';
                }
              }

              // ä¸­é—´é¡µç 
              for (let i = start; i <= end; i++) {
                buttons += `<a href="javascript:void(0)" class="page-btn ${
                  i === current ? "active" : ""
                }" data-page="${i}">${i}</a>`;
              }

              // æœ€åä¸€é¡µ
              if (end < totalPages) {
                if (end < totalPages - 1) {
                  buttons += '<span class="page-ellipsis">...</span>';
                }
                buttons += `<a href="javascript:void(0)" class="page-btn ${
                  totalPages === current ? "active" : ""
                }" data-page="${totalPages}">${totalPages}</a>`;
              }
            }

            return buttons;
          };

          // ç»‘å®šåˆ†é¡µäº‹ä»¶
          const bindPaginationEvents = () => {
            // æ¯é¡µæ˜¾ç¤ºæ•°é‡å˜åŒ–
            const pageSizeSelect = document.getElementById("page-size-select");
            if (pageSizeSelect) {
              pageSizeSelect.addEventListener("change", (e) => {
                pagination.size = parseInt(e.target.value);
                pagination.current = 1;
                loadDeclarations();
                initPagination(); // é‡æ–°åˆå§‹åŒ–åˆ†é¡µç»„ä»¶
              });
            }

            // ä¸Šä¸€é¡µ
            const prevBtn = document.getElementById("prev-btn");
            if (prevBtn) {
              prevBtn.addEventListener("click", () => {
                if (pagination.current > 1) {
                  pagination.current--;
                  loadDeclarations();
                  initPagination();
                }
              });
            }

            // ä¸‹ä¸€é¡µ
            const nextBtn = document.getElementById("next-btn");
            if (nextBtn) {
              nextBtn.addEventListener("click", () => {
                const totalPages = Math.ceil(
                  pagination.total / pagination.size
                );
                if (pagination.current < totalPages) {
                  pagination.current++;
                  loadDeclarations();
                  initPagination();
                }
              });
            }

            // é¡µç ç‚¹å‡»
            const pageNav = document.getElementById("page-nav");
            if (pageNav) {
              pageNav.addEventListener("click", (e) => {
                if (
                  e.target.classList.contains("page-btn") &&
                  !e.target.classList.contains("active")
                ) {
                  const page = parseInt(e.target.getAttribute("data-page"));
                  if (page && page !== pagination.current) {
                    pagination.current = page;
                    loadDeclarations();
                    initPagination();
                  }
                }
              });
            }

            // å¿«é€Ÿè·³è½¬
            const jumpBtn = document.getElementById("jump-btn");
            const jumpInput = document.getElementById("jump-input");
            if (jumpBtn && jumpInput) {
              const handleJump = () => {
                const page = parseInt(jumpInput.value);
                const totalPages = Math.ceil(
                  pagination.total / pagination.size
                );
                if (
                  page &&
                  page >= 1 &&
                  page <= totalPages &&
                  page !== pagination.current
                ) {
                  pagination.current = page;
                  loadDeclarations();
                  initPagination();
                } else {
                  jumpInput.value = pagination.current;
                }
              };

              jumpBtn.addEventListener("click", handleJump);
              jumpInput.addEventListener("keyup", (e) => {
                if (e.key === "Enter") {
                  handleJump();
                }
              });
            }
          };

          // ç»„ä»¶æŒ‚è½½æ—¶åŠ è½½æ•°æ®
          onMounted(() => {
            console.log("ç”³æŠ¥åˆ—è¡¨é¡µé¢åŠ è½½ä¸­...");
            loadDeclarations();

            // è°ƒè¯•ä¿¡æ¯ï¼šæ£€æŸ¥åŸç”ŸHTMLè¡¨æ ¼
            setTimeout(() => {
              const nativeTable = document.querySelector(".native-table");
              const tableRows = nativeTable
                ? nativeTable.querySelectorAll("tbody tr")
                : [];

              console.log("=== åŸç”ŸHTMLè¡¨æ ¼è°ƒè¯•ä¿¡æ¯ ===");
              console.log("- è¡¨æ ¼å…ƒç´ å­˜åœ¨:", !!nativeTable);
              console.log("- æ•°æ®è¡Œæ•°:", tableRows.length);
              console.log("- ç”³æŠ¥æ•°æ®:", declarations.value);
              console.log("- æ˜¯å¦åœ¨iframeä¸­:", window.parent !== window);

              if (tableRows.length > 0) {
                const firstRowCells = tableRows[0].querySelectorAll("td");
                console.log("- ç¬¬ä¸€è¡Œå•å…ƒæ ¼æ•°:", firstRowCells.length);
                for (let i = 0; i < firstRowCells.length; i++) {
                  const cell = firstRowCells[i];
                  console.log(
                    `- ç¬¬${i + 1}åˆ— (${
                      [
                        "ç”³æŠ¥ç¼–å·",
                        "ç”³æŠ¥äºº",
                        "ç ”ç©¶æ–¹å‘",
                        "ç”³æŠ¥æ—¶é—´",
                        "ç ”ç©¶é¢†åŸŸ",
                        "çŠ¶æ€",
                        "æ“ä½œ",
                      ][i]
                    }):`
                  );
                  console.log(`  - å•å…ƒæ ¼å†…å®¹:`, cell.textContent.trim());
                  console.log(`  - å•å…ƒæ ¼å®½åº¦:`, cell.offsetWidth);
                }
              }

              // æ£€æŸ¥æ•°æ®ç»‘å®š
              console.log("- æ•°æ®ç»‘å®šæ£€æŸ¥:");
              console.log(
                "  - declarations.valueé•¿åº¦:",
                declarations.value.length
              );
              if (declarations.value.length > 0) {
                console.log("  - ç¬¬ä¸€è¡Œæ•°æ®:", declarations.value[0]);
                console.log("  - numberå­—æ®µ:", declarations.value[0].number);
                console.log(
                  "  - applicantå­—æ®µ:",
                  declarations.value[0].applicant
                );
                console.log(
                  "  - directionå­—æ®µ:",
                  declarations.value[0].direction
                );
                console.log(
                  "  - submitTimeå­—æ®µ:",
                  declarations.value[0].submitTime
                );
              }

              // åˆå§‹åŒ–åˆ†é¡µç»„ä»¶
              initPagination();
            }, 1500);
          });

          return {
            loading,
            searchForm,
            declarations,
            pagination,
            statusOptions,
            editableStatusOptions,
            handleSearch,
            handleStatusChange,
            handleReset,
            handleNewDeclaration,
            handleView,
            handleDownload,
            handlePreview,
            handleStatusEdit,
            handleSizeChange,
            handleCurrentChange,
          };
        },
      })
        .use(ElementPlus)
        .mount("#app");
    </script>
  </body>
</html>
