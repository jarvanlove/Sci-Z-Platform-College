<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>登录 - 高校科研项目管理平台</title>
    <link rel="icon" href="../images/favicon.ico" type="image/x-icon" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/element-plus/dist/index.css"
    />
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <link rel="stylesheet" href="../通用规范/样式.css" />
    <style>
      .login-container {
        min-height: 100vh;
        background: linear-gradient(
          135deg,
          #eef2f7 0%,
          #e5ebf1 50%,
          #dde3ea 100%
        );
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        position: relative;
        overflow: hidden;
      }

      /* 背景景观层：SVG几何+电路图+聚焦光晕+暗角 */
      .bg-scape {
        position: absolute;
        inset: 0;
        z-index: 0;
        pointer-events: none;
        background-image: url("data:image/svg+xml,%3Csvg width='220' height='220' viewBox='0 0 220 220' xmlns='http://www.w3.org/2000/svg'%3E%3Cg stroke='%2390a4ae' stroke-opacity='0.18' stroke-width='1' fill='none'%3E%3Cpath d='M10 40 L60 20 L90 70 L10 40 M140 40 L180 20 L210 70 L140 40 M70 140 L110 110 L160 160 L70 140'/%3E%3Ccircle cx='60' cy='20' r='2' fill='%2390a4ae' fill-opacity='0.25'/%3E%3Ccircle cx='90' cy='70' r='2' fill='%2390a4ae' fill-opacity='0.25'/%3E%3Ccircle cx='110' cy='110' r='2' fill='%2390a4ae' fill-opacity='0.25'/%3E%3C/g%3E%3C/svg%3E"),
          url("data:image/svg+xml,%3Csvg width='260' height='260' viewBox='0 0 260 260' xmlns='http://www.w3.org/2000/svg'%3E%3Cg stroke='%2389a6d1' stroke-opacity='0.12' stroke-width='1' fill='none' stroke-linecap='round'%3E%3Cpath d='M20 30 h60 v40 h40 v-20 h60'/%3E%3Cpath d='M30 200 h80 v-30 h50 v-40 h50'/%3E%3Ccircle cx='80' cy='70' r='3' fill='%2389a6d1' fill-opacity='0.18'/%3E%3Ccircle cx='160' cy='90' r='3' fill='%2389a6d1' fill-opacity='0.18'/%3E%3C/g%3E%3C/svg%3E"),
          radial-gradient(
            ellipse at 50% 42%,
            rgba(255, 255, 255, 0.75) 0%,
            rgba(255, 255, 255, 0.55) 22%,
            rgba(255, 255, 255, 0.25) 46%,
            rgba(255, 255, 255, 0) 62%
          ),
          radial-gradient(
            circle at 50% 50%,
            rgba(15, 23, 42, 0.06) 0%,
            rgba(15, 23, 42, 0.1) 65%,
            rgba(15, 23, 42, 0.16) 100%
          );
        background-size: 460px 460px, 520px 520px, 100% 100%, 100% 100%;
        background-position: left -80px top -40px, right -100px bottom -60px,
          center, center;
        animation: bgPan 40s linear infinite;
      }

      @keyframes bgPan {
        0% {
          background-position: left -80px top -40px, right -100px bottom -60px,
            center, center;
        }
        50% {
          background-position: left -40px top -20px, right -60px bottom -30px,
            center, center;
        }
        100% {
          background-position: left -80px top -40px, right -100px bottom -60px,
            center, center;
        }
      }

      @media (prefers-reduced-motion: reduce) {
        .bg-scape {
          animation: none;
        }
      }

      /* SVG科技背景 */
      .login-container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3Cpattern id='grid' width='20' height='20' patternUnits='userSpaceOnUse'%3E%3Cpath d='M 20 0 L 0 0 0 20' fill='none' stroke='%23e2e8f0' stroke-width='0.5'/%3E%3C/pattern%3E%3C/defs%3E%3Crect width='100' height='100' fill='url(%23grid)'/%3E%3C/svg%3E");
        opacity: 0.3;
        animation: gridMove 20s linear infinite;
      }

      @keyframes gridMove {
        0% {
          transform: translate(0, 0);
        }
        100% {
          transform: translate(20px, 20px);
        }
      }

      /* 神经网络节点 */
      .login-container::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url("data:image/svg+xml,%3Csvg width='200' height='200' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3CradialGradient id='node1' cx='50%25' cy='50%25' r='50%25'%3E%3Cstop offset='0%25' style='stop-color:%233b82f6;stop-opacity:0.1'/%3E%3Cstop offset='100%25' style='stop-color:%233b82f6;stop-opacity:0'/%3E%3C/radialGradient%3E%3CradialGradient id='node2' cx='50%25' cy='50%25' r='50%25'%3E%3Cstop offset='0%25' style='stop-color:%238b5cf6;stop-opacity:0.08'/%3E%3Cstop offset='100%25' style='stop-color:%238b5cf6;stop-opacity:0'/%3E%3C/radialGradient%3E%3C/defs%3E%3Ccircle cx='50' cy='50' r='30' fill='url(%23node1)'/%3E%3Ccircle cx='150' cy='100' r='25' fill='url(%23node2)'/%3E%3Ccircle cx='100' cy='150' r='20' fill='url(%23node1)'/%3E%3Cline x1='50' y1='50' x2='150' y2='100' stroke='%23cbd5e1' stroke-width='1' opacity='0.3'/%3E%3Cline x1='150' y1='100' x2='100' y2='150' stroke='%23cbd5e1' stroke-width='1' opacity='0.3'/%3E%3Cline x1='100' y1='150' x2='50' y2='50' stroke='%23cbd5e1' stroke-width='1' opacity='0.3'/%3E%3C/svg%3E");
        animation: networkFloat 15s ease-in-out infinite;
        opacity: 0.6;
      }

      @keyframes networkFloat {
        0%,
        100% {
          transform: translateY(0px) scale(1);
        }
        50% {
          transform: translateY(-10px) scale(1.05);
        }
      }

      .login-card {
        width: 100%;
        max-width: 400px;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(20px);
        border-radius: 24px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1),
          0 0 0 1px rgba(255, 255, 255, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.3);
        padding: 40px;
        position: relative;
        z-index: 10;
        border: 1px solid rgba(255, 255, 255, 0.3);
        transition: all 0.3s ease;
      }

      .login-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15),
          0 0 0 1px rgba(255, 255, 255, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.4);
      }

      .logo-section {
        text-align: center;
        margin-bottom: 32px;
      }

      .logo-section img {
        width: 48px;
        height: 48px;
        margin-bottom: 16px;
      }

      .logo-section h1 {
        font-size: 24px;
        font-weight: 600;
        color: #1e3a8a;
        margin: 0 0 8px 0;
      }

      .logo-section p {
        font-size: 14px;
        color: #6b7280;
        margin: 0;
      }

      .form-section {
        margin-bottom: 24px;
      }

      .form-item {
        margin-bottom: 20px;
      }

      .form-item:last-child {
        margin-bottom: 0;
      }

      .remember-section {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 20px 0;
      }

      .forgot-link {
        color: #1e3a8a;
        text-decoration: none;
        font-size: 14px;
      }

      .forgot-link:hover {
        text-decoration: underline;
      }

      .login-button {
        width: 100%;
        height: 40px;
        font-size: 16px;
        margin-bottom: 24px;
      }

      .register-section {
        text-align: center;
        padding-top: 24px;
        border-top: 1px solid #e5e7eb;
      }

      .register-link {
        color: #1e3a8a;
        text-decoration: none;
        font-weight: 500;
      }

      .register-link:hover {
        text-decoration: underline;
      }

      .captcha-container {
        display: flex;
        gap: 12px;
        align-items: flex-start;
      }

      .captcha-input {
        flex: 2;
      }

      .captcha-image {
        flex: 1;
        height: 40px;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f9fafb;
        color: #6b7280;
        font-size: 12px;
      }

      .captcha-image:hover {
        border-color: #1e3a8a;
      }

      .error-message {
        color: #dc2626;
        font-size: 12px;
        margin-top: 4px;
      }

      .success-icon {
        color: #16a34a;
        font-size: 16px;
      }

      @media (max-width: 480px) {
        .login-card {
          margin: 0 20px;
          padding: 24px;
        }
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="login-container">
        <div class="bg-scape"></div>
        <div class="login-card">
          <!-- Logo 区域 -->
          <div class="logo-section">
            <img src="../images/logo.svg" alt="Logo" />
            <h1>高校科研管理平台</h1>
            <p>欢迎回来，请登录您的账户</p>
          </div>

          <!-- 表单区域 -->
          <div class="form-section">
            <el-form
              :model="loginForm"
              :rules="rules"
              ref="formRef"
              @submit.prevent="handleLogin"
            >
              <!-- 用户名输入框 -->
              <div class="form-item">
                <el-form-item prop="username">
                  <el-input
                    v-model="loginForm.username"
                    placeholder="请输入用户名/邮箱 (默认: admin)"
                    size="large"
                    :prefix-icon="User"
                    clearable
                    @blur="validateUsername"
                    @keydown.enter="handleLogin"
                  />
                  <div v-if="usernameError" class="error-message">
                    {{ usernameError }}
                  </div>
                  <div v-if="usernameSuccess" class="success-icon">✓</div>
                </el-form-item>
              </div>

              <!-- 密码输入框 -->
              <div class="form-item">
                <el-form-item prop="password">
                  <el-input
                    v-model="loginForm.password"
                    type="password"
                    placeholder="请输入密码 (默认: admin)"
                    size="large"
                    :prefix-icon="Lock"
                    show-password
                    clearable
                    @blur="validatePassword"
                    @keydown.enter="handleLogin"
                  />
                  <div v-if="passwordError" class="error-message">
                    {{ passwordError }}
                  </div>
                  <div v-if="passwordSuccess" class="success-icon">✓</div>
                </el-form-item>
              </div>

              <!-- 验证码输入框 -->
              <div class="form-item" v-if="showCaptcha">
                <el-form-item prop="captcha">
                  <div class="captcha-container">
                    <el-input
                      v-model="loginForm.captcha"
                      placeholder="请输入验证码"
                      size="large"
                      class="captcha-input"
                      maxlength="4"
                      clearable
                      @keydown.enter="handleLogin"
                    />
                    <div class="captcha-image" @click="refreshCaptcha">
                      <span v-if="!captchaUrl">点击获取</span>
                      <img
                        v-else
                        :src="captchaUrl"
                        alt="验证码"
                        style="width: 100%; height: 100%; object-fit: cover"
                      />
                    </div>
                  </div>
                  <div v-if="captchaError" class="error-message">
                    {{ captchaError }}
                  </div>
                </el-form-item>
              </div>

              <!-- 记住我和忘记密码 -->
              <div class="remember-section">
                <el-checkbox v-model="loginForm.remember">
                  7天免登录
                </el-checkbox>
                <a href="#" class="forgot-link" @click="handleForgotPassword">
                  忘记密码？
                </a>
              </div>

              <!-- 登录按钮 -->
              <el-button
                type="primary"
                class="login-button"
                size="large"
                :loading="loading"
                @click="handleLogin"
                @keydown.enter="handleLogin"
              >
                {{ loading ? '登录中...' : '登录' }}
              </el-button>
            </el-form>
          </div>

          <!-- 底部区域 -->
          <div class="register-section">
            <span style="color: #6b7280">还没有账户？</span>
            <a href="#" class="register-link" @click="handleRegister">
              立即注册
            </a>
          </div>
        </div>
      </div>
    </div>

    <script>
      const { createApp, ref, reactive } = Vue;
      const { ElMessage, ElLoading } = ElementPlus;

      createApp({
        setup() {
          // 表单数据
          const loginForm = reactive({
            username: "",
            password: "",
            captcha: "",
            remember: false,
          });

          // 状态管理
          const loading = ref(false);
          const showCaptcha = ref(false);
          const captchaUrl = ref("");
          const failedAttempts = ref(0);

          // 验证状态
          const usernameError = ref("");
          const usernameSuccess = ref(false);
          const passwordError = ref("");
          const passwordSuccess = ref(false);
          const captchaError = ref("");

          // 表单引用
          const formRef = ref();

          // 验证规则
          const rules = {
            username: [
              { required: true, message: "请输入用户名", trigger: "blur" },
              {
                min: 3,
                max: 50,
                message: "用户名长度为3-50个字符",
                trigger: "blur",
              },
            ],
            password: [
              { required: true, message: "请输入密码", trigger: "blur" },
              {
                min: 5,
                max: 20,
                message: "密码长度为5-20个字符",
                trigger: "blur",
              },
            ],
            captcha: [
              { required: true, message: "请输入验证码", trigger: "blur" },
              { len: 4, message: "验证码为4位字符", trigger: "blur" },
            ],
          };

          // 用户名验证
          const validateUsername = () => {
            usernameError.value = "";
            usernameSuccess.value = false;

            if (!loginForm.username) {
              usernameError.value = "请输入用户名";
              return false;
            }

            if (
              loginForm.username.length < 3 ||
              loginForm.username.length > 50
            ) {
              usernameError.value = "用户名长度为3-50个字符";
              return false;
            }

            // 模拟异步验证
            setTimeout(() => {
              usernameSuccess.value = true;
            }, 300);

            return true;
          };

          // 密码验证
          const validatePassword = () => {
            passwordError.value = "";
            passwordSuccess.value = false;

            if (!loginForm.password) {
              passwordError.value = "请输入密码";
              return false;
            }

            if (
              loginForm.password.length < 5 ||
              loginForm.password.length > 20
            ) {
              passwordError.value = "密码长度为5-20个字符";
              return false;
            }

            // 模拟密码强度检查
            setTimeout(() => {
              passwordSuccess.value = true;
            }, 300);

            return true;
          };

          // 刷新验证码
          const refreshCaptcha = () => {
            // 模拟生成验证码
            captchaUrl.value = `data:image/svg+xml;base64,${btoa(`
            <svg width="100" height="40" xmlns="http://www.w3.org/2000/svg">
              <rect width="100" height="40" fill="#F3F4F6"/>
              <text x="50" y="25" text-anchor="middle" font-family="monospace" font-size="18" fill="#374151">${Math.random()
                .toString()
                .substring(2, 6)}</text>
            </svg>
          `)}`;
            captchaError.value = "";
          };

          // 登录处理
          const handleLogin = async () => {
            if (!formRef.value) return;

            try {
              const valid = await formRef.value.validate();
              if (!valid) return;

              loading.value = true;

              // 模拟登录API调用
              await new Promise((resolve) => setTimeout(resolve, 1500));

              // 检查默认用户 admin/admin
              if (
                loginForm.username === "admin" &&
                loginForm.password === "admin"
              ) {
                ElMessage.success("登录成功！欢迎使用高校科研管理平台");

                // 模拟缓存Token
                if (loginForm.remember) {
                  localStorage.setItem("remember_token", "mock_remember_token");
                }
                localStorage.setItem("auth_token", "mock_auth_token");

                // 跳转到系统主界面
                setTimeout(() => {
                  // 检查是否在iframe中
                  if (window.parent !== window) {
                    window.parent.postMessage(
                      {
                        type: "navigate",
                        path: "dashboard",
                      },
                      "*"
                    );
                  } else {
                    // 直接跳转到系统主界面（包含左侧菜单和右上角用户信息）
                    window.location.href = "../通用规范/原型壳-布局.html";
                  }
                }, 1000);
              } else {
                // 登录失败
                failedAttempts.value++;
                if (failedAttempts.value >= 3) {
                  showCaptcha.value = true;
                  refreshCaptcha();
                }

                ElMessage.error("用户名或密码错误，请重试");
                ElMessage.info("提示：默认用户名和密码为 admin/admin");
              }
            } catch (error) {
              ElMessage.error("登录失败，请重试");
            } finally {
              loading.value = false;
            }
          };

          // 忘记密码
          const handleForgotPassword = () => {
            // 检查是否在iframe中
            if (window.parent !== window) {
              window.parent.postMessage(
                {
                  type: "navigate",
                  path: "auth/reset-password",
                },
                "*"
              );
            } else {
              // 直接跳转（用于独立访问）
              window.location.href = "重置密码.html";
            }
          };

          // 注册
          const handleRegister = () => {
            // 检查是否在iframe中
            if (window.parent !== window) {
              window.parent.postMessage(
                {
                  type: "navigate",
                  path: "auth/register",
                },
                "*"
              );
            } else {
              // 直接跳转（用于独立访问）
              window.location.href = "注册.html";
            }
          };

          return {
            loginForm,
            loading,
            showCaptcha,
            captchaUrl,
            usernameError,
            usernameSuccess,
            passwordError,
            passwordSuccess,
            captchaError,
            formRef,
            rules,
            validateUsername,
            validatePassword,
            refreshCaptcha,
            handleLogin,
            handleForgotPassword,
            handleRegister,
          };
        },
      })
        .use(ElementPlus)
        .mount("#app");
    </script>
  </body>
</html>
