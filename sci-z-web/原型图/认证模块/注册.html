<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>注册 - 高校科研项目管理平台</title>
    <link rel="icon" href="../images/favicon.ico" type="image/x-icon" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/element-plus/dist/index.css"
    />
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <link rel="stylesheet" href="../通用规范/样式.css" />
    <style>
      .register-container {
        min-height: 100vh;
        background: linear-gradient(
          135deg,
          #f1f5f9 0%,
          #e2e8f0 50%,
          #cbd5e1 100%
        );
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        position: relative;
        overflow: hidden;
      }

      /* 科研数据流SVG背景 */
      .register-container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url("data:image/svg+xml,%3Csvg width='120' height='120' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3Cpattern id='dots' width='20' height='20' patternUnits='userSpaceOnUse'%3E%3Ccircle cx='10' cy='10' r='1.5' fill='%23cbd5e1' opacity='0.4'/%3E%3C/pattern%3E%3C/defs%3E%3Crect width='120' height='120' fill='url(%23dots)'/%3E%3C/svg%3E");
        opacity: 0.4;
        animation: dotsMove 25s linear infinite;
      }

      @keyframes dotsMove {
        0% {
          transform: translate(0, 0);
        }
        100% {
          transform: translate(20px, 20px);
        }
      }

      /* 科研图表SVG */
      .register-container::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url("data:image/svg+xml,%3Csvg width='300' height='200' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3ClinearGradient id='chart1' x1='0%25' y1='0%25' x2='100%25' y2='0%25'%3E%3Cstop offset='0%25' style='stop-color:%233b82f6;stop-opacity:0.1'/%3E%3Cstop offset='100%25' style='stop-color:%233b82f6;stop-opacity:0'/%3E%3C/linearGradient%3E%3ClinearGradient id='chart2' x1='0%25' y1='0%25' x2='100%25' y2='0%25'%3E%3Cstop offset='0%25' style='stop-color:%238b5cf6;stop-opacity:0.08'/%3E%3Cstop offset='100%25' style='stop-color:%238b5cf6;stop-opacity:0'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cpath d='M20,150 L50,120 L80,100 L110,80 L140,60 L170,40 L200,20' stroke='%233b82f6' stroke-width='2' fill='none' opacity='0.3'/%3E%3Cpath d='M20,160 L50,140 L80,120 L110,100 L140,90 L170,70 L200,50' stroke='%238b5cf6' stroke-width='2' fill='none' opacity='0.3'/%3E%3Ccircle cx='50' cy='120' r='3' fill='%233b82f6' opacity='0.4'/%3E%3Ccircle cx='110' cy='80' r='3' fill='%233b82f6' opacity='0.4'/%3E%3Ccircle cx='170' cy='40' r='3' fill='%233b82f6' opacity='0.4'/%3E%3Ccircle cx='80' cy='120' r='3' fill='%238b5cf6' opacity='0.4'/%3E%3Ccircle cx='140' cy='90' r='3' fill='%238b5cf6' opacity='0.4'/%3E%3C/svg%3E");
        animation: chartFloat 18s ease-in-out infinite;
        opacity: 0.5;
      }

      @keyframes chartFloat {
        0%,
        100% {
          transform: translateY(0px) rotate(0deg);
        }
        50% {
          transform: translateY(-8px) rotate(1deg);
        }
      }

      .register-card {
        width: 100%;
        max-width: 500px;
        background: rgba(255, 255, 255, 0.88);
        backdrop-filter: blur(25px);
        border-radius: 28px;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.08),
          0 0 0 1px rgba(255, 255, 255, 0.25),
          inset 0 1px 0 rgba(255, 255, 255, 0.4);
        padding: 40px;
        position: relative;
        z-index: 10;
        border: 1px solid rgba(255, 255, 255, 0.4);
        transition: all 0.3s ease;
      }

      .register-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 30px 60px rgba(0, 0, 0, 0.12),
          0 0 0 1px rgba(255, 255, 255, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.5);
      }

      .logo-section {
        text-align: center;
        margin-bottom: 32px;
      }

      .logo-section img {
        width: 48px;
        height: 48px;
        margin-bottom: 16px;
      }

      .logo-section h1 {
        font-size: 24px;
        font-weight: 600;
        color: #1e3a8a;
        margin: 0 0 8px 0;
      }

      .logo-section p {
        font-size: 14px;
        color: #6b7280;
        margin: 0;
      }

      .form-section {
        margin-bottom: 24px;
      }

      .form-group {
        margin-bottom: 24px;
      }

      .form-group:last-child {
        margin-bottom: 0;
      }

      .group-title {
        font-size: 16px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 1px solid #e5e7eb;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }

      .form-item {
        margin-bottom: 16px;
      }

      .form-item:last-child {
        margin-bottom: 0;
      }

      .password-strength {
        margin-top: 8px;
        height: 4px;
        background: #e5e7eb;
        border-radius: 2px;
        overflow: hidden;
      }

      .password-strength-bar {
        height: 100%;
        transition: all 0.3s ease;
        border-radius: 2px;
      }

      .password-strength-weak {
        width: 33%;
        background: #dc2626;
      }

      .password-strength-medium {
        width: 66%;
        background: #f59e0b;
      }

      .password-strength-strong {
        width: 100%;
        background: #16a34a;
      }

      .password-strength-text {
        font-size: 12px;
        margin-top: 4px;
        color: #6b7280;
      }

      .verification-container {
        display: flex;
        gap: 12px;
        align-items: flex-start;
      }

      .verification-input {
        flex: 1;
      }

      .verification-button {
        flex-shrink: 0;
        height: 40px;
        min-width: 120px;
      }

      .verification-button:disabled {
        background: #f3f4f6;
        color: #9ca3af;
      }

      .verification-tips {
        margin-top: 8px;
        line-height: 1.4;
      }

      .error-message {
        color: #dc2626;
        font-size: 12px;
        margin-top: 4px;
      }

      .success-icon {
        color: #16a34a;
        font-size: 16px;
      }

      .register-button {
        width: 100%;
        height: 40px;
        font-size: 16px;
        margin-bottom: 24px;
      }

      .login-section {
        text-align: center;
        padding-top: 24px;
        border-top: 1px solid #e5e7eb;
      }

      .login-link {
        color: #1e3a8a;
        text-decoration: none;
        font-weight: 500;
      }

      .login-link:hover {
        text-decoration: underline;
      }

      @media (max-width: 640px) {
        .register-card {
          margin: 0 20px;
          padding: 24px;
        }

        .form-row {
          grid-template-columns: 1fr;
          gap: 0;
        }
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="register-container">
        <div class="bg-scape"></div>
        <div class="register-card">
          <!-- Logo 区域 -->
          <div class="logo-section">
            <img src="../images/logo.svg" alt="Logo" />
            <h1>创建新账户</h1>
            <p>加入高校科研管理平台，开启您的科研之旅</p>
          </div>

          <!-- 表单区域 -->
          <div class="form-section">
            <el-form
              :model="registerForm"
              :rules="rules"
              ref="formRef"
              @submit.prevent="handleRegister"
            >
              <!-- 基本信息组 -->
              <div class="form-group">
                <div class="group-title">基本信息</div>

                <div class="form-row">
                  <div class="form-item">
                    <el-form-item
                      prop="username"
                      label="用户名"
                      label-width="100px"
                    >
                      <el-input
                        v-model="registerForm.username"
                        placeholder="请输入工号"
                        size="large"
                        clearable
                        @blur="validateUsername"
                      />
                      <div v-if="usernameError" class="error-message">
                        {{ usernameError }}
                      </div>
                      <div v-if="usernameSuccess" class="success-icon">
                        ✓ 用户名可用
                      </div>
                    </el-form-item>
                  </div>

                  <div class="form-item">
                    <el-form-item
                      prop="realName"
                      label="真实姓名"
                      label-width="100px"
                    >
                      <el-input
                        v-model="registerForm.realName"
                        placeholder="请输入真实姓名"
                        size="large"
                        clearable
                        @blur="validateRealName"
                      />
                      <div v-if="realNameError" class="error-message">
                        {{ realNameError }}
                      </div>
                      <div v-if="realNameSuccess" class="success-icon">✓</div>
                    </el-form-item>
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-item">
                    <el-form-item prop="email" label="邮箱" label-width="100px">
                      <el-input
                        v-model="registerForm.email"
                        placeholder="请输入邮箱地址"
                        size="large"
                        clearable
                        @blur="validateEmail"
                      />
                      <div v-if="emailError" class="error-message">
                        {{ emailError }}
                      </div>
                      <div v-if="emailSuccess" class="success-icon">✓</div>
                    </el-form-item>
                  </div>

                  <div class="form-item">
                    <el-form-item
                      prop="phone"
                      label="手机号"
                      label-width="100px"
                    >
                      <el-input
                        v-model="registerForm.phone"
                        placeholder="请输入手机号"
                        size="large"
                        clearable
                        @blur="validatePhone"
                      />
                      <div v-if="phoneError" class="error-message">
                        {{ phoneError }}
                      </div>
                      <div v-if="phoneSuccess" class="success-icon">✓</div>
                    </el-form-item>
                  </div>
                </div>

                <div class="form-item">
                  <el-form-item
                    prop="department"
                    label="所属院系"
                    label-width="100px"
                  >
                    <el-select
                      v-model="registerForm.department"
                      placeholder="请选择所属院系"
                      size="large"
                      style="width: 100%"
                      clearable
                    >
                      <el-option
                        v-for="dept in departments"
                        :key="dept.value"
                        :label="dept.label"
                        :value="dept.value"
                      />
                    </el-select>
                  </el-form-item>
                </div>
              </div>

              <!-- 密码信息组 -->
              <div class="form-group">
                <div class="group-title">密码设置</div>

                <div class="form-item">
                  <el-form-item
                    prop="password"
                    label="密码"
                    label-width="100px"
                  >
                    <el-input
                      v-model="registerForm.password"
                      type="password"
                      placeholder="请输入密码"
                      size="large"
                      show-password
                      clearable
                      @input="checkPasswordStrength"
                    />
                    <!-- 密码强度指示器 -->
                    <div v-if="registerForm.password" class="password-strength">
                      <div
                        class="password-strength-bar"
                        :class="passwordStrengthClass"
                      ></div>
                    </div>
                    <div
                      v-if="registerForm.password"
                      class="password-strength-text"
                    >
                      密码强度：{{ passwordStrengthText }}
                    </div>
                    <div v-if="passwordError" class="error-message">
                      {{ passwordError }}
                    </div>
                  </el-form-item>
                </div>

                <div class="form-item">
                  <el-form-item
                    prop="confirmPassword"
                    label="确认密码"
                    label-width="100px"
                  >
                    <el-input
                      v-model="registerForm.confirmPassword"
                      type="password"
                      placeholder="请再次输入密码"
                      size="large"
                      show-password
                      clearable
                      @blur="validateConfirmPassword"
                    />
                    <div v-if="confirmPasswordError" class="error-message">
                      {{ confirmPasswordError }}
                    </div>
                    <div v-if="confirmPasswordSuccess" class="success-icon">
                      ✓ 密码匹配
                    </div>
                  </el-form-item>
                </div>
              </div>

              <!-- 验证信息组 -->
              <div class="form-group">
                <div class="group-title">身份验证</div>

                <div class="form-item">
                  <el-form-item
                    prop="verificationCode"
                    label="验证码"
                    label-width="100px"
                  >
                    <div class="verification-container">
                      <el-input
                        v-model="registerForm.verificationCode"
                        placeholder="请输入6位验证码"
                        size="large"
                        class="verification-input"
                        maxlength="6"
                        clearable
                      />
                      <el-button
                        type="primary"
                        size="large"
                        class="verification-button"
                        :disabled="verificationCountdown > 0 || !canSendCode"
                        @click="sendVerificationCode"
                      >
                        {{ verificationCountdown > 0 ?
                        `${verificationCountdown}s` : '获取验证码' }}
                      </el-button>
                    </div>
                    <div class="verification-tips">
                      <span
                        v-if="!verificationSent"
                        style="color: #6b7280; font-size: 12px"
                      >
                        验证码将发送至您的手机号 {{ maskedPhone }}
                      </span>
                      <span v-else style="color: #16a34a; font-size: 12px">
                        ✓ 验证码已发送至 {{ maskedPhone }}
                      </span>
                    </div>
                    <div v-if="verificationError" class="error-message">
                      {{ verificationError }}
                    </div>
                  </el-form-item>
                </div>
              </div>

              <!-- 注册按钮 -->
              <el-button
                type="primary"
                class="register-button"
                size="large"
                :loading="loading"
                @click="handleRegister"
              >
                {{ loading ? '注册中...' : '立即注册' }}
              </el-button>
            </el-form>
          </div>

          <!-- 底部区域 -->
          <div class="login-section">
            <span style="color: #6b7280">已有账户？</span>
            <a href="#" class="login-link" @click="handleLogin"> 立即登录 </a>
          </div>
        </div>
      </div>
    </div>

    <script>
      const { createApp, ref, reactive, computed } = Vue;
      const { ElMessage } = ElementPlus;

      createApp({
        setup() {
          // 表单数据
          const registerForm = reactive({
            username: "",
            realName: "",
            email: "",
            phone: "",
            department: "",
            password: "",
            confirmPassword: "",
            verificationCode: "",
          });

          // 状态管理
          const loading = ref(false);
          const verificationCountdown = ref(0);
          const passwordStrength = ref(0);
          const verificationSent = ref(false);

          // 验证状态
          const usernameError = ref("");
          const usernameSuccess = ref(false);
          const realNameError = ref("");
          const realNameSuccess = ref(false);
          const emailError = ref("");
          const emailSuccess = ref(false);
          const phoneError = ref("");
          const phoneSuccess = ref(false);
          const passwordError = ref("");
          const confirmPasswordError = ref("");
          const confirmPasswordSuccess = ref(false);
          const verificationError = ref("");
          const verificationSuccess = ref(false);

          // 表单引用
          const formRef = ref();

          // 院系选项
          const departments = ref([
            { label: "计算机科学与技术学院", value: "cs" },
            { label: "人工智能学院", value: "ai" },
            { label: "数学与统计学院", value: "math" },
            { label: "物理与电子工程学院", value: "physics" },
            { label: "化学与材料科学学院", value: "chemistry" },
            { label: "生物科学与技术学院", value: "biology" },
            { label: "经济管理学院", value: "economics" },
            { label: "文学院", value: "literature" },
            { label: "外国语学院", value: "foreign" },
            { label: "教育学院", value: "education" },
          ]);

          // 验证规则
          const rules = {
            username: [
              { required: true, message: "请输入用户名", trigger: "blur" },
              {
                min: 3,
                max: 20,
                message: "用户名长度为3-20个字符",
                trigger: "blur",
              },
            ],
            realName: [
              { required: true, message: "请输入真实姓名", trigger: "blur" },
              {
                min: 2,
                max: 10,
                message: "姓名长度为2-10个字符",
                trigger: "blur",
              },
            ],
            email: [
              { required: true, message: "请输入邮箱", trigger: "blur" },
              {
                type: "email",
                message: "请输入正确的邮箱格式",
                trigger: "blur",
              },
            ],
            phone: [
              { required: true, message: "请输入手机号", trigger: "blur" },
              {
                pattern: /^1[3-9]\d{9}$/,
                message: "请输入正确的手机号",
                trigger: "blur",
              },
            ],
            department: [
              { required: true, message: "请选择所属院系", trigger: "change" },
            ],
            password: [
              { required: true, message: "请输入密码", trigger: "blur" },
              {
                min: 6,
                max: 20,
                message: "密码长度为6-20个字符",
                trigger: "blur",
              },
            ],
            confirmPassword: [
              { required: true, message: "请确认密码", trigger: "blur" },
            ],
            verificationCode: [
              { required: true, message: "请输入验证码", trigger: "blur" },
              { len: 6, message: "验证码为6位数字", trigger: "blur" },
            ],
          };

          // 密码强度检查
          const checkPasswordStrength = () => {
            const password = registerForm.password;
            if (!password) {
              passwordStrength.value = 0;
              return;
            }

            let strength = 0;

            // 长度检查
            if (password.length >= 6) strength += 1;
            if (password.length >= 8) strength += 1;

            // 字符类型检查
            if (/[a-z]/.test(password)) strength += 1;
            if (/[A-Z]/.test(password)) strength += 1;
            if (/[0-9]/.test(password)) strength += 1;
            if (/[^a-zA-Z0-9]/.test(password)) strength += 1;

            passwordStrength.value = strength;
          };

          // 密码强度样式
          const passwordStrengthClass = computed(() => {
            if (passwordStrength.value <= 2) return "password-strength-weak";
            if (passwordStrength.value <= 4) return "password-strength-medium";
            return "password-strength-strong";
          });

          // 密码强度文字
          const passwordStrengthText = computed(() => {
            if (passwordStrength.value <= 2) return "弱";
            if (passwordStrength.value <= 4) return "中";
            return "强";
          });

          // 是否可以发送验证码
          const canSendCode = computed(() => {
            return (
              registerForm.email &&
              registerForm.phone &&
              !emailError.value &&
              !phoneError.value
            );
          });

          // 脱敏手机号显示
          const maskedPhone = computed(() => {
            if (!registerForm.phone) return "****";
            const phone = registerForm.phone;
            if (phone.length >= 11) {
              return phone.slice(0, 3) + "****" + phone.slice(-4);
            }
            return phone;
          });

          // 用户名验证
          const validateUsername = async () => {
            usernameError.value = "";
            usernameSuccess.value = false;

            if (!registerForm.username) {
              usernameError.value = "请输入用户名";
              return false;
            }

            if (
              registerForm.username.length < 3 ||
              registerForm.username.length > 20
            ) {
              usernameError.value = "用户名长度为3-20个字符";
              return false;
            }

            // 模拟异步用户名唯一性验证
            await new Promise((resolve) => setTimeout(resolve, 500));

            if (Math.random() > 0.2) {
              // 80% 可用
              usernameSuccess.value = true;
            } else {
              usernameError.value = "用户名已存在，请选择其他用户名";
            }

            return true;
          };

          // 真实姓名验证
          const validateRealName = () => {
            realNameError.value = "";
            realNameSuccess.value = false;

            if (!registerForm.realName) {
              realNameError.value = "请输入真实姓名";
              return false;
            }

            if (
              registerForm.realName.length < 2 ||
              registerForm.realName.length > 10
            ) {
              realNameError.value = "姓名长度为2-10个字符";
              return false;
            }

            realNameSuccess.value = true;
            return true;
          };

          // 邮箱验证
          const validateEmail = async () => {
            emailError.value = "";
            emailSuccess.value = false;

            if (!registerForm.email) {
              emailError.value = "请输入邮箱";
              return false;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(registerForm.email)) {
              emailError.value = "请输入正确的邮箱格式";
              return false;
            }

            // 模拟异步邮箱唯一性验证
            await new Promise((resolve) => setTimeout(resolve, 500));

            if (Math.random() > 0.1) {
              // 90% 可用
              emailSuccess.value = true;
            } else {
              emailError.value = "邮箱已被注册，请使用其他邮箱";
            }

            return true;
          };

          // 手机号验证
          const validatePhone = async () => {
            phoneError.value = "";
            phoneSuccess.value = false;

            if (!registerForm.phone) {
              phoneError.value = "请输入手机号";
              return false;
            }

            const phoneRegex = /^1[3-9]\d{9}$/;
            if (!phoneRegex.test(registerForm.phone)) {
              phoneError.value = "请输入正确的手机号";
              return false;
            }

            // 模拟异步手机号唯一性验证
            await new Promise((resolve) => setTimeout(resolve, 500));

            if (Math.random() > 0.1) {
              // 90% 可用
              phoneSuccess.value = true;
            } else {
              phoneError.value = "手机号已被注册，请使用其他手机号";
            }

            return true;
          };

          // 确认密码验证
          const validateConfirmPassword = () => {
            confirmPasswordError.value = "";
            confirmPasswordSuccess.value = false;

            if (!registerForm.confirmPassword) {
              confirmPasswordError.value = "请确认密码";
              return false;
            }

            if (registerForm.password !== registerForm.confirmPassword) {
              confirmPasswordError.value = "两次输入的密码不一致";
              return false;
            }

            confirmPasswordSuccess.value = true;
            return true;
          };

          // 发送验证码
          const sendVerificationCode = () => {
            if (!canSendCode.value) {
              ElMessage.warning("请先完善邮箱和手机号信息");
              return;
            }

            verificationCountdown.value = 60;
            verificationSent.value = true;
            verificationError.value = "";

            ElMessage.success(`验证码已发送至您的手机号 ${maskedPhone.value}`);

            // 倒计时
            const timer = setInterval(() => {
              verificationCountdown.value--;
              if (verificationCountdown.value <= 0) {
                clearInterval(timer);
              }
            }, 1000);
          };

          // 注册处理
          const handleRegister = async () => {
            if (!formRef.value) return;

            try {
              const valid = await formRef.value.validate();
              if (!valid) return;

              loading.value = true;

              // 模拟注册API调用
              await new Promise((resolve) => setTimeout(resolve, 2000));

              // 模拟注册结果
              if (Math.random() > 0.1) {
                // 90% 成功率
                ElMessage.success("注册成功！请登录您的账户");

                // 跳转到登录页面
                setTimeout(() => {
                  // 检查是否在iframe中
                  if (window.parent !== window) {
                    window.parent.postMessage(
                      {
                        type: "navigate",
                        path: "auth/login",
                      },
                      "*"
                    );
                  } else {
                    // 直接跳转（用于独立访问）
                    window.location.href = "登录.html";
                  }
                }, 1000);
              } else {
                ElMessage.error("注册失败，请重试");
              }
            } catch (error) {
              ElMessage.error("注册失败，请重试");
            } finally {
              loading.value = false;
            }
          };

          // 返回登录
          const handleLogin = () => {
            // 检查是否在iframe中
            if (window.parent !== window) {
              window.parent.postMessage(
                {
                  type: "navigate",
                  path: "auth/login",
                },
                "*"
              );
            } else {
              // 直接跳转（用于独立访问）
              window.location.href = "登录.html";
            }
          };

          return {
            registerForm,
            loading,
            verificationCountdown,
            passwordStrength,
            usernameError,
            usernameSuccess,
            realNameError,
            realNameSuccess,
            emailError,
            emailSuccess,
            phoneError,
            phoneSuccess,
            passwordError,
            confirmPasswordError,
            confirmPasswordSuccess,
            verificationError,
            verificationSuccess,
            formRef,
            rules,
            departments,
            passwordStrengthClass,
            passwordStrengthText,
            canSendCode,
            maskedPhone,
            verificationSent,
            validateUsername,
            validateRealName,
            validateEmail,
            validatePhone,
            validateConfirmPassword,
            sendVerificationCode,
            handleRegister,
            handleLogin,
          };
        },
      })
        .use(ElementPlus)
        .mount("#app");
    </script>
  </body>
</html>
