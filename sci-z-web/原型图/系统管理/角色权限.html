<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>è§’è‰²æƒé™ç®¡ç† - é«˜æ ¡ç§‘ç ”é¡¹ç›®ç®¡ç†å¹³å°</title>
    <link rel="icon" href="../images/favicon.ico" type="image/x-icon" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/element-plus@2.3.14/dist/index.css"
    />
    <script src="https://unpkg.com/vue@3.2.47/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/element-plus@2.3.14"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue@2.3.1/dist/index.iife.js"></script>
    <link rel="stylesheet" href="../é€šç”¨è§„èŒƒ/æ ·å¼.css" />
    <style>
      .role-management-container {
        padding: 20px;
        background: #f7f9fc;
        min-height: calc(100vh - 56px);
      }

      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .page-title {
        font-size: 24px;
        font-weight: 600;
        color: #1e3a8a;
        margin: 0;
      }

      .content-card {
        background: #ffffff;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        border: 1px solid #e5e7eb;
      }

      /* Loading æ ·å¼ */
      .loading-container {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 60px 20px;
        color: #6b7280;
        font-size: 14px;
        gap: 12px;
      }

      .loading-container .el-icon {
        font-size: 24px;
      }

      /* è¡¨æ ¼æ ·å¼ */
      .table-wrapper {
        width: 100%;
        overflow-x: auto;
        margin-top: 20px;
      }

      .native-table {
        width: 100%;
        border-collapse: collapse;
        background: #ffffff;
        border-radius: 8px;
        overflow: hidden;
      }

      .native-table thead {
        background: #f8fafc;
      }

      .native-table th {
        padding: 14px 16px;
        text-align: left;
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        border-bottom: 2px solid #e5e7eb;
        white-space: nowrap;
      }

      .native-table tbody tr {
        transition: background-color 0.2s;
      }

      .native-table tbody tr:nth-child(even) {
        background: #f9fafb;
      }

      .native-table tbody tr:hover {
        background: #f0f9ff;
      }

      .native-table td {
        padding: 12px 16px;
        font-size: 14px;
        color: #4b5563;
        border-bottom: 1px solid #e5e7eb;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .native-table tbody tr:last-child td {
        border-bottom: none;
      }

      /* æ“ä½œæŒ‰é’® */
      .action-btns {
        display: flex;
        gap: 8px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .action-btn {
        padding: 5px 12px;
        border: 1px solid transparent;
        border-radius: 4px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s;
        background: none;
        white-space: nowrap;
      }

      .btn-primary {
        color: #1e3a8a;
        border-color: #1e3a8a;
      }

      .btn-primary:hover {
        background: #1e3a8a;
        color: #ffffff;
      }

      .btn-primary-plain {
        color: #1e3a8a;
        background: #f0f9ff;
        border-color: #bfdbfe;
      }

      .btn-primary-plain:hover {
        background: #dbeafe;
        border-color: #93c5fd;
      }

      .btn-danger {
        color: #dc2626;
        border-color: #dc2626;
      }

      .btn-danger:hover {
        background: #dc2626;
        color: #ffffff;
      }

      /* ç»Ÿä¸€å¼¹çª—æ ·å¼ - åœ†è§’è®¾è®¡ */
      .el-dialog {
        border-radius: 12px !important;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12) !important;
      }

      .el-dialog__header {
        padding: 20px 24px 16px 24px !important;
        border-bottom: 1px solid #f0f0f0 !important;
        background: #ffffff !important;
      }

      .el-dialog__title {
        font-size: 18px !important;
        font-weight: 600 !important;
        color: #1e3a8a !important;
      }

      .el-dialog__headerbtn {
        top: 20px !important;
        right: 20px !important;
        width: 24px !important;
        height: 24px !important;
      }

      .el-dialog__close {
        color: #9ca3af !important;
        font-size: 16px !important;
      }

      .el-dialog__close:hover {
        color: #6b7280 !important;
      }

      .el-dialog__body {
        padding: 20px 24px !important;
        max-height: 600px;
        overflow-y: auto;
      }

      .el-dialog__footer {
        padding: 16px 24px 20px 24px !important;
        border-top: 1px solid #f0f0f0 !important;
      }

      /* ç»Ÿä¸€ MessageBox æ ·å¼ */
      .el-message-box {
        border-radius: 12px !important;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12) !important;
      }

      .el-message-box__header {
        padding: 20px 24px 16px 24px !important;
        border-bottom: 1px solid #f0f0f0 !important;
        background: #ffffff !important;
      }

      .el-message-box__title {
        font-size: 16px !important;
        font-weight: 600 !important;
        color: #1e3a8a !important;
        line-height: 1.5 !important;
      }

      .el-message-box__headerbtn {
        top: 16px !important;
        right: 20px !important;
        width: 24px !important;
        height: 24px !important;
      }

      .el-message-box__close {
        color: #9ca3af !important;
        font-size: 16px !important;
      }

      .el-message-box__close:hover {
        color: #6b7280 !important;
      }

      .el-message-box__content {
        padding: 20px 24px !important;
        background: #ffffff !important;
      }

      .el-message-box__message {
        font-size: 14px !important;
        line-height: 1.6 !important;
        color: #374151 !important;
        margin: 0 !important;
        padding: 0 !important;
      }

      .el-message-box__btns {
        padding: 16px 24px 20px 24px !important;
        background: #ffffff !important;
        display: flex !important;
        justify-content: flex-end !important;
        gap: 12px !important;
      }

      /* ç°ä»£åŒ–æŒ‰é’®æ ·å¼ */
      .el-message-box__btns .el-button,
      .el-dialog__footer .el-button {
        padding: 8px 20px !important;
        border-radius: 8px !important;
        font-size: 14px !important;
        font-weight: 500 !important;
        border: 1px solid !important;
        transition: all 0.2s ease !important;
      }

      .el-message-box__btns .el-button--default,
      .el-dialog__footer .el-button--default {
        background: #ffffff !important;
        border-color: #d1d5db !important;
        color: #6b7280 !important;
      }

      .el-message-box__btns .el-button--default:hover,
      .el-dialog__footer .el-button--default:hover {
        background: #f9fafb !important;
        border-color: #9ca3af !important;
        color: #374151 !important;
      }

      .el-message-box__btns .el-button--primary,
      .el-dialog__footer .el-button--primary {
        background: #1e3a8a !important;
        border-color: #1e3a8a !important;
        color: #ffffff !important;
      }

      .el-message-box__btns .el-button--primary:hover,
      .el-dialog__footer .el-button--primary:hover {
        background: #1e40af !important;
        border-color: #1e40af !important;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
      }

      .el-message-box__btns .el-button--primary:active,
      .el-dialog__footer .el-button--primary:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(30, 58, 138, 0.3);
      }

      /* è­¦å‘Šç±»å‹å¼¹çª—çš„ç‰¹æ®Šæ ·å¼ */
      .el-message-box--warning .el-message-box__content {
        position: relative;
      }

      .el-message-box--warning .el-message-box__message::before {
        content: "âš ï¸";
        font-size: 18px !important;
        margin-right: 8px !important;
        vertical-align: -0.15em !important;
        display: inline-block !important;
      }

      /* è¡¨å•æ ·å¼ */
      .role-form .el-form-item {
        margin-bottom: 20px;
      }

      .role-form .el-form-item__label {
        font-weight: 500;
        color: #374151;
      }

      /* æƒé™æ ‘æ ·å¼ */
      .permission-tree-container {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px;
        max-height: 400px;
        overflow-y: auto;
        background: #f9fafb;
      }

      .permission-tree-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e5e7eb;
      }

      .permission-tree-header > span {
        color: #1e3a8a !important;
      }

      /* å½“å‰è§’è‰²æ–‡å­—é¢œè‰² */
      .el-dialog__body > div > strong {
        color: #1e3a8a !important;
      }

      /* é…ç½®æƒé™å¼¹çª—ä¸­çš„è§’è‰²åç§°é¢œè‰² */
      .el-dialog__body > div:first-child {
        color: #1e3a8a !important;
        font-weight: 600 !important;
      }

      /* æƒé™æ“ä½œæŒ‰é’®æ‚¬æµ®æ•ˆæœ */
      .permission-tree-header .el-button:hover {
        color: #1e3a8a !important;
        border-color: #1e3a8a !important;
      }

      .permission-tree-search {
        margin-bottom: 12px;
      }

      .el-tree {
        background: transparent !important;
      }

      /* æ ‘å½¢é€‰æ‹©æ¡†é€‰ä¸­çš„å¯¹å‹¾é¢œè‰² */
      .el-tree .el-checkbox__input.is-checked .el-checkbox__inner {
        background-color: #1e3a8a !important;
        border-color: #1e3a8a !important;
      }

      .el-tree .el-checkbox__input.is-indeterminate .el-checkbox__inner {
        background-color: #1e3a8a !important;
        border-color: #1e3a8a !important;
      }

      .el-tree-node__content {
        height: 32px;
        line-height: 32px;
        padding: 0 8px !important;
        border-radius: 4px;
      }

      .el-tree-node__content:hover {
        background: #e5e7eb;
      }

      .permission-node {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
      }

      .permission-icon {
        font-size: 14px;
        color: #6b7280;
      }

      .permission-label {
        font-size: 14px;
        color: #374151;
      }

      .permission-code {
        font-size: 12px;
        color: #9ca3af;
        margin-left: 8px;
      }

      /* åˆ†é¡µå®¹å™¨ */
      .pagination-wrapper {
        margin-top: 20px;
        display: flex;
        justify-content: flex-end;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="role-management-container">
        <!-- é¡µé¢å¤´éƒ¨ -->
        <div class="page-header">
          <h1 class="page-title">è§’è‰²æƒé™ç®¡ç†</h1>
          <el-button type="primary" @click="handleAdd">
            <el-icon><Plus /></el-icon>
            æ–°å»ºè§’è‰²
          </el-button>
        </div>

        <!-- å†…å®¹å¡ç‰‡ -->
        <div class="content-card">
          <!-- è§’è‰²åˆ—è¡¨è¡¨æ ¼ -->
          <div v-if="loading" class="loading-container">
            <el-icon class="is-loading"><Loading /></el-icon>
            <span>åŠ è½½ä¸­...</span>
          </div>

          <!-- åŸç”ŸHTMLè¡¨æ ¼ -->
          <div v-else class="table-wrapper">
            <table class="native-table">
              <thead>
                <tr>
                  <th style="width: 180px">è§’è‰²åç§°</th>
                  <th style="min-width: 250px">è§’è‰²æè¿°</th>
                  <th style="width: 120px">ç”¨æˆ·æ•°é‡</th>
                  <th style="width: 180px">åˆ›å»ºæ—¶é—´</th>
                  <th style="width: 300px">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="role in roles" :key="role.id">
                  <td>{{ role.name }}</td>
                  <td :title="role.description">{{ role.description }}</td>
                  <td style="text-align: center">{{ role.userCount }}</td>
                  <td style="text-align: center">{{ role.createTime }}</td>
                  <td>
                    <div class="action-btns">
                      <button
                        class="action-btn btn-primary"
                        @click="handleEdit(role)"
                      >
                        ç¼–è¾‘
                      </button>
                      <button
                        class="action-btn btn-primary-plain"
                        @click="handleConfigPermission(role)"
                      >
                        é…ç½®æƒé™
                      </button>
                      <button
                        class="action-btn btn-danger"
                        @click="handleDelete(role)"
                        :disabled="role.isSystem"
                        :style="role.isSystem ? 'opacity: 0.5; cursor: not-allowed' : ''"
                      >
                        åˆ é™¤
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- åˆ†é¡µ -->
          <div v-if="roles.length > 0" class="pagination-container">
            <!-- é€šç”¨åˆ†é¡µç»„ä»¶ -->
            <div id="pagination-component"></div>
          </div>
        </div>

        <!-- æ–°å»º/ç¼–è¾‘è§’è‰²å¯¹è¯æ¡† -->
        <el-dialog
          v-model="showRoleDialog"
          :title="editMode ? 'ç¼–è¾‘è§’è‰²' : 'æ–°å»ºè§’è‰²'"
          width="600px"
          @close="handleDialogClose"
        >
          <el-form
            :model="roleForm"
            :rules="roleRules"
            ref="roleFormRef"
            label-width="100px"
            class="role-form"
          >
            <el-form-item label="è§’è‰²åç§°" prop="name">
              <el-input v-model="roleForm.name" placeholder="è¯·è¾“å…¥è§’è‰²åç§°" />
            </el-form-item>

            <el-form-item label="è§’è‰²æè¿°" prop="description">
              <el-input
                v-model="roleForm.description"
                type="textarea"
                :rows="3"
                placeholder="è¯·è¾“å…¥è§’è‰²æè¿°"
              />
            </el-form-item>

            <el-form-item label="è§’è‰²ç±»å‹" prop="type">
              <el-select
                v-model="roleForm.type"
                placeholder="è¯·é€‰æ‹©è§’è‰²ç±»å‹"
                style="width: 100%"
              >
                <el-option label="ç³»ç»Ÿè§’è‰²" value="system" />
                <el-option label="ä¸šåŠ¡è§’è‰²" value="business" />
                <el-option label="è‡ªå®šä¹‰è§’è‰²" value="custom" />
              </el-select>
            </el-form-item>
          </el-form>

          <template #footer>
            <el-button @click="showRoleDialog = false">å–æ¶ˆ</el-button>
            <el-button type="primary" @click="handleSubmit" :loading="saving">
              ç¡®å®š
            </el-button>
          </template>
        </el-dialog>

        <!-- é…ç½®æƒé™å¯¹è¯æ¡† -->
        <el-dialog
          v-model="showPermissionDialog"
          title="é…ç½®æƒé™"
          width="700px"
          @close="handlePermissionDialogClose"
        >
          <div style="margin-bottom: 16px">
            <strong>å½“å‰è§’è‰²ï¼š</strong>{{ currentRole.name }}
          </div>

          <div class="permission-tree-container">
            <div class="permission-tree-header">
              <span style="font-weight: 600; color: #374151">æƒé™åˆ—è¡¨</span>
              <div>
                <el-button size="small" @click="handleExpandAll">
                  å…¨éƒ¨å±•å¼€
                </el-button>
                <el-button size="small" @click="handleCollapseAll">
                  å…¨éƒ¨æ”¶èµ·
                </el-button>
                <el-button size="small" @click="handleCheckAll">
                  å…¨é€‰
                </el-button>
                <el-button size="small" @click="handleClearCheck">
                  æ¸…ç©º
                </el-button>
              </div>
            </div>

            <div class="permission-tree-search">
              <el-input
                v-model="permissionSearchKeyword"
                placeholder="æœç´¢æƒé™åç§°"
                clearable
              >
                <template #prefix>
                  <el-icon><Search /></el-icon>
                </template>
              </el-input>
            </div>

            <el-tree
              ref="permissionTreeRef"
              :data="permissionTree"
              :props="treeProps"
              show-checkbox
              node-key="id"
              :default-checked-keys="checkedKeys"
              :filter-node-method="filterNode"
            >
              <template #default="{ node, data }">
                <div class="permission-node">
                  <span class="permission-icon">
                    {{ getPermissionIcon(data.type) }}
                  </span>
                  <span class="permission-label">{{ node.label }}</span>
                  <span class="permission-code">{{ data.code }}</span>
                </div>
              </template>
            </el-tree>
          </div>

          <template #footer>
            <el-button @click="showPermissionDialog = false">å–æ¶ˆ</el-button>
            <el-button
              type="primary"
              @click="handleSavePermission"
              :loading="saving"
            >
              ä¿å­˜
            </el-button>
          </template>
        </el-dialog>
      </div>
    </div>

    <script>
      const { createApp, ref, reactive, computed, watch, onMounted } = Vue;
      const { ElMessage, ElMessageBox } = ElementPlus;
      const { Plus, Search } = ElementPlusIconsVue;

      const app = createApp({
        components: {
          Plus,
          Search,
        },
        setup() {
          const roleFormRef = ref();
          const permissionTreeRef = ref();
          const loading = ref(false);
          const saving = ref(false);
          const showRoleDialog = ref(false);
          const showPermissionDialog = ref(false);
          const editMode = ref(false);
          const permissionSearchKeyword = ref("");

          // åˆ†é¡µ
          const pagination = reactive({
            current: 1,
            size: 10,
            total: 0,
          });

          // è¡Œä¸šé…ç½®
          const industryConfig = ref({
            industryType: "education",
            industryName: "æ•™è‚²è¡Œä¸š",
            departmentLabel: "æ‰€å±é™¢ç³»",
            roleLabel: "è§’è‰²",
            employeeIdLabel: "å­¦å·¥å·",
          });

          // è§’è‰²åˆ—è¡¨æ•°æ® - åŠ¨æ€åŠ è½½
          const roles = ref([]);

          // åŠ è½½è¡Œä¸šé…ç½®
          const loadIndustryConfig = async () => {
            try {
              const response = await fetch("/api/industry-config/current");
              const data = await response.json();
              industryConfig.value = data;
            } catch (error) {
              console.log("ä½¿ç”¨é»˜è®¤æ•™è‚²è¡Œä¸šé…ç½®");
            }
          };

          // åŠ è½½è§’è‰²åˆ—è¡¨
          const loadRoles = async () => {
            try {
              const response = await fetch(
                `/api/roles?industry=${industryConfig.value.industryType}`
              );
              const data = await response.json();
              roles.value = data;
            } catch (error) {
              // ä½¿ç”¨é»˜è®¤æ•™è‚²è¡Œä¸šæ•°æ®
              roles.value = [
                {
                  id: 1,
                  name: "ç³»ç»Ÿç®¡ç†å‘˜",
                  description: "æ‹¥æœ‰ç³»ç»Ÿæ‰€æœ‰æƒé™çš„è¶…çº§ç®¡ç†å‘˜",
                  type: "system",
                  userCount: 2,
                  createTime: "2024-01-01 10:00:00",
                  isSystem: true,
                },
                {
                  id: 2,
                  name: "æ•™å¸ˆ",
                  description: "å¯ä»¥åˆ›å»ºå’Œç®¡ç†é¡¹ç›®ã€ç”³æŠ¥ç§‘ç ”é¡¹ç›®",
                  type: "business",
                  userCount: 25,
                  createTime: "2024-01-05 14:30:00",
                  isSystem: false,
                },
                {
                  id: 3,
                  name: "å­¦ç”Ÿ",
                  description: "å¯ä»¥å‚ä¸é¡¹ç›®ã€æŸ¥çœ‹é¡¹ç›®ä¿¡æ¯",
                  type: "business",
                  userCount: 150,
                  createTime: "2024-01-05 14:35:00",
                  isSystem: false,
                },
                {
                  id: 4,
                  name: "å®¡æ ¸å‘˜",
                  description: "è´Ÿè´£å®¡æ ¸é¡¹ç›®ç”³æŠ¥å’ŒéªŒæ”¶",
                  type: "custom",
                  userCount: 5,
                  createTime: "2024-02-10 09:00:00",
                  isSystem: false,
                },
              ];
            }
          };

          // è§’è‰²è¡¨å•
          const roleForm = reactive({
            id: null,
            name: "",
            description: "",
            type: "",
          });

          // è¡¨å•éªŒè¯è§„åˆ™
          const roleRules = {
            name: [
              { required: true, message: "è¯·è¾“å…¥è§’è‰²åç§°", trigger: "blur" },
            ],
            description: [
              { required: true, message: "è¯·è¾“å…¥è§’è‰²æè¿°", trigger: "blur" },
            ],
            type: [
              { required: true, message: "è¯·é€‰æ‹©è§’è‰²ç±»å‹", trigger: "change" },
            ],
          };

          // å½“å‰ç¼–è¾‘çš„è§’è‰²
          const currentRole = ref({});

          // æƒé™æ ‘æ•°æ® - åŠ¨æ€åŠ è½½
          const permissionTree = ref([]);

          // åŠ è½½æƒé™æ ‘
          const loadPermissionTree = async () => {
            try {
              const response = await fetch(
                `/api/permissions/tree?industry=${industryConfig.value.industryType}`
              );
              const data = await response.json();
              permissionTree.value = data;
            } catch (error) {
              // ä½¿ç”¨é»˜è®¤æ•™è‚²è¡Œä¸šæƒé™æ•°æ®
              permissionTree.value = [
                {
                  id: 1,
                  label: "ç³»ç»Ÿç®¡ç†",
                  code: "menu:system",
                  type: "menu",
                  children: [
                    {
                      id: 11,
                      label: "ç”¨æˆ·ç®¡ç†",
                      code: "menu:system:user",
                      type: "menu",
                      children: [
                        {
                          id: 111,
                          label: "æŸ¥çœ‹ç”¨æˆ·",
                          code: "btn:system:user:view",
                          type: "button",
                        },
                        {
                          id: 112,
                          label: "æ–°å»ºç”¨æˆ·",
                          code: "btn:system:user:add",
                          type: "button",
                        },
                        {
                          id: 113,
                          label: "ç¼–è¾‘ç”¨æˆ·",
                          code: "btn:system:user:edit",
                          type: "button",
                        },
                        {
                          id: 114,
                          label: "åˆ é™¤ç”¨æˆ·",
                          code: "btn:system:user:delete",
                          type: "button",
                        },
                      ],
                    },
                    {
                      id: 12,
                      label: "è§’è‰²æƒé™",
                      code: "menu:system:role",
                      type: "menu",
                      children: [
                        {
                          id: 121,
                          label: "æŸ¥çœ‹è§’è‰²",
                          code: "btn:system:role:view",
                          type: "button",
                        },
                        {
                          id: 122,
                          label: "é…ç½®æƒé™",
                          code: "btn:system:role:permission",
                          type: "button",
                        },
                      ],
                    },
                  ],
                },
                {
                  id: 2,
                  label: "é¡¹ç›®ç®¡ç†",
                  code: "menu:project",
                  type: "menu",
                  children: [
                    {
                      id: 21,
                      label: "é¡¹ç›®åˆ—è¡¨",
                      code: "menu:project:list",
                      type: "menu",
                      children: [
                        {
                          id: 211,
                          label: "æŸ¥çœ‹é¡¹ç›®",
                          code: "btn:project:view",
                          type: "button",
                        },
                        {
                          id: 212,
                          label: "æ–°å»ºé¡¹ç›®",
                          code: "btn:project:add",
                          type: "button",
                        },
                        {
                          id: 213,
                          label: "ç¼–è¾‘é¡¹ç›®",
                          code: "btn:project:edit",
                          type: "button",
                        },
                        {
                          id: 214,
                          label: "åˆ é™¤é¡¹ç›®",
                          code: "btn:project:delete",
                          type: "button",
                        },
                      ],
                    },
                  ],
                },
                {
                  id: 3,
                  label: "ç”³æŠ¥ç®¡ç†",
                  code: "menu:declare",
                  type: "menu",
                  children: [
                    {
                      id: 31,
                      label: "ç”³æŠ¥åˆ—è¡¨",
                      code: "menu:declare:list",
                      type: "menu",
                      children: [
                        {
                          id: 311,
                          label: "æŸ¥çœ‹ç”³æŠ¥",
                          code: "btn:declare:view",
                          type: "button",
                        },
                        {
                          id: 312,
                          label: "æ–°å»ºç”³æŠ¥",
                          code: "btn:declare:add",
                          type: "button",
                        },
                        {
                          id: 313,
                          label: "å®¡æ ¸ç”³æŠ¥",
                          code: "btn:declare:audit",
                          type: "button",
                        },
                      ],
                    },
                  ],
                },
                {
                  id: 4,
                  label: "éªŒæ”¶ç®¡ç†",
                  code: "menu:acceptance",
                  type: "menu",
                  children: [
                    {
                      id: 41,
                      label: "æŠ¥å‘Šåˆ—è¡¨",
                      code: "menu:acceptance:report",
                      type: "menu",
                      children: [
                        {
                          id: 411,
                          label: "æŸ¥çœ‹æŠ¥å‘Š",
                          code: "btn:acceptance:view",
                          type: "button",
                        },
                        {
                          id: 412,
                          label: "ç”ŸæˆæŠ¥å‘Š",
                          code: "btn:acceptance:generate",
                          type: "button",
                        },
                      ],
                    },
                  ],
                },
                {
                  id: 5,
                  label: "ç”¨æˆ·ä¸­å¿ƒ",
                  code: "menu:user",
                  type: "menu",
                  children: [
                    {
                      id: 51,
                      label: "ä¸ªäººä¿¡æ¯",
                      code: "menu:user:profile",
                      type: "menu",
                    },
                    {
                      id: 52,
                      label: "å®‰å…¨è®¾ç½®",
                      code: "menu:user:security",
                      type: "menu",
                    },
                  ],
                },
              ];
            }
          };

          // æ ‘å±æ€§é…ç½®
          const treeProps = {
            label: "label",
            children: "children",
          };

          // å·²é€‰ä¸­çš„æƒé™
          const checkedKeys = ref([]);

          // è·å–æƒé™å›¾æ ‡
          const getPermissionIcon = (type) => {
            const iconMap = {
              menu: "ğŸ“",
              button: "ğŸ”˜",
              data: "ğŸ“Š",
              api: "ğŸ”Œ",
            };
            return iconMap[type] || "ğŸ“„";
          };

          // è¿‡æ»¤èŠ‚ç‚¹
          const filterNode = (value, data) => {
            if (!value) return true;
            return (
              data.label.toLowerCase().includes(value.toLowerCase()) ||
              data.code.toLowerCase().includes(value.toLowerCase())
            );
          };

          // ç›‘å¬æœç´¢å…³é”®è¯
          watch(permissionSearchKeyword, (val) => {
            permissionTreeRef.value?.filter(val);
          });

          // æ–°å»ºè§’è‰²
          const handleAdd = () => {
            editMode.value = false;
            resetForm();
            showRoleDialog.value = true;
          };

          // ç¼–è¾‘è§’è‰²
          const handleEdit = (role) => {
            editMode.value = true;
            Object.assign(roleForm, { ...role });
            showRoleDialog.value = true;
          };

          // é…ç½®æƒé™
          const handleConfigPermission = (role) => {
            currentRole.value = { ...role };
            // æ¨¡æ‹ŸåŠ è½½è¯¥è§’è‰²çš„æƒé™
            checkedKeys.value =
              role.id === 1
                ? [
                    111, 112, 113, 114, 121, 122, 211, 212, 213, 214, 311, 312,
                    313, 411, 412,
                  ]
                : [211, 311];
            showPermissionDialog.value = true;
          };

          // åˆ é™¤è§’è‰²
          const handleDelete = async (role) => {
            if (role.isSystem) {
              ElMessage.warning("ç³»ç»Ÿè§’è‰²ä¸å¯åˆ é™¤");
              return;
            }

            try {
              await ElMessageBox.confirm(
                `ç¡®å®šè¦åˆ é™¤è§’è‰² "${role.name}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`,
                "åˆ é™¤è§’è‰²",
                {
                  confirmButtonText: "ç¡®å®š",
                  cancelButtonText: "å–æ¶ˆ",
                  type: "warning",
                }
              );
              const index = roles.value.findIndex((r) => r.id === role.id);
              if (index > -1) {
                roles.value.splice(index, 1);
              }
              ElMessage.success("åˆ é™¤æˆåŠŸ");
            } catch (error) {
              // ç”¨æˆ·å–æ¶ˆ
            }
          };

          // æäº¤è¡¨å•
          const handleSubmit = async () => {
            try {
              await roleFormRef.value.validate();
              saving.value = true;

              // æ¨¡æ‹Ÿä¿å­˜
              await new Promise((resolve) => setTimeout(resolve, 1000));

              if (editMode.value) {
                // ç¼–è¾‘æ¨¡å¼
                const index = roles.value.findIndex(
                  (r) => r.id === roleForm.id
                );
                if (index > -1) {
                  Object.assign(roles.value[index], { ...roleForm });
                }
                ElMessage.success("è§’è‰²ä¿¡æ¯æ›´æ–°æˆåŠŸ");
              } else {
                // æ–°å»ºæ¨¡å¼
                roles.value.push({
                  ...roleForm,
                  id: Date.now(),
                  userCount: 0,
                  createTime: new Date().toLocaleString("zh-CN"),
                  isSystem: false,
                });
                ElMessage.success("è§’è‰²åˆ›å»ºæˆåŠŸ");
              }

              saving.value = false;
              showRoleDialog.value = false;
            } catch (error) {
              saving.value = false;
              if (error !== "cancel") {
                ElMessage.error("è¯·å®Œå–„è¡¨å•ä¿¡æ¯");
              }
            }
          };

          // ä¿å­˜æƒé™
          const handleSavePermission = async () => {
            saving.value = true;

            // è·å–é€‰ä¸­çš„æƒé™
            const checkedNodes = permissionTreeRef.value.getCheckedKeys();
            console.log("å·²é€‰ä¸­çš„æƒé™ï¼š", checkedNodes);

            // æ¨¡æ‹Ÿä¿å­˜
            await new Promise((resolve) => setTimeout(resolve, 1000));

            ElMessage.success("æƒé™é…ç½®ä¿å­˜æˆåŠŸ");
            saving.value = false;
            showPermissionDialog.value = false;
          };

          // å±•å¼€æ‰€æœ‰èŠ‚ç‚¹
          const handleExpandAll = () => {
            const expandAllNodes = (nodes) => {
              nodes.forEach((node) => {
                permissionTreeRef.value.store.nodesMap[node.id].expanded = true;
                if (node.children && node.children.length > 0) {
                  expandAllNodes(node.children);
                }
              });
            };
            expandAllNodes(permissionTree.value);
          };

          // æ”¶èµ·æ‰€æœ‰èŠ‚ç‚¹
          const handleCollapseAll = () => {
            const collapseAllNodes = (nodes) => {
              nodes.forEach((node) => {
                permissionTreeRef.value.store.nodesMap[
                  node.id
                ].expanded = false;
                if (node.children && node.children.length > 0) {
                  collapseAllNodes(node.children);
                }
              });
            };
            collapseAllNodes(permissionTree.value);
          };

          // å…¨é€‰
          const handleCheckAll = () => {
            const getAllKeys = (nodes) => {
              let keys = [];
              nodes.forEach((node) => {
                keys.push(node.id);
                if (node.children && node.children.length > 0) {
                  keys = keys.concat(getAllKeys(node.children));
                }
              });
              return keys;
            };
            permissionTreeRef.value.setCheckedKeys(
              getAllKeys(permissionTree.value)
            );
          };

          // æ¸…ç©º
          const handleClearCheck = () => {
            permissionTreeRef.value.setCheckedKeys([]);
          };

          // é‡ç½®è¡¨å•
          const resetForm = () => {
            Object.assign(roleForm, {
              id: null,
              name: "",
              description: "",
              type: "",
            });
            if (roleFormRef.value) {
              roleFormRef.value.resetFields();
            }
          };

          // å¯¹è¯æ¡†å…³é—­
          const handleDialogClose = () => {
            resetForm();
          };

          // æƒé™å¯¹è¯æ¡†å…³é—­
          const handlePermissionDialogClose = () => {
            currentRole.value = {};
            checkedKeys.value = [];
            permissionSearchKeyword.value = "";
          };

          // åˆå§‹åŒ–åˆ†é¡µç»„ä»¶
          const initPagination = () => {
            const paginationContainer = document.getElementById(
              "pagination-component"
            );
            if (paginationContainer) {
              // åˆ›å»ºåˆ†é¡µç»„ä»¶HTML
              const paginationHTML = `
                <div class="pagination-wrapper">
                  <!-- æ€»æ•°ä¿¡æ¯ -->
                  <div class="pagination-info">
                    å…± ${pagination.total} æ¡è®°å½•
                  </div>

                  <!-- æ¯é¡µæ˜¾ç¤ºæ•°é‡ -->
                  <div class="page-size-selector">
                    æ¯é¡µæ˜¾ç¤º
                    <select id="page-size-select" class="page-size-select">
                      <option value="10" ${
                        pagination.size === 10 ? "selected" : ""
                      }>10</option>
                      <option value="20" ${
                        pagination.size === 20 ? "selected" : ""
                      }>20</option>
                      <option value="50" ${
                        pagination.size === 50 ? "selected" : ""
                      }>50</option>
                      <option value="100" ${
                        pagination.size === 100 ? "selected" : ""
                      }>100</option>
                    </select>
                    æ¡
                  </div>

                  <!-- åˆ†é¡µæ§åˆ¶å™¨ -->
                  <div class="pagination-controls">
                    <!-- ä¸Šä¸€é¡µæŒ‰é’® -->
                    <a href="javascript:void(0)" class="page-btn ${
                      pagination.current === 1 ? "disabled" : ""
                    }" id="prev-btn">
                      ä¸Šä¸€é¡µ
                    </a>

                    <!-- é¡µç æŒ‰é’® -->
                    <div class="page-nav" id="page-nav">
                      ${generatePageButtons()}
                    </div>

                    <!-- ä¸‹ä¸€é¡µæŒ‰é’® -->
                    <a href="javascript:void(0)" class="page-btn ${
                      pagination.current ===
                      Math.ceil(pagination.total / pagination.size)
                        ? "disabled"
                        : ""
                    }" id="next-btn">
                      ä¸‹ä¸€é¡µ
                    </a>
                  </div>

                  <!-- å¿«é€Ÿè·³è½¬ -->
                  <div class="page-jumper">
                    è·³è‡³
                    <input type="number" id="jump-input" value="${
                      pagination.current
                    }" min="1" max="${Math.ceil(
                pagination.total / pagination.size
              )}">
                    é¡µ
                    <button class="jump-btn" id="jump-btn">ç¡®å®š</button>
                  </div>
                </div>
              `;

              paginationContainer.innerHTML = paginationHTML;

              // ç»‘å®šäº‹ä»¶
              bindPaginationEvents();
            }
          };

          // ç”Ÿæˆé¡µç æŒ‰é’®
          const generatePageButtons = () => {
            const totalPages = Math.ceil(pagination.total / pagination.size);
            const current = pagination.current;
            const pagerCount = 7; // æ˜¾ç¤ºçš„é¡µç æ•°é‡

            let buttons = "";

            if (totalPages <= pagerCount) {
              // æ€»é¡µæ•°å°äºç­‰äºæ˜¾ç¤ºæ•°é‡ï¼Œæ˜¾ç¤ºæ‰€æœ‰é¡µç 
              for (let i = 1; i <= totalPages; i++) {
                buttons += `<a href="javascript:void(0)" class="page-btn ${
                  i === current ? "active" : ""
                }" data-page="${i}">${i}</a>`;
              }
            } else {
              // è®¡ç®—ä¸­é—´é¡µç èŒƒå›´
              const half = Math.floor(pagerCount / 2);
              let start = Math.max(1, current - half);
              let end = Math.min(totalPages, start + pagerCount - 1);

              // è°ƒæ•´èµ·å§‹ä½ç½®
              if (end - start + 1 < pagerCount) {
                start = Math.max(1, end - pagerCount + 1);
              }

              // ç¬¬ä¸€é¡µ
              if (start > 1) {
                buttons += `<a href="javascript:void(0)" class="page-btn ${
                  1 === current ? "active" : ""
                }" data-page="1">1</a>`;
                if (start > 2) {
                  buttons += '<span class="page-ellipsis">...</span>';
                }
              }

              // ä¸­é—´é¡µç 
              for (let i = start; i <= end; i++) {
                buttons += `<a href="javascript:void(0)" class="page-btn ${
                  i === current ? "active" : ""
                }" data-page="${i}">${i}</a>`;
              }

              // æœ€åä¸€é¡µ
              if (end < totalPages) {
                if (end < totalPages - 1) {
                  buttons += '<span class="page-ellipsis">...</span>';
                }
                buttons += `<a href="javascript:void(0)" class="page-btn ${
                  totalPages === current ? "active" : ""
                }" data-page="${totalPages}">${totalPages}</a>`;
              }
            }

            return buttons;
          };

          // ç»‘å®šåˆ†é¡µäº‹ä»¶
          const bindPaginationEvents = () => {
            // æ¯é¡µæ˜¾ç¤ºæ•°é‡å˜åŒ–
            const pageSizeSelect = document.getElementById("page-size-select");
            if (pageSizeSelect) {
              pageSizeSelect.addEventListener("change", (e) => {
                pagination.size = parseInt(e.target.value);
                pagination.current = 1;
                initPagination();
              });
            }

            // ä¸Šä¸€é¡µ
            const prevBtn = document.getElementById("prev-btn");
            if (prevBtn) {
              prevBtn.addEventListener("click", () => {
                if (pagination.current > 1) {
                  pagination.current--;
                  initPagination();
                }
              });
            }

            // ä¸‹ä¸€é¡µ
            const nextBtn = document.getElementById("next-btn");
            if (nextBtn) {
              nextBtn.addEventListener("click", () => {
                const totalPages = Math.ceil(
                  pagination.total / pagination.size
                );
                if (pagination.current < totalPages) {
                  pagination.current++;
                  initPagination();
                }
              });
            }

            // é¡µç ç‚¹å‡»
            const pageNav = document.getElementById("page-nav");
            if (pageNav) {
              pageNav.addEventListener("click", (e) => {
                if (
                  e.target.classList.contains("page-btn") &&
                  !e.target.classList.contains("active")
                ) {
                  const page = parseInt(e.target.getAttribute("data-page"));
                  if (page) {
                    pagination.current = page;
                    initPagination();
                  }
                }
              });
            }

            // å¿«é€Ÿè·³è½¬
            const jumpBtn = document.getElementById("jump-btn");
            const jumpInput = document.getElementById("jump-input");
            if (jumpBtn && jumpInput) {
              jumpBtn.addEventListener("click", () => {
                const page = parseInt(jumpInput.value);
                const totalPages = Math.ceil(
                  pagination.total / pagination.size
                );
                if (page >= 1 && page <= totalPages) {
                  pagination.current = page;
                  initPagination();
                } else {
                  ElMessage.warning("è¯·è¾“å…¥æœ‰æ•ˆçš„é¡µç ");
                }
              });

              // å›è½¦è·³è½¬
              jumpInput.addEventListener("keyup", (e) => {
                if (e.key === "Enter") {
                  jumpBtn.click();
                }
              });
            }
          };

          // é¡µé¢æŒ‚è½½ååˆå§‹åŒ–åˆ†é¡µ
          onMounted(async () => {
            // åŠ è½½è¡Œä¸šé…ç½®
            await loadIndustryConfig();
            // åŠ è½½è§’è‰²åˆ—è¡¨
            await loadRoles();
            // åŠ è½½æƒé™æ ‘
            await loadPermissionTree();

            pagination.total = roles.value.length;
            Vue.nextTick(() => {
              initPagination();
            });
          });

          return {
            roleFormRef,
            permissionTreeRef,
            loading,
            saving,
            showRoleDialog,
            showPermissionDialog,
            editMode,
            permissionSearchKeyword,
            industryConfig,
            roles,
            roleForm,
            roleRules,
            currentRole,
            permissionTree,
            treeProps,
            checkedKeys,
            getPermissionIcon,
            filterNode,
            handleAdd,
            handleEdit,
            handleConfigPermission,
            handleDelete,
            handleSubmit,
            handleSavePermission,
            handleExpandAll,
            handleCollapseAll,
            handleCheckAll,
            handleClearCheck,
            handleDialogClose,
            handlePermissionDialogClose,
            loadIndustryConfig,
            loadRoles,
            loadPermissionTree,
          };
        },
      });

      // æ³¨å†Œ Element Plus Icons
      for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
        app.component(key, component);
      }

      // é…ç½® Element Plus ä¸­æ–‡
      app.use(ElementPlus, {
        locale: {
          name: "zh-cn",
          el: {
            datepicker: {
              now: "æ­¤åˆ»",
              today: "ä»Šå¤©",
              cancel: "å–æ¶ˆ",
              clear: "æ¸…ç©º",
              confirm: "ç¡®è®¤",
            },
          },
        },
      });

      app.mount("#app");
    </script>
  </body>
</html>
