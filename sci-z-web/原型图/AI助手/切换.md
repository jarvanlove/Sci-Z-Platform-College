# 原型版 ⇆ 真实版 切换与演示手册（AI 对话）

本文档用于指导在不改动整体页面结构的前提下，在“原型演示模式”和“真实大模型接入模式（SaaS API 或自部署 GPU）”之间快速切换，并说明不同 UI 展现（v-html 与非 v-html）的实现方式与建议。

---

## 1. 名词说明

- 原型版：不真实请求模型，使用本地“演示逻辑”模拟回复，用于早期交互评审。
- 真实版：前端直接调用大模型服务（优先流式）。支持两类后端：
  - SaaS：通义千问 DashScope（OpenAI 兼容）
  - 自部署：OpenAI 兼容服务（vLLM / LM Studio / Ollama / 其他代理）

> 注意：本仓库没有后端网关，仅前端直连。上线前请务必迁移到后端网关，避免泄露 API-Key。

---

## 2. 代码位置与核心开关

文件：`原型图/AI助手/AI对话.html`

关键配置（页面 `<head>` 中的 `<script>` 已内置）：

```js
window.LLM_CONFIG = {
  provider: "dashscope", // 'dashscope' | 'custom'
  apiKey: "<你的APIKey>", // 仅本地/演示用途
  baseUrl: "https://dashscope.aliyuncs.com/compatible-mode/v1",
  model: "qwen3-max",
  useStream: true, // 是否优先走流式（SSE）
};
```

适配器函数（已内置）：

- `streamLLM(messages, onDelta, options, signal)`: 流式（SSE）增量回调
- `callLLM(messages, options)`: 非流式一次性返回
- `transformCodeBlocks(text)`: 将三引号代码块统一转换为深色 `code-view` 块（非 v-html 直吐原样）

> 渲染策略：优先流式；若 CORS/网络失败自动降级到非流式。

---

## 3. 快速切换

### 3.1 切到“真实版（SaaS：通义千问）”

1. 在 `AI对话.html` 顶部配置中填入你的 API-Key：

```js
window.LLM_CONFIG.apiKey = "sk-...";
window.LLM_CONFIG.provider = "dashscope";
window.LLM_CONFIG.baseUrl = "https://dashscope.aliyuncs.com/compatible-mode/v1";
window.LLM_CONFIG.model = "qwen3-max";
window.LLM_CONFIG.useStream = true; // 推荐流式
```

2. 保存并刷新页面。
3. 发送消息：应看到“正在生成”→ 实时逐字出现 → 完成后自动美化代码块。

> 如果浏览器控制台出现 CORS 报错，页面会自动降级到非流式，但仍能得到完整结果。

### 3.2 切到“真实版（自部署 GPU）”

假设你起了一个 OpenAI 兼容端点（例如 vLLM/LM Studio/Ollama 代理）：

```js
window.LLM_CONFIG.provider = "custom";
window.LLM_CONFIG.baseUrl = "http://localhost:8000/v1"; // 你的 /v1 根路径
window.LLM_CONFIG.model = "your-local-model"; // 例如 "qwen2.5-7b"
window.LLM_CONFIG.apiKey = "test"; // 如服务不校验可随意填
window.LLM_CONFIG.useStream = true;
```

> 注意：
>
> - 需在本地端点开启 CORS 允许浏览器访问（或用本地代理 Nginx 增加 CORS 头）。
> - 统一走 `/v1/chat/completions`（OpenAI 兼容），前端无需改动其它逻辑。

### 3.3 切回“原型演示版”（不真实请求）

目前代码仍保留“演示逻辑”的函数段落（simulate 的演示分支）。如需彻底走演示：

1. 将 `window.LLM_CONFIG.useStream = false`，并在 `sendKbMessage/ simulate*` 里临时注释 LLM 调用，
2. 开启示例定时器（setTimeout）回填预置文本。

> 建议：仅在无网时使用演示模式；正常评审/验收请使用“真实版”。

---

## 4. 如何演示（标准流程）

1. 进入页面后，在输入框键入：“帮我写一段 Python 斐波那契”。
2. 发送后：
   - 出现“正在生成”气泡；
   - 如为流式，内容边输出边刷新；
   - 完成后，代码以深色 `code-view` 样式展示（非 v-html 原样直出）。
3. 再演示“表格/图表/混合内容”的识别：输入关键词 `表格`、`图表` 或较长问题，真实版会按 markdown 与代码块规范返回，前端做基础美化。

> 说明：当前未强依赖 markdown-it/highlight.js（可按需追加）。已经内置 `transformCodeBlocks`，能把三引号代码块变为深色等宽体可复制区域。

---

## 5. 非 v-html 的真实 UI 展现（建议）

目标：避免直接 `v-html` 注入原文导致样式不统一与安全风险。推荐：

1. 保持“安全回退”：文本 → DOMPurify 清洗的 `v-html`。
2. 代码块：统一三引号识别 → 构造成：

```html
<div class="code-view">
  <pre><code>...转义后的代码...</code></pre>
</div>
```

3. 表格：
   - markdown 表格 → 可继续 `v-html` 渲染（已清洗），或将表格解析为列/行后用 `ElTable` 渲染（更真实）。
4. 图/结构化：
   - 若模型返回 JSON 指令（未来可以约定），前端用 ECharts/卡片组件渲染；
   - 当前阶段保留简化“迷你条形图”演示样式，后续替换为 ECharts。

> 真实开发阶段，建议加上 `markdown-it + highlight.js + katex`，并将代码块走语法高亮组件；本文档提供的是“无依赖、可立即看的最小可用方案”。

---

## 6. 自部署大模型的注意事项

1. 选择：vLLM / Text-Generation-Inference / LM Studio / Ollama / OpenAI 代理网关均可，**保证 OpenAI 兼容**。
2. CORS：开放 `Access-Control-Allow-Origin`、`Headers` 等，或通过 Nginx 反向代理添加 CORS。
3. SSE：确认 `/v1/chat/completions` 支持 `stream: true` 并以 `data: {...}` 分块返回。
4. 鉴权：如不校验可填假 Key；若校验，按 `Authorization: Bearer <key>` 处理。
5. 稳定性：建议还是加一个后端网关统一做超时/重试/限流/审计，前端只与网关交互。

---

## 7. 安全与上线建议

- 前端直连 Key 仅限**本地演示**；上线必须移除，改为后端网关透传。
- 统一协议：建议在网关层将模型的原始返回转为：`{contentType, content|payload}`，避免前端到处判断字符串格式。
- 日志/审计：模型调用参数与响应（脱敏后）应在后端记录，方便排障与成本统计。

---

## 8. 常见问题（FAQ）

**Q1：为什么没有流式？**  
A：浏览器 CORS 或网络限制会导致 SSE 失败，前端会自动降级为非流式。可查看控制台报错并配置服务端 CORS。

**Q2：代码块样式不好看？**  
A：已内置 `transformCodeBlocks` 将三引号代码块转为深色 `code-view`。若需语法高亮，请在真实开发阶段接入 `highlight.js`。

**Q3：如何快速切换不同模型？**  
A：修改 `window.LLM_CONFIG.model` 并刷新。若是自部署，请同时改 `baseUrl`、`provider` 和 `apiKey`。

**Q4：如何仅做演示，不访问外网？**  
A：将 `useStream=false` 并在 `simulate*` 函数中启用预置文本的 setTimeout 逻辑（原型保留）。

---

## 9. 开发阶段建议的落地清单

1. 新建后端网关：鉴权、限流、日志、QPS、重试、超时、SSE 代理。
2. 规范模型返回：统一 `{ contentType, content|payload }`，避免前端解析字符串。
3. 前端接入：
   - `markdown-it + highlight.js + katex`（可选）
   - 代码块组件（复制、折叠、全屏）
   - 表格组件（ElTable/虚拟滚动）
   - 图表组件（Vue-ECharts）
4. 文件/知识库管道：上传、RAG 检索、引用（citations）。

---

## 10. 变更记录

- v0.1 初稿：
  - 补充真实接入切换、演示流程、非 v-html 展现策略、自部署注意事项。
