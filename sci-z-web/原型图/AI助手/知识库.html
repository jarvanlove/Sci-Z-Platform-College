<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>知识库搜索 - Sci-Z Platform 高校科研管理平台</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue/dist/index.iife.js"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/element-plus/dist/index.css"
    />
    <!-- 多类型内容渲染库 -->
    <script src="https://unpkg.com/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <script src="https://unpkg.com/highlight.js@11.9.0/lib/core.min.js"></script>
    <script src="https://unpkg.com/highlight.js@11.9.0/lib/languages/javascript.min.js"></script>
    <script src="https://unpkg.com/highlight.js@11.9.0/lib/languages/python.min.js"></script>
    <script src="https://unpkg.com/highlight.js@11.9.0/lib/languages/sql.min.js"></script>
    <script src="https://unpkg.com/highlight.js@11.9.0/lib/languages/json.min.js"></script>
    <script src="https://unpkg.com/highlight.js@11.9.0/lib/languages/xml.min.js"></script>
    <script src="https://unpkg.com/highlight.js@11.9.0/lib/languages/css.min.js"></script>
    <script src="https://unpkg.com/highlight.js@11.9.0/lib/languages/bash.min.js"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/highlight.js@11.9.0/styles/github.min.css"
    />
    <script src="https://unpkg.com/dompurify@3.0.8/dist/purify.min.js"></script>
    <script src="https://unpkg.com/echarts@5.4.3/dist/echarts.min.js"></script>
    <script>
      // LLM 配置（仅原型，勿提交到生产）
      window.LLM_CONFIG = {
        provider: "dashscope", // 'dashscope' | 'custom'
        apiKey: "sk-62c7d519b9b543c7aa6215ef7190a7ed", // 仅测试用途
        baseUrl: "https://dashscope.aliyuncs.com/compatible-mode/v1",
        model: "qwen3-max",
        useStream: true, // 默认开启流式；若CORS失败会自动降级非流式
      };

      // 可切换为本地GPU（OpenAI兼容）
      // window.LLM_CONFIG = {
      //   provider: 'custom',
      //   apiKey: 'YOUR_LOCAL_KEY',
      //   baseUrl: 'http://localhost:8000/v1',
      //   model: 'your-local-model',
      //   useStream: true
      // };

      async function callLLM(messages, options = {}) {
        const cfg = Object.assign({}, window.LLM_CONFIG || {}, options);
        const url = `${cfg.baseUrl}/chat/completions`;
        const body = {
          model: cfg.model,
          messages: messages.map((m) => ({ role: m.role, content: m.content })),
          stream: false,
        };

        try {
          const resp = await fetch(url, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${cfg.apiKey}`,
            },
            body: JSON.stringify(body),
          });
          if (!resp.ok) {
            const text = await resp.text();
            throw new Error(`LLM请求失败: ${resp.status} ${text}`);
          }
          const data = await resp.json();
          // OpenAI兼容：data.choices[0].message.content
          const content = data?.choices?.[0]?.message?.content || "";
          return normalizeLLMContent(content);
        } catch (e) {
          console.error("callLLM error", e);
          return {
            contentType: "text",
            content: `调用模型失败：${e.message || e}`,
          };
        }
      }

      // 流式SSE
      async function streamLLM(messages, onDelta, options = {}, abortSignal) {
        const cfg = Object.assign({}, window.LLM_CONFIG || {}, options);
        const url = `${cfg.baseUrl}/chat/completions`;
        const body = {
          model: cfg.model,
          messages: messages.map((m) => ({ role: m.role, content: m.content })),
          stream: true,
        };
        const resp = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${cfg.apiKey}`,
          },
          body: JSON.stringify(body),
          signal: abortSignal,
        });
        if (!resp.ok || !resp.body) {
          throw new Error(`流式请求失败: ${resp.status}`);
        }
        const reader = resp.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let buffer = "";
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          buffer += decoder.decode(value, { stream: true });
          const parts = buffer.split("\n\n");
          buffer = parts.pop() || ""; // 剩余不完整片段留在 buffer
          for (const chunk of parts) {
            const line = chunk.trim();
            if (!line) continue;
            // 处理多行，取 data: 开头
            const dataLine = line
              .split("\n")
              .find((l) => l.startsWith("data:"));
            if (!dataLine) continue;
            const data = dataLine.replace(/^data:\s*/, "");
            if (data === "[DONE]") continue;
            try {
              const json = JSON.parse(data);
              const delta = json?.choices?.[0]?.delta?.content || "";
              if (delta) onDelta(delta);
            } catch (e) {
              // 忽略解析错误
            }
          }
        }
      }

      // 将 ```lang\n...\n``` 转换为深色代码块
      function transformCodeBlocks(text) {
        if (!text) return "";
        return text.replace(/```(\w+)?\n([\s\S]*?)```/g, (m, lang, inner) => {
          const safe = inner.replace(/</g, "&lt;").replace(/>/g, "&gt;");
          return `<div class=\"code-view\"><pre><code>${safe}</code></pre></div>`;
        });
      }

      function normalizeLLMContent(text) {
        if (!text) return { contentType: "text", content: "" };
        // 简单识别代码块 ```lang\n...\n```
        const codeBlockMatch = text.match(/```(\w+)?\n[\s\S]*?```/);
        if (codeBlockMatch) {
          const full = codeBlockMatch[0];
          const lang = (codeBlockMatch[1] || "text").toLowerCase();
          const inner = full.replace(/```(\w+)?\n/, "").replace(/```$/, "");
          return {
            contentType: "code",
            payload: { language: lang, content: inner },
          };
        }
        // 否则作为markdown文本（回退）
        return { contentType: "markdown", content: text };
      }
    </script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
          "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        background: #f7f9fc;
      }

      .knowledge-base-container {
        display: flex;
        height: 100vh;
        background: #f7f9fc;
        overflow: visible;
        position: relative;
      }

      /* 左侧导航栏 */
      .kb-list-sidebar {
        width: 280px;
        background: white;
        border-right: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .kb-list-header {
        padding: 14px 20px 14px 12px;
        border-bottom: 1px solid #f3f4f6;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .kb-header-title {
        font-size: 16px;
        font-weight: 600;
        color: #1e3a8a;
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 0;
      }

      .kb-header-actions {
        display: flex;
        gap: 8px;
      }

      .kb-section {
        margin-bottom: 24px;
        margin-top: 16px;
      }

      .kb-section-title {
        font-size: 14px;
        font-weight: 500;
        color: #6b7280;
        margin-bottom: 12px;
        margin-left: 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .kb-section-toggle {
        cursor: pointer;
        color: #9ca3af;
        transition: color 0.2s ease;
      }

      .kb-section-toggle:hover {
        color: #6b7280;
      }

      .kb-list {
        flex: 1;
        overflow-y: auto;
        padding: 0 20px;
      }
      .kb-list .kb-item {
        cursor: pointer;
      }

      .kb-list::-webkit-scrollbar {
        width: 6px;
      }

      .kb-list::-webkit-scrollbar-track {
        background: transparent;
      }

      .kb-list::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 3px;
      }

      .add-kb-btn {
        width: 100%;
        padding: 8px 12px;
        background: transparent;
        border: 1px dashed #d1d5db;
        border-radius: 8px;
        cursor: pointer;
        font-size: 12px;
        color: #6b7280;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        transition: all 0.2s ease;
        margin-bottom: 8px;
      }

      .add-kb-btn:hover {
        border-color: #0ea5e9;
        color: #0ea5e9;
        background: #f0f9ff;
      }

      .upgrade-dot {
        width: 6px;
        height: 6px;
        background: #ef4444;
        border-radius: 50%;
        display: inline-block;
      }

      /* 中间内容区域 */
      .main-content {
        flex: 0 0 calc(100% - 280px - 600px);
        background: white;
        display: flex;
        flex-direction: column;
      }

      .content-header {
        padding: 24px;
        border-bottom: 1px solid #f3f4f6;
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      }

      .content-title {
        font-size: 24px;
        font-weight: 600;
        color: #1e3a8a;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .content-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
      }

      .content-meta {
        font-size: 14px;
        color: #6b7280;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .content-avatar {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #e5e7eb;
        display: inline-block;
      }

      .content-description {
        font-size: 14px;
        color: #6b7280;
      }

      .content-body {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
      }

      .content-section {
        margin-bottom: 24px;
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }

      .section-title {
        font-size: 16px;
        font-weight: 600;
        color: #111827;
      }
      .kb-breadcrumb {
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .kb-crumb-link {
        color: #1e3a8a;
        cursor: pointer;
      }
      .kb-crumb-link:hover {
        text-decoration: underline;
      }

      .section-actions {
        display: flex;
        gap: 8px;
      }

      .action-icon {
        width: 32px;
        height: 32px;
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #374151;
        transition: all 0.2s ease;
        font-size: 14px;
      }

      .action-icon:hover {
        background: #eef2ff;
        color: #1e3a8a;
        border-color: #1e3a8a;
        box-shadow: 0 2px 6px rgba(30, 58, 138, 0.15);
      }

      /* 统一所有 title 提示的字体呈现（浏览器默认 tooltip 无法控，这里给按钮增加 aria-label 以便可读性） */
      .action-icon[title] {
        line-height: 1;
      }

      .content-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .content-item {
        padding: 16px;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: all 0.2s ease;
      }

      .content-item:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
      }

      .content-item-icon {
        width: 40px;
        height: 40px;
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #1e40af;
        font-size: 18px;
      }
      .content-item-icon.folder-icon {
        background: #eef2ff;
        border: 1px solid #dbeafe;
        color: #3b82f6; /* 更浅的蓝色 */
      }

      .content-item-info {
        flex: 1;
      }

      .content-item-name {
        font-size: 14px;
        font-weight: 500;
        color: #111827;
        margin-bottom: 4px;
      }

      .content-item-meta {
        font-size: 12px;
        color: #6b7280;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .content-empty {
        text-align: center;
        padding: 40px 20px;
        color: #9ca3af;
        font-size: 14px;
      }

      /* 搜索输入：左右内置图标 */
      .search-input-wrap {
        position: relative;
      }
      .search-left-icon {
        position: absolute;
        left: 8px;
        top: 50%;
        transform: translateY(-50%);
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #9ca3af;
      }
      .search-dismiss {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #6b7280; /* gray */
        color: #ffffff;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.2s ease;
      }
      .search-dismiss:hover {
        background: #374151;
      }

      /* 空状态页面样式 */
      .empty-knowledge-base {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 80px 20px;
        text-align: center;
        color: #6b7280;
      }

      .empty-icon-large {
        width: 120px;
        height: 120px;
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        border: 2px dashed #0ea5e9;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 24px;
        position: relative;
        overflow: hidden;
      }

      .empty-icon-large::before {
        content: "📄";
        font-size: 48px;
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        animation: float 3s ease-in-out infinite;
      }

      .empty-icon-large::after {
        content: "✈️";
        font-size: 24px;
        position: absolute;
        bottom: 20px;
        right: 20px;
        animation: fly 2s ease-in-out infinite;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateX(-50%) translateY(0px);
        }
        50% {
          transform: translateX(-50%) translateY(-10px);
        }
      }

      @keyframes fly {
        0%,
        100% {
          transform: translateX(0px) translateY(0px);
        }
        50% {
          transform: translateX(10px) translateY(-5px);
        }
      }

      .empty-title {
        font-size: 18px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
      }

      .empty-description {
        font-size: 14px;
        color: #6b7280;
        margin-bottom: 24px;
        line-height: 1.5;
      }

      .upload-files-btn {
        padding: 12px 24px;
        background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(14, 165, 233, 0.15);
      }

      .upload-files-btn:hover {
        background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
        box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
        transform: translateY(-2px);
      }

      /* 右侧AI助手区域 */
      .ai-assistant {
        width: 600px;
        background: white;
        border-left: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
        position: relative;
        z-index: 1;
        overflow: visible;
      }

      .ai-header {
        padding: 20px;
        border-bottom: 1px solid #f3f4f6;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .ai-header-left {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .ai-header-title {
        font-size: 16px;
        font-weight: 600;
        color: #1e3a8a;
      }

      .ai-header-actions {
        display: flex;
        gap: 8px;
      }

      .ai-header-action {
        width: 28px;
        height: 28px;
        background: #f3f4f6;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6b7280;
        transition: all 0.2s ease;
      }

      .ai-header-action:hover {
        background: #e5e7eb;
        color: #374151;
      }

      .ai-chat {
        flex: 1;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .ai-welcome {
        display: flex;
        align-items: flex-start;
        gap: 12px;
      }

      .ai-avatar {
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 14px;
        font-weight: 600;
        flex-shrink: 0;
      }

      .ai-message {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 12px 16px;
        font-size: 14px;
        line-height: 1.5;
        color: #374151;
      }

      .ai-input-area {
        padding: 20px;
        border-top: 1px solid #f3f4f6;
        background: #f9fafb;
      }

      .ai-input-container {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 12px 16px;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: all 0.2s ease;
      }

      .ai-input-container:focus-within {
        border-color: #0ea5e9;
        box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
      }

      .ai-input {
        flex: 1;
        border: none;
        outline: none;
        font-size: 14px;
        color: #111827;
        background: transparent;
      }

      .ai-input::placeholder {
        color: #9ca3af;
      }

      .ai-model-selector {
        background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
        color: white;
        border: none;
        border-radius: 6px;
        padding: 6px 12px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
        transition: all 0.2s ease;
      }

      .ai-model-selector:hover {
        background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
      }

      .ai-footer {
        padding: 12px 20px;
        text-align: center;
        font-size: 12px;
        color: #9ca3af;
        border-top: 1px solid #f3f4f6;
      }

      /* 右侧对话区样式（对齐 AI对话.html 视觉） */
      .kb-messages-container {
        flex: 1;
        overflow-y: auto;
        overflow-x: visible;
        padding: 24px;
        background: linear-gradient(180deg, #fafbfc 0%, #f7f9fc 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
        z-index: 1;
      }

      /* 自定义滚动条样式 - 更短、更浅、悬停显示 */
      .kb-messages-container {
        /* Firefox滚动条样式 */
        scrollbar-width: thin;
        scrollbar-color: transparent transparent;
        transition: scrollbar-color 0.3s ease;
      }

      .kb-messages-container:hover {
        scrollbar-color: #d1d5db transparent;
      }

      /* Webkit浏览器滚动条样式 */
      .kb-messages-container::-webkit-scrollbar {
        width: 6px;
      }

      .kb-messages-container::-webkit-scrollbar-track {
        background: transparent;
      }

      .kb-messages-container::-webkit-scrollbar-thumb {
        background: transparent;
        border-radius: 3px;
        transition: all 0.3s ease;
        min-height: 20px;
      }

      /* 悬停时显示滚动条 */
      .kb-messages-container:hover::-webkit-scrollbar-thumb {
        background: #d1d5db;
      }

      /* 滚动条悬停效果 */
      .kb-messages-container::-webkit-scrollbar-thumb:hover {
        background: #9ca3af;
      }

      /* 滚动条长度控制 - 只显示1/8长度 */
      .kb-messages-container::-webkit-scrollbar-thumb {
        background: linear-gradient(
          to bottom,
          transparent 0%,
          transparent 87.5%,
          transparent 87.5%,
          transparent 100%
        );
      }

      .kb-messages-container:hover::-webkit-scrollbar-thumb {
        background: linear-gradient(
          to bottom,
          transparent 0%,
          transparent 87.5%,
          #d1d5db 87.5%,
          #d1d5db 100%
        );
      }

      .kb-messages-container::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(
          to bottom,
          transparent 0%,
          transparent 87.5%,
          #9ca3af 87.5%,
          #9ca3af 100%
        );
      }

      .kb-messages-container.has-messages {
        align-items: stretch;
        justify-content: flex-start;
      }

      .kb-messages {
        width: 100%;
        max-width: 100%;
        overflow: visible;
      }

      .empty-chat-message {
        font-size: 16px;
        color: #6b7280;
        text-align: center;
        line-height: 1.6;
      }

      .kb-message {
        margin-bottom: 24px;
        display: flex;
        align-items: flex-start;
      }
      .kb-message.user {
        justify-content: flex-end;
      }
      .kb-message.ai {
        justify-content: flex-start;
      }

      .kb-message-avatar {
        width: 36px;
        height: 36px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 600;
        flex-shrink: 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .kb-message-avatar.user {
        background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
        color: #fff;
        margin-left: 12px;
        margin-right: 12px;
      }
      .kb-message-avatar.ai {
        background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%);
        color: #fff;
        margin-right: 12px;
      }

      .kb-message-bubble {
        max-width: 70%;
        position: relative;
        height: auto;
        min-height: auto;
        overflow: visible;
        width: auto;
      }

      .kb-message-content-wrapper {
        padding: 14px 18px;
        border-radius: 16px;
        line-height: 1.6;
        word-wrap: break-word;
        word-break: break-word;
        white-space: pre-wrap;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        transition: all 0.2s ease;
        border: 1px solid #e5e7eb;
        background: #fff;
        color: #374151;
        min-height: auto;
        height: auto;
        overflow: visible;
      }
      .kb-message.user .kb-message-content-wrapper {
        background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
        color: #fff;
        border-color: transparent;
        border-radius: 16px 16px 4px 16px;
      }

      /* 确保用户消息内容文字颜色正确显示 */
      .kb-message.user .kb-message-content {
        color: #fff !important;
      }

      /* 确保用户消息内的所有子元素文字颜色正确 */
      .kb-message.user .kb-message-content * {
        color: #fff !important;
      }

      /* 确保用户消息内容有足够的对比度和可见性 */
      .kb-message.user .kb-message-content-wrapper .kb-message-content {
        opacity: 1 !important;
        visibility: visible !important;
        display: block !important;
      }

      /* 修复可能的文字隐藏问题 */
      .kb-message.user .kb-message-content {
        text-shadow: none !important;
        filter: none !important;
        font-size: 14px !important;
        line-height: 1.6 !important;
        font-weight: normal !important;
        text-decoration: none !important;
        text-transform: none !important;
        letter-spacing: normal !important;
      }

      /* 确保用户消息气泡内的文字完全可见 */
      .kb-message.user .kb-message-content-wrapper {
        position: relative;
        z-index: 1;
      }

      .kb-message.user .kb-message-content-wrapper::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: -1;
        pointer-events: none;
      }
      .kb-message.ai .kb-message-content-wrapper {
        border-radius: 16px 16px 16px 4px;
      }

      /* 停止状态的消息样式 */
      .kb-message.ai .kb-message-content-wrapper.stopped {
        background: #f9fafb;
        color: #6b7280;
        border: 1px solid #e5e7eb;
      }

      .kb-message-content {
        font-size: 14px;
        white-space: pre-wrap;
        word-wrap: break-word;
        word-break: break-word;
        overflow: visible;
        height: auto;
        min-height: auto;
      }

      .kb-message-meta {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 8px;
        font-size: 11px;
        color: #9ca3af;
      }
      .kb-message.user .kb-message-meta {
        justify-content: flex-end;
      }

      .kb-message-actions {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .kb-message-actions .kb-copy-btn {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 8px;
        background: #f3f4f6;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        color: #9ca3af;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
      }
      .kb-message-actions .kb-copy-btn:hover {
        background: #e5e7eb;
        color: #374151;
        border-color: #d1d5db;
      }

      .kb-message-actions .kb-retry-btn {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 8px;
        background: #f3f4f6;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        color: #9ca3af;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .kb-message-actions .kb-retry-btn:hover {
        background: #e5e7eb;
        color: #374151;
        border-color: #d1d5db;
      }

      .kb-message-actions .kb-edit-btn {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 8px;
        background: #f3f4f6;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        color: #9ca3af;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .kb-message-actions .kb-edit-btn:hover {
        background: #e5e7eb;
        color: #374151;
        border-color: #d1d5db;
      }

      /* 编辑状态样式 - 完全模仿原始消息 */
      .kb-message.editing .kb-message-content-wrapper {
        padding: 14px 18px;
        border: 2px solid #1e3a8a;
        background: #ffffff;
        border-radius: 16px;
        box-shadow: 0 2px 12px rgba(30, 58, 138, 0.15);
        position: relative;
        height: auto;
        min-height: auto;
        max-height: none;
        overflow: visible;
        width: auto;
        max-width: none;
      }

      /* 编辑状态下的消息内容容器 */
      .kb-message.editing .kb-message-content {
        height: auto;
        min-height: auto;
        max-height: none;
        overflow: visible;
        width: auto;
        max-width: none;
      }

      /* 编辑框样式 - 完全模仿原始消息内容 */
      .kb-edit-input {
        width: 100%;
        min-height: 20px;
        padding: 0;
        margin: 0;
        border: none;
        outline: none;
        font-size: 14px;
        line-height: 1.6;
        resize: none;
        font-family: inherit;
        background: transparent;
        overflow: visible;
        word-wrap: break-word;
        word-break: break-word;
        white-space: pre-wrap;
        color: #374151;
        height: auto;
        box-sizing: border-box;
        display: block;
      }

      .kb-edit-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 12px;
        padding-top: 8px;
      }

      .kb-edit-btn-cancel,
      .kb-edit-btn-send {
        padding: 8px 16px;
        border: none;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 60px;
        text-align: center;
      }

      .kb-edit-btn-cancel {
        background: #f8f9fa;
        color: #6b7280;
        border: 1px solid #e9ecef;
      }

      .kb-edit-btn-cancel:hover {
        background: #e9ecef;
        color: #495057;
        transform: translateY(-1px);
      }

      .kb-edit-btn-send {
        background: #1e3a8a;
        color: #ffffff;
        box-shadow: 0 2px 8px rgba(30, 58, 138, 0.3);
      }

      .kb-edit-btn-send:hover {
        background: #1e40af;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(30, 58, 138, 0.4);
      }

      .kb-edit-btn-send:disabled {
        background: #d1d5db;
        color: #9ca3af;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      /* 编辑状态下的特殊效果 */
      .kb-message.editing {
        transform: scale(1.02);
        transition: transform 0.2s ease;
      }

      .kb-message.editing .kb-message-avatar {
        transform: scale(1.05);
        transition: transform 0.2s ease;
      }

      .kb-input-area {
        padding: 20px;
        border-top: 1px solid #f0f0f0;
        background: #fff;
        position: relative;
        z-index: 10;
      }

      .custom-model-selector {
        position: relative;
        min-width: 120px;
        flex-shrink: 0;
        z-index: 1000;
      }

      .model-display {
        padding: 8px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 12px;
        color: #6b7280;
        background: #ffffff;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        font-weight: bold;
      }

      .model-display:hover {
        border-color: #d1d5db;
        background: #f9fafb;
      }

      .model-dropdown {
        position: fixed;
        bottom: auto;
        left: auto;
        right: auto;
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1001;
        margin-bottom: 8px;
        overflow: hidden;
        max-height: 300px;
        overflow-y: auto;
        width: 320px;
      }

      .model-option {
        padding: 12px 16px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        position: relative;
        border-bottom: 1px solid #f3f4f6;
      }

      .model-option:last-child {
        border-bottom: none;
      }

      .model-option:hover {
        background: #f8f9fa;
      }

      .model-option.active {
        background: #eef2ff;
      }

      .model-name {
        font-size: 13px;
        font-weight: 500;
        color: #111827;
        margin-bottom: 2px;
      }

      .model-desc {
        font-size: 11px;
        color: #6b7280;
        line-height: 1.3;
      }

      .check-icon {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #3b82f6;
        font-weight: bold;
        font-size: 14px;
      }
      .kb-input-container {
        display: flex;
        flex-direction: column;
        background: #f8f9fa;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 0;
        transition: all 0.2s ease;
        overflow: visible;
      }
      .kb-input-container:has(.kb-message-input:placeholder-shown) {
        background: #f3f4f6;
      }
      .kb-input-container:has(.kb-message-input:not(:placeholder-shown)) {
        background: #ffffff;
      }
      .kb-message-input {
        width: 100%;
        min-height: 44px;
        max-height: 200px;
        padding: 12px 16px 8px 16px;
        border: none;
        font-size: 14px;
        line-height: 1.5;
        resize: none;
        outline: none;
        background: transparent;
        color: #333;
        overflow-y: hidden;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
          "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
        word-wrap: break-word;
        white-space: pre-wrap;
      }

      /* 底部控制栏 */
      .kb-input-bottom-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 16px 12px 16px;
        border-top: 1px solid #e5e7eb;
        background: transparent;
      }

      .kb-send-btn {
        width: 32px;
        height: 32px;
        border: none;
        background: #e5e7eb;
        color: #fff;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        flex-shrink: 0;
      }
      .kb-send-btn.active {
        background: #1e3a8a;
        color: #fff;
      }
      .kb-send-btn.active:hover {
        background: #1e40af;
      }

      /* 停止按钮样式（与发送按钮保持一致的深蓝背景） */
      .kb-stop-btn {
        width: 32px;
        height: 32px;
        border: none;
        background: #1e3a8a; /* 深蓝，与发送按钮一致 */
        color: #fff;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        flex-shrink: 0;
      }

      .kb-stop-btn:hover {
        background: #1e40af; /* 悬停加深 */
        transform: scale(1.05);
      }

      /* 创建知识库弹窗样式（对齐新建项目里程碑弹窗风格） */
      .create-kb-dialog {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .create-kb-content {
        background: #ffffff;
        border-radius: 8px;
        width: 700px;
        max-height: none;
        overflow: visible;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        border: 1px solid #e5e7eb;
      }

      .create-kb-header {
        padding: 20px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .create-kb-title {
        font-size: 18px;
        font-weight: 600;
        color: #1e3a8a;
        display: flex;
        align-items: center;
        gap: 8px;
        margin-left: -10px;
      }

      .create-kb-close {
        width: 32px;
        height: 32px;
        background: #f3f4f6;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6b7280;
        transition: all 0.2s ease;
      }

      .create-kb-close:hover {
        background: #e5e7eb;
        color: #374151;
      }

      .create-kb-body {
        padding: 20px;
      }

      .form-group {
        margin-bottom: 16px;
      }

      .form-label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        color: #374151;
        margin-bottom: 8px;
      }

      .form-label.required::after {
        content: " *";
        color: #ef4444;
      }

      .form-input {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        color: #111827;
        outline: none;
        transition: all 0.2s ease;
      }

      .form-input:focus {
        border-color: #0ea5e9;
        box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
      }

      .form-input::placeholder {
        color: #9ca3af;
      }

      .form-textarea::placeholder {
        color: #9ca3af;
      }

      .form-textarea {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        color: #111827;
        outline: none;
        resize: vertical;
        min-height: 80px;
        transition: all 0.2s ease;
      }

      .form-textarea:focus {
        border-color: #0ea5e9;
        box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
      }

      .cover-upload {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .cover-preview {
        width: 96px;
        height: 96px;
        background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
        border: 2px dashed #0ea5e9;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #0ea5e9;
        font-size: 24px;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
      }

      .cover-preview:hover {
        background: linear-gradient(135deg, #bae6fd 0%, #7dd3fc 100%);
        border-color: #0284c7;
      }

      .cover-edit-icon {
        position: absolute;
        bottom: -4px;
        right: -4px;
        width: 24px;
        height: 24px;
        background: #0ea5e9;
        border: 2px solid white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
      }

      .cover-upload-text {
        flex: 1;
        font-size: 14px;
        color: #6b7280;
      }

      .questions-section {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px;
        background: #f9fafb;
      }

      .questions-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }

      .questions-title {
        font-size: 14px;
        font-weight: 500;
        color: #374151;
      }

      .add-question-btn {
        padding: 6px 12px;
        background: #0ea5e9;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
        transition: all 0.2s ease;
      }

      .add-question-btn:hover {
        background: #0284c7;
      }

      .question-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 13px;
        color: #111827;
        outline: none;
        background: white;
        transition: all 0.2s ease;
      }

      .question-input:focus {
        border-color: #0ea5e9;
        box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.1);
      }

      .create-kb-footer {
        padding: 16px 20px;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
      }

      .btn-cancel {
        padding: 10px 20px;
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        color: #374151;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .btn-cancel:hover {
        background: #f9fafb;
        border-color: #9ca3af;
      }

      .btn-confirm {
        padding: 10px 20px;
        background: #0ea5e9;
        border: none;
        border-radius: 8px;
        color: white;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .btn-confirm:hover {
        background: #60a5fa;
      }

      .btn-confirm:disabled {
        background: #d1d5db;
        cursor: not-allowed;
      }

      .btn-confirm.has-name {
        color: white !important;
        background: #1e3a8a !important;
      }

      .search-input-wrapper {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
      }

      .search-input {
        flex: 1;
        padding: 14px 18px;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        font-size: 14px;
        outline: none;
        transition: all 0.3s ease;
      }

      .search-input:focus {
        border-color: #1e3a8a;
        box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
      }

      .search-btn {
        padding: 14px 28px;
        background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
        color: white;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(30, 58, 138, 0.15);
      }

      .search-btn:hover {
        background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%);
        box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
        transform: translateY(-2px);
      }

      .search-filters {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
      }

      .filter-item {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .filter-label {
        font-size: 13px;
        color: #6b7280;
        font-weight: 500;
      }

      .filter-select {
        padding: 10px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        outline: none;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .filter-select:hover {
        border-color: #d1d5db;
      }

      .filter-select:focus {
        border-color: #1e3a8a;
      }

      /* 搜索结果区域 */
      .results-area {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        flex: 1;
        overflow-y: auto;
      }

      .results-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid #f3f4f6;
      }

      .results-info {
        font-size: 14px;
        color: #6b7280;
      }

      .results-info strong {
        color: #1e3a8a;
        font-weight: 600;
      }

      .results-sort {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .sort-label {
        font-size: 13px;
        color: #6b7280;
      }

      .sort-select {
        padding: 8px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 13px;
        outline: none;
        cursor: pointer;
      }

      .results-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .result-card {
        padding: 20px;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        transition: all 0.2s ease;
        cursor: pointer;
      }

      .result-card:hover {
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        transform: translateY(-2px);
        border-color: #1e3a8a;
      }

      .result-title {
        font-size: 16px;
        font-weight: 600;
        color: #111827;
        margin-bottom: 12px;
      }

      .result-title .highlight {
        background: linear-gradient(120deg, #fef3c7 0%, #fde68a 100%);
        padding: 2px 4px;
        border-radius: 4px;
      }

      .result-summary {
        font-size: 14px;
        line-height: 1.6;
        color: #6b7280;
        margin-bottom: 12px;
      }

      .result-meta {
        display: flex;
        gap: 16px;
        font-size: 12px;
        color: #9ca3af;
        margin-bottom: 12px;
      }

      .result-meta-item {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .result-match {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .match-bar {
        flex: 1;
        height: 6px;
        background: #f3f4f6;
        border-radius: 3px;
        overflow: hidden;
      }

      .match-progress {
        height: 100%;
        background: linear-gradient(90deg, #16a34a 0%, #22c55e 100%);
        border-radius: 3px;
        transition: width 0.3s ease;
      }

      .match-percent {
        font-size: 12px;
        color: #16a34a;
        font-weight: 600;
      }

      .result-actions {
        display: flex;
        gap: 12px;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #f3f4f6;
      }

      .result-action-btn {
        padding: 8px 16px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        font-size: 13px;
        color: #374151;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s ease;
      }

      .result-action-btn:hover {
        background: #f9fafb;
        border-color: #1e3a8a;
        color: #1e3a8a;
      }

      /* 空状态 */
      .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 80px 20px;
        color: #6b7280;
      }

      .empty-icon {
        font-size: 64px;
        margin-bottom: 24px;
        opacity: 0.6;
      }

      .empty-text {
        font-size: 18px;
        font-weight: 500;
        color: #374151;
        margin-bottom: 12px;
      }

      .empty-desc {
        font-size: 14px;
        color: #9ca3af;
        text-align: center;
      }

      /* 上传区域 */
      .upload-area {
        margin-top: 24px;
        padding: 40px;
        border: 2px dashed #d1d5db;
        border-radius: 12px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .upload-area:hover {
        border-color: #1e3a8a;
        background: #f9fafb;
      }

      .upload-area.dragging {
        border-color: #1e3a8a;
        background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
      }

      .upload-icon {
        font-size: 48px;
        color: #9ca3af;
        margin-bottom: 16px;
      }

      .upload-text {
        font-size: 14px;
        color: #374151;
        margin-bottom: 8px;
      }

      .upload-hint {
        font-size: 12px;
        color: #9ca3af;
      }

      /* 分页 */
      .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        margin-top: 24px;
        padding-top: 24px;
        border-top: 1px solid #f3f4f6;
      }

      .page-btn {
        padding: 8px 12px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        font-size: 13px;
        color: #374151;
        transition: all 0.2s ease;
      }

      .page-btn:hover {
        background: #f9fafb;
        border-color: #1e3a8a;
        color: #1e3a8a;
      }

      .page-btn.active {
        background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
        border-color: #1e3a8a;
        color: white;
      }

      .page-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* 轻量代码视图（无依赖） */
      .code-view {
        background: #0b1021;
        color: #e2e8f0;
        border-radius: 8px;
        border: 1px solid #111827;
        padding: 12px 14px;
        margin: 8px 0;
        font-family: "Courier New", Monaco, Menlo, Consolas, monospace;
        font-size: 13px;
        line-height: 1.6;
        overflow-x: auto;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.03);
      }

      /* 轻量表格视图（无依赖） */
      .ai-table {
        width: 100%;
        border-collapse: collapse;
        margin: 8px 0;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        overflow: hidden;
      }
      .ai-table th,
      .ai-table td {
        border-bottom: 1px solid #e5e7eb;
        padding: 10px 12px;
        text-align: left;
        font-size: 13px;
      }
      .ai-table th {
        background: #f8fafc;
        color: #1e3a8a;
        font-weight: 600;
      }
      .ai-table tr:hover {
        background: #f9fafb;
      }
      .ai-table tr:last-child td {
        border-bottom: none;
      }

      /* 轻量条形图（纯CSS，无JS） */
      .mini-chart {
        width: 100%;
        max-width: 520px;
        margin: 10px 0;
      }
      .mini-chart__row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 6px 0;
      }
      .mini-chart__label {
        width: 64px;
        color: #374151;
        font-size: 12px;
      }
      .mini-chart__bar-wrap {
        flex: 1;
        background: #f3f4f6;
        border-radius: 6px;
        overflow: hidden;
        height: 10px;
      }
      .mini-chart__bar {
        height: 100%;
        background: linear-gradient(90deg, #60a5fa, #1e3a8a);
      }
      .mini-chart__value {
        width: 44px;
        text-align: right;
        color: #6b7280;
        font-size: 12px;
      }

      /* 多类型内容渲染样式 - 与当前主题保持一致 */

      /* Markdown 渲染样式 */
      .markdown-content {
        line-height: 1.6;
        color: inherit;
      }

      .markdown-content h1,
      .markdown-content h2,
      .markdown-content h3,
      .markdown-content h4,
      .markdown-content h5,
      .markdown-content h6 {
        margin: 16px 0 8px 0;
        font-weight: 600;
        color: #1e3a8a;
      }

      .markdown-content h1 {
        font-size: 1.5em;
      }
      .markdown-content h2 {
        font-size: 1.3em;
      }
      .markdown-content h3 {
        font-size: 1.2em;
      }

      .markdown-content p {
        margin: 8px 0;
      }

      .markdown-content ul,
      .markdown-content ol {
        margin: 8px 0;
        padding-left: 24px;
      }

      .markdown-content li {
        margin: 4px 0;
      }

      .markdown-content blockquote {
        margin: 12px 0;
        padding: 12px 16px;
        background: #f8f9fa;
        border-left: 4px solid #1e3a8a;
        border-radius: 0 8px 8px 0;
      }

      .markdown-content blockquote p {
        margin: 0;
        color: #6b7280;
      }

      /* 代码块样式 */
      .code-block {
        margin: 12px 0;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        background: #f8f9fa;
        border: 1px solid #e5e7eb;
      }

      .code-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: #1e3a8a;
        color: white;
        font-size: 12px;
        font-weight: 500;
      }

      .code-language {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .code-actions {
        display: flex;
        gap: 8px;
      }

      .code-action-btn {
        padding: 4px 8px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        border-radius: 4px;
        color: white;
        font-size: 11px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .code-action-btn:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .code-content {
        padding: 16px;
        overflow-x: auto;
        font-family: "Courier New", "Monaco", "Menlo", monospace;
        font-size: 13px;
        line-height: 1.5;
        background: #f8f9fa;
      }

      .code-content pre {
        margin: 0;
        white-space: pre;
      }

      /* 表格样式 */
      .table-container {
        margin: 12px 0;
        overflow-x: auto;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
      }

      .table-content {
        width: 100%;
        border-collapse: collapse;
        background: white;
      }

      .table-content th,
      .table-content td {
        padding: 12px 16px;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
      }

      .table-content th {
        background: #f8f9fa;
        font-weight: 600;
        color: #1e3a8a;
        font-size: 13px;
      }

      .table-content td {
        font-size: 14px;
        color: #374151;
      }

      .table-content tr:hover {
        background: #f9fafb;
      }

      .table-content tr:last-child td {
        border-bottom: none;
      }

      /* 图表容器样式 */
      .chart-container {
        margin: 12px 0;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
        background: white;
      }

      .chart-header {
        padding: 12px 16px;
        background: #f8f9fa;
        border-bottom: 1px solid #e5e7eb;
        font-weight: 500;
        color: #1e3a8a;
        font-size: 14px;
      }

      .chart-content {
        padding: 16px;
        min-height: 300px;
      }

      /* 图片容器样式 */
      .image-container {
        margin: 12px 0;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
        background: white;
      }

      .image-content {
        width: 100%;
        height: auto;
        display: block;
        cursor: pointer;
        transition: transform 0.2s ease;
      }

      .image-content:hover {
        transform: scale(1.02);
      }

      .image-caption {
        padding: 8px 12px;
        background: #f8f9fa;
        font-size: 12px;
        color: #6b7280;
        text-align: center;
      }

      /* 混合内容容器 */
      .mixed-content {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .content-block {
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
        background: white;
      }

      .content-block-header {
        padding: 8px 12px;
        background: #f8f9fa;
        border-bottom: 1px solid #e5e7eb;
        font-size: 12px;
        font-weight: 500;
        color: #6b7280;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .content-block-body {
        padding: 16px;
      }

      /* 提示块样式 */
      .alert-block {
        margin: 12px 0;
        padding: 12px 16px;
        border-radius: 8px;
        border-left: 4px solid;
        display: flex;
        align-items: flex-start;
        gap: 8px;
      }

      .alert-block.info {
        background: #eef2ff;
        border-left-color: #1e3a8a;
        color: #1e3a8a;
      }

      .alert-block.warning {
        background: #fef3c7;
        border-left-color: #f59e0b;
        color: #92400e;
      }

      .alert-block.success {
        background: #d1fae5;
        border-left-color: #10b981;
        color: #065f46;
      }

      .alert-block.error {
        background: #fee2e2;
        border-left-color: #ef4444;
        color: #991b1b;
      }

      .alert-icon {
        font-size: 16px;
        flex-shrink: 0;
        margin-top: 2px;
      }

      .alert-content {
        flex: 1;
        font-size: 14px;
        line-height: 1.5;
      }

      /* 响应式设计 */
      @media (max-width: 768px) {
        .table-container {
          font-size: 12px;
        }

        .table-content th,
        .table-content td {
          padding: 8px 12px;
        }

        .chart-content {
          min-height: 200px;
        }
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="knowledge-base-container">
        <!-- 左侧导航栏 -->
        <div class="kb-list-sidebar">
          <div class="kb-list-header">
            <div class="kb-header-title">
              <el-icon><FolderOpened /></el-icon>
              共享知识库
            </div>
            <div class="kb-header-actions">
              <button
                class="action-icon"
                title="新建共享知识库"
                @click="showCreateDialog = true"
              >
                <el-icon><Plus /></el-icon>
              </button>
            </div>
          </div>

          <div class="kb-list">
            <!-- 我创建的 -->
            <div class="kb-section">
              <div class="kb-section-title">
                <span>我创建的</span>
                <el-icon class="kb-section-toggle"><ArrowDown /></el-icon>
              </div>

              <div
                v-for="kb in knowledgeBases"
                :key="kb.id"
                class="kb-item"
                :class="{ active: selectedKnowledgeBase && selectedKnowledgeBase.id === kb.id }"
                @click="selectKnowledgeBase(kb)"
                style="
                  display: flex;
                  align-items: center;
                  gap: 12px;
                  padding: 10px 12px;
                  border: 1px solid #e5e7eb;
                  border-radius: 8px;
                  margin-bottom: 8px;
                  background: #fff;
                  cursor: pointer;
                "
              >
                <div
                  class="kb-item-icon"
                  style="
                    width: 32px;
                    height: 32px;
                    border-radius: 6px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                  "
                >
                  <img
                    v-if="kb.coverUrl"
                    :src="kb.coverUrl"
                    alt="cover"
                    style="
                      width: 100%;
                      height: 100%;
                      object-fit: cover;
                      border-radius: 6px;
                    "
                  />
                  <div
                    v-else
                    style="
                      width: 100%;
                      height: 100%;
                      border-radius: 6px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      background: #3b82f6;
                      box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.08);
                      color: #fff;
                    "
                  >
                    <el-icon><Document /></el-icon>
                  </div>
                </div>
                <div class="kb-item-info" style="flex: 1">
                  <div class="kb-item-name">{{ kb.name }}</div>
                </div>
              </div>

              <!-- <button class="add-kb-btn" @click="showCreateDialog = true">
                <el-icon><Plus /></el-icon>
                新建知识库
              </button> -->
            </div>
          </div>
        </div>

        <!-- 中间内容区域 -->
        <div class="main-content">
          <div class="content-header">
            <div class="content-title">
              <div class="content-icon">
                <el-icon><Document /></el-icon>
              </div>
              <div>
                <div>
                  {{ selectedKnowledgeBase ? selectedKnowledgeBase.shortName ||
                  selectedKnowledgeBase.name : '科研' }}
                </div>
                <div class="content-meta">
                  <!-- <span class="content-avatar"></span> -->
                  Sci-Z | {{ selectedKnowledgeBase ? getCurrentFileCount() : 1
                  }}个内容
                </div>
                <div class="content-description">
                  {{ selectedKnowledgeBase ? selectedKnowledgeBase.description :
                  '科研项目知识库' }}
                </div>
              </div>
            </div>
          </div>

          <div class="content-body">
            <!-- 选中任何知识库都显示框架（标题/按钮/列表容器） -->
            <div v-if="selectedKnowledgeBase" class="content-section">
              <div class="section-header">
                <div class="section-title">
                  <template v-if="currentFolder">
                    <span class="kb-breadcrumb">
                      <span class="kb-crumb-link" @click="backToParent"
                        >内容</span
                      >
                      <span>></span>
                      <span>{{ currentFolder.name }}</span>
                    </span>
                  </template>
                  <template v-else>内容</template>
                </div>
                <div class="section-actions">
                  <button
                    class="action-icon"
                    @click="toggleSearch"
                    title="查询"
                  >
                    <el-icon><Search /></el-icon>
                  </button>
                  <button
                    class="action-icon"
                    @click="createFolder"
                    title="创建文件夹"
                  >
                    <svg
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        d="M4 6C4 5.44772 4.44772 5 5 5H8.17157C8.70201 5 9.21071 5.21071 9.58579 5.58579L11 7H19C19.5523 7 20 7.44772 20 8V18C20 18.5523 19.5523 19 19 19H5C4.44772 19 4 18.5523 4 18V6Z"
                        fill="#374151"
                        fill-opacity="0.1"
                        stroke="#374151"
                        stroke-width="1.5"
                      />
                      <path
                        d="M12 9V13M10 11H14"
                        stroke="#374151"
                        stroke-width="1.5"
                        stroke-linecap="round"
                      />
                    </svg>
                  </button>
                  <button
                    class="action-icon"
                    @click="triggerKbUpload"
                    title="上传本地文件"
                  >
                    <el-icon><Upload /></el-icon>
                  </button>
                  <!-- <button
                    class="action-icon"
                    title="新建共享知识库"
                    @click="showCreateDialog = true"
                  >
                    <el-icon><Plus /></el-icon>
                  </button> -->
                  <input
                    ref="kbUploadInput"
                    type="file"
                    multiple
                    style="display: none"
                    @change="handleKbUpload"
                  />
                </div>
              </div>

              <div
                v-if="showSearch"
                class="search-input-wrap"
                style="margin: 0 0 12px 0"
              >
                <span class="search-left-icon"
                  ><el-icon><Search /></el-icon
                ></span>
                <input
                  class="form-input"
                  v-model="kbSearchQuery"
                  placeholder="在知识库中搜索"
                  style="width: 100%; padding: 10px 40px 10px 36px"
                />
                <div
                  class="search-dismiss"
                  title="关闭搜索"
                  @click="toggleSearch"
                >
                  <el-icon><Close /></el-icon>
                </div>
              </div>

              <div class="content-list">
                <template v-for="item in currentKbDisplayItems" :key="item.id">
                  <div class="content-item" v-if="item.type==='file'">
                    <div class="content-item-icon">
                      <el-icon><Document /></el-icon>
                    </div>
                    <div class="content-item-info">
                      <div class="content-item-name">{{ item.name }}</div>
                      <div class="content-item-meta">
                        <span>{{ item.ext }}</span>
                        <span>|</span>
                        <span>{{ item.time }}</span>
                      </div>
                    </div>
                    <div
                      style="
                        margin-left: auto;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                      "
                    >
                      <button
                        class="action-icon"
                        title="重命名"
                        @click.stop="renameItem(item)"
                      >
                        <el-icon><Edit /></el-icon>
                      </button>
                      <button
                        class="action-icon"
                        title="删除"
                        @click.stop="deleteItem(item)"
                      >
                        <el-icon><Delete /></el-icon>
                      </button>
                    </div>
                  </div>

                  <div class="content-item" v-else @click="enterFolder(item)">
                    <div class="content-item-icon folder-icon">
                      <svg
                        width="20"
                        height="16"
                        viewBox="0 0 20 16"
                        fill="none"
                        xmlns="http://www.w3.org/2000/svg"
                      >
                        <path
                          d="M2 3.5A1.5 1.5 0 0 1 3.5 2h3.879a1.5 1.5 0 0 1 1.06.44l.94.94H16.5A1.5 1.5 0 0 1 18 4.88v7.62A1.5 1.5 0 0 1 16.5 14h-13A1.5 1.5 0 0 1 2 12.5v-9Z"
                          fill="#1e40af"
                          fill-opacity="0.15"
                        />
                        <path
                          d="M2 5h16v7.5A1.5 1.5 0 0 1 16.5 14h-13A1.5 1.5 0 0 1 2 12.5V5Z"
                          stroke="#1e40af"
                          stroke-width="1.2"
                          fill="#eef2ff"
                        />
                      </svg>
                    </div>
                    <div class="content-item-info">
                      <div class="content-item-name">{{ item.name }}</div>
                      <div class="content-item-meta">
                        <span>{{ (item.files||[]).length }} 个文件</span>
                      </div>
                    </div>
                    <div
                      style="
                        margin-left: auto;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                      "
                    >
                      <span
                        v-if="(item.files||[]).length>2"
                        style="color: #9ca3af"
                        >▼</span
                      >
                      <button
                        class="action-icon"
                        title="重命名"
                        @click.stop="renameItem(item)"
                      >
                        <el-icon><Edit /></el-icon>
                      </button>
                      <button
                        class="action-icon"
                        title="删除"
                        @click.stop="deleteItem(item)"
                      >
                        <el-icon><Delete /></el-icon>
                      </button>
                    </div>
                  </div>
                </template>
              </div>
              <div
                v-if="currentFolder && currentKbDisplayItems.length===0"
                class="content-empty"
              >
                <div>文件夹什么也没有，去这里添加</div>
              </div>
              <div v-else-if="!currentFolder" class="content-empty">
                没有更多内容了
              </div>
            </div>

            <!-- 未选中任何知识库时的空状态显示 -->
            <!-- <div v-else class="empty-knowledge-base">
              <div class="empty-icon-large"></div>
              <div class="empty-title">知识库什么也没有，去这里添加</div>
              <div class="empty-description">
                上传文档、图片、视频等文件，让AI助手帮你整理和回答问题
              </div>
              <button class="upload-files-btn" @click="uploadFiles">
                <el-icon><Upload /></el-icon>
                上传文件
              </button>
            </div> -->
          </div>
        </div>

        <!-- 右侧AI助手区域 -->
        <div class="ai-assistant">
          <div class="ai-header">
            <div class="ai-header-left">
              <div class="ai-header-title">问知识库</div>
            </div>
          </div>

          <!-- 对话区（与 AI对话.html 对齐） -->
          <div
            class="kb-messages-container"
            :class="{ 'has-messages': kbMessagesList.length > 1 }"
            ref="kbMessages"
          >
            <!-- 空状态显示 -->
            <div v-if="kbMessagesList.length <= 1" class="empty-chat-message">
              Hi，任何关于这个知识库的问题都可以问我
            </div>

            <!-- 消息列表 -->
            <template v-if="kbMessagesList.length > 1">
              <div class="kb-messages">
                <div
                  v-for="msg in kbMessagesList.slice(1)"
                  :key="msg.id"
                  class="kb-message"
                  :class="[msg.type, { editing: msg.editing }]"
                >
                  <div class="kb-message-avatar" :class="msg.type">
                    {{ msg.type === 'user' ? '我' : 'AI' }}
                  </div>
                  <div class="kb-message-bubble">
                    <div
                      class="kb-message-content-wrapper"
                      :class="{ 'stopped': msg.status === 'stopped' }"
                    >
                      <!-- 正常显示状态 - 支持多类型内容渲染 -->
                      <template v-if="!msg.editing">
                        <component
                          v-if="msg.contentType"
                          :is="MessageRenderer"
                          :content="msg.content"
                          :content-type="msg.contentType"
                          :payload="msg.payload"
                          class="kb-message-content"
                        />
                        <div
                          v-else
                          class="kb-message-content"
                          v-html="formatKbContent(msg.content)"
                        ></div>
                      </template>

                      <!-- 编辑状态 - 完全模仿原始消息布局 -->
                      <div v-if="msg.editing" class="kb-message-content">
                        <textarea
                          v-model="msg.editContent"
                          class="kb-edit-input"
                          @input="autoResizeTextarea"
                          @keydown.enter.prevent="sendEditMessage(msg)"
                          @keydown.escape="cancelEdit(msg)"
                          ref="editInput"
                        ></textarea>
                        <div class="kb-edit-actions">
                          <button
                            class="kb-edit-btn-cancel"
                            @click="cancelEdit(msg)"
                          >
                            取消
                          </button>
                          <button
                            class="kb-edit-btn-send"
                            :disabled="!msg.editContent.trim()"
                            @click="sendEditMessage(msg)"
                          >
                            发送
                          </button>
                        </div>
                      </div>
                    </div>
                    <div class="kb-message-meta">
                      <span>{{ formatTime(msg.timestamp) }}</span>
                      <div class="kb-message-actions">
                        <!-- AI消息的复制和重试按钮 -->
                        <template v-if="msg.type === 'ai'">
                          <button
                            class="kb-copy-btn"
                            @click="copyKbMessage(msg.content)"
                          >
                            <svg
                              width="14"
                              height="14"
                              viewBox="0 0 24 24"
                              fill="none"
                              xmlns="http://www.w3.org/2000/svg"
                            >
                              <rect
                                x="9"
                                y="9"
                                width="13"
                                height="13"
                                rx="2"
                                ry="2"
                                stroke="currentColor"
                                stroke-width="2"
                                fill="none"
                              />
                              <path
                                d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"
                                stroke="currentColor"
                                stroke-width="2"
                                fill="none"
                              />
                            </svg>
                            <span>复制</span>
                          </button>
                          <button
                            class="kb-retry-btn"
                            @click="retryKbMessage(msg)"
                          >
                            <svg
                              width="14"
                              height="14"
                              viewBox="0 0 24 24"
                              fill="none"
                              xmlns="http://www.w3.org/2000/svg"
                            >
                              <path
                                d="M1 4V10H7"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                              />
                              <path
                                d="M23 20V14H17"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                              />
                              <path
                                d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10M23 14L18.36 18.36A9 9 0 0 1 3.51 15"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                              />
                            </svg>
                            <span>重试</span>
                          </button>
                        </template>

                        <!-- 用户消息的编辑和复制按钮 -->
                        <template v-if="msg.type === 'user' && !msg.editing">
                          <button class="kb-edit-btn" @click="startEdit(msg)">
                            <svg
                              width="14"
                              height="14"
                              viewBox="0 0 24 24"
                              fill="none"
                              xmlns="http://www.w3.org/2000/svg"
                            >
                              <path
                                d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                              />
                              <path
                                d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                              />
                            </svg>
                            <span>编辑</span>
                          </button>
                          <button
                            class="kb-copy-btn"
                            @click="copyKbMessage(msg.content)"
                          >
                            <svg
                              width="14"
                              height="14"
                              viewBox="0 0 24 24"
                              fill="none"
                              xmlns="http://www.w3.org/2000/svg"
                            >
                              <rect
                                x="9"
                                y="9"
                                width="13"
                                height="13"
                                rx="2"
                                ry="2"
                                stroke="currentColor"
                                stroke-width="2"
                                fill="none"
                              />
                              <path
                                d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"
                                stroke="currentColor"
                                stroke-width="2"
                                fill="none"
                              />
                            </svg>
                            <span>复制</span>
                          </button>
                        </template>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </template>
          </div>

          <div class="kb-input-area">
            <div class="kb-input-container">
              <textarea
                v-model="kbInput"
                class="kb-message-input"
                placeholder="基于知识库提问"
                @keydown.enter.prevent="sendKbMessage"
                @input="autoResizeInput"
              ></textarea>

              <!-- 底部控制栏 -->
              <div class="kb-input-bottom-bar">
                <div class="custom-model-selector" @click="toggleModelDropdown">
                  <div class="model-display">
                    {{ getSelectedModelName(selectedModel) }}
                    <svg
                      width="12"
                      height="12"
                      viewBox="0 0 24 24"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        d="M6 9L12 15L18 9"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                  </div>
                  <div v-if="showModelDropdown" class="model-dropdown">
                    <div
                      v-for="model in modelOptions"
                      :key="model.value"
                      class="model-option"
                      :class="{ active: selectedModel === model.value }"
                      @click.stop="selectModel(model.value)"
                    >
                      <div class="model-name">{{ model.name }}</div>
                      <div class="model-desc">{{ model.description }}</div>
                      <div
                        v-if="selectedModel === model.value"
                        class="check-icon"
                      >
                        ✓
                      </div>
                    </div>
                  </div>
                </div>

                <!-- 发送/停止按钮 -->
                <button
                  v-if="!isGenerating"
                  class="kb-send-btn"
                  :class="{ active: kbInput.trim() }"
                  @click="sendKbMessage"
                >
                  <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M12 19V5M5 12L12 5L19 12"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                </button>

                <!-- 停止按钮 -->
                <button
                  v-if="isGenerating"
                  class="kb-stop-btn"
                  @click="stopGeneration"
                >
                  <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <rect
                      x="6"
                      y="6"
                      width="12"
                      height="12"
                      rx="2"
                      fill="currentColor"
                    />
                  </svg>
                </button>
              </div>
            </div>
            <div class="ai-footer">内容由AI生成仅供参考</div>
          </div>
        </div>
      </div>

      <!-- 创建知识库弹窗 -->
      <div
        v-if="showCreateDialog"
        class="create-kb-dialog"
        @click.self="showCreateDialog = false"
      >
        <div class="create-kb-content">
          <div class="create-kb-header">
            <div class="create-kb-title">
              <el-icon><FolderOpened /></el-icon>
              创建共享知识库
            </div>
            <button class="create-kb-close" @click="showCreateDialog = false">
              <el-icon><Close /></el-icon>
            </button>
          </div>

          <div class="create-kb-body">
            <div class="form-group">
              <label class="form-label required">名称</label>
              <input
                v-model="newKbForm.name"
                type="text"
                class="form-input"
                placeholder="请输入知识库名称"
              />
            </div>

            <div class="form-group">
              <label class="form-label">封面</label>
              <div class="cover-upload">
                <div class="cover-preview" @click="triggerCoverUpload">
                  <img
                    v-if="newKbForm.coverUrl"
                    :src="newKbForm.coverUrl"
                    alt="知识库封面"
                    style="
                      width: 100%;
                      height: 100%;
                      object-fit: cover;
                      border-radius: 6px;
                    "
                  />
                  <el-icon v-else><Document /></el-icon>
                  <div class="cover-edit-icon">
                    <el-icon><Edit /></el-icon>
                  </div>
                </div>
                <div class="cover-upload-text">
                  点击上传知识库封面图片，建议尺寸 200x200px
                </div>
                <input
                  ref="coverInput"
                  type="file"
                  accept="image/*"
                  style="display: none"
                  @change="handleCoverSelect"
                />
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">描述</label>
              <textarea
                v-model="newKbForm.description"
                class="form-textarea"
                placeholder="为你的共享知识库填写描述"
              ></textarea>
            </div>
          </div>

          <div class="create-kb-footer">
            <button class="btn-cancel" @click="showCreateDialog = false">
              取消
            </button>
            <button
              class="btn-confirm"
              :class="{ 'has-name': newKbForm.name.trim() }"
              @click="createKnowledgeBase"
              :disabled="!newKbForm.name.trim()"
            >
              确定
            </button>
          </div>
        </div>
      </div>

      <!-- 重命名弹窗 -->
      <div
        v-if="showRenameDialog"
        class="create-kb-dialog"
        @click.self="cancelRename"
      >
        <div class="create-kb-content" style="width: 500px">
          <div class="create-kb-header">
            <div class="create-kb-title">重命名</div>
            <button class="create-kb-close" @click="cancelRename">
              <el-icon><Close /></el-icon>
            </button>
          </div>

          <div class="create-kb-body">
            <div class="form-group">
              <label class="form-label required">名称</label>
              <input
                v-model="renameForm"
                type="text"
                class="form-input"
                placeholder="请输入新名称"
                @keydown.enter="confirmRename"
              />
            </div>
          </div>

          <div class="create-kb-footer">
            <button class="btn-cancel" @click="cancelRename">取消</button>
            <button
              class="btn-confirm"
              :class="{ 'has-name': renameForm.trim() }"
              @click="confirmRename"
              :disabled="!renameForm.trim()"
            >
              确定
            </button>
          </div>
        </div>
      </div>

      <!-- 删除确认弹窗 -->
      <div
        v-if="showDeleteDialog"
        class="create-kb-dialog"
        @click.self="cancelDelete"
      >
        <div class="create-kb-content" style="width: 500px">
          <div class="create-kb-header">
            <div class="create-kb-title">删除确认</div>
            <button class="create-kb-close" @click="cancelDelete">
              <el-icon><Close /></el-icon>
            </button>
          </div>

          <div class="create-kb-body">
            <div style="text-align: center; padding: 20px 0">
              <div style="font-size: 16px; color: #374151; margin-bottom: 8px">
                确定要删除该项吗？
              </div>
              <div style="font-size: 14px; color: #6b7280">此操作不可恢复</div>
            </div>
          </div>

          <div class="create-kb-footer">
            <button class="btn-cancel" @click="cancelDelete">取消</button>
            <button
              class="btn-confirm"
              style="background: #1e3a8a; color: white"
              @click="confirmDelete"
            >
              删除
            </button>
          </div>
        </div>
      </div>

      <!-- 编辑知识库对话框 -->
      <el-dialog v-model="showEditDialog" title="编辑知识库" width="500px">
        <el-form
          v-if="editingKnowledgeBase"
          :model="editingKnowledgeBase"
          label-width="100px"
        >
          <el-form-item label="知识库名称">
            <el-input v-model="editingKnowledgeBase.name"></el-input>
          </el-form-item>
          <el-form-item label="描述">
            <el-input
              v-model="editingKnowledgeBase.description"
              type="textarea"
              :rows="3"
            ></el-input>
          </el-form-item>
        </el-form>
        <template #footer>
          <el-button @click="showEditDialog = false">取消</el-button>
          <el-button type="primary" @click="saveKnowledgeBase">保存</el-button>
        </template>
      </el-dialog>
    </div>

    <script>
      const { createApp, ref, computed, onMounted, nextTick } = Vue;
      const { ElMessage, ElMessageBox } = ElementPlus;
      const Icons = ElementPlusIconsVue;

      const app = createApp({
        setup() {
          // 内容区域：文件/文件夹 数据与搜索（按知识库区分内容）
          const kbItems = ref([]);
          const kbContents = Vue.reactive({}); // kbId -> items
          const currentFolder = ref(null); // 当前进入的文件夹对象 {id,name,files,parentId}
          const buildDefaultItems = (kb) => [
            {
              id: "f_" + kb.id + "_1",
              type: "file",
              name: "test.txt",
              ext: "TXT",
              time: new Date().toLocaleTimeString("zh-CN", {
                hour: "2-digit",
                minute: "2-digit",
              }),
            },
            {
              id: "f_" + kb.id + "_2",
              type: "file",
              name: "product_design_document.pdf",
              ext: "PDF",
              time: new Date().toLocaleDateString("zh-CN"),
            },
            {
              id: "f_" + kb.id + "_3",
              type: "file",
              name: "知识库使用指南.docx",
              ext: "WORD",
              time: new Date().toLocaleDateString("zh-CN"),
            },
          ];
          const kbSearchQuery = ref("");
          const showSearch = ref(false);
          const kbUploadInput = ref(null);

          const currentKbDisplayItems = computed(() => {
            const q = kbSearchQuery.value.trim().toLowerCase();
            const list = currentFolder.value
              ? currentFolder.value.files || []
              : kbItems.value;
            if (!q) return list;
            return list.filter((it) =>
              (it.name || "").toLowerCase().includes(q)
            );
          });

          const toggleSearch = () => (showSearch.value = !showSearch.value);

          const createFolder = () => {
            const now = new Date();
            const pad = (n) => String(n).padStart(2, "0");
            const name = `默认文件夹_${now.getFullYear()}${pad(
              now.getMonth() + 1
            )}${pad(now.getDate())}${pad(now.getHours())}${pad(
              now.getMinutes()
            )}${pad(now.getSeconds())}`;
            const targetList = currentFolder.value
              ? currentFolder.value.files
              : kbItems.value;
            targetList.unshift({
              id: "dir_" + Date.now(),
              type: "folder",
              name,
              files: [],
              parentId: currentFolder.value ? currentFolder.value.id : null,
            });
            ElMessage.success("已创建文件夹");
            if (selectedKnowledgeBase.value) {
              kbContents[selectedKnowledgeBase.value.id] = kbItems.value;
              selectedKnowledgeBase.value.docCount = kbItems.value.length;
            }
          };

          const triggerKbUpload = () =>
            kbUploadInput.value && kbUploadInput.value.click();
          const handleKbUpload = (e) => {
            const files = e.target.files || [];
            if (!files.length) return;
            const targetList = currentFolder.value
              ? currentFolder.value.files
              : kbItems.value;
            for (const f of files) {
              const ext = (f.name.split(".").pop() || "file").toUpperCase();
              targetList.unshift({
                id: "up_" + Date.now() + Math.random(),
                type: "file",
                name: f.name,
                ext,
                time: formatFullDateTime(new Date()),
              });
            }
            e.target.value = "";
            ElMessage.success("上传成功");
            if (selectedKnowledgeBase.value) {
              kbContents[selectedKnowledgeBase.value.id] = kbItems.value;
              selectedKnowledgeBase.value.docCount = kbItems.value.length;
            }
          };

          // 进入文件夹
          const enterFolder = (folder) => {
            if (!folder || folder.type !== "folder") return;
            currentFolder.value = folder;
          };
          // 返回上一级
          const backToParent = () => {
            currentFolder.value = null;
          };

          const renameItem = (item) => {
            editingItem.value = { ...item };
            renameForm.value = item.name;
            showRenameDialog.value = true;
          };

          const confirmRename = () => {
            if (!renameForm.value.trim()) {
              ElMessage.warning("请输入新名称");
              return;
            }
            if (editingItem.value) {
              editingItem.value.name = renameForm.value.trim();
              ElMessage.success("名称已更新");
            }
            showRenameDialog.value = false;
            editingItem.value = null;
            renameForm.value = "";
          };

          const cancelRename = () => {
            showRenameDialog.value = false;
            editingItem.value = null;
            renameForm.value = "";
          };

          const deleteItem = (item) => {
            deletingItem.value = item;
            showDeleteDialog.value = true;
          };

          const confirmDelete = () => {
            if (!deletingItem.value) return;

            // 确定要删除的目标列表
            const targetList = currentFolder.value
              ? currentFolder.value.files
              : kbItems.value;

            const idx = targetList.findIndex(
              (it) => it.id === deletingItem.value.id
            );
            if (idx > -1) {
              targetList.splice(idx, 1);

              // 更新知识库内容（只在根层删除时更新 docCount）
              if (selectedKnowledgeBase.value) {
                if (!currentFolder.value) {
                  kbContents[selectedKnowledgeBase.value.id] = kbItems.value;
                  selectedKnowledgeBase.value.docCount = kbItems.value.length;
                }
              }
              ElMessage.success("已删除");
            }
            showDeleteDialog.value = false;
            deletingItem.value = null;
          };

          const cancelDelete = () => {
            showDeleteDialog.value = false;
            deletingItem.value = null;
          };
          // 右侧问知识库对话数据
          const kbMessagesList = ref([
            {
              id: 1,
              type: "ai",
              content: "Hi，任何关于这个知识库的问题都可以问我～",
              timestamp: new Date(),
            },
          ]);
          const kbInput = ref("");
          const kbMessages = ref(null);
          const selectedModel = ref("qwen3-max");
          const showModelDropdown = ref(false);

          // 按钮状态管理
          const isGenerating = ref(false);
          const currentGeneratingId = ref(null);

          const modelOptions = ref([
            {
              value: "qwen3-max",
              name: "Qwen3-Max",
              description: "通义千问最新模型，擅长中文理解和生成",
            },
            {
              value: "deepseek-v3.1",
              name: "Deepseek-V3.1",
              description: "深度求索V3.1，强大的代码和推理能力",
            },
            {
              value: "deepseek-r1",
              name: "Deepseek-R1",
              description: "深度求索R1，增强的推理和数学能力",
            },
          ]);

          const formatKbContent = (content) => {
            if (!content || typeof content !== "string") {
              return "";
            }
            return content
              .replace(/\n/g, "<br>")
              .replace(/\*\*(.*?)\*\*/g, "<strong>$1<\/strong>")
              .replace(/\*(.*?)\*/g, "<em>$1<\/em>")
              .replace(/`(.*?)`/g, "<code>$1<\/code>");
          };

          // 多类型内容渲染系统
          const MessageRenderer = {
            props: ["content", "contentType", "payload"],
            setup(props) {
              const renderContent = () => {
                const { content, contentType, payload } = props;

                // 如果没有contentType，使用传统文本渲染
                if (!contentType || contentType === "text") {
                  return renderTextContent(content);
                }

                // 根据contentType分发到不同渲染器
                switch (contentType) {
                  case "markdown":
                    return renderMarkdown(content);
                  case "code":
                    return renderCode(payload || { content, language: "text" });
                  case "table":
                    return renderTable(payload);
                  case "chart":
                    return renderChart(payload);
                  case "image":
                    return renderImage(payload);
                  case "mixed":
                    return renderMixed(payload);
                  case "alert":
                    return renderAlert(payload);
                  default:
                    return renderTextContent(content);
                }
              };

              return { renderContent };
            },
            template: `
              <div v-html="renderContent()"></div>
            `,
          };

          // 文本内容渲染（向后兼容）
          const renderTextContent = (content) => {
            if (!content) return "";
            return DOMPurify.sanitize(formatKbContent(content));
          };

          // Markdown渲染
          const renderMarkdown = (content) => {
            if (!content) return "";

            // 初始化markdown-it
            const md = window.markdownit({
              html: true,
              linkify: true,
              typographer: true,
              highlight: function (str, lang) {
                if (lang && window.hljs.getLanguage(lang)) {
                  try {
                    return window.hljs.highlight(str, { language: lang }).value;
                  } catch (__) {}
                }
                return "";
              },
            });

            const html = md.render(content);
            return DOMPurify.sanitize(html);
          };

          // 代码块渲染
          const renderCode = (payload) => {
            const { content, language = "text", title } = payload;
            if (!content) return "";

            const highlighted = window.hljs.highlightAuto(content).value;
            const langDisplay =
              language === "text" ? "Text" : language.toUpperCase();

            return `
              <div class="code-block">
                <div class="code-header">
                  <div class="code-language">
                    <span>📄</span>
                    <span>${title || langDisplay}</span>
                  </div>
                  <div class="code-actions">
                    <button class="code-action-btn" onclick="copyCode(this)">复制</button>
                    <button class="code-action-btn" onclick="toggleCode(this)">折叠</button>
                  </div>
                </div>
                <div class="code-content">
                  <pre><code class="hljs">${highlighted}</code></pre>
                </div>
              </div>
            `;
          };

          // 表格渲染
          const renderTable = (payload) => {
            if (!payload || !payload.columns || !payload.rows) return "";

            const { columns, rows, title } = payload;

            let tableHtml = `
              <div class="table-container">
                ${title ? `<div class="table-header">${title}</div>` : ""}
                <table class="table-content">
                  <thead>
                    <tr>
                      ${columns.map((col) => `<th>${col}</th>`).join("")}
                    </tr>
                  </thead>
                  <tbody>
                    ${rows
                      .map(
                        (row) => `
                      <tr>
                        ${row.map((cell) => `<td>${cell}</td>`).join("")}
                      </tr>
                    `
                      )
                      .join("")}
                  </tbody>
                </table>
              </div>
            `;

            return tableHtml;
          };

          // 图表渲染
          const renderChart = (payload) => {
            if (!payload || !payload.option) return "";

            const { title, option } = payload;
            const chartId =
              "chart_" +
              Date.now() +
              "_" +
              Math.random().toString(36).substr(2, 9);

            // 异步渲染图表
            setTimeout(() => {
              const chartElement = document.getElementById(chartId);
              if (chartElement && window.echarts) {
                const chart = window.echarts.init(chartElement);
                chart.setOption(option);

                // 响应式调整
                window.addEventListener("resize", () => {
                  chart.resize();
                });
              }
            }, 100);

            return `
              <div class="chart-container">
                ${title ? `<div class="chart-header">${title}</div>` : ""}
                <div class="chart-content">
                  <div id="${chartId}" style="width: 100%; height: 300px;"></div>
                </div>
              </div>
            `;
          };

          // 图片渲染
          const renderImage = (payload) => {
            if (!payload || !payload.src) return "";

            const { src, caption, alt } = payload;

            return `
              <div class="image-container">
                <img 
                  src="${src}" 
                  alt="${alt || caption || ""}" 
                  class="image-content"
                  onclick="previewImage('${src}')"
                  onerror="this.style.display='none'"
                />
                ${caption ? `<div class="image-caption">${caption}</div>` : ""}
              </div>
            `;
          };

          // 混合内容渲染
          const renderMixed = (payload) => {
            if (!payload || !payload.blocks) return "";

            let html = '<div class="mixed-content">';

            payload.blocks.forEach((block, index) => {
              html += `
                <div class="content-block">
                  <div class="content-block-header">
                    <span>📦</span>
                    <span>${block.type.toUpperCase()}</span>
                  </div>
                  <div class="content-block-body">
                    ${renderBlock(block)}
                  </div>
                </div>
              `;
            });

            html += "</div>";
            return html;
          };

          // 渲染单个块
          const renderBlock = (block) => {
            switch (block.type) {
              case "markdown":
                return renderMarkdown(block.content);
              case "code":
                return renderCode(block);
              case "table":
                return renderTable(block);
              case "chart":
                return renderChart(block);
              case "image":
                return renderImage(block);
              default:
                return renderTextContent(block.content || "");
            }
          };

          // 提示块渲染
          const renderAlert = (payload) => {
            if (!payload || !payload.content) return "";

            const { content, type = "info", title } = payload;
            const icons = {
              info: "ℹ️",
              warning: "⚠️",
              success: "✅",
              error: "❌",
            };

            return `
              <div class="alert-block ${type}">
                <div class="alert-icon">${icons[type] || icons.info}</div>
                <div class="alert-content">
                  ${title ? `<strong>${title}</strong><br>` : ""}
                  ${content}
                </div>
              </div>
            `;
          };

          // 全局辅助函数
          window.copyCode = function (button) {
            const codeBlock = button.closest(".code-block");
            const codeContent = codeBlock.querySelector("code").textContent;
            navigator.clipboard.writeText(codeContent).then(() => {
              button.textContent = "已复制";
              setTimeout(() => {
                button.textContent = "复制";
              }, 2000);
            });
          };

          window.toggleCode = function (button) {
            const codeBlock = button.closest(".code-block");
            const codeContent = codeBlock.querySelector(".code-content");
            if (codeContent.style.display === "none") {
              codeContent.style.display = "block";
              button.textContent = "折叠";
            } else {
              codeContent.style.display = "none";
              button.textContent = "展开";
            }
          };

          window.previewImage = function (src) {
            // 简单的图片预览实现
            const modal = document.createElement("div");
            modal.style.cssText = `
              position: fixed; top: 0; left: 0; width: 100%; height: 100%;
              background: rgba(0,0,0,0.8); display: flex; align-items: center;
              justify-content: center; z-index: 10000; cursor: pointer;
            `;
            modal.innerHTML = `
              <img src="${src}" style="max-width: 90%; max-height: 90%; object-fit: contain;">
            `;
            modal.onclick = () => document.body.removeChild(modal);
            document.body.appendChild(modal);
          };

          const scrollKbToBottom = () => {
            if (kbMessages.value) {
              kbMessages.value.scrollTop = kbMessages.value.scrollHeight;
            }
          };

          // 输入框自动调整高度
          const autoResizeInput = (event) => {
            if (event && event.target) {
              const textarea = event.target;

              // 重置高度以获取真实内容高度
              textarea.style.height = "auto";

              // 计算内容高度
              const scrollHeight = textarea.scrollHeight;
              const minHeight = 44; // 最小高度44px
              const maxHeight = 200; // 最大高度200px

              // 设置高度，在最小和最大高度之间
              const newHeight = Math.min(
                Math.max(scrollHeight, minHeight),
                maxHeight
              );
              textarea.style.height = newHeight + "px";

              // 如果内容超出最大高度，显示滚动条
              if (scrollHeight > maxHeight) {
                textarea.style.overflowY = "auto";
              } else {
                textarea.style.overflowY = "hidden";
              }
            }
          };

          // 重置输入框高度函数
          const resetInputHeight = () => {
            const inputElement = document.querySelector(".kb-message-input");
            if (inputElement) {
              inputElement.style.height = "44px";
              inputElement.style.overflowY = "hidden";
            }
          };

          // 真实LLM回复（流式优先，失败回退非流式）
          const simulateAiResponse = async (userInputRaw = "") => {
            const responseId = Date.now() + Math.random();
            currentGeneratingId.value = responseId;

            const generatingMessage = {
              id: responseId,
              type: "ai",
              content: "正在生成回复...",
              status: "generating",
              timestamp: new Date(),
            };

            kbMessagesList.value.push(generatingMessage);
            nextTick(scrollKbToBottom);

            try {
              // 组装历史消息（OpenAI兼容协议）
              const history = kbMessagesList.value
                .slice(1, -1) // 排除欢迎消息和当前生成消息
                .map((m) => ({
                  role: m.type === "user" ? "user" : "assistant",
                  content: typeof m.content === "string" ? m.content : "",
                }));
              history.push({ role: "user", content: userInputRaw || "" });

              let finalText = "";
              if (window.LLM_CONFIG?.useStream) {
                await streamLLM(
                  history,
                  (delta) => {
                    finalText += delta;
                    const html = transformCodeBlocks(finalText);
                    const messageIndex = kbMessagesList.value.findIndex(
                      (msg) => msg.id === responseId
                    );
                    if (messageIndex !== -1) {
                      kbMessagesList.value[messageIndex].content = html;
                      nextTick(scrollKbToBottom);
                    }
                  },
                  {}
                );
              } else {
                const res = await callLLM(history);
                if (res.contentType === "code" && res.payload?.content) {
                  finalText = `\n\n\`\`\`${res.payload.language || ""}\n${
                    res.payload.content
                  }\n\`\`\``;
                } else {
                  finalText = res.content || "";
                }
              }

              const contentHtml = transformCodeBlocks(finalText);
              const messageIndex = kbMessagesList.value.findIndex(
                (msg) => msg.id === responseId
              );
              if (messageIndex !== -1) {
                kbMessagesList.value[messageIndex] = {
                  id: responseId,
                  type: "ai",
                  contentType: "markdown",
                  content: contentHtml,
                  status: "completed",
                  timestamp: new Date(),
                };
              }

              isGenerating.value = false;
              currentGeneratingId.value = null;
              nextTick(scrollKbToBottom);
            } catch (err) {
              console.error("LLM 调用失败", err);
              const messageIndex = kbMessagesList.value.findIndex(
                (msg) => msg.id === responseId
              );
              if (messageIndex !== -1) {
                kbMessagesList.value[messageIndex] = {
                  id: responseId,
                  type: "ai",
                  content: `调用大模型失败：${err?.message || err}`,
                  status: "completed",
                  timestamp: new Date(),
                };
              }
              isGenerating.value = false;
              currentGeneratingId.value = null;
              nextTick(scrollKbToBottom);
            }
          };

          const sendKbMessage = () => {
            if (!kbInput.value.trim()) return;
            const text = kbInput.value;
            kbMessagesList.value.push({
              id: Date.now(),
              type: "user",
              content: text,
              timestamp: new Date(),
            });
            kbInput.value = "";

            // 重置输入框高度
            nextTick(() => {
              resetInputHeight();
              scrollKbToBottom();
            });

            // 设置生成状态
            isGenerating.value = true;

            // 记录用户输入供LLM使用
            const lastUserInput = text;
            // 调用AI回复函数，传入用户输入
            simulateAiResponse(lastUserInput);
          };

          // 停止生成函数
          const stopGeneration = () => {
            if (currentGeneratingId.value) {
              const messageIndex = kbMessagesList.value.findIndex(
                (msg) => msg.id === currentGeneratingId.value
              );
              if (messageIndex !== -1) {
                // 更新为停止状态
                kbMessagesList.value[messageIndex] = {
                  id: currentGeneratingId.value,
                  type: "ai",
                  content: "已停止内容生成",
                  status: "stopped",
                  timestamp: new Date(),
                };
              }

              // 重置生成状态
              isGenerating.value = false;
              currentGeneratingId.value = null;

              nextTick(scrollKbToBottom);
            }
          };

          const copyKbMessage = async (content) => {
            try {
              const textContent = content.replace(/<[^>]*>/g, "");
              await navigator.clipboard.writeText(textContent);
              ElMessage.success("内容已复制到剪贴板");
            } catch (e) {
              ElMessage.error("复制失败");
            }
          };

          const retryKbMessage = (msg) => {
            // 基于当前AI消息，找到上一条用户消息并重新生成答案，不清空历史
            const messageIndex = kbMessagesList.value.findIndex(
              (m) => m.id === msg.id
            );
            if (messageIndex > 0) {
              const userMessage = kbMessagesList.value[messageIndex - 1];
              if (userMessage && userMessage.type === "user") {
                // 移除当前AI回复
                kbMessagesList.value.splice(messageIndex, 1);

                // 设置生成状态
                isGenerating.value = true;

                // 重新生成AI回复
                simulateAiResponse(userMessage.content);

                ElMessage.success("正在重新生成回答...");
              } else {
                ElMessage.warning("无法找到对应的用户消息");
              }
            } else {
              ElMessage.warning("无法重试此消息");
            }
          };

          const startEdit = (msg) => {
            msg.editing = true;
            msg.editContent = msg.content;

            nextTick(() => {
              // 聚焦到编辑输入框
              const editInput = document.querySelector(".kb-edit-input");
              if (editInput) {
                // 重置高度为auto，让内容自然撑开
                editInput.style.height = "auto";
                editInput.style.maxHeight = "none";
                editInput.style.overflowY = "hidden";

                // 确保容器也完全自适应
                const contentWrapper = editInput.closest(
                  ".kb-message-content-wrapper"
                );
                if (contentWrapper) {
                  contentWrapper.style.height = "auto";
                  contentWrapper.style.maxHeight = "none";
                  contentWrapper.style.overflow = "visible";
                }

                editInput.focus();
                editInput.select();

                // 触发自动调整高度
                const event = { target: editInput };
                autoResizeTextarea(event);
              }
            });
          };

          const cancelEdit = (msg) => {
            msg.editing = false;
            msg.editContent = "";
          };

          const sendEditMessage = (msg) => {
            if (!msg.editContent.trim()) return;

            // 更新当前消息内容
            msg.content = msg.editContent.trim();
            msg.editing = false;
            msg.editContent = "";

            // 找到当前消息的索引
            const messageIndex = kbMessagesList.value.findIndex(
              (m) => m.id === msg.id
            );

            if (messageIndex !== -1) {
              // 检查是否有后续的AI回复需要删除
              if (messageIndex + 1 < kbMessagesList.value.length) {
                const nextMessage = kbMessagesList.value[messageIndex + 1];
                if (nextMessage.type === "ai") {
                  // 删除后续的AI回复
                  kbMessagesList.value.splice(messageIndex + 1, 1);
                }
              }

              // 设置生成状态
              isGenerating.value = true;

              // 直接调用AI回复函数，为编辑后的消息生成新回复
              simulateAiResponse(msg.content);
            }
          };

          const autoResizeTextarea = (event) => {
            if (event && event.target) {
              const textarea = event.target;

              // 重置高度为auto，让内容自然撑开
              textarea.style.height = "auto";

              // 获取内容的真实高度
              const scrollHeight = textarea.scrollHeight;

              // 设置最小高度为20px，其他完全自适应
              const newHeight = Math.max(20, scrollHeight);
              textarea.style.height = newHeight + "px";

              // 确保不显示任何滚动条，完全自适应
              textarea.style.overflowY = "hidden";
              textarea.style.overflowX = "hidden";

              // 确保容器也完全自适应
              const contentWrapper = textarea.closest(
                ".kb-message-content-wrapper"
              );
              if (contentWrapper) {
                contentWrapper.style.height = "auto";
                contentWrapper.style.maxHeight = "none";
                contentWrapper.style.overflow = "visible";
              }
            }
          };

          const toggleModelDropdown = () => {
            showModelDropdown.value = !showModelDropdown.value;

            // 如果打开下拉框，计算位置
            if (showModelDropdown.value) {
              nextTick(() => {
                const selector = document.querySelector(
                  ".custom-model-selector"
                );
                const dropdown = document.querySelector(".model-dropdown");
                if (selector && dropdown) {
                  const rect = selector.getBoundingClientRect();
                  dropdown.style.left = rect.left + "px";
                  dropdown.style.bottom =
                    window.innerHeight - rect.top + 8 + "px";
                }
              });
            }
          };

          const selectModel = (modelValue) => {
            selectedModel.value = modelValue;
            showModelDropdown.value = false;
            ElMessage.success(`已切换到模型: ${modelValue}`);
          };

          const getSelectedModelName = (modelValue) => {
            const model = modelOptions.value.find(
              (m) => m.value === modelValue
            );
            return model ? model.name : modelValue;
          };

          // 点击外部关闭下拉框
          const closeDropdownOnClickOutside = (event) => {
            if (!event.target.closest(".custom-model-selector")) {
              showModelDropdown.value = false;
            }
          };

          // 窗口大小变化时重新计算下拉框位置
          const handleResize = () => {
            if (showModelDropdown.value) {
              const selector = document.querySelector(".custom-model-selector");
              const dropdown = document.querySelector(".model-dropdown");
              if (selector && dropdown) {
                const rect = selector.getBoundingClientRect();
                dropdown.style.left = rect.left + "px";
                dropdown.style.bottom =
                  window.innerHeight - rect.top + 8 + "px";
              }
            }
          };

          // 响应式数据
          const knowledgeBases = ref([]);
          const selectedKnowledgeBase = ref(null);
          const kbFilter = ref("all");
          const searchQuery = ref("");
          const searchResults = ref([]);
          const hasSearched = ref(false);
          const loading = ref(false);
          const sortBy = ref("relevance");
          const filters = ref({
            knowledgeBase: "",
            type: "",
            dateRange: "",
            category: "",
          });
          const pagination = ref({
            current: 1,
            size: 10,
            total: 0,
          });
          const showCreateDialog = ref(false);
          const showEditDialog = ref(false);
          const editingKnowledgeBase = ref(null);
          const newKbForm = ref({
            name: "",
            description: "",
            coverUrl: "",
          });
          const coverInput = ref(null);

          // 重命名和删除弹窗状态
          const showRenameDialog = ref(false);
          const showDeleteDialog = ref(false);
          const editingItem = ref(null);
          const deletingItem = ref(null);
          const renameForm = ref("");

          // 模拟数据
          const mockKnowledgeBases = [
            {
              id: 1,
              name: "智能制造系统研究",
              type: "project",
              projectName: "智能制造系统研究",
              docCount: 156,
              updatedAt: new Date(Date.now() - 1000 * 60 * 60 * 2),
              description: "智能制造系统研究项目知识库",
              shortName: "智能制造系统研究",
            },
            {
              id: 2,
              name: "人工智能算法研究",
              type: "project",
              projectName: "人工智能算法研究",
              docCount: 89,
              updatedAt: new Date(Date.now() - 1000 * 60 * 60 * 5),
              description: "人工智能算法研究项目知识库",
              shortName: "人工智能算法研究",
            },
            {
              id: 3,
              name: "通用学术资料",
              type: "independent",
              docCount: 234,
              updatedAt: new Date(Date.now() - 1000 * 60 * 60 * 24),
              description: "通用学术资料知识库",
              shortName: "通用学术资料",
            },
            {
              id: 4,
              name: "论文写作参考",
              type: "independent",
              docCount: 67,
              updatedAt: new Date(Date.now() - 1000 * 60 * 60 * 48),
              description: "科研项目知识库",
              shortName: "论文写作参考",
            },
          ];

          const mockSearchResults = [
            {
              id: 1,
              title: "智能制造系统架构设计方案",
              summary:
                "本文档详细介绍了智能制造系统的整体架构设计，包括系统层次结构、核心模块功能、数据流转机制等关键技术要点...",
              type: "pdf",
              size: "2.3 MB",
              uploadTime: new Date(Date.now() - 1000 * 60 * 60 * 24 * 3),
              matchPercent: 95,
            },
            {
              id: 2,
              title: "人工智能算法在制造业中的应用研究",
              summary:
                "研究了深度学习、强化学习等人工智能算法在智能制造领域的应用场景，提出了基于AI的生产优化方案...",
              type: "doc",
              size: "1.8 MB",
              uploadTime: new Date(Date.now() - 1000 * 60 * 60 * 24 * 5),
              matchPercent: 88,
            },
            {
              id: 3,
              title: "项目实施计划与进度管理",
              summary:
                "详细规划了项目各阶段的实施计划，包括时间节点、人员安排、资源配置等内容，并提供了进度管理工具和方法...",
              type: "pdf",
              size: "1.2 MB",
              uploadTime: new Date(Date.now() - 1000 * 60 * 60 * 24 * 7),
              matchPercent: 82,
            },
          ];

          // 计算属性
          const filteredKnowledgeBases = computed(() => {
            // 仅展示共享知识库（project 类型）；若需要包含个人可调整条件
            return knowledgeBases.value.filter(
              (kb) => kb.type === "project" || kb.type === "independent"
            );
          });

          const totalPages = computed(() => {
            return Math.ceil(pagination.value.total / pagination.value.size);
          });

          // 方法
          const loadKnowledgeBases = () => {
            knowledgeBases.value = mockKnowledgeBases;
          };

          const selectKnowledgeBase = (kb) => {
            selectedKnowledgeBase.value = kb;
            filters.value.knowledgeBase = kb.id;
            if (!kbContents[kb.id]) {
              kbContents[kb.id] = buildDefaultItems(kb);
            }
            kbItems.value = kbContents[kb.id];
          };

          const createKnowledgeBase = () => {
            if (!newKbForm.value.name.trim()) {
              ElMessage.warning("请输入知识库名称");
              return;
            }

            const newKb = {
              id: Date.now(),
              name: newKbForm.value.name,
              type: "independent",
              docCount: 0,
              updatedAt: new Date(),
              description: newKbForm.value.description,
              coverUrl: newKbForm.value.coverUrl,
            };

            knowledgeBases.value.unshift(newKb);

            // 新知识库保持空状态，不添加任何默认文件
            kbContents[newKb.id] = [];
            newKb.docCount = 0;

            // 将新建的知识库展示在左侧"我创建的"列表顶部
            // 同时选中该知识库
            selectedKnowledgeBase.value = newKb;
            kbItems.value = [];

            showCreateDialog.value = false;
            newKbForm.value = { name: "", description: "", coverUrl: "" };
            ElMessage.success("知识库创建成功");
          };

          const triggerCoverUpload = () => {
            coverInput.value && coverInput.value.click();
          };
          const handleCoverSelect = (e) => {
            const file = e.target.files && e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
              newKbForm.value.coverUrl = reader.result;
            };
            reader.readAsDataURL(file);
          };

          const uploadFiles = () => {
            ElMessage.info("上传文件功能");
          };

          const editKnowledgeBase = (kb) => {
            editingKnowledgeBase.value = { ...kb };
            showEditDialog.value = true;
          };

          const saveKnowledgeBase = () => {
            const index = knowledgeBases.value.findIndex(
              (kb) => kb.id === editingKnowledgeBase.value.id
            );
            if (index !== -1) {
              knowledgeBases.value[index] = { ...editingKnowledgeBase.value };
            }
            showEditDialog.value = false;
            ElMessage.success("知识库保存成功");
          };

          const deleteKnowledgeBase = async (kb) => {
            try {
              await ElMessageBox.confirm(
                "确定要删除该知识库吗？此操作不可恢复。",
                "删除知识库",
                {
                  confirmButtonText: "确定",
                  cancelButtonText: "取消",
                  type: "warning",
                }
              );

              const index = knowledgeBases.value.findIndex(
                (k) => k.id === kb.id
              );
              if (index !== -1) {
                knowledgeBases.value.splice(index, 1);
              }
              ElMessage.success("知识库删除成功");
            } catch (error) {
              // 用户取消
            }
          };

          const handleSearch = () => {
            if (!searchQuery.value.trim()) {
              ElMessage.warning("请输入搜索关键词");
              return;
            }

            loading.value = true;
            hasSearched.value = true;

            // 模拟搜索
            setTimeout(() => {
              searchResults.value = mockSearchResults;
              pagination.value.total = mockSearchResults.length;
              loading.value = false;
            }, 1000);
          };

          const highlightText = (text) => {
            if (!searchQuery.value.trim()) return text;
            const regex = new RegExp(searchQuery.value, "gi");
            return text.replace(
              regex,
              (match) => `<span class="highlight">${match}</span>`
            );
          };

          const formatDate = (date) => {
            const now = new Date();
            const diff = now - date;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));

            if (hours < 1) return "刚刚";
            if (hours < 24) return `${hours}小时前`;
            if (days < 7) return `${days}天前`;
            return date.toLocaleDateString("zh-CN");
          };

          // 统一文件时间格式：YYYY-MM-DD HH:mm:ss
          const formatFullDateTime = (d) => {
            const pad = (n) => String(n).padStart(2, "0");
            const dt =
              typeof d === "number" || typeof d === "string" ? new Date(d) : d;
            return `${dt.getFullYear()}-${pad(dt.getMonth() + 1)}-${pad(
              dt.getDate()
            )} ${pad(dt.getHours())}:${pad(dt.getMinutes())}:${pad(
              dt.getSeconds()
            )}`;
          };

          // 对话时间格式化，供右侧消息使用
          const formatTime = (date) => {
            const d =
              typeof date === "string" || typeof date === "number"
                ? new Date(date)
                : date;
            const now = new Date();
            const diff = now - d;
            const minutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            if (minutes < 1) return "刚刚";
            if (minutes < 60) return `${minutes}分钟前`;
            if (hours < 24) return `${hours}小时前`;
            return `${days}天前`;
          };

          const viewResult = (result) => {
            ElMessage.info("查看文档详情: " + result.title);
          };

          const downloadResult = (result) => {
            ElMessage.success("开始下载: " + result.title);
          };

          const changePage = (page) => {
            if (page < 1 || page > totalPages.value) return;
            pagination.value.current = page;
            handleSearch();
          };

          // 获取当前知识库的文件数量
          const getCurrentFileCount = () => {
            if (!selectedKnowledgeBase.value) return 0;
            const currentItems = kbContents[selectedKnowledgeBase.value.id];
            return currentItems ? currentItems.length : 0;
          };

          onMounted(() => {
            loadKnowledgeBases();
            nextTick(() => {
              if (
                !selectedKnowledgeBase.value &&
                filteredKnowledgeBases.value.length
              ) {
                const first = filteredKnowledgeBases.value[0];
                selectedKnowledgeBase.value = first;
                kbContents[first.id] = buildDefaultItems(first);
                // 初始化默认列表的时间格式
                kbContents[first.id] = kbContents[first.id].map((it) =>
                  it.type === "file" && !/\d{4}-\d{2}-\d{2}/.test(it.time)
                    ? { ...it, time: formatFullDateTime(new Date()) }
                    : it
                );
                kbItems.value = kbContents[first.id];
              }
              scrollKbToBottom();
            });

            // 添加点击外部关闭下拉框的事件监听
            document.addEventListener("click", closeDropdownOnClickOutside);
            // 添加窗口大小变化事件监听
            window.addEventListener("resize", handleResize);
          });

          return {
            // KB chat
            kbMessagesList,
            kbInput,
            kbMessages,
            selectedModel,
            showModelDropdown,
            modelOptions,
            sendKbMessage,
            copyKbMessage,
            retryKbMessage,
            startEdit,
            cancelEdit,
            sendEditMessage,
            autoResizeTextarea,
            autoResizeInput,
            resetInputHeight,
            simulateAiResponse,
            stopGeneration,
            toggleModelDropdown,
            selectModel,
            getSelectedModelName,
            handleResize,
            formatKbContent,
            formatTime,
            // 多类型内容渲染组件
            MessageRenderer,
            // 按钮状态管理
            isGenerating,
            currentGeneratingId,
            // 内容
            kbItems,
            kbSearchQuery,
            currentKbDisplayItems,
            showSearch,
            kbUploadInput,
            toggleSearch,
            createFolder,
            triggerKbUpload,
            handleKbUpload,
            renameItem,
            deleteItem,
            confirmRename,
            cancelRename,
            confirmDelete,
            cancelDelete,
            knowledgeBases,
            selectedKnowledgeBase,
            kbFilter,
            searchQuery,
            searchResults,
            hasSearched,
            loading,
            sortBy,
            filters,
            pagination,
            showCreateDialog,
            showEditDialog,
            editingKnowledgeBase,
            newKbForm,
            coverInput,
            showRenameDialog,
            showDeleteDialog,
            editingItem,
            deletingItem,
            renameForm,
            filteredKnowledgeBases,
            totalPages,
            loadKnowledgeBases,
            selectKnowledgeBase,
            createKnowledgeBase,
            triggerCoverUpload,
            handleCoverSelect,
            uploadFiles,
            editKnowledgeBase,
            saveKnowledgeBase,
            deleteKnowledgeBase,
            handleSearch,
            highlightText,
            formatDate,
            viewResult,
            downloadResult,
            changePage,
            getCurrentFileCount,
            // folder nav
            currentFolder,
            enterFolder,
            backToParent,
            formatFullDateTime,
          };
        },
      });

      // 全量注册 Element Plus 图标，避免常用图标未解析
      for (const key in Icons) {
        app.component(key, Icons[key]);
      }

      app.use(ElementPlus).mount("#app");
    </script>
  </body>
</html>
