# 后端接口集成说明（仅保留方案一）

本项目前端已按“方案一：登录接口一次性返回所有初始化数据”实现。后端只需实现一个登录接口（以及可选的用户信息接口），不再单独查询按钮权限或菜单权限接口。

## 设计约定
- 框架与鉴权：后端使用 Sa-Token 负责登录鉴权与会话管理。
- 权限粒度：当前阶段仅控制“菜单级权限”（permission_type=1）。按钮统一对前端开放，不需要返回，也不参与授权判断。
- 多行业支持：数据库已初始化 `education | medical | power` 三个行业的角色与菜单。登录时由后端按当前行业返回对应行业的数据集。
- 管理员权限：管理员返回 `permissions: ["*"]` 视为全开，前端将放行所有菜单。

## 登录接口（必须）
- URL：`/auth/login`
- 方法：`POST`
- 入参（示例）：
```json
{
  "username": "admin",
  "password": "admin",
  "industry": "education"
}
```
- 出参（成功，示例）：
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "satoken-xxxx",
    "tokenType": "Bearer",
    "expiresIn": 7200,
    "userInfo": {
      "id": 1,
      "username": "admin",
      "realName": "系统管理员",
      "email": "admin@university.edu.cn",
      "phone": "13800138000",
      "department": "计算机科学学院",
      "role": "admin",
      "status": "active",
      "industry": "education",
      "avatar": ""
    },
    "roles": ["admin"],
    "permissions": ["*"],
    "menus": [
      {"path":"/dashboard","title":"仪表板","icon":"Odometer","permission":"menu:dashboard:view"},
      {"path":"declaration","title":"申报管理","icon":"Document","permission":"menu:declaration:list","children":[
        {"path":"/declaration/list","title":"申报列表","icon":"List","permission":"menu:declaration:list"},
        {"path":"/declaration/create","title":"新建申报","icon":"CirclePlus","permission":"menu:declaration:create"}]},
      {"path":"project","title":"项目管理","icon":"Folder","permission":"menu:project:list","children":[
        {"path":"/project/list","title":"项目列表","icon":"List","permission":"menu:project:list"}]},
      {"path":"acceptance","title":"验收管理","icon":"Check","permission":"menu:report:list","children":[
        {"path":"/report/list","title":"报告管理","icon":"List","permission":"menu:report:list"}]},
      {"path":"ai","title":"AI助手","icon":"Monitor","permission":"menu:ai:chat","children":[
        {"path":"/knowledge/list","title":"知识库","icon":"Reading","permission":"menu:knowledge:list"},
        {"path":"/ai/chat","title":"AI对话","icon":"Avatar","permission":"menu:ai:chat"}]},
      {"path":"user","title":"用户中心","icon":"User","permission":"menu:user:profile","children":[
        {"path":"/user/profile","title":"个人信息","icon":"House","permission":"menu:user:profile"},
        {"path":"/user/security","title":"安全设置","icon":"Lock","permission":"menu:user:security"}]},
      {"path":"system","title":"系统管理","icon":"Setting","permission":"menu:system:user","children":[
        {"path":"/system/user","title":"用户管理","icon":"User","permission":"menu:system:user:sub"},
        {"path":"/system/role","title":"角色权限","icon":"Key","permission":"menu:system:role"},
        {"path":"/system/config","title":"系统配置","icon":"Setting","permission":"menu:system:config"},
        {"path":"/system/logs","title":"日志管理","icon":"Document","permission":"menu:system:logs"}]}
    ]
  }
}
```
- 失败（示例）：
```json
{"code":401,"message":"用户名或密码错误"}
```

### 字段说明
- `token`/`tokenType`/`expiresIn`：由 Sa-Token 登录鉴权生成与维护。
- `userInfo`：当前登录用户信息。
- `roles`：角色列表，用于前端展示或扩展逻辑。
- `permissions`：仅包含“菜单级权限码”或返回 `*`。不返回按钮权限。
- `menus`：前端侧边栏菜单树，节点包含 `path | title | icon | permission`，子节点放 `children`。

## 用户信息接口（可选）
- URL：`/auth/user-info`
- 作用：会话恢复时返回与登录接口相同的结构（`userInfo/roles/permissions/menus`）。

## 与 Sa-Token 的对接是否满足？
满足。
- 登录时调用 Sa-Token 生成 `token` 写入响应。
- 依据 `industry_type` 查询该用户的“菜单类权限码（permission_type=1）”与“菜单树”，组装为 `permissions/menus` 返回。
- 管理员返回 `permissions: ["*"]` 直接全开。
- 目前按钮权限不返回、不校验；若后续启用按钮级控制：
  1) 在 DB 新增/绑定按钮权限（permission_type=2）；
  2) 登录时把按钮权限合并进 `permissions`；
  3) 前端将 `ALLOW_ALL_BUTTONS=false` 即可生效。

## 查询示例
菜单权限码：
```sql
SELECT DISTINCT p.permission_code
FROM sys_permission p
JOIN sys_role_permission rp ON rp.permission_id = p.id
JOIN sys_user_role ur ON ur.role_id = rp.role_id
WHERE ur.user_id = :userId
  AND p.permission_type = 1
  AND p.status = 1
  AND p.industry_type = :industry;
```
菜单树（思路）：
- 顶级菜单：`parent_id = 0`
- 子菜单：`parent_id = 顶级菜单.id`
- 仅取 `permission_type = 1` 构建树；字段：`id, parent_id, path, permission_code, permission_name, icon, sort_order`

