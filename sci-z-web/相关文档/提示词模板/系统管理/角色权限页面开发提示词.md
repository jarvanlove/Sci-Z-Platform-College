# 角色权限页面开发提示词

## 📋 页面信息
- **页面名称**: 角色权限
- **文件路径**: `src/views/System/Role.vue`
- **路由路径**: `/system/role`
- **权限代码**: `system:role:view`

## 🎯 开发要求

### 页面结构
1. **页面头部**: 标题 + 操作按钮（新增角色）
2. **角色列表表格**: 使用Element Plus表格组件展示角色信息
3. **分页组件**: 使用Element Plus分页组件
4. **新增/编辑角色对话框**: 角色基本信息表单
5. **权限配置对话框**: 使用Element Plus树形组件配置权限

### 组件使用
- **布局组件**: `MainLayout` (默认布局)
- **通用组件**: `BaseCard`, `BaseButton`, `BasePagination`
- **业务组件**: `DataTable`, `ActionButtons`
- **Element Plus**: `el-table`, `el-table-column`, `el-dialog`, `el-form`, `el-tree`, `el-input`, `el-textarea`

### 核心功能实现
1. **角色列表展示**: 角色名称、描述、用户数量、创建时间
2. **角色操作**: 新增、编辑、配置权限、删除
3. **权限配置**: 树形结构展示权限，支持全选、清空、搜索
4. **表单验证**: 角色名称唯一性、描述必填
5. **权限控制**: 根据用户权限显示不同操作按钮

### 信息展示
- **角色基本信息**: 角色名称、角色描述
- **统计信息**: 用户数量、创建时间
- **权限信息**: 权限树形结构，支持展开/收起、搜索

## 📝 代码结构

### Vue模板结构
```vue
<template>
  <div class="role-management-container">
    <!-- 页面头部 -->
    <div class="page-header">
      <h1 class="page-title">{{ $t('system.role.title') }}</h1>
      <div class="header-actions">
        <el-button type="primary" @click="handleAdd">
          <el-icon><Plus /></el-icon>
          {{ $t('system.role.addRole') }}
        </el-button>
      </div>
    </div>

    <!-- 内容卡片 -->
    <BaseCard>
      <!-- 角色列表表格 -->
      <el-table
        :data="filteredRoles"
        v-loading="loading"
        stripe
        border
        style="width: 100%"
      >
        <el-table-column prop="name" :label="$t('system.role.roleName')" width="150" />
        <el-table-column prop="description" :label="$t('system.role.roleDescription')" min-width="200" />
        <el-table-column prop="userCount" :label="$t('system.role.userCount')" width="100" align="center">
          <template #default="{ row }">
            <el-tag type="info">{{ row.userCount }}</el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="createTime" :label="$t('common.createTime')" width="160" />
        <el-table-column :label="$t('common.actions')" width="280" fixed="right">
          <template #default="{ row }">
            <el-button size="small" @click="handleEdit(row)">{{ $t('common.edit') }}</el-button>
            <el-button size="small" type="primary" @click="handleConfigPermission(row)">
              {{ $t('system.role.configPermission') }}
            </el-button>
            <el-button 
              size="small" 
              type="danger" 
              :disabled="row.userCount > 0"
              @click="handleDelete(row)"
            >
              {{ $t('common.delete') }}
            </el-button>
          </template>
        </el-table-column>
      </el-table>

      <!-- 分页 -->
      <BasePagination
        v-model:current-page="pagination.current"
        v-model:page-size="pagination.size"
        :total="pagination.total"
        @current-change="handlePageChange"
        @size-change="handleSizeChange"
      />
    </BaseCard>

    <!-- 新增/编辑角色对话框 -->
    <el-dialog
      v-model="showRoleDialog"
      :title="roleDialogTitle"
      width="500px"
      @close="handleRoleDialogClose"
    >
      <el-form
        ref="roleFormRef"
        :model="roleFormData"
        :rules="roleFormRules"
        label-width="100px"
      >
        <el-form-item :label="$t('system.role.roleName')" prop="name">
          <el-input v-model="roleFormData.name" />
        </el-form-item>
        <el-form-item :label="$t('system.role.roleDescription')" prop="description">
          <el-textarea 
            v-model="roleFormData.description" 
            :rows="3"
            :placeholder="$t('system.role.descriptionPlaceholder')"
          />
        </el-form-item>
      </el-form>
      
      <template #footer>
        <el-button @click="showRoleDialog = false">{{ $t('common.cancel') }}</el-button>
        <el-button type="primary" @click="handleRoleSubmit" :loading="submitting">
          {{ $t('common.confirm') }}
        </el-button>
      </template>
    </el-dialog>

    <!-- 权限配置对话框 -->
    <el-dialog
      v-model="showPermissionDialog"
      :title="$t('system.role.configPermission')"
      width="800px"
      @close="handlePermissionDialogClose"
    >
      <div class="permission-config">
        <div class="permission-header">
          <h3>{{ $t('system.role.role') }}：{{ currentRole?.name }}</h3>
          <div class="permission-actions">
            <el-input
              v-model="permissionSearchText"
              :placeholder="$t('system.role.searchPermission')"
              clearable
              style="width: 200px"
            >
              <template #prefix>
                <el-icon><Search /></el-icon>
              </template>
            </el-input>
            <el-button @click="handleExpandAll">{{ $t('system.role.expandAll') }}</el-button>
            <el-button @click="handleCollapseAll">{{ $t('system.role.collapseAll') }}</el-button>
            <el-button @click="handleSelectAll">{{ $t('system.role.selectAll') }}</el-button>
            <el-button @click="handleClearAll">{{ $t('system.role.clearAll') }}</el-button>
          </div>
        </div>
        
        <el-tree
          ref="permissionTreeRef"
          :data="filteredPermissionTree"
          :props="treeProps"
          show-checkbox
          node-key="id"
          :default-checked-keys="checkedPermissions"
          :filter-node-method="filterNode"
          class="permission-tree"
        />
      </div>
      
      <template #footer>
        <el-button @click="showPermissionDialog = false">{{ $t('common.cancel') }}</el-button>
        <el-button type="primary" @click="handlePermissionSubmit" :loading="submitting">
          {{ $t('system.role.savePermission') }}
        </el-button>
      </template>
    </el-dialog>
  </div>
</template>
```

### JavaScript逻辑
```javascript
import { ref, reactive, computed, onMounted, nextTick } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import { useRouter } from 'vue-router'
import { useAuthStore } from '@/store/modules/auth'
import { useI18n } from 'vue-i18n'
import { formatDate } from '@/utils/date'
import { PERMISSIONS } from '@/utils/constants'
import { validateRoleName } from '@/utils/validate'
import { createLogger } from '@/utils/simpleLogger'

export default {
  name: 'RoleManagement',
  setup() {
    const router = useRouter()
    const authStore = useAuthStore()
    const { t } = useI18n()
    const logger = createLogger('RoleManagement')
    
    // 响应式数据
    const loading = ref(false)
    const submitting = ref(false)
    const showRoleDialog = ref(false)
    const showPermissionDialog = ref(false)
    const isEdit = ref(false)
    const roleFormRef = ref()
    const permissionTreeRef = ref()
    const permissionSearchText = ref('')
    
    // 分页
    const pagination = reactive({
      current: 1,
      size: 20,
      total: 0
    })
    
    // 角色表单数据
    const roleFormData = reactive({
      id: null,
      name: '',
      description: ''
    })
    
    // 角色表单验证规则
    const roleFormRules = {
        name: [
          { required: true, message: t('system.role.nameRequired'), trigger: 'blur' },
          { 
            validator: (rule, value, callback) => {
              if (!validateRoleName(value)) {
                callback(new Error(t('system.role.nameFormat')))
              } else {
                callback()
              }
            }, 
            trigger: 'blur' 
          }
        ],
      description: [
        { required: true, message: t('system.role.descriptionRequired'), trigger: 'blur' }
      ]
    }
    
    // 当前操作的角色
    const currentRole = ref(null)
    const checkedPermissions = ref([])
    
    // 角色列表数据（通过接口获取）
    const roles = ref([])
    
    // 加载角色列表
    const loadRoles = async () => {
      try {
        loading.value = true
        logger.info('Loading roles list')
        
        // TODO: 替换为实际的后端接口
        // const response = await getRolesList({
        //   page: pagination.current,
        //   size: pagination.size
        // })
        // roles.value = response.data.list
        // pagination.total = response.data.total
        
        // 临时模拟数据（后端开发完成后删除）
        await new Promise(resolve => setTimeout(resolve, 500))
        
        const mockRoles = [
          {
            id: 1,
            name: '超级管理员',
            description: '拥有系统所有权限，可以管理所有用户和角色',
            userCount: 1,
            createTime: '2024-01-01 10:00:00',
            permissions: ['*']
          },
          {
            id: 2,
            name: '教师',
            description: '可以管理自己的项目和申报，查看相关报告',
            userCount: 5,
            createTime: '2024-01-02 10:00:00',
            permissions: ['project:view', 'project:create', 'declaration:view', 'declaration:create']
          },
          {
            id: 3,
            name: '学生',
            description: '可以查看和参与项目，提交申报',
            userCount: 20,
            createTime: '2024-01-03 10:00:00',
            permissions: ['project:view', 'declaration:view', 'declaration:create']
          }
        ]
        
        roles.value = mockRoles
        pagination.total = mockRoles.length
        logger.info('Roles list loaded successfully', { count: roles.value.length })
      } catch (error) {
        logger.error('Failed to load roles list', error)
        ElMessage.error(t('system.role.loadError'))
      } finally {
        loading.value = false
      }
    }
    
    // 权限树数据（通过接口获取）
    const permissionTree = ref([])
    
    // 加载权限树数据
    const loadPermissionTree = async () => {
      try {
        logger.info('Loading permission tree')
        
        // TODO: 替换为实际的后端接口
        // const response = await getPermissionTree()
        // permissionTree.value = response.data.tree
        
        // 临时模拟数据（后端开发完成后删除）
        await new Promise(resolve => setTimeout(resolve, 300))
        
        const mockPermissionTree = [
          {
            id: 'dashboard',
            label: '仪表板',
            children: [
              { id: 'dashboard:view', label: '查看仪表板' }
            ]
          },
          {
            id: 'project',
            label: '项目管理',
            children: [
              { id: 'project:view', label: '查看项目' },
              { id: 'project:create', label: '创建项目' },
              { id: 'project:edit', label: '编辑项目' },
              { id: 'project:delete', label: '删除项目' }
            ]
          },
          {
            id: 'declaration',
            label: '申报管理',
            children: [
              { id: 'declaration:view', label: '查看申报' },
              { id: 'declaration:create', label: '创建申报' },
              { id: 'declaration:edit', label: '编辑申报' },
              { id: 'declaration:delete', label: '删除申报' }
            ]
          },
          {
            id: 'system',
            label: '系统管理',
            children: [
              { id: 'system:user:view', label: '查看用户' },
              { id: 'system:user:create', label: '创建用户' },
              { id: 'system:user:edit', label: '编辑用户' },
              { id: 'system:user:delete', label: '删除用户' },
              { id: 'system:role:view', label: '查看角色' },
              { id: 'system:role:create', label: '创建角色' },
              { id: 'system:role:edit', label: '编辑角色' },
              { id: 'system:role:delete', label: '删除角色' }
            ]
          }
        ]
        
        permissionTree.value = mockPermissionTree
        logger.info('Permission tree loaded successfully', { count: mockPermissionTree.length })
      } catch (error) {
        logger.error('Failed to load permission tree', error)
        ElMessage.error(t('system.role.permissionTreeLoadError'))
      }
    }
    
    // 树形组件配置
    const treeProps = {
      children: 'children',
      label: 'label'
    }
    
    // 计算属性
    const roleDialogTitle = computed(() => isEdit.value ? t('system.role.editRole') : t('system.role.addRole'))
    
    const filteredRoles = computed(() => {
      // 分页逻辑由后端接口处理，直接返回角色列表
      return roles.value
    })
    
    const filteredPermissionTree = computed(() => {
      if (!permissionSearchText.value) {
        return permissionTree.value
      }
      
      const filterTree = (nodes) => {
        return nodes.filter(node => {
          const matchesSearch = node.label.toLowerCase().includes(permissionSearchText.value.toLowerCase())
          const hasMatchingChildren = node.children ? filterTree(node.children).length > 0 : false
          
          if (matchesSearch || hasMatchingChildren) {
            return {
              ...node,
              children: node.children ? filterTree(node.children) : undefined
            }
          }
          return false
        }).map(node => ({
          ...node,
          children: node.children ? filterTree(node.children) : undefined
        }))
      }
      
      return filterTree(permissionTree.value)
    })
    
    // 方法
    const handleAdd = () => {
      isEdit.value = false
      resetRoleForm()
      showRoleDialog.value = true
    }
    
    const handleEdit = (role) => {
      isEdit.value = true
      Object.assign(roleFormData, role)
      showRoleDialog.value = true
    }
    
    const handleConfigPermission = (role) => {
      currentRole.value = role
      checkedPermissions.value = [...role.permissions]
      showPermissionDialog.value = true
      
      nextTick(() => {
        permissionTreeRef.value?.setCheckedKeys(checkedPermissions.value)
      })
    }
    
    const handleDelete = async (role) => {
      if (role.userCount > 0) {
        ElMessage.warning(t('system.role.cannotDeleteWithUsers'))
        return
      }
      
      try {
        await ElMessageBox.confirm(
          t('system.role.deleteConfirm', { name: role.name }),
          t('system.role.deleteRole'),
          { type: 'warning' }
        )
        
        logger.info('Deleting role', { roleId: role.id, roleName: role.name })
        
        // TODO: 替换为实际的后端接口
        // await deleteRole(role.id)
        
        // 临时模拟删除（后端开发完成后删除）
        await new Promise(resolve => setTimeout(resolve, 500))
        
        const index = roles.value.findIndex(r => r.id === role.id)
        if (index > -1) {
          roles.value.splice(index, 1)
        }
        
        ElMessage.success(t('system.role.deleteSuccess'))
        logger.info('Role deleted successfully', { roleId: role.id })
      } catch (error) {
        if (error !== 'cancel') {
          logger.error('Failed to delete role', error)
          ElMessage.error(t('system.role.deleteFailed'))
        }
      }
    }
    
    const handleRoleSubmit = async () => {
      try {
        await roleFormRef.value.validate()
        
        submitting.value = true
        logger.info('Submitting role form', { isEdit: isEdit.value, roleData: roleFormData })
        
        // TODO: 替换为实际的后端接口
        // if (isEdit.value) {
        //   await updateRole(roleFormData.id, roleFormData)
        // } else {
        //   await createRole(roleFormData)
        // }
        
        // 临时模拟保存（后端开发完成后删除）
        await new Promise(resolve => setTimeout(resolve, 1000))
        
        if (isEdit.value) {
          // 更新角色
          const index = roles.value.findIndex(r => r.id === roleFormData.id)
          if (index > -1) {
            Object.assign(roles.value[index], roleFormData)
          }
          ElMessage.success(t('system.role.updateSuccess'))
          logger.info('Role updated successfully', { roleId: roleFormData.id })
        } else {
          // 新增角色
          const newRole = {
            ...roleFormData,
            id: Date.now(),
            userCount: 0,
            createTime: new Date().toLocaleString(),
            permissions: []
          }
          roles.value.unshift(newRole)
          ElMessage.success(t('system.role.createSuccess'))
          logger.info('Role created successfully', { roleId: newRole.id })
        }
        
        showRoleDialog.value = false
        submitting.value = false
      } catch (error) {
        submitting.value = false
        if (error !== false) {
          logger.error('Role submit failed', error)
          ElMessage.error(t('common.operationFailed'))
        }
      }
    }
    
    const handlePermissionSubmit = async () => {
      try {
        submitting.value = true
        
        // 获取选中的权限
        const checkedKeys = permissionTreeRef.value.getCheckedKeys()
        const halfCheckedKeys = permissionTreeRef.value.getHalfCheckedKeys()
        const allCheckedKeys = [...checkedKeys, ...halfCheckedKeys]
        
        logger.info('Submitting role permissions', { 
          roleId: currentRole.value.id, 
          permissions: allCheckedKeys 
        })
        
        // TODO: 替换为实际的后端接口
        // await updateRolePermissions(currentRole.value.id, allCheckedKeys)
        
        // 临时模拟保存权限（后端开发完成后删除）
        await new Promise(resolve => setTimeout(resolve, 1000))
        
        // 更新角色权限
        const index = roles.value.findIndex(r => r.id === currentRole.value.id)
        if (index > -1) {
          roles.value[index].permissions = allCheckedKeys
        }
        
        ElMessage.success(t('system.role.permissionConfigSuccess'))
        showPermissionDialog.value = false
        submitting.value = false
        logger.info('Role permissions updated successfully', { roleId: currentRole.value.id })
      } catch (error) {
        submitting.value = false
        logger.error('Failed to update role permissions', error)
        ElMessage.error(t('system.role.permissionConfigFailed'))
      }
    }
    
    const handleRoleDialogClose = () => {
      resetRoleForm()
      roleFormRef.value?.resetFields()
    }
    
    const handlePermissionDialogClose = () => {
      currentRole.value = null
      checkedPermissions.value = []
      permissionSearchText.value = ''
    }
    
    const resetRoleForm = () => {
      Object.assign(roleFormData, {
        id: null,
        name: '',
        description: ''
      })
    }
    
    const handleExpandAll = () => {
      const allKeys = []
      const getAllKeys = (nodes) => {
        nodes.forEach(node => {
          allKeys.push(node.id)
          if (node.children) {
            getAllKeys(node.children)
          }
        })
      }
      getAllKeys(permissionTree.value)
      permissionTreeRef.value?.setExpandedKeys(allKeys)
    }
    
    const handleCollapseAll = () => {
      permissionTreeRef.value?.setExpandedKeys([])
    }
    
    const handleSelectAll = () => {
      const allKeys = []
      const getAllKeys = (nodes) => {
        nodes.forEach(node => {
          if (!node.children) {
            allKeys.push(node.id)
          } else {
            getAllKeys(node.children)
          }
        })
      }
      getAllKeys(permissionTree.value)
      permissionTreeRef.value?.setCheckedKeys(allKeys)
    }
    
    const handleClearAll = () => {
      permissionTreeRef.value?.setCheckedKeys([])
    }
    
    const filterNode = (value, data) => {
      if (!value) return true
      return data.label.toLowerCase().includes(value.toLowerCase())
    }
    
    const handlePageChange = (page) => {
      pagination.current = page
      loadRoles()
    }
    
    const handleSizeChange = (size) => {
      pagination.size = size
      pagination.current = 1
      loadRoles()
    }
    
    // 生命周期
    onMounted(() => {
      loadRoles()
      loadPermissionTree()
    })
    
    return {
      loading,
      submitting,
      showRoleDialog,
      showPermissionDialog,
      isEdit,
      roleFormRef,
      permissionTreeRef,
      permissionSearchText,
      pagination,
      roleFormData,
      roleFormRules,
      currentRole,
      checkedPermissions,
      roles,
      permissionTree,
      treeProps,
      roleDialogTitle,
      filteredRoles,
      filteredPermissionTree,
      loadRoles,
      loadPermissionTree,
      handleAdd,
      handleEdit,
      handleConfigPermission,
      handleDelete,
      handleRoleSubmit,
      handlePermissionSubmit,
      handleRoleDialogClose,
      handlePermissionDialogClose,
      handleExpandAll,
      handleCollapseAll,
      handleSelectAll,
      handleClearAll,
      filterNode,
      handlePageChange,
      handleSizeChange
    }
  }
}
```

## 🎨 样式实现

```scss
<style scoped>
.role-management-container {
  padding: 20px;
  background: #f7f9fc;
  min-height: calc(100vh - 56px);
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.page-title {
  font-size: 24px;
  font-weight: 600;
  color: #1e3a8a;
  margin: 0;
}

.header-actions {
  display: flex;
  gap: 12px;
}

.permission-config {
  .permission-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid #e5e7eb;
    
    h3 {
      margin: 0;
      color: #1e3a8a;
      font-size: 16px;
      font-weight: 600;
    }
    
    .permission-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }
  }
  
  .permission-tree {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    padding: 12px;
  }
}

:deep(.el-table) {
  border-radius: 8px;
  overflow: hidden;
}

:deep(.el-table__header) {
  background: #f8fafc;
}

:deep(.el-table th) {
  background: #f8fafc;
  color: #374151;
  font-weight: 600;
}

:deep(.el-table--striped .el-table__body tr.el-table__row--striped td) {
  background: #f9fafb;
}

:deep(.el-table__body tr:hover > td) {
  background: #f0f9ff;
}

:deep(.el-tag) {
  border-radius: 4px;
  font-weight: 500;
}

:deep(.el-dialog) {
  border-radius: 12px;
}

:deep(.el-dialog__header) {
  border-bottom: 1px solid #f0f0f0;
  padding: 20px 24px 16px;
}

:deep(.el-dialog__title) {
  font-size: 18px;
  font-weight: 600;
  color: #1e3a8a;
}

:deep(.el-dialog__body) {
  padding: 20px 24px;
}

:deep(.el-dialog__footer) {
  border-top: 1px solid #f0f0f0;
  padding: 16px 24px 20px;
}

:deep(.el-tree) {
  background: transparent;
}

:deep(.el-tree-node__content) {
  height: 32px;
  line-height: 32px;
}

:deep(.el-tree-node__label) {
  font-size: 14px;
  color: #374151;
}

:deep(.el-checkbox) {
  margin-right: 8px;
}
</style>
```

## ⚠️ 注意事项

1. **表格组件**: 使用Element Plus的`el-table`和`el-table-column`组件，不要使用原生HTML表格
2. **权限树**: 使用Element Plus的`el-tree`组件，支持复选框、搜索、展开/收起功能
3. **权限控制**: 根据用户权限显示不同的操作按钮，删除角色前检查是否有用户
4. **表单验证**: 角色名称唯一性检查、描述必填验证
5. **权限配置**: 支持全选、清空、搜索权限，保存时包含半选状态
6. **分页功能**: 使用Element Plus分页组件，支持页码跳转和每页显示数量调整
7. **接口集成**: 所有数据操作通过后端接口实现，包含完整的错误处理和加载状态
8. **用户体验**: 操作成功/失败都有相应的消息提示，重要操作需要确认对话框
9. **树形结构**: 权限树支持多级结构，支持搜索过滤和批量操作
10. **状态管理**: 权限配置对话框关闭时重置相关状态

**最终要求：生成的代码必须与原型图的视觉效果和交互逻辑完全一致！**
